{"version":3,"file":"wordpress-235dee24.js","sources":["../../../../../packages/php-wasm/node-polyfills/src/lib/current-js-runtime.ts","../../../../../packages/php-wasm/node-polyfills/src/lib/blob.ts","../../../../../packages/php-wasm/node-polyfills/src/lib/custom-event.ts","../../../../../packages/php-wasm/node-polyfills/src/lib/url.ts","../../../../../packages/php-wasm/universal/src/lib/rethrow-file-system-error.ts","../../../../../packages/php-wasm/logger/src/lib/handlers/log-event.ts","../../../../../packages/php-wasm/logger/src/lib/handlers/log-to-console.ts","../../../../../packages/php-wasm/logger/src/lib/handlers/log-to-memory.ts","../../../../../packages/php-wasm/logger/src/lib/logger.ts","../../../../../packages/php-wasm/util/src/lib/sleep.ts","../../../../../packages/php-wasm/util/src/lib/semaphore.ts","../../../../../packages/php-wasm/util/src/lib/php-wasm-error.ts","../../../../../packages/php-wasm/util/src/lib/paths.ts","../../../../../packages/php-wasm/util/src/lib/random-string.ts","../../../../../packages/php-wasm/util/src/lib/random-filename.ts","../../../../../packages/php-wasm/util/src/lib/php-vars.ts","../../../../../packages/php-wasm/universal/src/lib/fs-helpers.ts","../../../../../packages/php-wasm/universal/src/lib/php-response.ts","../../../../../packages/php-wasm/universal/src/lib/load-php-runtime.ts","../../../../../packages/php-wasm/stream-compression/src/utils/iterable-stream-polyfill.ts","../../../../../packages/php-wasm/universal/src/lib/write-files.ts","../../../../../node_modules/comlink/dist/esm/comlink.mjs","../../../../../packages/php-wasm/web/src/lib/api.ts","../../../../../packages/php-wasm/web/src/lib/tls/utils.ts","../../../../../packages/php-wasm/web/src/lib/tls/extensions/types.ts","../../../../../packages/php-wasm/web/src/lib/tls/extensions/0_server_name.ts","../../../../../packages/php-wasm/web/src/lib/tls/cipher-suites.ts","../../../../../packages/php-wasm/web/src/lib/tls/extensions/10_supported_groups.ts","../../../../../packages/php-wasm/web/src/lib/tls/extensions/11_ec_point_formats.ts","../../../../../packages/php-wasm/web/src/lib/tls/extensions/13_signature_algorithms.ts","../../../../../packages/php-wasm/web/src/lib/tls/1_2/types.ts","../../../../../packages/php-wasm/web/src/lib/tls/1_2/connection.ts","../../../../../packages/php-wasm/web-service-worker/src/messaging.ts","../../../../../packages/php-wasm/web-service-worker/src/utils.ts","../../../../../packages/php-wasm/web/src/lib/fetch-with-cors-proxy.ts","../../../../../packages/php-wasm/web/src/lib/setup-post-message-relay.ts","../../../../../packages/php-wasm/web/src/lib/worker-thread/spawn-php-worker-thread.ts","../../../../../packages/playground/remote/src/lib/progress-bar/index.ts","../../../../../packages/playground/blueprints/src/lib/utils/wp-content-files-excluded-from-exports.ts","../../../../../packages/playground/blueprints/src/lib/steps/activate-plugin.ts","../../../../../packages/playground/blueprints/src/lib/steps/activate-theme.ts","../../../../../packages/playground/blueprints/src/lib/steps/run-php.ts","../../../../../packages/playground/blueprints/src/lib/steps/run-php-with-options.ts","../../../../../packages/playground/blueprints/src/lib/steps/rm.ts","../../../../../packages/playground/blueprints/src/lib/steps/run-sql.ts","../../../../../packages/playground/blueprints/src/lib/steps/request.ts","../../../../../packages/playground/blueprints/src/lib/steps/rewrite-wp-config-to-define-constants.php?raw","../../../../../packages/playground/blueprints/src/lib/steps/define-wp-config-consts.ts","../../../../../packages/playground/blueprints/src/lib/steps/site-data.ts","../../../../../packages/playground/blueprints/src/lib/steps/wp-cli.ts","../../../../../packages/playground/blueprints/src/lib/steps/enable-multisite.ts","../../../../../packages/playground/blueprints/src/lib/steps/cp.ts","../../../../../packages/playground/blueprints/src/lib/steps/mv.ts","../../../../../packages/playground/blueprints/src/lib/steps/mkdir.ts","../../../../../packages/playground/blueprints/src/lib/steps/rmdir.ts","../../../../../packages/playground/blueprints/src/lib/steps/write-file.ts","../../../../../packages/playground/blueprints/src/lib/steps/write-files.ts","../../../../../packages/playground/blueprints/src/lib/steps/define-site-url.ts","../../../../../packages/playground/blueprints/src/lib/steps/import-wxr.ts","../../../../../packages/playground/blueprints/src/lib/steps/import-theme-starter-content.ts","../../../../../packages/playground/common/src/create-memoized-fetch.ts","../../../../../packages/playground/common/src/index.ts","../../../../../packages/playground/blueprints/src/lib/steps/unzip.ts","../../../../../packages/playground/blueprints/src/lib/steps/import-wordpress-files.ts","../../../../../packages/playground/blueprints/src/lib/steps/export-wxr.ts","../../../../../packages/playground/blueprints/src/lib/steps/install-asset.ts","../../../../../packages/playground/blueprints/src/lib/utils/zip-name-to-human-name.ts","../../../../../packages/playground/blueprints/src/lib/steps/install-plugin.ts","../../../../../packages/playground/blueprints/src/lib/steps/install-theme.ts","../../../../../packages/playground/blueprints/src/lib/steps/login.ts","../../../../../packages/playground/blueprints/src/lib/steps/reset-data.ts","../../../../../packages/playground/blueprints/src/lib/steps/run-wp-installation-wizard.ts","../../../../../packages/playground/blueprints/src/lib/steps/zip-wp-content.ts","../../../../../packages/playground/wordpress/src/index.ts","../../../../../packages/playground/blueprints/src/lib/steps/set-site-language.ts","../../../../../isomorphic-git/src/errors/BaseError.js","../../../../../node_modules/crc-32/crc32.js","../../../../../node_modules/base64-js/index.js","../../../../../node_modules/ieee754/index.js","../../../../../node_modules/buffer/index.js","../../../../../isomorphic-git/src/errors/ObjectTypeError.js","../../../../../packages/playground/storage/src/lib/git-sparse-checkout.ts","../../../../../packages/playground/blueprints/src/lib/compile.ts","../../../../../packages/playground/remote/src/lib/setup-fetch-network-transport.ts","../../../../../packages/playground/remote/src/lib/boot-playground-remote.ts","../../../../../packages/playground/wordpress-builds/src/index.ts","../../../../../packages/playground/remote/remote.html?html-proxy&index=1.js"],"sourcesContent":["export const currentJsRuntime = (function () {\n\tif (typeof process !== 'undefined' && process.release?.name === 'node') {\n\t\treturn 'NODE';\n\t} else if (typeof window !== 'undefined') {\n\t\treturn 'WEB';\n\t} else if (\n\t\t// @ts-ignore\n\t\ttypeof WorkerGlobalScope !== 'undefined' &&\n\t\t// @ts-ignore\n\t\tself instanceof (WorkerGlobalScope as any)\n\t) {\n\t\treturn 'WORKER';\n\t} else {\n\t\treturn 'NODE';\n\t}\n})();\n","import { currentJsRuntime } from './current-js-runtime';\n\n// Without this check, the polyfills below would also be applied\n// in web browsers. Unfortunately, Safari doesn't sypport BYOB streams\n// and doesn't support the polyfill provided here. Let's only apply\n// those polyfills in Node.js environments.\nif (currentJsRuntime === 'NODE') {\n\t/**\n\t * WordPress Playground heavily realies on the File class. This module\n\t * polyfill the File class for the different environments where\n\t * WordPress Playground may run.\n\t */\n\tif (typeof File === 'undefined') {\n\t\t/**\n\t\t * Polyfill the File class that isn't shipped in Node.js version 18.\n\t\t *\n\t\t * Blob conveniently provides a lot of the same methods as File, we\n\t\t * just need to implement a few File-specific properties.\n\t\t */\n\t\tclass File extends Blob {\n\t\t\toverride readonly name;\n\t\t\treadonly lastModified: number;\n\t\t\treadonly lastModifiedDate: Date;\n\t\t\twebkitRelativePath: any;\n\t\t\tconstructor(\n\t\t\t\tsources: BlobPart[],\n\t\t\t\tfileName: string,\n\t\t\t\toptions?: FilePropertyBag\n\t\t\t) {\n\t\t\t\tsuper(sources);\n\t\t\t\t/*\n\t\t\t\t * Compute a valid last modified date as that's what the\n\t\t\t\t * browsers do:\n\t\t\t\t *\n\t\t\t\t * ```\n\t\t\t\t * > new File([], '').lastModifiedDate\n\t\t\t\t * Sat Dec 16 2023 10:07:53 GMT+0100 (czas środkowoeuropejski standardowy)\n\t\t\t\t *\n\t\t\t\t * > new File([], '', { lastModified: NaN }).lastModifiedDate\n\t\t\t\t * Thu Jan 01 1970 01:00:00 GMT+0100 (czas środkowoeuropejski standardowy)\n\t\t\t\t *\n\t\t\t\t * > new File([], '', { lastModified: 'string' }).lastModifiedDate\n\t\t\t\t * Thu Jan 01 1970 01:00:00 GMT+0100 (czas środkowoeuropejski standardowy)\n\t\t\t\t *\n\t\t\t\t * > new File([], '', { lastModified: {} }).lastModifiedDate\n\t\t\t\t * Thu Jan 01 1970 01:00:00 GMT+0100 (czas środkowoeuropejski standardowy)\n\t\t\t\t * ```\n\t\t\t\t */\n\t\t\t\tlet date;\n\t\t\t\tif (options?.lastModified) {\n\t\t\t\t\tdate = new Date();\n\t\t\t\t}\n\t\t\t\tif (!date || isNaN(date.getFullYear())) {\n\t\t\t\t\tdate = new Date();\n\t\t\t\t}\n\t\t\t\tthis.lastModifiedDate = date;\n\t\t\t\tthis.lastModified = date.getMilliseconds();\n\t\t\t\tthis.name = fileName || '';\n\t\t\t}\n\t\t}\n\t\tglobal.File = File;\n\t}\n\n\t// eslint-disable-next-line no-inner-declarations\n\tfunction asPromise<T>(obj: FileReader) {\n\t\treturn new Promise<T>(function (resolve, reject) {\n\t\t\tobj.onload = obj.onerror = function (event: Event) {\n\t\t\t\tobj.onload = obj.onerror = null;\n\n\t\t\t\tif (event.type === 'load') {\n\t\t\t\t\tresolve(obj.result as T);\n\t\t\t\t} else {\n\t\t\t\t\treject(new Error('Failed to read the blob/file'));\n\t\t\t\t}\n\t\t\t};\n\t\t});\n\t}\n\n\t/**\n\t * File is a subclass of Blob. Let's polyfill the following Blob\n\t * methods that are missing in JSDOM:\n\t *\n\t * – Blob.text()\n\t * – Blob.stream()\n\t * – Blob.arrayBuffer()\n\t *\n\t * See the related JSDom issue:\n\t *\n\t * – [Implement Blob.stream, Blob.text and Blob.arrayBuffer](https://github.com/jsdom/jsdom/issues/2555).\n\t *\n\t * @source `blob-polyfill` npm package.\n\t * * By Eli Grey, https://eligrey.com\n\t * * By Jimmy Wärting, https://github.com/jimmywarting\n\t */\n\tif (typeof Blob.prototype.arrayBuffer === 'undefined') {\n\t\tBlob.prototype.arrayBuffer = function arrayBuffer() {\n\t\t\tconst reader = new FileReader();\n\t\t\treader.readAsArrayBuffer(this);\n\t\t\treturn asPromise<Uint8Array>(reader);\n\t\t};\n\t}\n\n\tif (typeof Blob.prototype.text === 'undefined') {\n\t\tBlob.prototype.text = function text() {\n\t\t\tconst reader = new FileReader();\n\t\t\treader.readAsText(this);\n\t\t\treturn asPromise<string>(reader);\n\t\t};\n\t}\n\n\t/**\n\t * Detects if BYOB (Bring Your Own Buffer) streams are supported\n\t * in the current environment.\n\t *\n\t * BYOB is a new feature in the Streams API that allows reading\n\t * an arbitrary number of bytes from a stream. It's not supported\n\t * in older versions of Node.js.\n\t *\n\t * @see https://developer.mozilla.org/en-US/docs/Web/API/ReadableStreamBYOBReader\n\t */\n\t// eslint-disable-next-line no-inner-declarations\n\tfunction isByobSupported() {\n\t\tconst inputBytes = new Uint8Array([1, 2, 3, 4]);\n\t\tconst file = new File([inputBytes], 'test');\n\t\tconst stream = file.stream();\n\t\ttry {\n\t\t\t// This throws on older versions of node:\n\t\t\tstream.getReader({ mode: 'byob' });\n\t\t\treturn true;\n\t\t} catch (e) {\n\t\t\treturn false;\n\t\t}\n\t}\n\n\t/**\n\t * Polyfill the stream() method if it either doesn't exist,\n\t * or is an older version shipped with e.g. Node.js 18 where\n\t * BYOB streams seem to be unsupported.\n\t */\n\tif (typeof Blob.prototype.stream === 'undefined' || !isByobSupported()) {\n\t\tBlob.prototype.stream = function () {\n\t\t\tlet position = 0;\n\t\t\t// eslint-disable-next-line\n\t\t\tconst blob = this;\n\t\t\treturn new ReadableStream({\n\t\t\t\ttype: 'bytes',\n\t\t\t\t// 0.5 MB seems like a reasonable chunk size, let's adjust\n\t\t\t\t// this if needed.\n\t\t\t\tautoAllocateChunkSize: 512 * 1024,\n\n\t\t\t\tasync pull(controller) {\n\t\t\t\t\tconst view = controller.byobRequest!.view;\n\n\t\t\t\t\t// Read the next chunk of data:\n\t\t\t\t\tconst chunk = blob.slice(\n\t\t\t\t\t\tposition,\n\t\t\t\t\t\tposition + view!.byteLength\n\t\t\t\t\t);\n\t\t\t\t\tconst buffer = await chunk.arrayBuffer();\n\t\t\t\t\tconst uint8array = new Uint8Array(buffer);\n\n\t\t\t\t\t// Emit that chunk:\n\t\t\t\t\tnew Uint8Array(view!.buffer).set(uint8array);\n\t\t\t\t\tconst bytesRead = uint8array.byteLength;\n\t\t\t\t\tcontroller.byobRequest!.respond(bytesRead);\n\n\t\t\t\t\t// Bump the position and close this stream once\n\t\t\t\t\t// we've read the entire blob.\n\t\t\t\t\tposition += bytesRead;\n\t\t\t\t\tif (position >= blob.size) {\n\t\t\t\t\t\tcontroller.close();\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t});\n\t\t};\n\t}\n}\n\nexport default {};\n","import { currentJsRuntime } from './current-js-runtime';\n\nif (currentJsRuntime === 'NODE' && typeof CustomEvent === 'undefined') {\n\tclass CustomEvent<T = any> extends Event {\n\t\treadonly detail: T;\n\t\tconstructor(\n\t\t\tname: string,\n\t\t\toptions: {\n\t\t\t\tdetail?: T;\n\t\t\t\tbubbles?: boolean;\n\t\t\t\tcancellable?: boolean;\n\t\t\t\tcomposed?: boolean;\n\t\t\t} = {}\n\t\t) {\n\t\t\tsuper(name, options);\n\t\t\t/*\n\t\t\t * The bang symbol (`!`) here is a lie to make TypeScript happy.\n\t\t\t *\n\t\t\t * Without the bang TS has the following complaint:\n\t\t\t *\n\t\t\t * > T | undefined is not assignable to type T\n\t\t\t *\n\t\t\t * In reality, it's absolutely fine for T (or `options.detail`)\n\t\t\t * to be undefined. However, the CustomEvent interface shipped\n\t\t\t * with TypeScript doesn't think so and marks `this.details` as\n\t\t\t * a required property.\n\t\t\t *\n\t\t\t * This little and harmless trick silences that error.\n\t\t\t */\n\t\t\tthis.detail = options.detail!;\n\t\t}\n\t\tinitCustomEvent(): void {}\n\t}\n\tglobalThis.CustomEvent = CustomEvent;\n}\n","import { currentJsRuntime } from './current-js-runtime';\n\nif (currentJsRuntime === 'NODE') {\n\t/**\n\t * Polyfill for URL.canParse if it's missing.\n\t *\n\t * URL.canParse is available since Node 19.9.0,\n\t * but Playground currently uses Node 18.18.0.\n\t *\n\t * This implementation is based on the one from `core-js`\n\t * by Denis Pushkarev, https://github.com/zloirock\n\t * https://github.com/zloirock/core-js/blob/master/packages/core-js/modules/web.url.can-parse.js\n\t */\n\tif (typeof URL.canParse !== 'function') {\n\t\tglobalThis.URL.canParse = function (url: string) {\n\t\t\ttry {\n\t\t\t\treturn !!new URL(url);\n\t\t\t} catch (e) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t};\n\t}\n}\n","/**\n * Emscripten's filesystem-related Exception.\n *\n * @see https://emscripten.org/docs/api_reference/Filesystem-API.html\n * @see https://github.com/emscripten-core/emscripten/blob/main/system/lib/libc/musl/arch/emscripten/bits/errno.h\n * @see https://github.com/emscripten-core/emscripten/blob/38eedc630f17094b3202fd48ac0c2c585dbea31e/system/include/wasi/api.h#L336\n */\n\nexport interface ErrnoError extends Error {\n\tnode?: any;\n\terrno: number;\n\tmessage: string;\n}\n/**\n * @see https://github.com/emscripten-core/emscripten/blob/38eedc630f17094b3202fd48ac0c2c585dbea31e/system/include/wasi/api.h#L336\n */\nexport const FileErrorCodes = {\n\t0: 'No error occurred. System call completed successfully.',\n\t1: 'Argument list too long.',\n\t2: 'Permission denied.',\n\t3: 'Address in use.',\n\t4: 'Address not available.',\n\t5: 'Address family not supported.',\n\t6: 'Resource unavailable, or operation would block.',\n\t7: 'Connection already in progress.',\n\t8: 'Bad file descriptor.',\n\t9: 'Bad message.',\n\t10: 'Device or resource busy.',\n\t11: 'Operation canceled.',\n\t12: 'No child processes.',\n\t13: 'Connection aborted.',\n\t14: 'Connection refused.',\n\t15: 'Connection reset.',\n\t16: 'Resource deadlock would occur.',\n\t17: 'Destination address required.',\n\t18: 'Mathematics argument out of domain of function.',\n\t19: 'Reserved.',\n\t20: 'File exists.',\n\t21: 'Bad address.',\n\t22: 'File too large.',\n\t23: 'Host is unreachable.',\n\t24: 'Identifier removed.',\n\t25: 'Illegal byte sequence.',\n\t26: 'Operation in progress.',\n\t27: 'Interrupted function.',\n\t28: 'Invalid argument.',\n\t29: 'I/O error.',\n\t30: 'Socket is connected.',\n\t31: 'There is a directory under that path.',\n\t32: 'Too many levels of symbolic links.',\n\t33: 'File descriptor value too large.',\n\t34: 'Too many links.',\n\t35: 'Message too large.',\n\t36: 'Reserved.',\n\t37: 'Filename too long.',\n\t38: 'Network is down.',\n\t39: 'Connection aborted by network.',\n\t40: 'Network unreachable.',\n\t41: 'Too many files open in system.',\n\t42: 'No buffer space available.',\n\t43: 'No such device.',\n\t44: 'There is no such file or directory OR the parent directory does not exist.',\n\t45: 'Executable file format error.',\n\t46: 'No locks available.',\n\t47: 'Reserved.',\n\t48: 'Not enough space.',\n\t49: 'No message of the desired type.',\n\t50: 'Protocol not available.',\n\t51: 'No space left on device.',\n\t52: 'Function not supported.',\n\t53: 'The socket is not connected.',\n\t54: 'Not a directory or a symbolic link to a directory.',\n\t55: 'Directory not empty.',\n\t56: 'State not recoverable.',\n\t57: 'Not a socket.',\n\t58: 'Not supported, or operation not supported on socket.',\n\t59: 'Inappropriate I/O control operation.',\n\t60: 'No such device or address.',\n\t61: 'Value too large to be stored in data type.',\n\t62: 'Previous owner died.',\n\t63: 'Operation not permitted.',\n\t64: 'Broken pipe.',\n\t65: 'Protocol error.',\n\t66: 'Protocol not supported.',\n\t67: 'Protocol wrong type for socket.',\n\t68: 'Result too large.',\n\t69: 'Read-only file system.',\n\t70: 'Invalid seek.',\n\t71: 'No such process.',\n\t72: 'Reserved.',\n\t73: 'Connection timed out.',\n\t74: 'Text file busy.',\n\t75: 'Cross-device link.',\n\t76: 'Extension: Capabilities insufficient.',\n} as any;\n\nexport function getEmscriptenFsError(e: any) {\n\tconst errno = typeof e === 'object' ? ((e as any)?.errno as any) : null;\n\tif (errno in FileErrorCodes) {\n\t\treturn FileErrorCodes[errno];\n\t}\n}\n\nexport function rethrowFileSystemError(messagePrefix = '') {\n\treturn function catchFileSystemError(\n\t\ttarget: any,\n\t\tmethodName: string,\n\t\tdescriptor: PropertyDescriptor\n\t) {\n\t\tconst method = descriptor.value;\n\t\tdescriptor.value = function (...args: any[]) {\n\t\t\ttry {\n\t\t\t\treturn method.apply(this, args);\n\t\t\t} catch (e) {\n\t\t\t\tconst errno =\n\t\t\t\t\ttypeof e === 'object' ? ((e as any)?.errno as any) : null;\n\t\t\t\tif (errno in FileErrorCodes) {\n\t\t\t\t\tconst errmsg = FileErrorCodes[errno];\n\t\t\t\t\tconst path = typeof args[1] === 'string' ? args[1] : null;\n\t\t\t\t\tconst formattedPrefix =\n\t\t\t\t\t\tpath !== null\n\t\t\t\t\t\t\t? messagePrefix.replaceAll('{path}', path)\n\t\t\t\t\t\t\t: messagePrefix;\n\t\t\t\t\tthrow new Error(`${formattedPrefix}: ${errmsg}`, {\n\t\t\t\t\t\tcause: e,\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\tthrow e;\n\t\t\t}\n\t\t};\n\t};\n}\n","import { LogHandler } from '../log-handlers';\nimport { Log, logger } from '../logger';\n\nexport const logEventType = 'playground-log';\n\nexport const logEvent: LogHandler = (log: Log, ...args: any[]): void => {\n\tlogger.dispatchEvent(\n\t\tnew CustomEvent(logEventType, {\n\t\t\tdetail: {\n\t\t\t\tlog,\n\t\t\t\targs,\n\t\t\t},\n\t\t})\n\t);\n};\n","import { LogHandler } from '../log-handlers';\nimport { Log, prepareLogMessage } from '../logger';\n\n/**\n * Log message to the console.\n */\nexport const logToConsole: LogHandler = (log: Log, ...args: any[]): void => {\n\tif (typeof log.message === 'string') {\n\t\t// Some errors have a read-only message property where direct\n\t\t// assignment will throw an error. The assignment is merely for\n\t\t// formatting, so let's assign with Reflect.set and avoid the error.\n\t\tReflect.set(log, 'message', prepareLogMessage(log.message));\n\t} else if (log.message.message && typeof log.message.message === 'string') {\n\t\t// Some errors have a read-only message property where direct\n\t\t// assignment will throw an error. The assignment is merely for\n\t\t// formatting, so let's assign with Reflect.set and avoid the error.\n\t\tReflect.set(\n\t\t\tlog.message,\n\t\t\t'message',\n\t\t\tprepareLogMessage(log.message.message)\n\t\t);\n\t}\n\t/* eslint-disable no-console */\n\tswitch (log.severity) {\n\t\tcase 'Debug':\n\t\t\tconsole.debug(log.message, ...args);\n\t\t\tbreak;\n\t\tcase 'Info':\n\t\t\tconsole.info(log.message, ...args);\n\t\t\tbreak;\n\t\tcase 'Warn':\n\t\t\tconsole.warn(log.message, ...args);\n\t\t\tbreak;\n\t\tcase 'Error':\n\t\t\tconsole.error(log.message, ...args);\n\t\t\tbreak;\n\t\tcase 'Fatal':\n\t\t\tconsole.error(log.message, ...args);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tconsole.log(log.message, ...args);\n\t}\n\t/* eslint-enable no-console */\n};\n","import { LogHandler } from '../log-handlers';\nimport { formatLogEntry, Log } from '../logger';\n\nconst prepareLogMessage = (logMessage: object): string => {\n\tif (logMessage instanceof Error) {\n\t\treturn [logMessage.message, logMessage.stack].join('\\n');\n\t}\n\treturn JSON.stringify(logMessage, null, 2);\n};\n\nexport const logs: string[] = [];\n\nconst addToLogArray = (message: string): void => {\n\tlogs.push(message);\n};\n\n/**\n * Log to memory\n */\nexport const logToMemory: LogHandler = (log: Log): void => {\n\tif (log.raw === true) {\n\t\taddToLogArray(log.message);\n\t} else {\n\t\tconst message = formatLogEntry(\n\t\t\ttypeof log.message === 'object'\n\t\t\t\t? prepareLogMessage(log.message)\n\t\t\t\t: log.message,\n\t\t\tlog.severity ?? 'Info',\n\t\t\tlog.prefix ?? 'JavaScript'\n\t\t);\n\t\taddToLogArray(message);\n\t}\n};\n\nexport const clearMemoryLogs = (): void => {\n\tlogs.length = 0;\n};\n","import { logEvent } from './handlers/log-event';\nimport { logToMemory, logToConsole, logs } from './log-handlers';\n\nexport { logEventType } from './handlers/log-event';\n\nexport { errorLogPath } from './collectors/collect-php-logs';\n\nexport type Log = {\n\tmessage: any;\n\tseverity?: LogSeverity;\n\tprefix?: LogPrefix;\n\traw?: boolean;\n};\n\n/**\n * Log severity levels.\n */\nexport type LogSeverity = 'Debug' | 'Info' | 'Warn' | 'Error' | 'Fatal';\n\n/**\n * Log prefix.\n */\nexport type LogPrefix = 'WASM Crash' | 'PHP' | 'JavaScript';\n\n/**\n * A logger for Playground.\n */\nexport class Logger extends EventTarget {\n\tpublic readonly fatalErrorEvent = 'playground-fatal-error';\n\n\t// constructor\n\tconstructor(\n\t\t// Log handlers\n\t\tprivate readonly handlers: Function[] = []\n\t) {\n\t\tsuper();\n\t}\n\n\t/**\n\t * Get all logs.\n\t * @returns string[]\n\t */\n\tpublic getLogs(): string[] {\n\t\tif (!this.handlers.includes(logToMemory)) {\n\t\t\tthis\n\t\t\t\t.error(`Logs aren't stored because the logToMemory handler isn't registered.\n\t\t\t\tIf you're using a custom logger instance, make sure to register logToMemory handler.\n\t\t\t`);\n\t\t\treturn [];\n\t\t}\n\t\treturn [...logs];\n\t}\n\n\t/**\n\t * Log message with severity.\n\t *\n\t * @param message any\n\t * @param severity LogSeverity\n\t * @param raw boolean\n\t * @param args any\n\t */\n\tpublic logMessage(log: Log, ...args: any[]): void {\n\t\tfor (const handler of this.handlers) {\n\t\t\thandler(log, ...args);\n\t\t}\n\t}\n\n\t/**\n\t * Log message\n\t *\n\t * @param message any\n\t * @param args any\n\t */\n\tpublic log(message: any, ...args: any[]): void {\n\t\tthis.logMessage(\n\t\t\t{\n\t\t\t\tmessage,\n\t\t\t\tseverity: undefined,\n\t\t\t\tprefix: 'JavaScript',\n\t\t\t\traw: false,\n\t\t\t},\n\t\t\t...args\n\t\t);\n\t}\n\n\t/**\n\t * Log debug message\n\t *\n\t * @param message any\n\t * @param args any\n\t */\n\tpublic debug(message: any, ...args: any[]): void {\n\t\tthis.logMessage(\n\t\t\t{\n\t\t\t\tmessage,\n\t\t\t\tseverity: 'Debug',\n\t\t\t\tprefix: 'JavaScript',\n\t\t\t\traw: false,\n\t\t\t},\n\t\t\t...args\n\t\t);\n\t}\n\n\t/**\n\t * Log info message\n\t *\n\t * @param message any\n\t * @param args any\n\t */\n\tpublic info(message: any, ...args: any[]): void {\n\t\tthis.logMessage(\n\t\t\t{\n\t\t\t\tmessage,\n\t\t\t\tseverity: 'Info',\n\t\t\t\tprefix: 'JavaScript',\n\t\t\t\traw: false,\n\t\t\t},\n\t\t\t...args\n\t\t);\n\t}\n\n\t/**\n\t * Log warning message\n\t *\n\t * @param message any\n\t * @param args any\n\t */\n\tpublic warn(message: any, ...args: any[]): void {\n\t\tthis.logMessage(\n\t\t\t{\n\t\t\t\tmessage,\n\t\t\t\tseverity: 'Warn',\n\t\t\t\tprefix: 'JavaScript',\n\t\t\t\traw: false,\n\t\t\t},\n\t\t\t...args\n\t\t);\n\t}\n\n\t/**\n\t * Log error message\n\t *\n\t * @param message any\n\t * @param args any\n\t */\n\tpublic error(message: any, ...args: any[]): void {\n\t\tthis.logMessage(\n\t\t\t{\n\t\t\t\tmessage,\n\t\t\t\tseverity: 'Error',\n\t\t\t\tprefix: 'JavaScript',\n\t\t\t\traw: false,\n\t\t\t},\n\t\t\t...args\n\t\t);\n\t}\n}\n\nconst getDefaultHandlers = () => {\n\ttry {\n\t\tif (process.env['NODE_ENV'] === 'test') {\n\t\t\treturn [logToMemory, logEvent];\n\t\t}\n\t} catch (e) {\n\t\t// Process.env is not available in the browser\n\t}\n\treturn [logToMemory, logToConsole, logEvent];\n};\n\n/**\n * The logger instance.\n */\nexport const logger: Logger = new Logger(getDefaultHandlers());\n\nexport const prepareLogMessage = (message: string) => {\n\treturn message.replace(/\\t/g, '');\n};\n\nexport const formatLogEntry = (\n\tmessage: string,\n\tseverity: LogSeverity,\n\tprefix: string\n): string => {\n\tconst date = new Date();\n\tconst formattedDate = new Intl.DateTimeFormat('en-GB', {\n\t\tyear: 'numeric',\n\t\tmonth: 'short',\n\t\tday: '2-digit',\n\t\ttimeZone: 'UTC',\n\t})\n\t\t.format(date)\n\t\t.replace(/ /g, '-');\n\n\tconst formattedTime = new Intl.DateTimeFormat('en-GB', {\n\t\thour: '2-digit',\n\t\tminute: '2-digit',\n\t\tsecond: '2-digit',\n\t\thour12: false,\n\t\ttimeZone: 'UTC',\n\t\ttimeZoneName: 'short',\n\t}).format(date);\n\tconst now = formattedDate + ' ' + formattedTime;\n\tmessage = prepareLogMessage(message);\n\treturn `[${now}] ${prefix} ${severity}: ${message}`;\n};\n\n/**\n * Add a listener for the Playground crashes.\n * These crashes include Playground errors like Asyncify errors.\n * The callback function will receive an Event object with logs in the detail\n * property.\n *\n * @param loggerInstance The logger instance\n * @param callback The callback function\n */\nexport const addCrashListener = (\n\tloggerInstance: Logger,\n\tcallback: EventListenerOrEventListenerObject\n) => {\n\tloggerInstance.addEventListener(loggerInstance.fatalErrorEvent, callback);\n};\n","export const SleepFinished = Symbol('SleepFinished');\n\nexport function sleep(ms: number): Promise<typeof SleepFinished> {\n\treturn new Promise((resolve) => {\n\t\tsetTimeout(() => resolve(SleepFinished), ms);\n\t});\n}\n","import { SleepFinished, sleep } from './sleep';\n\nexport interface SemaphoreOptions {\n\t/**\n\t * The maximum number of concurrent locks.\n\t */\n\tconcurrency: number;\n\t/**\n\t * The maximum time to wait for a lock to become available.\n\t */\n\ttimeout?: number;\n}\n\nexport class AcquireTimeoutError extends Error {\n\tconstructor() {\n\t\tsuper('Acquiring lock timed out');\n\t}\n}\n\nexport default class Semaphore {\n\tprivate _running = 0;\n\tprivate concurrency: number;\n\tprivate timeout?: number;\n\tprivate queue: (() => void)[];\n\n\tconstructor({ concurrency, timeout }: SemaphoreOptions) {\n\t\tthis.concurrency = concurrency;\n\t\tthis.timeout = timeout;\n\t\tthis.queue = [];\n\t}\n\n\tget remaining(): number {\n\t\treturn this.concurrency - this.running;\n\t}\n\n\tget running(): number {\n\t\treturn this._running;\n\t}\n\n\tasync acquire(): Promise<() => void> {\n\t\twhile (true) {\n\t\t\tif (this._running >= this.concurrency) {\n\t\t\t\t// Concurrency exhausted – wait until a lock is released:\n\t\t\t\tconst acquired = new Promise<void>((resolve) => {\n\t\t\t\t\tthis.queue.push(resolve);\n\t\t\t\t});\n\t\t\t\tif (this.timeout !== undefined) {\n\t\t\t\t\tawait Promise.race([acquired, sleep(this.timeout)]).then(\n\t\t\t\t\t\t(value) => {\n\t\t\t\t\t\t\tif (value === SleepFinished) {\n\t\t\t\t\t\t\t\tthrow new AcquireTimeoutError();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t);\n\t\t\t\t} else {\n\t\t\t\t\tawait acquired;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\t// Acquire the lock:\n\t\t\t\tthis._running++;\n\t\t\t\tlet released = false;\n\t\t\t\treturn () => {\n\t\t\t\t\tif (released) {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\treleased = true;\n\t\t\t\t\tthis._running--;\n\t\t\t\t\t// Release the lock:\n\t\t\t\t\tif (this.queue.length > 0) {\n\t\t\t\t\t\tthis.queue.shift()!();\n\t\t\t\t\t}\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\t}\n\n\tasync run<T>(fn: () => T | Promise<T>): Promise<T> {\n\t\tconst release = await this.acquire();\n\t\ttry {\n\t\t\treturn await fn();\n\t\t} finally {\n\t\t\trelease();\n\t\t}\n\t}\n}\n","export class PhpWasmError extends Error {\n\tconstructor(message: string, public userFriendlyMessage?: string) {\n\t\tsuper(message);\n\t\tif (!this.userFriendlyMessage) {\n\t\t\tthis.userFriendlyMessage = message;\n\t\t}\n\t}\n}\n","/**\n * The functions in this module are mostly copied from the generated\n * Emscripten PHP module. This enables features like filesystem journaling,\n * which use some low-level Emscripten APIs and need access to the\n * same path helpers.\n */\n\n/**\n * Joins paths together.\n *\n * For example:\n *\n * > joinPaths('wordpress', 'wp-content')\n * 'wordpress/wp-content'\n *\n * Use this for all PHP paths and **do not** use path.join().\n * This is important because Emscripten paths are **always**\n * POSIX-style paths. Imagine joining paths on Windows:\n *\n * > path.join('wordpress', 'wp-content')\n * '\\\\wordpress\\\\wp-content'  // invalid in PHP.wasm\n *\n * See the path.join issue for more details:\n *\n * https://github.com/WordPress/playground-tools/issues/11#issuecomment-1579074763\n *\n * @param paths Paths segments to join\n * @returns A joined path\n */\nexport function joinPaths(...paths: string[]) {\n\tfunction hasTrailingSlash(p: string) {\n\t\treturn p.substring(p.length - 1) === '/';\n\t}\n\n\tlet path = paths.join('/');\n\tconst isAbsolute = path[0] === '/';\n\tconst trailingSlash = hasTrailingSlash(path);\n\tpath = normalizePath(path);\n\tif (!path && !isAbsolute) {\n\t\tpath = '.';\n\t}\n\tif (path && trailingSlash && !hasTrailingSlash(path)) {\n\t\tpath += '/';\n\t}\n\treturn path;\n}\n\n/**\n * Returns the directory name of a path.\n *\n * @param path\n * @returns\n */\nexport function dirname(path: string) {\n\tif (path === '/') {\n\t\treturn '/';\n\t}\n\n\tpath = normalizePath(path);\n\n\tconst lastSlash = path.lastIndexOf('/');\n\tif (lastSlash === -1) {\n\t\treturn '';\n\t} else if (lastSlash === 0) {\n\t\treturn '/';\n\t}\n\treturn path.substr(0, lastSlash);\n}\n\n/**\n * Returns the last portion of a path.\n *\n * @param path - The path to extract the basename from.\n * @returns The basename of the path.\n */\nexport function basename(path: string) {\n\tif (path === '/') {\n\t\treturn '/';\n\t}\n\n\tpath = normalizePath(path);\n\n\tconst lastSlash = path.lastIndexOf('/');\n\tif (lastSlash === -1) {\n\t\treturn path;\n\t}\n\treturn path.substr(lastSlash + 1);\n}\n\n/**\n * Normalizes a path.\n *\n * For example:\n *\n * > normalizePath('wordpress/wp-content/../')\n * 'wordpress'\n *\n * @param path\n * @returns\n */\nexport function normalizePath(path: string) {\n\tconst isAbsolute = path[0] === '/';\n\tpath = normalizePathsArray(\n\t\tpath.split('/').filter((p: any) => !!p),\n\t\t!isAbsolute\n\t).join('/');\n\treturn (isAbsolute ? '/' : '') + path.replace(/\\/$/, '');\n}\n\n/**\n * Normalizes paths.\n *\n * For example:\n *\n * > normalizePathsArray(['wordpress', 'wp-content', '..', '', '.',\n * 'wp-includes']) ['wordpress', 'wp-includes']\n *\n * @param parts parts of the path to normalize\n * @param allowAboveRoot allow paths above the root\n * @returns normalized paths\n */\nexport function normalizePathsArray(parts: string[], allowAboveRoot: boolean) {\n\tlet up = 0;\n\tfor (let i = parts.length - 1; i >= 0; i--) {\n\t\tconst last = parts[i];\n\t\tif (last === '.') {\n\t\t\tparts.splice(i, 1);\n\t\t} else if (last === '..') {\n\t\t\tparts.splice(i, 1);\n\t\t\tup++;\n\t\t} else if (up) {\n\t\t\tparts.splice(i, 1);\n\t\t\tup--;\n\t\t}\n\t}\n\tif (allowAboveRoot) {\n\t\tfor (; up; up--) {\n\t\t\tparts.unshift('..');\n\t\t}\n\t}\n\treturn parts;\n}\n\n/**\n * Checks if the given parent path is an ancestor of the given child path.\n *\n * @param parent The parent path to check.\n * @param child The child path to verify against the parent.\n * @returns Whether the `parent` path is an ancestor of the `child` path.\n */\nexport function isParentOf(parent: string, child: string) {\n\tif (parent === '/') {\n\t\treturn true;\n\t}\n\tparent = normalizePath(parent);\n\tchild = normalizePath(child);\n\treturn child.startsWith(parent + '/') || child === parent;\n}\n","export function randomString(\n\tlength = 36,\n\tspecialChars = '!@#$%^&*()_+=-[]/.,<>?'\n) {\n\tconst chars =\n\t\t'0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ' +\n\t\tspecialChars;\n\tlet result = '';\n\tfor (let i = length; i > 0; --i)\n\t\tresult += chars[Math.floor(Math.random() * chars.length)];\n\treturn result;\n}\n","import { randomString } from './random-string';\n\nexport function randomFilename() {\n\treturn randomString(36, '-_');\n}\n","export function phpVar(value: unknown): string {\n\treturn `json_decode(base64_decode('${stringToBase64(\n\t\tJSON.stringify(value)\n\t)}'), true)`;\n}\n\nexport function phpVars<T extends Record<string, unknown>>(\n\tvars: T\n): Record<keyof T, string> {\n\tconst result: Record<string, string> = {};\n\tfor (const key in vars) {\n\t\tresult[key] = phpVar(vars[key]);\n\t}\n\treturn result as Record<keyof T, string>;\n}\n\nfunction stringToBase64(str: string) {\n\treturn bytesToBase64(new TextEncoder().encode(str));\n}\n\nfunction bytesToBase64(bytes: Uint8Array) {\n\tconst binString = String.fromCodePoint(...bytes);\n\treturn btoa(binString);\n}\n","import { Emscripten } from './emscripten-types';\nimport {\n\tgetEmscriptenFsError,\n\trethrowFileSystemError,\n} from './rethrow-file-system-error';\nimport { logger } from '@php-wasm/logger';\nimport { dirname, joinPaths } from '@php-wasm/util';\n\nexport interface RmDirOptions {\n\t/**\n\t * If true, recursively removes the directory and all its contents.\n\t * Default: true.\n\t */\n\trecursive?: boolean;\n}\n\nexport interface ListFilesOptions {\n\t/**\n\t * If true, prepend given folder path to all file names.\n\t * Default: false.\n\t */\n\tprependPath: boolean;\n}\n\nexport class FSHelpers {\n\t/**\n\t * Reads a file from the PHP filesystem and returns it as a string.\n\t *\n\t * @throws {@link @php-wasm/universal:ErrnoError} – If the file doesn't exist.\n\t * @param FS\n\t * @param  path - The file path to read.\n\t * @returns The file contents.\n\t */\n\t@rethrowFileSystemError('Could not read \"{path}\"')\n\tstatic readFileAsText(FS: Emscripten.RootFS, path: string) {\n\t\treturn new TextDecoder().decode(FSHelpers.readFileAsBuffer(FS, path));\n\t}\n\n\t/**\n\t * Reads a file from the PHP filesystem and returns it as an array buffer.\n\t *\n\t * @throws {@link @php-wasm/universal:ErrnoError} – If the file doesn't exist.\n\t * @param FS\n\t * @param  path - The file path to read.\n\t * @returns The file contents.\n\t */\n\t@rethrowFileSystemError('Could not read \"{path}\"')\n\tstatic readFileAsBuffer(FS: Emscripten.RootFS, path: string): Uint8Array {\n\t\treturn FS.readFile(path);\n\t}\n\n\t/**\n\t * Overwrites data in a file in the PHP filesystem.\n\t * Creates a new file if one doesn't exist yet.\n\t *\n\t * @param FS\n\t * @param  path - The file path to write to.\n\t * @param  data - The data to write to the file.\n\t */\n\t@rethrowFileSystemError('Could not write to \"{path}\"')\n\tstatic writeFile(\n\t\tFS: Emscripten.RootFS,\n\t\tpath: string,\n\t\tdata: string | Uint8Array\n\t) {\n\t\tFS.writeFile(path, data);\n\t}\n\n\t/**\n\t * Removes a file from the PHP filesystem.\n\t *\n\t * @throws {@link @php-wasm/universal:ErrnoError} – If the file doesn't exist.\n\t * @param FS\n\t * @param  path - The file path to remove.\n\t */\n\t@rethrowFileSystemError('Could not unlink \"{path}\"')\n\tstatic unlink(FS: Emscripten.RootFS, path: string) {\n\t\tFS.unlink(path);\n\t}\n\n\t/**\n\t * Moves a file or directory in the PHP filesystem to a\n\t * new location.\n\t *\n\t * @param FS\n\t * @param fromPath The path to rename.\n\t * @param toPath The new path.\n\t */\n\tstatic mv(FS: Emscripten.RootFS, fromPath: string, toPath: string) {\n\t\ttry {\n\t\t\t// FS.rename moves the inode within the same filesystem.\n\t\t\t// If fromPath and toPath are on different filesystems,\n\t\t\t// the operation will fail. In that case, we need to do\n\t\t\t// a recursive copy of all the files and remove the original.\n\t\t\t// Note this is also what happens in the linux `mv` command.\n\t\t\tconst fromMount = FS.lookupPath(fromPath).node.mount;\n\t\t\tconst toMount = FSHelpers.fileExists(FS, toPath)\n\t\t\t\t? FS.lookupPath(toPath).node.mount\n\t\t\t\t: FS.lookupPath(dirname(toPath)).node.mount;\n\t\t\tconst movingBetweenFilesystems =\n\t\t\t\tfromMount.mountpoint !== toMount.mountpoint;\n\n\t\t\tif (movingBetweenFilesystems) {\n\t\t\t\tFSHelpers.copyRecursive(FS, fromPath, toPath);\n\t\t\t\tif (FSHelpers.isDir(FS, fromPath)) {\n\t\t\t\t\tFSHelpers.rmdir(FS, fromPath, { recursive: true });\n\t\t\t\t} else {\n\t\t\t\t\tFS.unlink(fromPath);\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tFS.rename(fromPath, toPath);\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tconst errmsg = getEmscriptenFsError(e);\n\t\t\tif (!errmsg) {\n\t\t\t\tthrow e;\n\t\t\t}\n\t\t\tthrow new Error(\n\t\t\t\t`Could not move ${fromPath} to ${toPath}: ${errmsg}`,\n\t\t\t\t{\n\t\t\t\t\tcause: e,\n\t\t\t\t}\n\t\t\t);\n\t\t}\n\t}\n\n\t/**\n\t * Removes a directory from the PHP filesystem.\n\t *\n\t * @param FS\n\t * @param path The directory path to remove.\n\t * @param options Options for the removal.\n\t */\n\t@rethrowFileSystemError('Could not remove directory \"{path}\"')\n\tstatic rmdir(\n\t\tFS: Emscripten.RootFS,\n\t\tpath: string,\n\t\toptions: RmDirOptions = { recursive: true }\n\t) {\n\t\tif (options?.recursive) {\n\t\t\tFSHelpers.listFiles(FS, path).forEach((file) => {\n\t\t\t\tconst filePath = `${path}/${file}`;\n\t\t\t\tif (FSHelpers.isDir(FS, filePath)) {\n\t\t\t\t\tFSHelpers.rmdir(FS, filePath, options);\n\t\t\t\t} else {\n\t\t\t\t\tFSHelpers.unlink(FS, filePath);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t\tFS.rmdir(path);\n\t}\n\n\t/**\n\t * Lists the files and directories in the given directory.\n\t *\n\t * @param FS\n\t * @param  path - The directory path to list.\n\t * @param  options - Options for the listing.\n\t * @returns The list of files and directories in the given directory.\n\t */\n\t@rethrowFileSystemError('Could not list files in \"{path}\"')\n\tstatic listFiles(\n\t\tFS: Emscripten.RootFS,\n\t\tpath: string,\n\t\toptions: ListFilesOptions = { prependPath: false }\n\t): string[] {\n\t\tif (!FSHelpers.fileExists(FS, path)) {\n\t\t\treturn [];\n\t\t}\n\t\ttry {\n\t\t\tconst files = FS.readdir(path).filter(\n\t\t\t\t(name: string) => name !== '.' && name !== '..'\n\t\t\t);\n\t\t\tif (options.prependPath) {\n\t\t\t\tconst prepend = path.replace(/\\/$/, '');\n\t\t\t\treturn files.map((name: string) => `${prepend}/${name}`);\n\t\t\t}\n\t\t\treturn files;\n\t\t} catch (e) {\n\t\t\tlogger.error(e, { path });\n\t\t\treturn [];\n\t\t}\n\t}\n\n\t/**\n\t * Checks if a directory exists in the PHP filesystem.\n\t *\n\t * @param FS\n\t * @param  path – The path to check.\n\t * @returns True if the path is a directory, false otherwise.\n\t */\n\t@rethrowFileSystemError('Could not stat \"{path}\"')\n\tstatic isDir(FS: Emscripten.RootFS, path: string): boolean {\n\t\tif (!FSHelpers.fileExists(FS, path)) {\n\t\t\treturn false;\n\t\t}\n\t\treturn FS.isDir(FS.lookupPath(path, { follow: true }).node.mode);\n\t}\n\n\t/**\n\t * Checks if a file exists in the PHP filesystem.\n\t *\n\t * @param FS\n\t * @param  path – The path to check.\n\t * @returns True if the path is a file, false otherwise.\n\t */\n\t@rethrowFileSystemError('Could not stat \"{path}\"')\n\tstatic isFile(FS: Emscripten.RootFS, path: string): boolean {\n\t\tif (!FSHelpers.fileExists(FS, path)) {\n\t\t\treturn false;\n\t\t}\n\t\treturn FS.isFile(FS.lookupPath(path, { follow: true }).node.mode);\n\t}\n\n\t/**\n\t * Creates a symlink in the PHP filesystem.\n\t *\n\t * @param FS\n\t * @param target\n\t * @param link\n\t */\n\tstatic symlink(FS: Emscripten.RootFS, target: string, link: string): any {\n\t\treturn FS.symlink(target, link);\n\t}\n\n\t/**\n\t * Checks if a path is a symlink in the PHP filesystem.\n\t *\n\t * @param FS\n\t * @param path\n\t * @returns True if the path is a symlink, false otherwise.\n\t */\n\tstatic isSymlink(FS: Emscripten.RootFS, path: string): boolean {\n\t\tif (!FSHelpers.fileExists(FS, path)) {\n\t\t\treturn false;\n\t\t}\n\n\t\treturn FS.isLink(FS.lookupPath(path).node.mode);\n\t}\n\n\t/**\n\t * Reads the target of a symlink in the PHP filesystem.\n\t * @param FS\n\t * @param path\n\t * @returns The target of the symlink.\n\t * @throws {@link @php-wasm/universal:ErrnoError} – If the path is not a symlink.\n\t */\n\tstatic readlink(FS: Emscripten.RootFS, path: string): string {\n\t\treturn FS.readlink(path);\n\t}\n\n\t/**\n\t * Gets the real path of a file in the PHP filesystem.\n\t * @param FS\n\t * @param path\n\t *\n\t * @returns The real path of the file.\n\t */\n\t@rethrowFileSystemError('Could not stat \"{path}\"')\n\tstatic realpath(FS: Emscripten.RootFS, path: string): string {\n\t\treturn FS.lookupPath(path, { follow: true }).path;\n\t}\n\n\t/**\n\t * Checks if a file (or a directory) exists in the PHP filesystem.\n\t *\n\t * @param FS\n\t * @param  path - The file path to check.\n\t * @returns True if the file exists, false otherwise.\n\t */\n\t@rethrowFileSystemError('Could not stat \"{path}\"')\n\tstatic fileExists(FS: Emscripten.RootFS, path: string): boolean {\n\t\ttry {\n\t\t\tFS.lookupPath(path);\n\t\t\treturn true;\n\t\t} catch (e) {\n\t\t\treturn false;\n\t\t}\n\t}\n\n\t/**\n\t * Recursively creates a directory with the given path in the PHP filesystem.\n\t * For example, if the path is `/root/php/data`, and `/root` already exists,\n\t * it will create the directories `/root/php` and `/root/php/data`.\n\t *\n\t * @param FS\n\t * @param  path - The directory path to create.\n\t */\n\t@rethrowFileSystemError('Could not create directory \"{path}\"')\n\tstatic mkdir(FS: Emscripten.RootFS, path: string) {\n\t\tFS.mkdirTree(path);\n\t}\n\n\t@rethrowFileSystemError('Could not copy files from \"{path}\"')\n\tstatic copyRecursive(\n\t\tFS: Emscripten.FileSystemInstance,\n\t\tfromPath: string,\n\t\ttoPath: string\n\t) {\n\t\tconst fromNode = FS.lookupPath(fromPath).node;\n\t\tif (FS.isDir(fromNode.mode)) {\n\t\t\tFS.mkdirTree(toPath);\n\t\t\tconst filenames = FS.readdir(fromPath).filter(\n\t\t\t\t(name: string) => name !== '.' && name !== '..'\n\t\t\t);\n\t\t\tfor (const filename of filenames) {\n\t\t\t\tFSHelpers.copyRecursive(\n\t\t\t\t\tFS,\n\t\t\t\t\tjoinPaths(fromPath, filename),\n\t\t\t\t\tjoinPaths(toPath, filename)\n\t\t\t\t);\n\t\t\t}\n\t\t} else {\n\t\t\tFS.writeFile(toPath, FS.readFile(fromPath));\n\t\t}\n\t}\n}\n","/*\n * This type is used in Comlink.transferHandlers.set('PHPResponse', { ... })\n * so be sure to update that if you change this type.\n */\nexport interface PHPResponseData {\n\t/**\n\t * Response headers.\n\t */\n\treadonly headers: Record<string, string[]>;\n\n\t/**\n\t * Response body. Contains the output from `echo`,\n\t * `print`, inline HTML etc.\n\t */\n\treadonly bytes: ArrayBuffer;\n\n\t/**\n\t * Stderr contents, if any.\n\t */\n\treadonly errors: string;\n\n\t/**\n\t * The exit code of the script. `0` is a success, while\n\t * `1` and `2` indicate an error.\n\t */\n\treadonly exitCode: number;\n\n\t/**\n\t * Response HTTP status code, e.g. 200.\n\t */\n\treadonly httpStatusCode: number;\n}\n\nconst responseTexts: Record<number, string> = {\n\t500: 'Internal Server Error',\n\t502: 'Bad Gateway',\n\t404: 'Not Found',\n\t403: 'Forbidden',\n\t401: 'Unauthorized',\n\t400: 'Bad Request',\n\t301: 'Moved Permanently',\n\t302: 'Found',\n\t307: 'Temporary Redirect',\n\t308: 'Permanent Redirect',\n\t204: 'No Content',\n\t201: 'Created',\n\t200: 'OK',\n};\n\n/**\n * PHP response. Body is an `ArrayBuffer` because it can\n * contain binary data.\n *\n * This type is used in Comlink.transferHandlers.set('PHPResponse', \\{ ... \\})\n * so be sure to update that if you change this type.\n */\nexport class PHPResponse implements PHPResponseData {\n\t/** @inheritDoc */\n\treadonly headers: Record<string, string[]>;\n\n\t/** @inheritDoc */\n\treadonly bytes: ArrayBuffer;\n\n\t/** @inheritDoc */\n\treadonly errors: string;\n\n\t/** @inheritDoc */\n\treadonly exitCode: number;\n\n\t/** @inheritDoc */\n\treadonly httpStatusCode: number;\n\n\tconstructor(\n\t\thttpStatusCode: number,\n\t\theaders: Record<string, string[]>,\n\t\tbody: ArrayBuffer,\n\t\terrors = '',\n\t\texitCode = 0\n\t) {\n\t\tthis.httpStatusCode = httpStatusCode;\n\t\tthis.headers = headers;\n\t\tthis.bytes = body;\n\t\tthis.exitCode = exitCode;\n\t\tthis.errors = errors;\n\t}\n\n\tstatic forHttpCode(httpStatusCode: number, text = '') {\n\t\treturn new PHPResponse(\n\t\t\thttpStatusCode,\n\t\t\t{},\n\t\t\tnew TextEncoder().encode(\n\t\t\t\ttext || responseTexts[httpStatusCode] || ''\n\t\t\t)\n\t\t);\n\t}\n\n\tstatic fromRawData(data: PHPResponseData): PHPResponse {\n\t\treturn new PHPResponse(\n\t\t\tdata.httpStatusCode,\n\t\t\tdata.headers,\n\t\t\tdata.bytes,\n\t\t\tdata.errors,\n\t\t\tdata.exitCode\n\t\t);\n\t}\n\n\ttoRawData(): PHPResponseData {\n\t\treturn {\n\t\t\theaders: this.headers,\n\t\t\tbytes: this.bytes,\n\t\t\terrors: this.errors,\n\t\t\texitCode: this.exitCode,\n\t\t\thttpStatusCode: this.httpStatusCode,\n\t\t};\n\t}\n\n\t/**\n\t * Response body as JSON.\n\t */\n\tget json() {\n\t\treturn JSON.parse(this.text);\n\t}\n\n\t/**\n\t * Response body as text.\n\t */\n\tget text() {\n\t\treturn new TextDecoder().decode(this.bytes);\n\t}\n}\n","import { logger } from '@php-wasm/logger';\nimport { IncomingMessage, Server, ServerResponse } from 'http';\n\nconst RuntimeId = Symbol('RuntimeId');\nconst loadedRuntimes: Map<number, PHPRuntime> = new Map();\nlet lastRuntimeId = 0;\n\n/**\n * Loads the PHP runtime with the given arguments and data dependencies.\n *\n * This function handles the entire PHP initialization pipeline. In particular,\n * it:\n *\n * * Instantiates the Emscripten PHP module\n * * Wires it together with the data dependencies and loads them\n * * Ensures is all happens in a correct order\n * * Waits until the entire loading sequence is finished\n *\n * Basic usage:\n *\n * ```js\n *  const phpLoaderModule = await getPHPLoaderModule(\"7.4\");\n *  const php = await loadPHPRuntime( phpLoaderModule );\n *  console.log(php.run(`<?php echo \"Hello, world!\"; `));\n *  // { stdout: ArrayBuffer containing the string \"Hello, world!\", stderr: [''], exitCode: 0 }\n * ```\n *\n * **The PHP loader module:**\n *\n * In the basic usage example, `phpLoaderModule` is **not** a vanilla\n * Emscripten module. Instead, it's an ESM module that wraps the regular\n * Emscripten output and adds some extra functionality. It's generated by the\n * Dockerfile shipped with this repo. Here's the API it provides:\n *\n * ```js\n * // php.wasm size in bytes:\n * export const dependenciesTotalSize = 5644199;\n *\n * // php.wasm filename:\n * export const dependencyFilename = 'php.wasm';\n *\n * // Run Emscripten's generated module:\n * export default function(jsEnv, emscriptenModuleArgs) {}\n * ```\n *\n * **PHP Filesystem:**\n *\n * Once initialized, the PHP has its own filesystem separate from the project\n * files. It's provided by [Emscripten and uses its FS library](https://emscripten.org/docs/api_reference/Filesystem-API.html).\n *\n * The API exposed to you via the PHP class is succinct and abstracts\n * certain unintuitive parts of low-level filesystem interactions.\n *\n * Here's how to use it:\n *\n * ```js\n * // Recursively create a /var/www directory\n * php.mkdirTree('/var/www');\n *\n * console.log(php.fileExists('/var/www/file.txt'));\n * // false\n *\n * php.writeFile('/var/www/file.txt', 'Hello from the filesystem!');\n *\n * console.log(php.fileExists('/var/www/file.txt'));\n * // true\n *\n * console.log(php.readFile('/var/www/file.txt'));\n * // \"Hello from the filesystem!\n *\n * // Delete the file:\n * php.unlink('/var/www/file.txt');\n * ```\n *\n * For more details consult the PHP class directly.\n *\n * **Data dependencies:**\n *\n * Using existing PHP packages by manually recreating them file-by-file would\n * be quite inconvenient. Fortunately, Emscripten provides a \"data dependencies\"\n * feature.\n *\n * Data dependencies consist of a `dependency.data` file and a `dependency.js`\n * loader and can be packaged with the [file_packager.py tool](\n * https://emscripten.org/docs/porting/files/packaging_files.html#packaging-using-the-file-packager-tool).\n * This project requires wrapping the Emscripten-generated `dependency.js` file\n * in an ES module as follows:\n *\n * 1. Prepend `export default function(emscriptenPHPModule) {'; `\n * 2. Prepend `export const dependencyFilename = '<DATA FILE NAME>'; `\n * 3. Prepend `export const dependenciesTotalSize = <DATA FILE SIZE>;`\n * 4. Append `}`\n *\n * Be sure to use the `--export-name=\"emscriptenPHPModule\"` file_packager.py\n * option.\n *\n * You want the final output to look as follows:\n *\n * ```js\n * export const dependenciesTotalSize = 5644199;\n * export const dependencyFilename = 'dependency.data';\n * export default function(emscriptenPHPModule) {\n *    // Emscripten-generated code:\n *    var Module = typeof emscriptenPHPModule !== 'undefined' ? emscriptenPHPModule : {};\n *    // ... the rest of it ...\n * }\n * ```\n *\n * Such a constructions enables loading the `dependency.js` as an ES Module\n * using `import(\"/dependency.js\")`.\n *\n * Once it's ready, you can load PHP and your data dependencies as follows:\n *\n * ```js\n *  const [phpLoaderModule, wordPressLoaderModule] = await Promise.all([\n *    getPHPLoaderModule(\"7.4\"),\n *    import(\"/wp.js\")\n *  ]);\n *  const php = await loadPHPRuntime(phpLoaderModule, {}, [wordPressLoaderModule]);\n * ```\n *\n * @public\n * @param  phpLoaderModule         - The ESM-wrapped Emscripten module. Consult the Dockerfile for the build process.\n * @param  phpModuleArgs           - The Emscripten module arguments, see https://emscripten.org/docs/api_reference/module.html#affecting-execution.\n * @returns Loaded runtime id.\n */\n\nexport async function loadPHPRuntime(\n\tphpLoaderModule: PHPLoaderModule,\n\tphpModuleArgs: EmscriptenOptions = {}\n): Promise<number> {\n\tconst [phpReady, resolvePHP, rejectPHP] = makePromise();\n\n\tconst PHPRuntime = phpLoaderModule.init(currentJsRuntime, {\n\t\tonAbort(reason) {\n\t\t\trejectPHP(reason);\n\t\t\t// This can happen after PHP has been initialized so\n\t\t\t// let's just log it.\n\t\t\tlogger.error(reason);\n\t\t},\n\t\tENV: {},\n\t\t// Emscripten sometimes prepends a '/' to the path, which\n\t\t// breaks vite dev mode. An identity `locateFile` function\n\t\t// fixes it.\n\t\tlocateFile: (path) => path,\n\t\t...phpModuleArgs,\n\t\tnoInitialRun: true,\n\t\tonRuntimeInitialized() {\n\t\t\tif (phpModuleArgs.onRuntimeInitialized) {\n\t\t\t\tphpModuleArgs.onRuntimeInitialized();\n\t\t\t}\n\t\t\tresolvePHP();\n\t\t},\n\t});\n\n\tawait phpReady;\n\n\tconst id = ++lastRuntimeId;\n\n\tPHPRuntime.FS;\n\tPHPRuntime.id = id;\n\tPHPRuntime.originalExit = PHPRuntime._exit;\n\n\tPHPRuntime._exit = function (code: number) {\n\t\tif (PHPRuntime.outboundNetworkProxyServer) {\n\t\t\tPHPRuntime.outboundNetworkProxyServer.close();\n\t\t\tPHPRuntime.outboundNetworkProxyServer.closeAllConnections();\n\t\t}\n\t\tloadedRuntimes.delete(id);\n\t\treturn PHPRuntime.originalExit(code);\n\t};\n\n\tPHPRuntime[RuntimeId] = id;\n\tloadedRuntimes.set(id, PHPRuntime);\n\treturn id;\n}\n\nexport type RuntimeType = 'NODE' | 'WEB' | 'WORKER';\n\ndeclare const self: WindowOrWorkerGlobalScope;\ndeclare const WorkerGlobalScope: object | undefined;\n\nexport type PHPRuntimeId = number;\n\nexport function getLoadedRuntime(id: PHPRuntimeId): PHPRuntime {\n\treturn loadedRuntimes.get(id);\n}\n\nexport const currentJsRuntime = (function () {\n\tif (typeof process !== 'undefined' && process.release?.name === 'node') {\n\t\treturn 'NODE';\n\t} else if (typeof window !== 'undefined') {\n\t\treturn 'WEB';\n\t} else if (\n\t\ttypeof WorkerGlobalScope !== 'undefined' &&\n\t\tself instanceof (WorkerGlobalScope as any)\n\t) {\n\t\treturn 'WORKER';\n\t} else {\n\t\treturn 'NODE';\n\t}\n})();\n\n/**\n * Creates and exposes Promise resolve/reject methods for later use.\n */\nconst makePromise = () => {\n\tconst methods: any = [];\n\n\tconst promise = new Promise((resolve, reject) => {\n\t\tmethods.push(resolve, reject);\n\t});\n\tmethods.unshift(promise);\n\n\treturn methods as [Promise<any>, (v?: any) => void, (e?: any) => void];\n};\n\nexport type PHPRuntime = any;\n\nexport type PHPLoaderModule = {\n\tdependencyFilename: string;\n\tdependenciesTotalSize: number;\n\tinit: (jsRuntime: string, options: EmscriptenOptions) => PHPRuntime;\n};\n\nexport type DataModule = {\n\tdependencyFilename: string;\n\tdependenciesTotalSize: number;\n\tdefault: (phpRuntime: PHPRuntime) => void;\n};\n\nexport type EmscriptenOptions = {\n\tonAbort?: (message: string) => void;\n\t/**\n\t * Set to true for debugging tricky WebAssembly errors.\n\t */\n\tdebug?: boolean;\n\tENV?: Record<string, string>;\n\tlocateFile?: (path: string) => string;\n\tnoInitialRun?: boolean;\n\tprint?: (message: string) => void;\n\tprintErr?: (message: string) => void;\n\tquit?: (status: number, toThrow: any) => void;\n\tonRuntimeInitialized?: () => void;\n\tmonitorRunDependencies?: (left: number) => void;\n\tonMessage?: (listener: EmscriptenMessageListener) => void;\n\toutboundNetworkProxyServer?: Server<\n\t\ttypeof IncomingMessage,\n\t\ttypeof ServerResponse\n\t>;\n\tinstantiateWasm?: (\n\t\tinfo: WebAssembly.Imports,\n\t\treceiveInstance: (\n\t\t\tinstance: WebAssembly.Instance,\n\t\t\tmodule: WebAssembly.Module\n\t\t) => void\n\t) => void;\n} & Record<string, any>;\n\nexport type EmscriptenMessageListener = (type: string, data: string) => void;\n","/**\n * Polyfill for ReadableStream[Symbol.asyncIterator]\n * This enables the use of for-await-of loops with ReadableStreams\n *\n * @example\n * ```ts\n * for await (const entry of stream) {\n * \t   // ...\n * }\n * ```\n */\n// @ts-ignore\nif (!ReadableStream.prototype[Symbol.asyncIterator]) {\n\t// @ts-ignore\n\tReadableStream.prototype[Symbol.asyncIterator] = async function* () {\n\t\tconst reader = this.getReader();\n\t\ttry {\n\t\t\twhile (true) {\n\t\t\t\tconst { done, value } = await reader.read();\n\t\t\t\tif (done) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tyield value;\n\t\t\t}\n\t\t} finally {\n\t\t\treader.releaseLock();\n\t\t}\n\t};\n\t// @ts-ignore\n\tReadableStream.prototype.iterate =\n\t\t// @ts-ignore\n\t\tReadableStream.prototype[Symbol.asyncIterator];\n}\n\nexport type IterableReadableStream<R> = ReadableStream<R> & AsyncIterable<R>;\n","import { dirname, joinPaths } from '@php-wasm/util';\nimport { UniversalPHP } from './universal-php';\n\nexport interface WriteFilesOptions {\n\t/**\n\t * Whether to wipe out the contents of the\n\t * root directory before writing the new files.\n\t */\n\trmRoot?: boolean;\n}\n\nexport interface FileTree\n\textends Record<string, Uint8Array | string | FileTree> {}\n\n/**\n * Writes multiple files to a specified directory in the Playground\n * filesystem.\n *\n * @example ```ts\n * await writeFiles(php, '/test', {\n * \t'file.txt': 'file',\n * \t'sub/file.txt': 'file',\n * \t'sub1/sub2/file.txt': 'file',\n * });\n * ```\n *\n * @param php\n * @param root\n * @param newFiles\n * @param options\n */\nexport async function writeFiles(\n\tphp: UniversalPHP,\n\troot: string,\n\tnewFiles: FileTree,\n\t{ rmRoot = false }: WriteFilesOptions = {}\n) {\n\tif (rmRoot) {\n\t\tif (await php.isDir(root)) {\n\t\t\tawait php.rmdir(root, { recursive: true });\n\t\t}\n\t}\n\tfor (const [relativePath, content] of Object.entries(newFiles)) {\n\t\tconst filePath = joinPaths(root, relativePath);\n\t\tif (!(await php.fileExists(dirname(filePath)))) {\n\t\t\tawait php.mkdir(dirname(filePath));\n\t\t}\n\t\tif (content instanceof Uint8Array || typeof content === 'string') {\n\t\t\tawait php.writeFile(filePath, content);\n\t\t} else {\n\t\t\tawait writeFiles(php, filePath, content);\n\t\t}\n\t}\n}\n","/**\n * @license\n * Copyright 2019 Google LLC\n * SPDX-License-Identifier: Apache-2.0\n */\nconst proxyMarker = Symbol(\"Comlink.proxy\");\nconst createEndpoint = Symbol(\"Comlink.endpoint\");\nconst releaseProxy = Symbol(\"Comlink.releaseProxy\");\nconst finalizer = Symbol(\"Comlink.finalizer\");\nconst throwMarker = Symbol(\"Comlink.thrown\");\nconst isObject = (val) => (typeof val === \"object\" && val !== null) || typeof val === \"function\";\n/**\n * Internal transfer handle to handle objects marked to proxy.\n */\nconst proxyTransferHandler = {\n    canHandle: (val) => isObject(val) && val[proxyMarker],\n    serialize(obj) {\n        const { port1, port2 } = new MessageChannel();\n        expose(obj, port1);\n        return [port2, [port2]];\n    },\n    deserialize(port) {\n        port.start();\n        return wrap(port);\n    },\n};\n/**\n * Internal transfer handler to handle thrown exceptions.\n */\nconst throwTransferHandler = {\n    canHandle: (value) => isObject(value) && throwMarker in value,\n    serialize({ value }) {\n        let serialized;\n        if (value instanceof Error) {\n            serialized = {\n                isError: true,\n                value: {\n                    message: value.message,\n                    name: value.name,\n                    stack: value.stack,\n                },\n            };\n        }\n        else {\n            serialized = { isError: false, value };\n        }\n        return [serialized, []];\n    },\n    deserialize(serialized) {\n        if (serialized.isError) {\n            throw Object.assign(new Error(serialized.value.message), serialized.value);\n        }\n        throw serialized.value;\n    },\n};\n/**\n * Allows customizing the serialization of certain values.\n */\nconst transferHandlers = new Map([\n    [\"proxy\", proxyTransferHandler],\n    [\"throw\", throwTransferHandler],\n]);\nfunction isAllowedOrigin(allowedOrigins, origin) {\n    for (const allowedOrigin of allowedOrigins) {\n        if (origin === allowedOrigin || allowedOrigin === \"*\") {\n            return true;\n        }\n        if (allowedOrigin instanceof RegExp && allowedOrigin.test(origin)) {\n            return true;\n        }\n    }\n    return false;\n}\nfunction expose(obj, ep = globalThis, allowedOrigins = [\"*\"]) {\n    ep.addEventListener(\"message\", function callback(ev) {\n        if (!ev || !ev.data) {\n            return;\n        }\n        if (!isAllowedOrigin(allowedOrigins, ev.origin)) {\n            console.warn(`Invalid origin '${ev.origin}' for comlink proxy`);\n            return;\n        }\n        const { id, type, path } = Object.assign({ path: [] }, ev.data);\n        const argumentList = (ev.data.argumentList || []).map(fromWireValue);\n        let returnValue;\n        try {\n            const parent = path.slice(0, -1).reduce((obj, prop) => obj[prop], obj);\n            const rawValue = path.reduce((obj, prop) => obj[prop], obj);\n            switch (type) {\n                case \"GET\" /* MessageType.GET */:\n                    {\n                        returnValue = rawValue;\n                    }\n                    break;\n                case \"SET\" /* MessageType.SET */:\n                    {\n                        parent[path.slice(-1)[0]] = fromWireValue(ev.data.value);\n                        returnValue = true;\n                    }\n                    break;\n                case \"APPLY\" /* MessageType.APPLY */:\n                    {\n                        returnValue = rawValue.apply(parent, argumentList);\n                    }\n                    break;\n                case \"CONSTRUCT\" /* MessageType.CONSTRUCT */:\n                    {\n                        const value = new rawValue(...argumentList);\n                        returnValue = proxy(value);\n                    }\n                    break;\n                case \"ENDPOINT\" /* MessageType.ENDPOINT */:\n                    {\n                        const { port1, port2 } = new MessageChannel();\n                        expose(obj, port2);\n                        returnValue = transfer(port1, [port1]);\n                    }\n                    break;\n                case \"RELEASE\" /* MessageType.RELEASE */:\n                    {\n                        returnValue = undefined;\n                    }\n                    break;\n                default:\n                    return;\n            }\n        }\n        catch (value) {\n            returnValue = { value, [throwMarker]: 0 };\n        }\n        Promise.resolve(returnValue)\n            .catch((value) => {\n            return { value, [throwMarker]: 0 };\n        })\n            .then((returnValue) => {\n            const [wireValue, transferables] = toWireValue(returnValue);\n            ep.postMessage(Object.assign(Object.assign({}, wireValue), { id }), transferables);\n            if (type === \"RELEASE\" /* MessageType.RELEASE */) {\n                // detach and deactive after sending release response above.\n                ep.removeEventListener(\"message\", callback);\n                closeEndPoint(ep);\n                if (finalizer in obj && typeof obj[finalizer] === \"function\") {\n                    obj[finalizer]();\n                }\n            }\n        })\n            .catch((error) => {\n            // Send Serialization Error To Caller\n            const [wireValue, transferables] = toWireValue({\n                value: new TypeError(\"Unserializable return value\"),\n                [throwMarker]: 0,\n            });\n            ep.postMessage(Object.assign(Object.assign({}, wireValue), { id }), transferables);\n        });\n    });\n    if (ep.start) {\n        ep.start();\n    }\n}\nfunction isMessagePort(endpoint) {\n    return endpoint.constructor.name === \"MessagePort\";\n}\nfunction closeEndPoint(endpoint) {\n    if (isMessagePort(endpoint))\n        endpoint.close();\n}\nfunction wrap(ep, target) {\n    return createProxy(ep, [], target);\n}\nfunction throwIfProxyReleased(isReleased) {\n    if (isReleased) {\n        throw new Error(\"Proxy has been released and is not useable\");\n    }\n}\nfunction releaseEndpoint(ep) {\n    return requestResponseMessage(ep, {\n        type: \"RELEASE\" /* MessageType.RELEASE */,\n    }).then(() => {\n        closeEndPoint(ep);\n    });\n}\nconst proxyCounter = new WeakMap();\nconst proxyFinalizers = \"FinalizationRegistry\" in globalThis &&\n    new FinalizationRegistry((ep) => {\n        const newCount = (proxyCounter.get(ep) || 0) - 1;\n        proxyCounter.set(ep, newCount);\n        if (newCount === 0) {\n            releaseEndpoint(ep);\n        }\n    });\nfunction registerProxy(proxy, ep) {\n    const newCount = (proxyCounter.get(ep) || 0) + 1;\n    proxyCounter.set(ep, newCount);\n    if (proxyFinalizers) {\n        proxyFinalizers.register(proxy, ep, proxy);\n    }\n}\nfunction unregisterProxy(proxy) {\n    if (proxyFinalizers) {\n        proxyFinalizers.unregister(proxy);\n    }\n}\nfunction createProxy(ep, path = [], target = function () { }) {\n    let isProxyReleased = false;\n    const proxy = new Proxy(target, {\n        get(_target, prop) {\n            throwIfProxyReleased(isProxyReleased);\n            if (prop === releaseProxy) {\n                return () => {\n                    unregisterProxy(proxy);\n                    releaseEndpoint(ep);\n                    isProxyReleased = true;\n                };\n            }\n            if (prop === \"then\") {\n                if (path.length === 0) {\n                    return { then: () => proxy };\n                }\n                const r = requestResponseMessage(ep, {\n                    type: \"GET\" /* MessageType.GET */,\n                    path: path.map((p) => p.toString()),\n                }).then(fromWireValue);\n                return r.then.bind(r);\n            }\n            return createProxy(ep, [...path, prop]);\n        },\n        set(_target, prop, rawValue) {\n            throwIfProxyReleased(isProxyReleased);\n            // FIXME: ES6 Proxy Handler `set` methods are supposed to return a\n            // boolean. To show good will, we return true asynchronously ¯\\_(ツ)_/¯\n            const [value, transferables] = toWireValue(rawValue);\n            return requestResponseMessage(ep, {\n                type: \"SET\" /* MessageType.SET */,\n                path: [...path, prop].map((p) => p.toString()),\n                value,\n            }, transferables).then(fromWireValue);\n        },\n        apply(_target, _thisArg, rawArgumentList) {\n            throwIfProxyReleased(isProxyReleased);\n            const last = path[path.length - 1];\n            if (last === createEndpoint) {\n                return requestResponseMessage(ep, {\n                    type: \"ENDPOINT\" /* MessageType.ENDPOINT */,\n                }).then(fromWireValue);\n            }\n            // We just pretend that `bind()` didn’t happen.\n            if (last === \"bind\") {\n                return createProxy(ep, path.slice(0, -1));\n            }\n            const [argumentList, transferables] = processArguments(rawArgumentList);\n            return requestResponseMessage(ep, {\n                type: \"APPLY\" /* MessageType.APPLY */,\n                path: path.map((p) => p.toString()),\n                argumentList,\n            }, transferables).then(fromWireValue);\n        },\n        construct(_target, rawArgumentList) {\n            throwIfProxyReleased(isProxyReleased);\n            const [argumentList, transferables] = processArguments(rawArgumentList);\n            return requestResponseMessage(ep, {\n                type: \"CONSTRUCT\" /* MessageType.CONSTRUCT */,\n                path: path.map((p) => p.toString()),\n                argumentList,\n            }, transferables).then(fromWireValue);\n        },\n    });\n    registerProxy(proxy, ep);\n    return proxy;\n}\nfunction myFlat(arr) {\n    return Array.prototype.concat.apply([], arr);\n}\nfunction processArguments(argumentList) {\n    const processed = argumentList.map(toWireValue);\n    return [processed.map((v) => v[0]), myFlat(processed.map((v) => v[1]))];\n}\nconst transferCache = new WeakMap();\nfunction transfer(obj, transfers) {\n    transferCache.set(obj, transfers);\n    return obj;\n}\nfunction proxy(obj) {\n    return Object.assign(obj, { [proxyMarker]: true });\n}\nfunction windowEndpoint(w, context = globalThis, targetOrigin = \"*\") {\n    return {\n        postMessage: (msg, transferables) => w.postMessage(msg, targetOrigin, transferables),\n        addEventListener: context.addEventListener.bind(context),\n        removeEventListener: context.removeEventListener.bind(context),\n    };\n}\nfunction toWireValue(value) {\n    for (const [name, handler] of transferHandlers) {\n        if (handler.canHandle(value)) {\n            const [serializedValue, transferables] = handler.serialize(value);\n            return [\n                {\n                    type: \"HANDLER\" /* WireValueType.HANDLER */,\n                    name,\n                    value: serializedValue,\n                },\n                transferables,\n            ];\n        }\n    }\n    return [\n        {\n            type: \"RAW\" /* WireValueType.RAW */,\n            value,\n        },\n        transferCache.get(value) || [],\n    ];\n}\nfunction fromWireValue(value) {\n    switch (value.type) {\n        case \"HANDLER\" /* WireValueType.HANDLER */:\n            return transferHandlers.get(value.name).deserialize(value.value);\n        case \"RAW\" /* WireValueType.RAW */:\n            return value.value;\n    }\n}\nfunction requestResponseMessage(ep, msg, transfers) {\n    return new Promise((resolve) => {\n        const id = generateUUID();\n        ep.addEventListener(\"message\", function l(ev) {\n            if (!ev.data || !ev.data.id || ev.data.id !== id) {\n                return;\n            }\n            ep.removeEventListener(\"message\", l);\n            resolve(ev.data);\n        });\n        if (ep.start) {\n            ep.start();\n        }\n        ep.postMessage(Object.assign({ id }, msg), transfers);\n    });\n}\nfunction generateUUID() {\n    return new Array(4)\n        .fill(0)\n        .map(() => Math.floor(Math.random() * Number.MAX_SAFE_INTEGER).toString(16))\n        .join(\"-\");\n}\n\nexport { createEndpoint, expose, finalizer, proxy, proxyMarker, releaseProxy, transfer, transferHandlers, windowEndpoint, wrap };\n//# sourceMappingURL=comlink.mjs.map\n","import { PHPResponse, PHPResponseData } from '@php-wasm/universal';\nimport * as Comlink from 'comlink';\n\nexport type WithAPIState = {\n\t/**\n\t * Resolves to true when the remote API is ready for\n\t * Comlink communication, but not necessarily fully initialized yet.\n\t */\n\tisConnected: () => Promise<void>;\n\t/**\n\t * Resolves to true when the remote API is declares it's\n\t * fully loaded and ready to be used.\n\t */\n\tisReady: () => Promise<void>;\n};\nexport type RemoteAPI<T> = Comlink.Remote<T> & WithAPIState;\n\nexport function consumeAPI<APIType>(\n\tremote: Worker | Window,\n\tcontext: undefined | EventTarget = undefined\n): RemoteAPI<APIType> {\n\tsetupTransferHandlers();\n\n\tconst endpoint =\n\t\tremote instanceof Worker\n\t\t\t? remote\n\t\t\t: Comlink.windowEndpoint(remote, context);\n\n\t/**\n\t * This shouldn't be necessary, but Comlink doesn't seem to\n\t * handle the initial isConnected() call correctly unless it's\n\t * explicitly provided here. This is especially weird\n\t * since the only thing this proxy does is to call the\n\t * isConnected() method on the remote API.\n\t *\n\t * @TODO: Remove this workaround.\n\t */\n\tconst api = Comlink.wrap<APIType & WithAPIState>(endpoint);\n\tconst methods = proxyClone(api);\n\treturn new Proxy(methods, {\n\t\tget: (target, prop) => {\n\t\t\tif (prop === 'isConnected') {\n\t\t\t\treturn async () => {\n\t\t\t\t\t// Keep retrying until the remote API confirms it's connected.\n\t\t\t\t\twhile (true) {\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tawait runWithTimeout(api.isConnected(), 200);\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\t\t// Timeout exceeded, try again. We can't just use a single\n\t\t\t\t\t\t\t// `runWithTimeout` call because it won't reach the remote API\n\t\t\t\t\t\t\t// if it's not connected yet. Instead, we need to keep retrying\n\t\t\t\t\t\t\t// until the remote API is connected and registers a handler\n\t\t\t\t\t\t\t// for the `isConnected` method.\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t};\n\t\t\t}\n\t\t\treturn (api as any)[prop];\n\t\t},\n\t}) as unknown as RemoteAPI<APIType>;\n}\n\nasync function runWithTimeout<T>(\n\tpromise: Promise<T>,\n\ttimeout: number\n): Promise<T> {\n\treturn new Promise<T>((resolve, reject) => {\n\t\tsetTimeout(reject, timeout);\n\t\tpromise.then(resolve);\n\t});\n}\n\nexport type PublicAPI<Methods, PipedAPI = unknown> = RemoteAPI<\n\tMethods & PipedAPI\n>;\nexport function exposeAPI<Methods, PipedAPI>(\n\tapiMethods?: Methods,\n\tpipedApi?: PipedAPI\n): [() => void, (e: Error) => void, PublicAPI<Methods, PipedAPI>] {\n\tsetupTransferHandlers();\n\n\tconst connected = Promise.resolve();\n\n\tlet setReady: any;\n\tlet setFailed: any;\n\tconst ready = new Promise((resolve, reject) => {\n\t\tsetReady = resolve;\n\t\tsetFailed = reject;\n\t});\n\n\tconst methods = proxyClone(apiMethods);\n\tconst exposedApi = new Proxy(methods, {\n\t\tget: (target, prop) => {\n\t\t\tif (prop === 'isConnected') {\n\t\t\t\treturn () => connected;\n\t\t\t} else if (prop === 'isReady') {\n\t\t\t\treturn () => ready;\n\t\t\t} else if (prop in target) {\n\t\t\t\treturn target[prop];\n\t\t\t}\n\t\t\treturn (pipedApi as any)?.[prop];\n\t\t},\n\t}) as unknown as PublicAPI<Methods, PipedAPI>;\n\n\tComlink.expose(\n\t\texposedApi,\n\t\ttypeof window !== 'undefined'\n\t\t\t? Comlink.windowEndpoint(self.parent)\n\t\t\t: undefined\n\t);\n\treturn [setReady, setFailed, exposedApi];\n}\n\nlet isTransferHandlersSetup = false;\nfunction setupTransferHandlers() {\n\tif (isTransferHandlersSetup) {\n\t\treturn;\n\t}\n\tisTransferHandlersSetup = true;\n\tComlink.transferHandlers.set('EVENT', {\n\t\tcanHandle: (obj): obj is CustomEvent => obj instanceof CustomEvent,\n\t\tserialize: (ev: CustomEvent) => {\n\t\t\treturn [\n\t\t\t\t{\n\t\t\t\t\tdetail: ev.detail,\n\t\t\t\t},\n\t\t\t\t[],\n\t\t\t];\n\t\t},\n\t\tdeserialize: (obj) => obj,\n\t});\n\tComlink.transferHandlers.set('FUNCTION', {\n\t\tcanHandle: (obj: unknown): obj is Function => typeof obj === 'function',\n\t\tserialize(obj: Function) {\n\t\t\tconst { port1, port2 } = new MessageChannel();\n\t\t\tComlink.expose(obj, port1);\n\t\t\treturn [port2, [port2]];\n\t\t},\n\t\tdeserialize(port: any) {\n\t\t\tport.start();\n\t\t\treturn Comlink.wrap(port);\n\t\t},\n\t});\n\tComlink.transferHandlers.set('PHPResponse', {\n\t\tcanHandle: (obj: unknown): obj is PHPResponseData =>\n\t\t\ttypeof obj === 'object' &&\n\t\t\tobj !== null &&\n\t\t\t'headers' in obj &&\n\t\t\t'bytes' in obj &&\n\t\t\t'errors' in obj &&\n\t\t\t'exitCode' in obj &&\n\t\t\t'httpStatusCode' in obj,\n\t\tserialize(obj: PHPResponse): [PHPResponseData, Transferable[]] {\n\t\t\treturn [obj.toRawData(), []];\n\t\t},\n\t\tdeserialize(responseData: PHPResponseData): PHPResponse {\n\t\t\treturn PHPResponse.fromRawData(responseData);\n\t\t},\n\t});\n\t// Augment Comlink's throw handler to include Error the response and source\n\t// information in the serialized error object. BasePHP may throw\n\t// PHPExecutionFailureError which includes those information and we'll want to\n\t// display them for the user.\n\tconst throwHandler = Comlink.transferHandlers.get('throw')!;\n\tconst originalSerialize = throwHandler?.serialize;\n\tthrowHandler.serialize = ({ value }: any) => {\n\t\tconst serialized = originalSerialize({ value }) as any;\n\t\tif (value.response) {\n\t\t\tserialized[0].value.response = value.response;\n\t\t}\n\t\tif (value.source) {\n\t\t\tserialized[0].value.source = value.source;\n\t\t}\n\t\treturn serialized;\n\t};\n}\n\nfunction proxyClone(object: any): any {\n\treturn new Proxy(object, {\n\t\tget(target, prop) {\n\t\t\tswitch (typeof target[prop]) {\n\t\t\t\tcase 'function':\n\t\t\t\t\treturn (...args: any[]) => target[prop](...args);\n\t\t\t\tcase 'object':\n\t\t\t\t\tif (target[prop] === null) {\n\t\t\t\t\t\treturn target[prop];\n\t\t\t\t\t}\n\t\t\t\t\treturn proxyClone(target[prop]);\n\t\t\t\tcase 'undefined':\n\t\t\t\tcase 'number':\n\t\t\t\tcase 'string':\n\t\t\t\t\treturn target[prop];\n\t\t\t\tdefault:\n\t\t\t\t\treturn Comlink.proxy(target[prop]);\n\t\t\t}\n\t\t},\n\t});\n}\n","export function flipObject(obj: Record<any, any>) {\n\treturn Object.fromEntries(Object.entries(obj).map(([k, v]) => [v, k]));\n}\n\nexport function concatUint8Arrays(arrays: Uint8Array[]): Uint8Array {\n\tlet totalLength = 0;\n\tarrays.forEach((a) => (totalLength += a.length));\n\tconst result = new Uint8Array(totalLength);\n\tlet offset = 0;\n\tarrays.forEach((a) => {\n\t\tresult.set(a, offset);\n\t\toffset += a.length;\n\t});\n\treturn result;\n}\n\nexport function concatArrayBuffers(buffers: ArrayBuffer[]): ArrayBuffer {\n\treturn concatUint8Arrays(buffers.map((b) => new Uint8Array(b))).buffer;\n}\n\nexport function as2Bytes(value: number): Uint8Array {\n\treturn new Uint8Array([(value >> 8) & 0xff, value & 0xff]);\n}\n\nexport function as3Bytes(value: number): Uint8Array {\n\treturn new Uint8Array([\n\t\t(value >> 16) & 0xff,\n\t\t(value >> 8) & 0xff,\n\t\tvalue & 0xff,\n\t]);\n}\n\nexport function as8Bytes(value: number): Uint8Array {\n\tconst buffer = new ArrayBuffer(8);\n\tconst view = new DataView(buffer);\n\tview.setBigUint64(0, BigInt(value), false); // false for big-endian\n\treturn new Uint8Array(buffer);\n}\nexport class ArrayBufferReader {\n\tprivate view: DataView;\n\toffset = 0;\n\tconstructor(private buffer: ArrayBuffer) {\n\t\tthis.view = new DataView(buffer);\n\t}\n\n\treadUint8(): number {\n\t\tconst value = this.view.getUint8(this.offset);\n\t\tthis.offset += 1;\n\t\treturn value;\n\t}\n\treadUint16(): number {\n\t\tconst value = this.view.getUint16(this.offset);\n\t\tthis.offset += 2;\n\t\treturn value;\n\t}\n\treadUint32(): number {\n\t\tconst value = this.view.getUint32(this.offset);\n\t\tthis.offset += 4;\n\t\treturn value;\n\t}\n\treadUint8Array(length: number): Uint8Array {\n\t\tconst value = this.buffer.slice(this.offset, this.offset + length);\n\t\tthis.offset += length;\n\t\treturn new Uint8Array(value);\n\t}\n\n\tisFinished() {\n\t\treturn this.offset >= this.buffer.byteLength;\n\t}\n}\n\nexport class ArrayBufferWriter {\n\tbuffer: ArrayBuffer;\n\tview: DataView;\n\tuint8Array: Uint8Array;\n\n\tprivate offset = 0;\n\n\tconstructor(length: number) {\n\t\tthis.buffer = new ArrayBuffer(length);\n\t\tthis.uint8Array = new Uint8Array(this.buffer);\n\t\tthis.view = new DataView(this.buffer);\n\t}\n\n\twriteUint8(value: number) {\n\t\tthis.view.setUint8(this.offset, value);\n\t\tthis.offset += 1;\n\t}\n\n\twriteUint16(value: number) {\n\t\tthis.view.setUint16(this.offset, value);\n\t\tthis.offset += 2;\n\t}\n\n\twriteUint32(value: number) {\n\t\tthis.view.setUint32(this.offset, value);\n\t\tthis.offset += 4;\n\t}\n\n\twriteUint8Array(value: Uint8Array) {\n\t\tthis.uint8Array.set(value, this.offset);\n\t\tthis.offset += value.length;\n\t}\n}\n","/**\n * IANA maintains a list of TLS extensions here:\n * https://www.iana.org/assignments/tls-extensiontype-values/tls-extensiontype-values.xhtml\n */\nexport const ExtensionTypes = {\n\tserver_name: 0,\n\tmax_fragment_length: 1,\n\tclient_certificate_url: 2,\n\ttrusted_ca_keys: 3,\n\ttruncated_hmac: 4,\n\tstatus_request: 5,\n\tuser_mapping: 6,\n\tclient_authz: 7,\n\tserver_authz: 8,\n\tcert_type: 9,\n\tsupported_groups: 10,\n\tec_point_formats: 11,\n\tsrp: 12,\n\tsignature_algorithms: 13,\n\tuse_srtp: 14,\n\theartbeat: 15,\n\tapplication_layer_protocol_negotiation: 16,\n\tstatus_request_v2: 17,\n\tsigned_certificate_timestamp: 18,\n\tclient_certificate_type: 19,\n\tserver_certificate_type: 20,\n\tpadding: 21,\n\tencrypt_then_mac: 22,\n\textended_master_secret: 23,\n\ttoken_binding: 24,\n\tcached_info: 25,\n\ttls_its: 26,\n\tcompress_certificate: 27,\n\trecord_size_limit: 28,\n\tpwd_protect: 29,\n\tpwo_clear: 30,\n\tpassword_salt: 31,\n\tticket_pinning: 32,\n\ttls_cert_with_extern_psk: 33,\n\tdelegated_credential: 34,\n\tsession_ticket: 35,\n\tTLMSP: 36,\n\tTLMSP_proxying: 37,\n\tTLMSP_delegate: 38,\n\tsupported_ekt_ciphers: 39,\n\tpre_shared_key: 41,\n\tearly_data: 42,\n\tsupported_versions: 43,\n\tcookie: 44,\n\tpsk_key_exchange_modes: 45,\n\treserved: 46,\n\tcertificate_authorities: 47,\n\toid_filters: 48,\n\tpost_handshake_auth: 49,\n\tsignature_algorithms_cert: 50,\n\tkey_share: 51,\n\ttransparency_info: 52,\n\tconnection_id: 54,\n} as const;\n\nimport { flipObject } from '../utils';\n\nexport type ExtensionType = keyof typeof ExtensionTypes;\n\nexport const ExtensionNames = flipObject(ExtensionTypes);\nexport type ExtensionName = keyof typeof ExtensionNames;\n","/**\n * TLS server_name extension\n * https://www.rfc-editor.org/rfc/rfc6066.html\n */\n\nimport { ArrayBufferWriter } from '../utils';\nimport { ExtensionTypes } from './types';\nimport { flipObject } from '../utils';\n\nexport interface ServerNameList {\n\tserver_name_list: ServerName[];\n}\n\nexport interface ServerName {\n\tname_type: typeof ServerNameTypes;\n\tname: {\n\t\thost_name: string;\n\t};\n}\n\nexport const ServerNameTypes = {\n\thost_name: 0,\n} as const;\nexport type ServerNameType =\n\t(typeof ServerNameTypes)[keyof typeof ServerNameTypes];\nexport const ServerNameNames = flipObject(ServerNameTypes);\n\nexport class ServerNameExtension {\n\tstatic decodeFromClient(data: Uint8Array): ServerNameList {\n\t\tconst view = new DataView(data.buffer);\n\t\tlet offset = 0;\n\n\t\tconst listLength = view.getUint16(offset);\n\t\toffset += 2;\n\n\t\tconst serverNameList: ServerName[] = [];\n\n\t\twhile (offset < listLength + 2) {\n\t\t\tconst nameType = data[offset] as ServerNameType;\n\t\t\toffset += 1;\n\n\t\t\tconst valueLength = view.getUint16(offset);\n\t\t\toffset += 2;\n\n\t\t\tconst value = data.slice(offset, offset + valueLength);\n\t\t\toffset += valueLength;\n\n\t\t\tswitch (nameType) {\n\t\t\t\tcase ServerNameTypes.host_name:\n\t\t\t\t\tserverNameList.push({\n\t\t\t\t\t\tname_type: ServerNameNames[nameType],\n\t\t\t\t\t\tname: {\n\t\t\t\t\t\t\thost_name: new TextDecoder().decode(value),\n\t\t\t\t\t\t},\n\t\t\t\t\t});\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\tthrow new Error(`Unsupported name type ${nameType}`);\n\t\t\t}\n\t\t}\n\n\t\treturn { server_name_list: serverNameList };\n\t}\n\n\t/**\n\t * Encode the server_name extension\n\t *\n\t * +------------------------------------+\n\t * | Extension Type (server_name) [2B]  |\n\t * | 0x00 0x00                          |\n\t * +------------------------------------+\n\t * | Extension Length             [2B]  |\n\t * | 0x00 0x00                          |\n\t * +------------------------------------+\n\t */\n\tstatic encodeForClient(serverNames?: ServerNameList) {\n\t\tif (serverNames?.server_name_list.length) {\n\t\t\tthrow new Error(\n\t\t\t\t'Encoding non-empty lists for ClientHello is not supported yet. ' +\n\t\t\t\t\t'Only empty lists meant for ServerHello are supported today.'\n\t\t\t);\n\t\t}\n\n\t\tconst writer = new ArrayBufferWriter(4);\n\t\twriter.writeUint16(ExtensionTypes.server_name);\n\t\t// Zero body length encoded using two bytes\n\t\twriter.writeUint16(0);\n\t\treturn writer.uint8Array;\n\t}\n}\n","import { flipObject } from './utils';\n\n/**\n * TLS1 cipher suites sourced from OpenSSL:\n *\n * https://github.com/openssl/openssl/blob/36254fda37fe169e136079404a3c32aeea35cbd4/include/openssl/tls1.h#L371\n */\nexport const CipherSuites = {\n\tTLS1_CK_PSK_WITH_RC4_128_SHA: 0x008a,\n\tTLS1_CK_PSK_WITH_3DES_EDE_CBC_SHA: 0x008b,\n\tTLS1_CK_PSK_WITH_AES_128_CBC_SHA: 0x008c,\n\tTLS1_CK_PSK_WITH_AES_256_CBC_SHA: 0x008d,\n\tTLS1_CK_DHE_PSK_WITH_RC4_128_SHA: 0x008e,\n\tTLS1_CK_DHE_PSK_WITH_3DES_EDE_CBC_SHA: 0x008f,\n\tTLS1_CK_DHE_PSK_WITH_AES_128_CBC_SHA: 0x0090,\n\tTLS1_CK_DHE_PSK_WITH_AES_256_CBC_SHA: 0x0091,\n\tTLS1_CK_RSA_PSK_WITH_RC4_128_SHA: 0x0092,\n\tTLS1_CK_RSA_PSK_WITH_3DES_EDE_CBC_SHA: 0x0093,\n\tTLS1_CK_RSA_PSK_WITH_AES_128_CBC_SHA: 0x0094,\n\tTLS1_CK_RSA_PSK_WITH_AES_256_CBC_SHA: 0x0095,\n\tTLS1_CK_PSK_WITH_AES_128_GCM_SHA256: 0x00a8,\n\tTLS1_CK_PSK_WITH_AES_256_GCM_SHA384: 0x00a9,\n\tTLS1_CK_DHE_PSK_WITH_AES_128_GCM_SHA256: 0x00aa,\n\tTLS1_CK_DHE_PSK_WITH_AES_256_GCM_SHA384: 0x00ab,\n\tTLS1_CK_RSA_PSK_WITH_AES_128_GCM_SHA256: 0x00ac,\n\tTLS1_CK_RSA_PSK_WITH_AES_256_GCM_SHA384: 0x00ad,\n\tTLS1_CK_PSK_WITH_AES_128_CBC_SHA256: 0x00ae,\n\tTLS1_CK_PSK_WITH_AES_256_CBC_SHA384: 0x00af,\n\tTLS1_CK_PSK_WITH_NULL_SHA256: 0x00b0,\n\tTLS1_CK_PSK_WITH_NULL_SHA384: 0x00b1,\n\tTLS1_CK_DHE_PSK_WITH_AES_128_CBC_SHA256: 0x00b2,\n\tTLS1_CK_DHE_PSK_WITH_AES_256_CBC_SHA384: 0x00b3,\n\tTLS1_CK_DHE_PSK_WITH_NULL_SHA256: 0x00b4,\n\tTLS1_CK_DHE_PSK_WITH_NULL_SHA384: 0x00b5,\n\tTLS1_CK_RSA_PSK_WITH_AES_128_CBC_SHA256: 0x00b6,\n\tTLS1_CK_RSA_PSK_WITH_AES_256_CBC_SHA384: 0x00b7,\n\tTLS1_CK_RSA_PSK_WITH_NULL_SHA256: 0x00b8,\n\tTLS1_CK_RSA_PSK_WITH_NULL_SHA384: 0x00b9,\n\tTLS1_CK_PSK_WITH_NULL_SHA: 0x002c,\n\tTLS1_CK_DHE_PSK_WITH_NULL_SHA: 0x002d,\n\tTLS1_CK_RSA_PSK_WITH_NULL_SHA: 0x002e,\n\tTLS1_CK_RSA_WITH_AES_128_SHA: 0x002f,\n\tTLS1_CK_DH_DSS_WITH_AES_128_SHA: 0x0030,\n\tTLS1_CK_DH_RSA_WITH_AES_128_SHA: 0x0031,\n\tTLS1_CK_DHE_DSS_WITH_AES_128_SHA: 0x0032,\n\tTLS1_CK_DHE_RSA_WITH_AES_128_SHA: 0x0033,\n\tTLS1_CK_ADH_WITH_AES_128_SHA: 0x0034,\n\tTLS1_CK_RSA_WITH_AES_256_SHA: 0x0035,\n\tTLS1_CK_DH_DSS_WITH_AES_256_SHA: 0x0036,\n\tTLS1_CK_DH_RSA_WITH_AES_256_SHA: 0x0037,\n\tTLS1_CK_DHE_DSS_WITH_AES_256_SHA: 0x0038,\n\tTLS1_CK_DHE_RSA_WITH_AES_256_SHA: 0x0039,\n\tTLS1_CK_ADH_WITH_AES_256_SHA: 0x003a,\n\tTLS1_CK_RSA_WITH_NULL_SHA256: 0x003b,\n\tTLS1_CK_RSA_WITH_AES_128_SHA256: 0x003c,\n\tTLS1_CK_RSA_WITH_AES_256_SHA256: 0x003d,\n\tTLS1_CK_DH_DSS_WITH_AES_128_SHA256: 0x003e,\n\tTLS1_CK_DH_RSA_WITH_AES_128_SHA256: 0x003f,\n\tTLS1_CK_DHE_DSS_WITH_AES_128_SHA256: 0x0040,\n\tTLS1_CK_RSA_WITH_CAMELLIA_128_CBC_SHA: 0x0041,\n\tTLS1_CK_DH_DSS_WITH_CAMELLIA_128_CBC_SHA: 0x0042,\n\tTLS1_CK_DH_RSA_WITH_CAMELLIA_128_CBC_SHA: 0x0043,\n\tTLS1_CK_DHE_DSS_WITH_CAMELLIA_128_CBC_SHA: 0x0044,\n\tTLS1_CK_DHE_RSA_WITH_CAMELLIA_128_CBC_SHA: 0x0045,\n\tTLS1_CK_ADH_WITH_CAMELLIA_128_CBC_SHA: 0x0046,\n\tTLS1_CK_DHE_RSA_WITH_AES_128_SHA256: 0x0067,\n\tTLS1_CK_DH_DSS_WITH_AES_256_SHA256: 0x0068,\n\tTLS1_CK_DH_RSA_WITH_AES_256_SHA256: 0x0069,\n\tTLS1_CK_DHE_DSS_WITH_AES_256_SHA256: 0x006a,\n\tTLS1_CK_DHE_RSA_WITH_AES_256_SHA256: 0x006b,\n\tTLS1_CK_ADH_WITH_AES_128_SHA256: 0x006c,\n\tTLS1_CK_ADH_WITH_AES_256_SHA256: 0x006d,\n\tTLS1_CK_RSA_WITH_CAMELLIA_256_CBC_SHA: 0x0084,\n\tTLS1_CK_DH_DSS_WITH_CAMELLIA_256_CBC_SHA: 0x0085,\n\tTLS1_CK_DH_RSA_WITH_CAMELLIA_256_CBC_SHA: 0x0086,\n\tTLS1_CK_DHE_DSS_WITH_CAMELLIA_256_CBC_SHA: 0x0087,\n\tTLS1_CK_DHE_RSA_WITH_CAMELLIA_256_CBC_SHA: 0x0088,\n\tTLS1_CK_ADH_WITH_CAMELLIA_256_CBC_SHA: 0x0089,\n\tTLS1_CK_RSA_WITH_SEED_SHA: 0x0096,\n\tTLS1_CK_DH_DSS_WITH_SEED_SHA: 0x0097,\n\tTLS1_CK_DH_RSA_WITH_SEED_SHA: 0x0098,\n\tTLS1_CK_DHE_DSS_WITH_SEED_SHA: 0x0099,\n\tTLS1_CK_DHE_RSA_WITH_SEED_SHA: 0x009a,\n\tTLS1_CK_ADH_WITH_SEED_SHA: 0x009b,\n\tTLS1_CK_RSA_WITH_AES_128_GCM_SHA256: 0x009c,\n\tTLS1_CK_RSA_WITH_AES_256_GCM_SHA384: 0x009d,\n\tTLS1_CK_DHE_RSA_WITH_AES_128_GCM_SHA256: 0x009e,\n\tTLS1_CK_DHE_RSA_WITH_AES_256_GCM_SHA384: 0x009f,\n\tTLS1_CK_DH_RSA_WITH_AES_128_GCM_SHA256: 0x00a0,\n\tTLS1_CK_DH_RSA_WITH_AES_256_GCM_SHA384: 0x00a1,\n\tTLS1_CK_DHE_DSS_WITH_AES_128_GCM_SHA256: 0x00a2,\n\tTLS1_CK_DHE_DSS_WITH_AES_256_GCM_SHA384: 0x00a3,\n\tTLS1_CK_DH_DSS_WITH_AES_128_GCM_SHA256: 0x00a4,\n\tTLS1_CK_DH_DSS_WITH_AES_256_GCM_SHA384: 0x00a5,\n\tTLS1_CK_ADH_WITH_AES_128_GCM_SHA256: 0x00a6,\n\tTLS1_CK_ADH_WITH_AES_256_GCM_SHA384: 0x00a7,\n\tTLS1_CK_RSA_WITH_AES_128_CCM: 0xc09c,\n\tTLS1_CK_RSA_WITH_AES_256_CCM: 0xc09d,\n\tTLS1_CK_DHE_RSA_WITH_AES_128_CCM: 0xc09e,\n\tTLS1_CK_DHE_RSA_WITH_AES_256_CCM: 0xc09f,\n\tTLS1_CK_RSA_WITH_AES_128_CCM_8: 0xc0a0,\n\tTLS1_CK_RSA_WITH_AES_256_CCM_8: 0xc0a1,\n\tTLS1_CK_DHE_RSA_WITH_AES_128_CCM_8: 0xc0a2,\n\tTLS1_CK_DHE_RSA_WITH_AES_256_CCM_8: 0xc0a3,\n\tTLS1_CK_PSK_WITH_AES_128_CCM: 0xc0a4,\n\tTLS1_CK_PSK_WITH_AES_256_CCM: 0xc0a5,\n\tTLS1_CK_DHE_PSK_WITH_AES_128_CCM: 0xc0a6,\n\tTLS1_CK_DHE_PSK_WITH_AES_256_CCM: 0xc0a7,\n\tTLS1_CK_PSK_WITH_AES_128_CCM_8: 0xc0a8,\n\tTLS1_CK_PSK_WITH_AES_256_CCM_8: 0xc0a9,\n\tTLS1_CK_DHE_PSK_WITH_AES_128_CCM_8: 0xc0aa,\n\tTLS1_CK_DHE_PSK_WITH_AES_256_CCM_8: 0xc0ab,\n\tTLS1_CK_ECDHE_ECDSA_WITH_AES_128_CCM: 0xc0ac,\n\tTLS1_CK_ECDHE_ECDSA_WITH_AES_256_CCM: 0xc0ad,\n\tTLS1_CK_ECDHE_ECDSA_WITH_AES_128_CCM_8: 0xc0ae,\n\tTLS1_CK_ECDHE_ECDSA_WITH_AES_256_CCM_8: 0xc0af,\n\tTLS1_CK_RSA_WITH_CAMELLIA_128_CBC_SHA256: 0x00ba,\n\tTLS1_CK_DH_DSS_WITH_CAMELLIA_128_CBC_SHA256: 0x00bb,\n\tTLS1_CK_DH_RSA_WITH_CAMELLIA_128_CBC_SHA256: 0x00bc,\n\tTLS1_CK_DHE_DSS_WITH_CAMELLIA_128_CBC_SHA256: 0x00bd,\n\tTLS1_CK_DHE_RSA_WITH_CAMELLIA_128_CBC_SHA256: 0x00be,\n\tTLS1_CK_ADH_WITH_CAMELLIA_128_CBC_SHA256: 0x00bf,\n\tTLS1_CK_RSA_WITH_CAMELLIA_256_CBC_SHA256: 0x00c0,\n\tTLS1_CK_DH_DSS_WITH_CAMELLIA_256_CBC_SHA256: 0x00c1,\n\tTLS1_CK_DH_RSA_WITH_CAMELLIA_256_CBC_SHA256: 0x00c2,\n\tTLS1_CK_DHE_DSS_WITH_CAMELLIA_256_CBC_SHA256: 0x00c3,\n\tTLS1_CK_DHE_RSA_WITH_CAMELLIA_256_CBC_SHA256: 0x00c4,\n\tTLS1_CK_ADH_WITH_CAMELLIA_256_CBC_SHA256: 0x00c5,\n\tTLS1_CK_ECDH_ECDSA_WITH_NULL_SHA: 0xc001,\n\tTLS1_CK_ECDH_ECDSA_WITH_RC4_128_SHA: 0xc002,\n\tTLS1_CK_ECDH_ECDSA_WITH_DES_192_CBC3_SHA: 0xc003,\n\tTLS1_CK_ECDH_ECDSA_WITH_AES_128_CBC_SHA: 0xc004,\n\tTLS1_CK_ECDH_ECDSA_WITH_AES_256_CBC_SHA: 0xc005,\n\tTLS1_CK_ECDHE_ECDSA_WITH_NULL_SHA: 0xc006,\n\tTLS1_CK_ECDHE_ECDSA_WITH_RC4_128_SHA: 0xc007,\n\tTLS1_CK_ECDHE_ECDSA_WITH_DES_192_CBC3_SHA: 0xc008,\n\tTLS1_CK_ECDHE_ECDSA_WITH_AES_128_CBC_SHA: 0xc009,\n\tTLS1_CK_ECDHE_ECDSA_WITH_AES_256_CBC_SHA: 0xc00a,\n\tTLS1_CK_ECDH_RSA_WITH_NULL_SHA: 0xc00b,\n\tTLS1_CK_ECDH_RSA_WITH_RC4_128_SHA: 0xc00c,\n\tTLS1_CK_ECDH_RSA_WITH_DES_192_CBC3_SHA: 0xc00d,\n\tTLS1_CK_ECDH_RSA_WITH_AES_128_CBC_SHA: 0xc00e,\n\tTLS1_CK_ECDH_RSA_WITH_AES_256_CBC_SHA: 0xc00f,\n\tTLS1_CK_ECDHE_RSA_WITH_NULL_SHA: 0xc010,\n\tTLS1_CK_ECDHE_RSA_WITH_RC4_128_SHA: 0xc011,\n\tTLS1_CK_ECDHE_RSA_WITH_DES_192_CBC3_SHA: 0xc012,\n\tTLS1_CK_ECDHE_RSA_WITH_AES_128_CBC_SHA: 0xc013,\n\tTLS1_CK_ECDHE_RSA_WITH_AES_256_CBC_SHA: 0xc014,\n\tTLS1_CK_ECDH_anon_WITH_NULL_SHA: 0xc015,\n\tTLS1_CK_ECDH_anon_WITH_RC4_128_SHA: 0xc016,\n\tTLS1_CK_ECDH_anon_WITH_DES_192_CBC3_SHA: 0xc017,\n\tTLS1_CK_ECDH_anon_WITH_AES_128_CBC_SHA: 0xc018,\n\tTLS1_CK_ECDH_anon_WITH_AES_256_CBC_SHA: 0xc019,\n\tTLS1_CK_SRP_SHA_WITH_3DES_EDE_CBC_SHA: 0xc01a,\n\tTLS1_CK_SRP_SHA_RSA_WITH_3DES_EDE_CBC_SHA: 0xc01b,\n\tTLS1_CK_SRP_SHA_DSS_WITH_3DES_EDE_CBC_SHA: 0xc01c,\n\tTLS1_CK_SRP_SHA_WITH_AES_128_CBC_SHA: 0xc01d,\n\tTLS1_CK_SRP_SHA_RSA_WITH_AES_128_CBC_SHA: 0xc01e,\n\tTLS1_CK_SRP_SHA_DSS_WITH_AES_128_CBC_SHA: 0xc01f,\n\tTLS1_CK_SRP_SHA_WITH_AES_256_CBC_SHA: 0xc020,\n\tTLS1_CK_SRP_SHA_RSA_WITH_AES_256_CBC_SHA: 0xc021,\n\tTLS1_CK_SRP_SHA_DSS_WITH_AES_256_CBC_SHA: 0xc022,\n\tTLS1_CK_ECDHE_ECDSA_WITH_AES_128_SHA256: 0xc023,\n\tTLS1_CK_ECDHE_ECDSA_WITH_AES_256_SHA384: 0xc024,\n\tTLS1_CK_ECDH_ECDSA_WITH_AES_128_SHA256: 0xc025,\n\tTLS1_CK_ECDH_ECDSA_WITH_AES_256_SHA384: 0xc026,\n\tTLS1_CK_ECDHE_RSA_WITH_AES_128_SHA256: 0xc027,\n\tTLS1_CK_ECDHE_RSA_WITH_AES_256_SHA384: 0xc028,\n\tTLS1_CK_ECDH_RSA_WITH_AES_128_SHA256: 0xc029,\n\tTLS1_CK_ECDH_RSA_WITH_AES_256_SHA384: 0xc02a,\n\tTLS1_CK_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256: 0xc02b,\n\tTLS1_CK_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384: 0xc02c,\n\tTLS1_CK_ECDH_ECDSA_WITH_AES_128_GCM_SHA256: 0xc02d,\n\tTLS1_CK_ECDH_ECDSA_WITH_AES_256_GCM_SHA384: 0xc02e,\n\tTLS1_CK_ECDHE_RSA_WITH_AES_128_GCM_SHA256: 0xc02f,\n\tTLS1_CK_ECDHE_RSA_WITH_AES_256_GCM_SHA384: 0xc030,\n\tTLS1_CK_ECDH_RSA_WITH_AES_128_GCM_SHA256: 0xc031,\n\tTLS1_CK_ECDH_RSA_WITH_AES_256_GCM_SHA384: 0xc032,\n\tTLS1_CK_ECDHE_PSK_WITH_RC4_128_SHA: 0xc033,\n\tTLS1_CK_ECDHE_PSK_WITH_3DES_EDE_CBC_SHA: 0xc034,\n\tTLS1_CK_ECDHE_PSK_WITH_AES_128_CBC_SHA: 0xc035,\n\tTLS1_CK_ECDHE_PSK_WITH_AES_256_CBC_SHA: 0xc036,\n\tTLS1_CK_ECDHE_PSK_WITH_AES_128_CBC_SHA256: 0xc037,\n\tTLS1_CK_ECDHE_PSK_WITH_AES_256_CBC_SHA384: 0xc038,\n\tTLS1_CK_ECDHE_PSK_WITH_NULL_SHA: 0xc039,\n\tTLS1_CK_ECDHE_PSK_WITH_NULL_SHA256: 0xc03a,\n\tTLS1_CK_ECDHE_PSK_WITH_NULL_SHA384: 0xc03b,\n\tTLS1_CK_ECDHE_ECDSA_WITH_CAMELLIA_128_CBC_SHA256: 0xc072,\n\tTLS1_CK_ECDHE_ECDSA_WITH_CAMELLIA_256_CBC_SHA384: 0xc073,\n\tTLS1_CK_ECDH_ECDSA_WITH_CAMELLIA_128_CBC_SHA256: 0xc074,\n\tTLS1_CK_ECDH_ECDSA_WITH_CAMELLIA_256_CBC_SHA384: 0xc075,\n\tTLS1_CK_ECDHE_RSA_WITH_CAMELLIA_128_CBC_SHA256: 0xc076,\n\tTLS1_CK_ECDHE_RSA_WITH_CAMELLIA_256_CBC_SHA384: 0xc077,\n\tTLS1_CK_ECDH_RSA_WITH_CAMELLIA_128_CBC_SHA256: 0xc078,\n\tTLS1_CK_ECDH_RSA_WITH_CAMELLIA_256_CBC_SHA384: 0xc079,\n\tTLS1_CK_PSK_WITH_CAMELLIA_128_CBC_SHA256: 0xc094,\n\tTLS1_CK_PSK_WITH_CAMELLIA_256_CBC_SHA384: 0xc095,\n\tTLS1_CK_DHE_PSK_WITH_CAMELLIA_128_CBC_SHA256: 0xc096,\n\tTLS1_CK_DHE_PSK_WITH_CAMELLIA_256_CBC_SHA384: 0xc097,\n\tTLS1_CK_RSA_PSK_WITH_CAMELLIA_128_CBC_SHA256: 0xc098,\n\tTLS1_CK_RSA_PSK_WITH_CAMELLIA_256_CBC_SHA384: 0xc099,\n\tTLS1_CK_ECDHE_PSK_WITH_CAMELLIA_128_CBC_SHA256: 0xc09a,\n\tTLS1_CK_ECDHE_PSK_WITH_CAMELLIA_256_CBC_SHA384: 0xc09b,\n\tTLS1_CK_ECDHE_RSA_WITH_CHACHA20_POLY1305: 0xcca8,\n\tTLS1_CK_ECDHE_ECDSA_WITH_CHACHA20_POLY1305: 0xcca9,\n\tTLS1_CK_DHE_RSA_WITH_CHACHA20_POLY1305: 0xccaa,\n\tTLS1_CK_PSK_WITH_CHACHA20_POLY1305: 0xccab,\n\tTLS1_CK_ECDHE_PSK_WITH_CHACHA20_POLY1305: 0xccac,\n\tTLS1_CK_DHE_PSK_WITH_CHACHA20_POLY1305: 0xccad,\n\tTLS1_CK_RSA_PSK_WITH_CHACHA20_POLY1305: 0xccae,\n} as const;\n\nexport const CipherSuitesNames = flipObject(CipherSuites);\n","/**\n * TLS supported_groups extension\n * https://www.iana.org/go/rfc7919\n * https://www.iana.org/go/rfc8422\n */\n\nimport { ArrayBufferReader, ArrayBufferWriter } from '../utils';\nimport { ExtensionTypes } from './types';\nimport { flipObject } from '../utils';\n\nexport const SupportedGroups = {\n\tsecp256r1: 23,\n\tsecp384r1: 24,\n\tsecp521r1: 25,\n\tx25519: 29,\n\tx448: 30,\n} as const;\nexport const SupportedGroupsNames = flipObject(SupportedGroups);\nexport type SupportedGroup = keyof typeof SupportedGroups;\n\nexport type ParsedSupportedGroups = (keyof typeof SupportedGroups)[];\n\nexport class SupportedGroupsExtension {\n\t/**\n\t * +--------------------------------------------------+\n\t * | Payload Length                            [2B]   |\n\t * +--------------------------------------------------+\n\t * | Supported Groups List Length              [2B]   |\n\t * +--------------------------------------------------+\n\t * | Supported Group 1                         [2B]   |\n\t * +--------------------------------------------------+\n\t * | Supported Group 2                         [2B]   |\n\t * +--------------------------------------------------+\n\t * | ...                                              |\n\t * +--------------------------------------------------+\n\t * | Supported Group n                         [2B]   |\n\t * +--------------------------------------------------+\n\t */\n\tstatic decodeFromClient(data: Uint8Array): ParsedSupportedGroups {\n\t\tconst reader = new ArrayBufferReader(data.buffer);\n\t\t// Skip the length field\n\t\treader.readUint16();\n\t\tconst groups = [];\n\t\twhile (!reader.isFinished()) {\n\t\t\tconst group = reader.readUint16();\n\t\t\tif (!(group in SupportedGroupsNames)) {\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tgroups.push(SupportedGroupsNames[group]);\n\t\t}\n\t\treturn groups;\n\t}\n\n\t/**\n\t * +--------------------------------------------------+\n\t * | Extension Type (supported_groups)         [2B]   |\n\t * | 0x00 0x0A                                        |\n\t * +--------------------------------------------------+\n\t * | Extension Length                          [2B]   |\n\t * +--------------------------------------------------+\n\t * | Selected Group                            [2B]   |\n\t * +--------------------------------------------------+\n\t */\n\tstatic encodeForClient(group: SupportedGroup): Uint8Array {\n\t\tconst writer = new ArrayBufferWriter(6);\n\t\twriter.writeUint16(ExtensionTypes.supported_groups);\n\t\twriter.writeUint16(2);\n\t\twriter.writeUint16(SupportedGroups[group]);\n\t\treturn writer.uint8Array;\n\t}\n}\n","/**\n * TLS ec_point_formats extension\n * https://www.rfc-editor.org/rfc/rfc4492#section-5.1.2\n */\n\nimport { ArrayBufferReader, ArrayBufferWriter } from '../utils';\nimport { ExtensionTypes } from './types';\nimport { flipObject } from '../utils';\n\nexport const ECPointFormats = {\n\tuncompressed: 0,\n\tansiX962_compressed_prime: 1,\n\tansiX962_compressed_char2: 2,\n} as const;\nexport type ECPointFormat = keyof typeof ECPointFormats;\n\nexport const ECPointFormatNames = flipObject(ECPointFormats);\n\nexport type ParsedECPointFormats = (keyof typeof ECPointFormats)[];\n\nexport class ECPointFormatsExtension {\n\t/**\n\t * +--------------------------------------------------+\n\t * | Payload Length                            [2B]   |\n\t * +--------------------------------------------------+\n\t * | EC Point Formats Length                   [1B]   |\n\t * +--------------------------------------------------+\n\t * | EC Point Format 1                         [1B]   |\n\t * +--------------------------------------------------+\n\t * | EC Point Format 2                         [1B]   |\n\t * +--------------------------------------------------+\n\t * | ...                                              |\n\t * +--------------------------------------------------+\n\t * | EC Point Format n                         [1B]   |\n\t * +--------------------------------------------------+\n\t */\n\tstatic decodeFromClient(data: Uint8Array): ParsedECPointFormats {\n\t\tconst reader = new ArrayBufferReader(data.buffer);\n\t\t// Read the EC Point Formats Length\n\t\tconst length = reader.readUint8();\n\t\tconst formats = [];\n\t\tfor (let i = 0; i < length; i++) {\n\t\t\tconst format = reader.readUint8();\n\t\t\tif (format in ECPointFormatNames) {\n\t\t\t\tformats.push(ECPointFormatNames[format]);\n\t\t\t}\n\t\t}\n\t\treturn formats;\n\t}\n\n\t/**\n\t * Encode the ec_point_formats extension\n\t *\n\t * +--------------------------------------------------+\n\t * | Extension Type (ec_point_formats)         [2B]   |\n\t * | 0x00 0x0B                                        |\n\t * +--------------------------------------------------+\n\t * | Body Length                               [2B]   |\n\t * +--------------------------------------------------+\n\t * | EC Point Format Length                    [1B]   |\n\t * +--------------------------------------------------+\n\t * | EC Point Format                           [1B]   |\n\t * +--------------------------------------------------+\n\t */\n\tstatic encodeForClient(format: ECPointFormat): Uint8Array {\n\t\tconst writer = new ArrayBufferWriter(6);\n\t\twriter.writeUint16(ExtensionTypes.ec_point_formats);\n\t\twriter.writeUint16(2); // Body length\n\t\twriter.writeUint8(1); // EC Point Formats Length\n\t\twriter.writeUint8(ECPointFormats[format]);\n\t\treturn writer.uint8Array;\n\t}\n}\n","/**\n * TLS signature_algorithms extension\n * https://www.rfc-editor.org/rfc/rfc8446.html#page-41\n */\n\nimport { ArrayBufferReader, ArrayBufferWriter } from '../utils';\nimport { ExtensionTypes } from './types';\nimport { flipObject } from '../utils';\nimport { logger } from '@php-wasm/logger';\n\n/**\n * A list of supported signature algorithms,\n * one byte per algorithm.\n */\nexport type SignatureAlgorithms = Uint8Array;\n\n/**\n * Signature algorithms from\n * https://datatracker.ietf.org/doc/html/rfc5246#section-7.4.1.4.1\n */\nexport const SignatureAlgorithms = {\n\tanonymous: 0,\n\trsa: 1,\n\tdsa: 2,\n\tecdsa: 3,\n};\nexport type SignatureAlgorithm = keyof typeof SignatureAlgorithms;\nexport const SignatureAlgorithmsNames = flipObject(SignatureAlgorithms);\n\n/**\n * Hash algorithms from\n * https://datatracker.ietf.org/doc/html/rfc5246#section-7.4.1.4.1\n */\nexport const HashAlgorithms = {\n\tnone: 0,\n\tmd5: 1,\n\tsha1: 2,\n\tsha224: 3,\n\tsha256: 4,\n\tsha384: 5,\n\tsha512: 6,\n};\nexport type HashAlgorithm = keyof typeof HashAlgorithms;\nexport const HashAlgorithmsNames = flipObject(HashAlgorithms);\n\nexport type ParsedSignatureAlgorithm = {\n\thash: HashAlgorithm;\n\talgorithm: SignatureAlgorithm;\n};\n\n/**\n * Handles the signature algorithms extension as defined in\n * https://www.rfc-editor.org/rfc/rfc8446.html#page-41\n */\nexport class SignatureAlgorithmsExtension {\n\t/**\n\t * Binary layout:\n\t *\n\t * +------------------------------------+\n\t * | Payload Length              [2B]   |\n\t * +------------------------------------+\n\t * | Hash Algorithm 1            [1B]   |\n\t * | Signature Algorithm 1       [1B]   |\n\t * +------------------------------------+\n\t * | Hash Algorithm 2            [1B]   |\n\t * | Signature Algorithm 2       [1B]   |\n\t * +------------------------------------+\n\t * | ...                                |\n\t * +------------------------------------+\n\t */\n\tstatic decodeFromClient(data: Uint8Array): ParsedSignatureAlgorithm[] {\n\t\tconst reader = new ArrayBufferReader(data.buffer);\n\t\treader.readUint16(); // Skip algorithms length\n\t\tconst parsedAlgorithms: ParsedSignatureAlgorithm[] = [];\n\t\twhile (!reader.isFinished()) {\n\t\t\tconst hash = reader.readUint8();\n\t\t\tconst algorithm = reader.readUint8();\n\t\t\tif (!SignatureAlgorithmsNames[algorithm]) {\n\t\t\t\tlogger.warn(`Unknown signature algorithm: ${algorithm}`);\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tif (!HashAlgorithmsNames[hash]) {\n\t\t\t\tlogger.warn(`Unknown hash algorithm: ${hash}`);\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tparsedAlgorithms.push({\n\t\t\t\talgorithm: SignatureAlgorithmsNames[algorithm],\n\t\t\t\thash: HashAlgorithmsNames[hash],\n\t\t\t});\n\t\t}\n\t\treturn parsedAlgorithms;\n\t}\n\n\t/**\n\t * +--------------------------------------------------+\n\t * | Extension Type (signature_algorithms)     [2B]   |\n\t * | 0x00 0x0D                                        |\n\t * +--------------------------------------------------+\n\t * | Body Length                               [2B]   |\n\t * +--------------------------------------------------+\n\t * | Hash Algorithm                            [1B]   |\n\t * | Signature Algorithm                       [1B]   |\n\t * +--------------------------------------------------+\n\t */\n\tstatic encodeforClient(\n\t\thash: HashAlgorithm,\n\t\talgorithm: SignatureAlgorithm\n\t): Uint8Array {\n\t\tconst writer = new ArrayBufferWriter(6);\n\t\twriter.writeUint16(ExtensionTypes.signature_algorithms);\n\t\twriter.writeUint16(2);\n\t\twriter.writeUint8(HashAlgorithms[hash]);\n\t\twriter.writeUint8(SignatureAlgorithms[algorithm]);\n\t\treturn writer.uint8Array;\n\t}\n}\n","/**\n * TLS 1.2 Record layer types defined after the structs\n * from the TLS 1.2 RFC.\n * https://datatracker.ietf.org/doc/html/rfc5246#section-6.2\n */\n\nimport { ParsedExtension } from '../extensions/parse-extensions';\nimport { flipObject } from '../utils';\n\nexport const enum CompressionMethod {\n\tNull = 0,\n\tDeflate = 1,\n}\n\n/**\n * TLS 1.2 Record layer types defined after the structs\n * from the TLS 1.2 RFC.\n * https://datatracker.ietf.org/doc/html/rfc5246#section-6.2.1\n */\n\nexport interface TLSRecord {\n\ttype: ContentType; // 1 byte\n\tversion: ProtocolVersion; // 2 bytes\n\tlength: number; // 2 bytes\n\tfragment: Uint8Array; // variable length\n}\n\nexport interface ProtocolVersion {\n\tmajor: number;\n\tminor: number;\n}\n\nexport interface GenericStreamCipher {\n\tcontent: Uint8Array;\n\tMAC: Uint8Array;\n}\n\nexport interface GenericBlockCipher {\n\tIV: Uint8Array;\n\tblock_ciphered: BlockCiphered;\n}\n\nexport interface BlockCiphered {\n\tcontent: Uint8Array;\n\tMAC: Uint8Array;\n\tpadding: Uint8Array;\n\tpadding_length: number;\n}\n\nexport interface GenericAEADCipher {\n\tnonce_explicit: Uint8Array;\n\taead_encrypted: Uint8Array;\n}\n\n/**\n * TLS 1.2 Handshake types defined after the structs\n * from the TLS 1.2 RFC.\n * https://datatracker.ietf.org/doc/html/rfc5246#section-7.4\n */\n\nexport type TLSMessage =\n\t| AlertMessage\n\t| HandshakeMessage<any>\n\t| ChangeCipherSpecMessage\n\t| ApplicationDataMessage;\n\nexport interface AlertMessage {\n\ttype: typeof ContentTypes.Alert;\n\tlevel: AlertLevel;\n\tdescription: AlertDescription;\n}\n\nexport const AlertLevels = {\n\tWarning: 1,\n\tFatal: 2,\n} as const;\nexport type AlertLevel = (typeof AlertLevels)[keyof typeof AlertLevels];\nexport const AlertLevelNames = flipObject(AlertLevels);\n\nexport const AlertDescriptions = {\n\tCloseNotify: 0,\n\tUnexpectedMessage: 10,\n\tBadRecordMac: 20,\n\tDecryptionFailed: 21,\n\tRecordOverflow: 22,\n\tDecompressionFailure: 30,\n\tHandshakeFailure: 40,\n\tNoCertificate: 41,\n\tBadCertificate: 42,\n\tUnsupportedCertificate: 43,\n\tCertificateRevoked: 44,\n\tCertificateExpired: 45,\n\tCertificateUnknown: 46,\n\tIllegalParameter: 47,\n\tUnknownCa: 48,\n\tAccessDenied: 49,\n\tDecodeError: 50,\n\tDecryptError: 51,\n\tExportRestriction: 60,\n\tProtocolVersion: 70,\n\tInsufficientSecurity: 71,\n\tInternalError: 80,\n\tUserCanceled: 90,\n\tNoRenegotiation: 100,\n\tUnsupportedExtension: 110,\n} as const;\nexport type AlertDescription =\n\t(typeof AlertDescriptions)[keyof typeof AlertDescriptions];\nexport const AlertDescriptionNames = flipObject(AlertDescriptions);\n\nexport interface ChangeCipherSpecMessage {\n\ttype: typeof ContentTypes.ChangeCipherSpec;\n\tbody: Uint8Array;\n}\n\nexport interface ApplicationDataMessage {\n\ttype: typeof ContentTypes.ApplicationData;\n\tbody: Uint8Array;\n}\n\nexport const ContentTypes = {\n\tChangeCipherSpec: 20,\n\tAlert: 21,\n\tHandshake: 22,\n\tApplicationData: 23,\n} as const;\nexport type ContentType = (typeof ContentTypes)[keyof typeof ContentTypes];\n\nexport const enum HandshakeType {\n\tHelloRequest = 0,\n\tClientHello = 1,\n\tServerHello = 2,\n\tCertificate = 11,\n\tServerKeyExchange = 12,\n\tCertificateRequest = 13,\n\tServerHelloDone = 14,\n\tCertificateVerify = 15,\n\tClientKeyExchange = 16,\n\n\tFinished = 20,\n}\n\nexport type HandshakeMessageBody =\n\t| HelloRequest\n\t| ClientHello\n\t| ServerHello\n\t| Certificate\n\t| ServerKeyExchange\n\t| CertificateRequest\n\t| ServerHelloDone\n\t| CertificateVerify\n\t| ClientKeyExchange\n\t| Finished;\n\nexport interface HandshakeMessage<Body extends HandshakeMessageBody> {\n\ttype: typeof ContentTypes.Handshake;\n\tmsg_type: HandshakeType; // 1 byte\n\tlength: number; // 2 bytes\n\t// Custom property to hold the raw body of the message\n\tbody: Body;\n}\n\n// Specific Handshake Message Types\nexport interface HelloRequest {} // Empty for TLS 1.2\n\n/**\n * 1 byte\n */\nexport type SessionId = Uint8Array;\nexport interface ClientHello {\n\tclient_version: Uint8Array; // 2 bytes\n\trandom: Uint8Array; // 32 bytes\n\tsession_id: SessionId;\n\tcipher_suites: string[];\n\tcompression_methods: Uint8Array;\n\textensions: ParsedExtension[];\n}\n\nexport interface ServerHello {\n\tserver_version: Uint8Array; // 2 bytes\n\trandom: Uint8Array; // 32 bytes\n\tsession_id: Uint8Array;\n\tcipher_suite: Uint8Array; // 2 bytes\n\tcompression_method: number;\n\textensions?: Uint8Array;\n}\n\nexport interface Certificate {\n\tcertificate_list: Uint8Array[];\n}\n\nexport interface ServerKeyExchange {\n\tparams: Uint8Array;\n\tsigned_params: Uint8Array;\n}\n\n/**\n * ECCurveType from\n * https://datatracker.ietf.org/doc/html/rfc4492#section-5.4\n */\nexport const ECCurveTypes = {\n\t/**\n\t * Indicates the elliptic curve domain parameters are\n\t * conveyed verbosely, and the underlying finite field is a prime\n\t * field.\n\t */\n\tExplicitPrime: 1,\n\t/**\n\t * Indicates the elliptic curve domain parameters are\n\t * conveyed verbosely, and the underlying finite field is a\n\t * characteristic-2 field.\n\t */\n\tExplicitChar2: 2,\n\t/**\n\t * Indicates that a named curve is used.  This option\n\t * SHOULD be used when applicable.\n\t */\n\tNamedCurve: 3,\n\t/**\n\t * Values 248 through 255 are reserved for private use.\n\t */\n};\n\n/**\n * Named elliptic curves from\n * https://datatracker.ietf.org/doc/html/rfc4492#section-5.1.1\n */\nexport const ECNamedCurves = {\n\tsect163k1: 1,\n\tsect163r1: 2,\n\tsect163r2: 3,\n\tsect193r1: 4,\n\tsect193r2: 5,\n\tsect233k1: 6,\n\tsect233r1: 7,\n\tsect239k1: 8,\n\tsect283k1: 9,\n\tsect283r1: 10,\n\tsect409k1: 11,\n\tsect409r1: 12,\n\tsecp256k1: 22,\n\tsecp256r1: 23,\n\tsecp384r1: 24,\n\tsecp521r1: 25,\n\tarbitrary_explicit_prime_curves: 0xff01,\n\tarbitrary_explicit_char2_curves: 0xff02,\n};\n\nexport interface CertificateRequest {\n\tcertificate_types: Uint8Array;\n\tsupported_signature_algorithms: Uint8Array;\n\tcertificate_authorities: Uint8Array;\n}\n\nexport interface ServerHelloDone {} // Empty for TLS 1.2\n\nexport interface CertificateVerify {\n\talgorithm: Uint8Array;\n\tsignature: Uint8Array;\n}\n\nexport interface ClientKeyExchange {\n\texchange_keys: Uint8Array;\n}\n\nexport interface Finished {\n\tverify_data: Uint8Array;\n}\n\nexport type SessionKeys = {\n\tmasterSecret: Uint8Array;\n\tclientWriteKey: CryptoKey;\n\tserverWriteKey: CryptoKey;\n\tclientIV: Uint8Array;\n\tserverIV: Uint8Array;\n};\n","import { ServerNameExtension } from '../extensions/0_server_name';\nimport { CipherSuitesNames } from '../cipher-suites';\nimport { CipherSuites } from '../cipher-suites';\nimport { SupportedGroupsExtension } from '../extensions/10_supported_groups';\nimport { ECPointFormatsExtension } from '../extensions/11_ec_point_formats';\nimport { parseClientHelloExtensions } from '../extensions/parse-extensions';\nimport {\n\tArrayBufferReader,\n\tas2Bytes,\n\tas3Bytes,\n\tas8Bytes,\n\tconcatUint8Arrays,\n} from '../utils';\nimport {\n\tHashAlgorithms,\n\tSignatureAlgorithms,\n\tSignatureAlgorithmsExtension,\n} from '../extensions/13_signature_algorithms';\nimport { tls12Prf } from './prf';\nimport {\n\tCompressionMethod,\n\tSessionKeys,\n\tHandshakeType,\n\tContentTypes,\n\tHandshakeMessage,\n\tClientHello,\n\tClientKeyExchange,\n\tFinished,\n\tApplicationDataMessage,\n\tAlertMessage,\n\tChangeCipherSpecMessage,\n\tTLSMessage,\n\tContentType,\n\tTLSRecord,\n\tAlertLevelNames,\n\tAlertDescriptionNames,\n\tHandshakeMessageBody,\n\tHelloRequest,\n\tECCurveTypes,\n\tECNamedCurves,\n} from './types';\n\nclass TLSConnectionClosed extends Error {}\nconst TLS_Version_1_2 = new Uint8Array([0x03, 0x03]);\n\n/**\n * Reuse the same ECDHE key pair for all connections to\n * save some CPU cycles. We can do this because this TLS\n * implementation is not meant to be secure.\n */\nconst generalEcdheKeyPair = crypto.subtle.generateKey(\n\t{\n\t\tname: 'ECDH',\n\t\tnamedCurve: 'P-256', // Use secp256r1 curve\n\t},\n\ttrue, // Extractable\n\t['deriveKey', 'deriveBits'] // Key usage\n);\n\n/**\n * This isomorphic class implements the server end of\n * the client <-> server TLS 1.2 connection. It has two ends:\n *\n * * Client end, that emits and accepts TLS encrypted data.\n * * Server end, that emits and accepts unencrypted data.\n *\n * The API consumer is responsible for connecting both ends\n * to the appropriate handlers.\n *\n * See https://datatracker.ietf.org/doc/html/rfc5246.\n *\n * ## Warning\n *\n * **WARNING** NEVER USE THIS CODE AS A SERVER-SIDE TLS HANDLER.\n *\n * This code is not secure. It is a minimal subset required\n * to decrypt the TLS traffic from a PHP-wasm worker. Yes,\n * it can speak TLS. No, it won't protect your data.\n *\n * ## Rationale\n *\n * This is useful for running PHP.wasm in web browsers.\n * Function calls such as `file_get_contents(\"https://w.org\")`\n * emit encrypted TLS traffic. With this class, you\n * can decrypt it, serve the requested data, and encrypt\n * the response before passing it back to the PHP.wasm\n * module.\n *\n * ## Implementation details\n *\n * TLS_1_2_Connection implements the minimal subset of TLS 1.2\n * required to exchange encrypted data with PHP.wasm:\n *\n * * TLS Handshake\n * * All TLS 1.2 record types, including messages spanning multiple\n *   records and empty records.\n * * Encryption and decryption of application data.\n * * Auto-chunking long data blobs before encrypting them to\n *   respect the AES-GCM record size limit.\n *\n * The logic is based on numerous RFCs:\n *\n * * RFC 5246: The TLS Protocol Version 1.2\n * * RFC 8446: TLS 1.3\n * * RFC 6066: TLS Extensions\n * * RFC 4492: Elliptic Curve Cryptography (ECC) Cipher Suites for TLS\n * * RFC 5288: AES Galois Counter Mode (GCM) Cipher Suites for TLS\n * * RFC 6070: PKCS #5: Password-Based Key Derivation Function 2 (PBKDF2) Test Vectors\n *\n * ... and a few others.\n *\n * ## Limitations\n *\n * * Multiple ChangeCipherSpec messages are not supported.\n * * Only uncompressed mode (compression method 0) is supported.\n * * Only the TLS1_CK_ECDHE_RSA_WITH_AES_128_GCM_SHA256 cipher suite is\n *   supported, primarily because `crypto.subtle` supports AES-GCM.\n *   For AES-GCM details, see https://datatracker.ietf.org/doc/html/rfc5288.\n */\nexport class TLS_1_2_Connection {\n\t/**\n\t * Sequence number of the last received TLS  record.\n\t *\n\t * AES-GCM requires transmitting the sequence number\n\t * in the clear in the additional data to prevent a\n\t * potential attacker from re-transmitting the same\n\t * TLS record in a different context.\n\t */\n\tprivate receivedRecordSequenceNumber = 0;\n\n\t/**\n\t * Sequence number of the last sent TLS record.\n\t *\n\t * AES-GCM requires transmitting the sequence number\n\t * in the clear in the additional data to prevent a\n\t * potential attacker from re-transmitting the same\n\t * TLS record in a different context.\n\t */\n\tprivate sentRecordSequenceNumber = 0;\n\n\t/**\n\t * Encryption keys for this connection derived during\n\t * the TLS handshake.\n\t */\n\tprivate sessionKeys: SessionKeys | undefined;\n\n\t/**\n\t * Whether this connection have been closed.\n\t */\n\tprivate closed = false;\n\n\t/**\n\t * Bytes received from the client but not yet parsed\n\t * as TLS records.\n\t */\n\tprivate receivedBytesBuffer: Uint8Array = new Uint8Array();\n\n\t/**\n\t * TLS records received from the client but not yet\n\t * parsed as TLS messages.\n\t */\n\tprivate receivedTLSRecords: Array<TLSRecord> = [];\n\n\t/**\n\t * TLS messages can span multiple TLS records. This\n\t * map holds partial TLS messages that are still incomplete\n\t * after parsing one or more TLS records.\n\t */\n\tprivate partialTLSMessages: Partial<Record<ContentType, Uint8Array>> = {};\n\n\t/**\n\t * A log of all the exchanged TLS handshake messages.\n\t * This is required to build the Finished message and\n\t * verify the integrity of the handshake.\n\t */\n\tprivate handshakeMessages: Uint8Array[] = [];\n\n\t/**\n\t * Maximum chunk size supported by the cipher suite used\n\t * in this TLS implementation.\n\t */\n\tprivate MAX_CHUNK_SIZE = 1024 * 16;\n\n\t/**\n\t * The client end of the TLS connection.\n\t * This is where the WASM module can write and read the\n\t * encrypted data.\n\t */\n\tclientEnd = {\n\t\t// We don't need to chunk the encrypted data.\n\t\t// OpenSSL already done that for us.\n\t\tupstream: new TransformStream<Uint8Array, Uint8Array>(),\n\t\tdownstream: new TransformStream<Uint8Array, Uint8Array>(),\n\t};\n\n\tprivate clientDownstreamWriter =\n\t\tthis.clientEnd.downstream.writable.getWriter();\n\tprivate clientUpstreamReader = this.clientEnd.upstream.readable.getReader();\n\n\t/**\n\t * The server end of the TLS connection.\n\t * This is where the JavaScript handler can write and read the\n\t * unencrypted data.\n\t */\n\tserverEnd = {\n\t\tupstream: new TransformStream<Uint8Array, Uint8Array>(),\n\t\t/**\n\t\t * Chunk the data before encrypting it. The\n\t\t * TLS1_CK_ECDHE_RSA_WITH_AES_128_GCM_SHA256 cipher suite\n\t\t * only supports up to 16KB of data per record.\n\t\t *\n\t\t * This will spread some messages across multiple records,\n\t\t * but TLS supports it so that's fine.\n\t\t */\n\t\tdownstream: chunkStream(this.MAX_CHUNK_SIZE),\n\t};\n\n\tprivate serverUpstreamWriter = this.serverEnd.upstream.writable.getWriter();\n\n\tconstructor() {\n\t\t// eslint-disable-next-line @typescript-eslint/no-this-alias\n\t\tconst tlsConnection = this;\n\t\t// Whenever the \"server handler\" produces data, encrypt it\n\t\t// and send it back to the client.\n\t\tthis.serverEnd.downstream.readable\n\t\t\t.pipeTo(\n\t\t\t\tnew WritableStream({\n\t\t\t\t\tasync write(chunk) {\n\t\t\t\t\t\tawait tlsConnection.writeTLSRecord(\n\t\t\t\t\t\t\tContentTypes.ApplicationData,\n\t\t\t\t\t\t\tchunk\n\t\t\t\t\t\t);\n\t\t\t\t\t},\n\t\t\t\t\tasync abort(e) {\n\t\t\t\t\t\ttlsConnection.clientDownstreamWriter.releaseLock();\n\t\t\t\t\t\ttlsConnection.clientEnd.downstream.writable.abort(e);\n\t\t\t\t\t\ttlsConnection.close();\n\t\t\t\t\t},\n\t\t\t\t\tclose() {\n\t\t\t\t\t\ttlsConnection.close();\n\t\t\t\t\t},\n\t\t\t\t})\n\t\t\t)\n\t\t\t.catch(() => {\n\t\t\t\t// Ignore failures arising from stream errors. The caller\n\t\t\t\t// should react to the readable stream erroring out.\n\t\t\t});\n\t}\n\n\t/**\n\t * Marks this connections as closed and closes all the associated\n\t * streams.\n\t */\n\tasync close() {\n\t\tif (this.closed) {\n\t\t\treturn;\n\t\t}\n\t\tthis.closed = true;\n\t\ttry {\n\t\t\tawait this.clientDownstreamWriter.close();\n\t\t} catch (e) {\n\t\t\t// Ignore\n\t\t}\n\t\ttry {\n\t\t\tawait this.clientUpstreamReader.cancel();\n\t\t} catch (e) {\n\t\t\t// Ignore\n\t\t}\n\t\ttry {\n\t\t\tawait this.serverUpstreamWriter.close();\n\t\t} catch (e) {\n\t\t\t// Ignore\n\t\t}\n\t\ttry {\n\t\t\tawait this.clientEnd.upstream.readable.cancel();\n\t\t} catch (e) {\n\t\t\t// Ignore\n\t\t}\n\t\ttry {\n\t\t\tawait this.clientEnd.downstream.writable.close();\n\t\t} catch (e) {\n\t\t\t// Ignore\n\t\t}\n\t}\n\n\t/**\n\t * TLS handshake as per RFC 5246.\n\t *\n\t * https://datatracker.ietf.org/doc/html/rfc5246#section-7.4\n\t */\n\tasync TLSHandshake(\n\t\tcertificatePrivateKey: CryptoKey,\n\t\tcertificatesDER: Uint8Array[]\n\t): Promise<void> {\n\t\t// Step 1: Receive ClientHello\n\t\tconst clientHelloRecord = await this.readNextHandshakeMessage(\n\t\t\tHandshakeType.ClientHello\n\t\t);\n\t\tif (!clientHelloRecord.body.cipher_suites.length) {\n\t\t\tthrow new Error(\n\t\t\t\t'Client did not propose any supported cipher suites.'\n\t\t\t);\n\t\t}\n\n\t\t// Step 2: Choose hashing, encryption etc. and tell the\n\t\t//         client about our choices. Also share the certificate\n\t\t//         and the encryption keys.\n\t\tconst serverRandom = crypto.getRandomValues(new Uint8Array(32));\n\t\tawait this.writeTLSRecord(\n\t\t\tContentTypes.Handshake,\n\t\t\tMessageEncoder.serverHello(\n\t\t\t\tclientHelloRecord.body,\n\t\t\t\tserverRandom,\n\t\t\t\tCompressionMethod.Null\n\t\t\t)\n\t\t);\n\n\t\tawait this.writeTLSRecord(\n\t\t\tContentTypes.Handshake,\n\t\t\tMessageEncoder.certificate(certificatesDER)\n\t\t);\n\n\t\tconst ecdheKeyPair = await generalEcdheKeyPair;\n\t\tconst clientRandom = clientHelloRecord.body.random;\n\t\tconst serverKeyExchange = await MessageEncoder.ECDHEServerKeyExchange(\n\t\t\tclientRandom,\n\t\t\tserverRandom,\n\t\t\tecdheKeyPair,\n\t\t\tcertificatePrivateKey\n\t\t);\n\t\tawait this.writeTLSRecord(ContentTypes.Handshake, serverKeyExchange);\n\t\tawait this.writeTLSRecord(\n\t\t\tContentTypes.Handshake,\n\t\t\tMessageEncoder.serverHelloDone()\n\t\t);\n\n\t\t// Step 3: Receive the client's response, encryption keys, and\n\t\t//         decrypt the first encrypted message.\n\t\tconst clientKeyExchangeRecord = await this.readNextHandshakeMessage(\n\t\t\tHandshakeType.ClientKeyExchange\n\t\t);\n\t\tawait this.readNextMessage(ContentTypes.ChangeCipherSpec);\n\n\t\tthis.sessionKeys = await this.deriveSessionKeys({\n\t\t\tclientRandom,\n\t\t\tserverRandom,\n\t\t\tserverPrivateKey: ecdheKeyPair.privateKey,\n\t\t\tclientPublicKey: await crypto.subtle.importKey(\n\t\t\t\t'raw',\n\t\t\t\tclientKeyExchangeRecord.body.exchange_keys,\n\t\t\t\t{ name: 'ECDH', namedCurve: 'P-256' },\n\t\t\t\tfalse,\n\t\t\t\t[]\n\t\t\t),\n\t\t});\n\n\t\tawait this.readNextHandshakeMessage(HandshakeType.Finished);\n\n\t\t// We're not actually verifying the hash provided by client\n\t\t// as we're not concerned with the client's identity.\n\n\t\tawait this.writeTLSRecord(\n\t\t\tContentTypes.ChangeCipherSpec,\n\t\t\tMessageEncoder.changeCipherSpec()\n\t\t);\n\t\tawait this.writeTLSRecord(\n\t\t\tContentTypes.Handshake,\n\t\t\tawait MessageEncoder.createFinishedMessage(\n\t\t\t\tthis.handshakeMessages,\n\t\t\t\tthis.sessionKeys!.masterSecret\n\t\t\t)\n\t\t);\n\t\t// Clean up the handshake messages as they are no longer needed.\n\t\tthis.handshakeMessages = [];\n\n\t\tthis.pollForClientMessages();\n\t}\n\n\t/**\n\t * Derives the session keys from the random values and the\n\t * pre-master secret – as per RFC 5246.\n\t */\n\tprivate async deriveSessionKeys({\n\t\tclientRandom,\n\t\tserverRandom,\n\t\tserverPrivateKey,\n\t\tclientPublicKey,\n\t}: {\n\t\tclientRandom: Uint8Array;\n\t\tserverRandom: Uint8Array;\n\t\tserverPrivateKey: CryptoKey;\n\t\tclientPublicKey: CryptoKey;\n\t}): Promise<SessionKeys> {\n\t\tconst preMasterSecret = await crypto.subtle.deriveBits(\n\t\t\t{\n\t\t\t\tname: 'ECDH',\n\t\t\t\tpublic: clientPublicKey,\n\t\t\t},\n\t\t\tserverPrivateKey,\n\t\t\t256 // Length of the derived secret (256 bits for P-256)\n\t\t);\n\n\t\tconst masterSecret = new Uint8Array(\n\t\t\tawait tls12Prf(\n\t\t\t\tpreMasterSecret,\n\t\t\t\tnew TextEncoder().encode('master secret'),\n\t\t\t\tconcatUint8Arrays([clientRandom, serverRandom]),\n\t\t\t\t48\n\t\t\t)\n\t\t);\n\n\t\tconst keyBlock = await tls12Prf(\n\t\t\tmasterSecret,\n\t\t\tnew TextEncoder().encode('key expansion'),\n\t\t\tconcatUint8Arrays([serverRandom, clientRandom]),\n\t\t\t// Client key, server key, client IV, server IV\n\t\t\t16 + 16 + 4 + 4\n\t\t);\n\n\t\tconst reader = new ArrayBufferReader(keyBlock);\n\t\tconst clientWriteKey = reader.readUint8Array(16);\n\t\tconst serverWriteKey = reader.readUint8Array(16);\n\t\tconst clientIV = reader.readUint8Array(4);\n\t\tconst serverIV = reader.readUint8Array(4);\n\n\t\treturn {\n\t\t\tmasterSecret,\n\t\t\tclientWriteKey: await crypto.subtle.importKey(\n\t\t\t\t'raw',\n\t\t\t\tclientWriteKey,\n\t\t\t\t{ name: 'AES-GCM' },\n\t\t\t\tfalse,\n\t\t\t\t['encrypt', 'decrypt']\n\t\t\t),\n\t\t\tserverWriteKey: await crypto.subtle.importKey(\n\t\t\t\t'raw',\n\t\t\t\tserverWriteKey,\n\t\t\t\t{ name: 'AES-GCM' },\n\t\t\t\tfalse,\n\t\t\t\t['encrypt', 'decrypt']\n\t\t\t),\n\t\t\tclientIV,\n\t\t\tserverIV,\n\t\t};\n\t}\n\n\tprivate async readNextHandshakeMessage(\n\t\tmessageType: HandshakeType.ClientHello\n\t): Promise<HandshakeMessage<ClientHello>>;\n\tprivate async readNextHandshakeMessage(\n\t\tmessageType: HandshakeType.ClientKeyExchange\n\t): Promise<HandshakeMessage<ClientKeyExchange>>;\n\tprivate async readNextHandshakeMessage(\n\t\tmessageType: HandshakeType.Finished\n\t): Promise<HandshakeMessage<Finished>>;\n\tprivate async readNextHandshakeMessage(\n\t\tmessageType:\n\t\t\t| HandshakeType.ClientHello\n\t\t\t| HandshakeType.ClientKeyExchange\n\t\t\t| HandshakeType.Finished\n\t): Promise<HandshakeMessage<any>> {\n\t\tconst message = await this.readNextMessage(ContentTypes.Handshake);\n\t\tif (message.msg_type !== messageType) {\n\t\t\tthrow new Error(`Expected ${messageType} message`);\n\t\t}\n\t\treturn message;\n\t}\n\n\tprivate async readNextMessage(\n\t\trequestedType: (typeof ContentTypes)['Handshake']\n\t): Promise<HandshakeMessage<any>>;\n\tprivate async readNextMessage(\n\t\trequestedType: (typeof ContentTypes)['ApplicationData']\n\t): Promise<ApplicationDataMessage>;\n\tprivate async readNextMessage(\n\t\trequestedType: (typeof ContentTypes)['Alert']\n\t): Promise<AlertMessage>;\n\tprivate async readNextMessage(\n\t\trequestedType: (typeof ContentTypes)['ChangeCipherSpec']\n\t): Promise<ChangeCipherSpecMessage>;\n\tprivate async readNextMessage<Message extends TLSMessage>(\n\t\trequestedType: ContentType\n\t): Promise<Message> {\n\t\tlet record: TLSRecord;\n\t\tlet accumulatedPayload: false | Uint8Array = false;\n\t\tdo {\n\t\t\trecord = await this.readNextTLSRecord(requestedType);\n\t\t\taccumulatedPayload = await this.accumulateUntilMessageIsComplete(\n\t\t\t\trecord\n\t\t\t);\n\t\t} while (accumulatedPayload === false);\n\n\t\tconst message = TLSDecoder.TLSMessage(\n\t\t\trecord.type,\n\t\t\taccumulatedPayload\n\t\t) as Message;\n\t\tif (record.type === ContentTypes.Handshake) {\n\t\t\tthis.handshakeMessages.push(record.fragment);\n\t\t}\n\t\treturn message;\n\t}\n\n\tprivate async readNextTLSRecord(\n\t\trequestedType: ContentType\n\t): Promise<TLSRecord> {\n\t\twhile (true) {\n\t\t\t// First, check if we have a complete record of the requested type.\n\t\t\tfor (let i = 0; i < this.receivedTLSRecords.length; i++) {\n\t\t\t\tconst record = this.receivedTLSRecords[i];\n\t\t\t\tif (record.type !== requestedType) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t\tthis.receivedTLSRecords.splice(i, 1);\n\t\t\t\treturn record;\n\t\t\t}\n\n\t\t\t// We don't have a complete record of the requested type yet.\n\t\t\t// Let's read the next TLS record, then.\n\t\t\tconst header = await this.pollBytes(5);\n\t\t\tconst length = (header[3] << 8) | header[4];\n\t\t\tconst type = header[0];\n\t\t\tconst fragment = await this.pollBytes(length);\n\t\t\tconst record = {\n\t\t\t\ttype,\n\t\t\t\tversion: {\n\t\t\t\t\tmajor: header[1],\n\t\t\t\t\tminor: header[2],\n\t\t\t\t},\n\t\t\t\tlength,\n\t\t\t\tfragment:\n\t\t\t\t\tthis.sessionKeys && type !== ContentTypes.ChangeCipherSpec\n\t\t\t\t\t\t? await this.decryptData(type, fragment)\n\t\t\t\t\t\t: fragment,\n\t\t\t} as TLSRecord;\n\n\t\t\tif (record.type === ContentTypes.Alert) {\n\t\t\t\tconst severity = AlertLevelNames[record.fragment[0]];\n\t\t\t\tconst description = AlertDescriptionNames[record.fragment[1]];\n\t\t\t\t/**\n\t\t\t\t * @TODO: Handle TLS warnings, e.g. this one:\n\t\t\t\t *\n\t\t\t\t * close_notify\n\t\t\t\t *     Either party may initiate a close by sending a close_notify alert.\n\t\t\t\t *     Any data received after a closure alert is ignored.\n\t\t\t\t *\n\t\t\t\t *     Unless some other fatal alert has been transmitted, each party is\n\t\t\t\t *     required to send a close_notify alert before closing the write side\n\t\t\t\t *     of the connection.  The other party MUST respond with a close_notify\n\t\t\t\t *     alert of its own and close down the connection immediately,\n\t\t\t\t *     discarding any pending writes.\n\t\t\t\t */\n\t\t\t\tthrow new Error(\n\t\t\t\t\t`TLS non-warning alert received: ${severity} ${description}`\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tthis.receivedTLSRecords.push(record);\n\t\t}\n\t}\n\n\t/**\n\t * Returns the requested number of bytes from the client.\n\t * Waits for the bytes to arrive if necessary.\n\t */\n\tprivate async pollBytes(length: number) {\n\t\twhile (this.receivedBytesBuffer.length < length) {\n\t\t\tconst { value, done } = await this.clientUpstreamReader.read();\n\t\t\tif (done) {\n\t\t\t\tawait this.close();\n\t\t\t\tthrow new TLSConnectionClosed('TLS connection closed');\n\t\t\t}\n\t\t\tthis.receivedBytesBuffer = concatUint8Arrays([\n\t\t\t\tthis.receivedBytesBuffer,\n\t\t\t\tvalue,\n\t\t\t]);\n\t\t\tif (this.receivedBytesBuffer.length >= length) {\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\t// Patience is the key...\n\t\t\tawait new Promise((resolve) => setTimeout(resolve, 100));\n\t\t}\n\t\tconst requestedBytes = this.receivedBytesBuffer.slice(0, length);\n\t\tthis.receivedBytesBuffer = this.receivedBytesBuffer.slice(length);\n\t\treturn requestedBytes;\n\t}\n\n\t/**\n\t * Listens for all incoming messages and passes them to the\n\t * server handler.\n\t */\n\tprivate async pollForClientMessages() {\n\t\ttry {\n\t\t\twhile (true) {\n\t\t\t\tconst appData = await this.readNextMessage(\n\t\t\t\t\tContentTypes.ApplicationData\n\t\t\t\t);\n\t\t\t\tthis.serverUpstreamWriter.write(appData.body);\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tif (e instanceof TLSConnectionClosed) {\n\t\t\t\t// Connection closed, no more application data to emit.\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tthrow e;\n\t\t}\n\t}\n\n\t/**\n\t * Decrypts data in a TLS 1.2-compliant manner using\n\t * the AES-GCM algorithm.\n\t */\n\tprivate async decryptData(\n\t\tcontentType: number,\n\t\tpayload: Uint8Array\n\t): Promise<Uint8Array> {\n\t\tconst implicitIV = this.sessionKeys!.clientIV;\n\t\t// Part of the IV is randomly generated for each record\n\t\t// and prepended in its unencrypted form before the\n\t\t// ciphertext.\n\t\tconst explicitIV = payload.slice(0, 8);\n\t\tconst iv = new Uint8Array([...implicitIV, ...explicitIV]);\n\n\t\tconst decrypted = await crypto.subtle.decrypt(\n\t\t\t{\n\t\t\t\tname: 'AES-GCM',\n\t\t\t\tiv,\n\t\t\t\tadditionalData: new Uint8Array([\n\t\t\t\t\t...as8Bytes(this.receivedRecordSequenceNumber),\n\t\t\t\t\tcontentType,\n\t\t\t\t\t...TLS_Version_1_2,\n\t\t\t\t\t// Payload length without IV and tag\n\t\t\t\t\t...as2Bytes(payload.length - 8 - 16),\n\t\t\t\t]),\n\t\t\t\ttagLength: 128,\n\t\t\t},\n\t\t\tthis.sessionKeys!.clientWriteKey,\n\t\t\t// Payload without the explicit IV\n\t\t\tpayload.slice(8)\n\t\t);\n\t\t++this.receivedRecordSequenceNumber;\n\n\t\treturn new Uint8Array(decrypted);\n\t}\n\n\tprivate async accumulateUntilMessageIsComplete(\n\t\trecord: TLSRecord\n\t): Promise<false | Uint8Array> {\n\t\tthis.partialTLSMessages[record.type] = concatUint8Arrays([\n\t\t\tthis.partialTLSMessages[record.type] || new Uint8Array(),\n\t\t\trecord.fragment,\n\t\t]);\n\t\tconst message = this.partialTLSMessages[record.type]!;\n\t\tswitch (record.type) {\n\t\t\tcase ContentTypes.Handshake: {\n\t\t\t\t// We don't have the message header yet, let's wait for more data.\n\t\t\t\tif (message.length < 4) {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t\tconst length = (message[1] << 8) | message[2];\n\t\t\t\tif (message.length < 3 + length) {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase ContentTypes.Alert: {\n\t\t\t\tif (message.length < 2) {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase ContentTypes.ChangeCipherSpec:\n\t\t\tcase ContentTypes.ApplicationData:\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tthrow new Error(`TLS: Unsupported record type ${record.type}`);\n\t\t}\n\t\tdelete this.partialTLSMessages[record.type];\n\t\treturn message;\n\t}\n\n\t/**\n\t * Passes a TLS record to the client.\n\t *\n\t * Accepts unencrypted data and ensures it gets encrypted\n\t * if needed before sending it to the client. The encryption\n\t * only kicks in after the handshake is complete.\n\t */\n\tprivate async writeTLSRecord(\n\t\tcontentType: number,\n\t\tpayload: Uint8Array\n\t): Promise<void> {\n\t\tif (contentType === ContentTypes.Handshake) {\n\t\t\tthis.handshakeMessages.push(payload);\n\t\t}\n\t\tif (this.sessionKeys && contentType !== ContentTypes.ChangeCipherSpec) {\n\t\t\tpayload = await this.encryptData(contentType, payload);\n\t\t}\n\n\t\tconst version = TLS_Version_1_2;\n\t\tconst length = payload.length;\n\t\tconst header = new Uint8Array(5);\n\t\theader[0] = contentType;\n\t\theader[1] = version[0];\n\t\theader[2] = version[1];\n\t\theader[3] = (length >> 8) & 0xff;\n\t\theader[4] = length & 0xff;\n\n\t\tconst record = concatUint8Arrays([header, payload]);\n\t\tthis.clientDownstreamWriter.write(record);\n\t}\n\n\t/**\n\t * Encrypts data in a TLS 1.2-compliant manner using\n\t * the AES-GCM algorithm.\n\t */\n\tprivate async encryptData(\n\t\tcontentType: number,\n\t\tpayload: Uint8Array\n\t): Promise<Uint8Array> {\n\t\tconst implicitIV = this.sessionKeys!.serverIV;\n\t\t// Part of the IV is randomly generated for each record\n\t\t// and prepended in its unencrypted form before the\n\t\t// ciphertext.\n\t\tconst explicitIV = crypto.getRandomValues(new Uint8Array(8));\n\t\tconst iv = new Uint8Array([...implicitIV, ...explicitIV]);\n\n\t\tconst additionalData = new Uint8Array([\n\t\t\t...as8Bytes(this.sentRecordSequenceNumber),\n\t\t\tcontentType,\n\t\t\t...TLS_Version_1_2,\n\t\t\t// Payload length without IV and tag\n\t\t\t...as2Bytes(payload.length),\n\t\t]);\n\t\tconst ciphertextWithTag = await crypto.subtle.encrypt(\n\t\t\t{\n\t\t\t\tname: 'AES-GCM',\n\t\t\t\tiv,\n\t\t\t\tadditionalData,\n\t\t\t\ttagLength: 128,\n\t\t\t},\n\t\t\tthis.sessionKeys!.serverWriteKey,\n\t\t\tpayload\n\t\t);\n\t\t++this.sentRecordSequenceNumber;\n\n\t\tconst encrypted = concatUint8Arrays([\n\t\t\texplicitIV,\n\t\t\tnew Uint8Array(ciphertextWithTag),\n\t\t]);\n\n\t\treturn encrypted;\n\t}\n}\n\nclass TLSDecoder {\n\tstatic TLSMessage(\n\t\ttype: ContentType,\n\t\taccumulatedPayload: Uint8Array\n\t): TLSMessage {\n\t\tswitch (type) {\n\t\t\tcase ContentTypes.Handshake: {\n\t\t\t\treturn TLSDecoder.clientHandshake(accumulatedPayload);\n\t\t\t}\n\t\t\tcase ContentTypes.Alert: {\n\t\t\t\treturn TLSDecoder.alert(accumulatedPayload);\n\t\t\t}\n\t\t\tcase ContentTypes.ChangeCipherSpec: {\n\t\t\t\treturn TLSDecoder.changeCipherSpec();\n\t\t\t}\n\t\t\tcase ContentTypes.ApplicationData: {\n\t\t\t\treturn TLSDecoder.applicationData(accumulatedPayload);\n\t\t\t}\n\t\t\tdefault:\n\t\t\t\tthrow new Error(`TLS: Unsupported TLS record type ${type}`);\n\t\t}\n\t}\n\n\t/**\n\t * Parses the cipher suites from the server hello message.\n\t *\n\t * The cipher suites are encoded as a list of 2-byte values.\n\t *\n\t * Binary layout:\n\t *\n\t * +----------------------------+\n\t * | Cipher Suites Length       |  2 bytes\n\t * +----------------------------+\n\t * | Cipher Suite 1             |  2 bytes\n\t * +----------------------------+\n\t * | Cipher Suite 2             |  2 bytes\n\t * +----------------------------+\n\t * | ...                        |\n\t * +----------------------------+\n\t * | Cipher Suite n             |  2 bytes\n\t * +----------------------------+\n\t *\n\t * The full list of supported cipher suites values is available at:\n\t *\n\t * https://www.iana.org/assignments/tls-parameters/tls-parameters.xhtml#tls-parameters-4\n\t */\n\tstatic parseCipherSuites(buffer: ArrayBuffer): string[] {\n\t\tconst reader = new ArrayBufferReader(buffer);\n\t\t// Skip the length of the cipher suites\n\t\treader.readUint16();\n\n\t\tconst cipherSuites = [];\n\t\twhile (!reader.isFinished()) {\n\t\t\tconst suite = reader.readUint16();\n\t\t\tif (!(suite in CipherSuitesNames)) {\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tcipherSuites.push(CipherSuitesNames[suite]);\n\t\t}\n\t\treturn cipherSuites;\n\t}\n\n\tstatic applicationData(message: Uint8Array): ApplicationDataMessage {\n\t\treturn {\n\t\t\ttype: ContentTypes.ApplicationData,\n\t\t\tbody: message,\n\t\t};\n\t}\n\n\tstatic changeCipherSpec(): ChangeCipherSpecMessage {\n\t\treturn {\n\t\t\ttype: ContentTypes.ChangeCipherSpec,\n\t\t\tbody: new Uint8Array(),\n\t\t};\n\t}\n\n\tstatic alert(message: Uint8Array): AlertMessage {\n\t\treturn {\n\t\t\ttype: ContentTypes.Alert,\n\t\t\tlevel: AlertLevelNames[message[0]],\n\t\t\tdescription: AlertDescriptionNames[message[1]],\n\t\t};\n\t}\n\n\tstatic clientHandshake<T extends HandshakeMessageBody>(\n\t\tmessage: Uint8Array\n\t): HandshakeMessage<T> {\n\t\tconst msg_type = message[0];\n\t\tconst length = (message[1] << 16) | (message[2] << 8) | message[3];\n\t\tconst bodyBytes = message.slice(4);\n\t\tlet body: HandshakeMessageBody | undefined = undefined;\n\t\tswitch (msg_type) {\n\t\t\tcase HandshakeType.HelloRequest:\n\t\t\t\tbody = TLSDecoder.clientHelloRequestPayload();\n\t\t\t\tbreak;\n\t\t\tcase HandshakeType.ClientHello:\n\t\t\t\tbody = TLSDecoder.clientHelloPayload(bodyBytes);\n\t\t\t\tbreak;\n\t\t\tcase HandshakeType.ClientKeyExchange:\n\t\t\t\tbody = TLSDecoder.clientKeyExchangePayload(bodyBytes);\n\t\t\t\tbreak;\n\t\t\tcase HandshakeType.Finished:\n\t\t\t\tbody = TLSDecoder.clientFinishedPayload(bodyBytes);\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tthrow new Error(`Invalid handshake type ${msg_type}`);\n\t\t}\n\t\treturn {\n\t\t\ttype: ContentTypes.Handshake,\n\t\t\tmsg_type,\n\t\t\tlength,\n\t\t\tbody: body as T,\n\t\t};\n\t}\n\n\tstatic clientHelloRequestPayload(): HelloRequest {\n\t\treturn {};\n\t}\n\n\t/**\n\t *\tOffset  Size    Field\n\t *\t(bytes) (bytes)\n\t *\t+------+------+---------------------------+\n\t *\t| 0000 |  1   | Handshake Type (1 = ClientHello)\n\t *\t+------+------+---------------------------+\n\t *\t| 0001 |  3   | Length of ClientHello\n\t *\t+------+------+---------------------------+\n\t *\t| 0004 |  2   | Protocol Version\n\t *\t+------+------+---------------------------+\n\t *\t| 0006 |  32  | Client Random\n\t *\t|      |      | (4 bytes timestamp +\n\t *\t|      |      |  28 bytes random)\n\t *\t+------+------+---------------------------+\n\t *\t| 0038 |  1   | Session ID Length\n\t *\t+------+------+---------------------------+\n\t *\t| 0039 |  0+  | Session ID (variable)\n\t *\t|      |      | (0-32 bytes)\n\t *\t+------+------+---------------------------+\n\t *\t| 003A*|  2   | Cipher Suites Length\n\t *\t+------+------+---------------------------+\n\t *\t| 003C*|  2+  | Cipher Suites\n\t *\t|      |      | (2 bytes each)\n\t *\t+------+------+---------------------------+\n\t *\t| xxxx |  1   | Compression Methods Length\n\t *\t+------+------+---------------------------+\n\t *\t| xxxx |  1+  | Compression Methods\n\t *\t|      |      | (1 byte each)\n\t *\t+------+------+---------------------------+\n\t *\t| xxxx |  2   | Extensions Length\n\t *\t+------+------+---------------------------+\n\t *\t| xxxx |  2   | Extension Type\n\t *\t+------+------+---------------------------+\n\t *\t| xxxx |  2   | Extension Length\n\t *\t+------+------+---------------------------+\n\t *\t| xxxx |  v   | Extension Data\n\t *\t+------+------+---------------------------+\n\t *\t|      |      | (Additional extensions...)\n\t *\t+------+------+---------------------------+\n\t */\n\tstatic clientHelloPayload(data: Uint8Array): ClientHello {\n\t\tconst reader = new ArrayBufferReader(data.buffer);\n\t\tconst buff: Partial<ClientHello> = {\n\t\t\tclient_version: reader.readUint8Array(2),\n\t\t\t/**\n\t\t\t * Technically this consists of a GMT timestamp\n\t\t\t * and 28 random bytes, but we don't need to\n\t\t\t * parse this further.\n\t\t\t */\n\t\t\trandom: reader.readUint8Array(32),\n\t\t};\n\t\tconst sessionIdLength = reader.readUint8();\n\t\tbuff.session_id = reader.readUint8Array(sessionIdLength);\n\n\t\tconst cipherSuitesLength = reader.readUint16();\n\t\tbuff.cipher_suites = TLSDecoder.parseCipherSuites(\n\t\t\treader.readUint8Array(cipherSuitesLength).buffer\n\t\t);\n\n\t\tconst compressionMethodsLength = reader.readUint8();\n\t\tbuff.compression_methods = reader.readUint8Array(\n\t\t\tcompressionMethodsLength\n\t\t);\n\n\t\tconst extensionsLength = reader.readUint16();\n\t\tbuff.extensions = parseClientHelloExtensions(\n\t\t\treader.readUint8Array(extensionsLength)\n\t\t);\n\t\treturn buff as ClientHello;\n\t}\n\n\t/**\n\t * Binary layout:\n\t *\n\t *\t+------------------------------------+\n\t *\t| ECDH Client Public Key Length [1B] |\n\t *\t+------------------------------------+\n\t *\t| ECDH Client Public Key   [variable]|\n\t *\t+------------------------------------+\n\t */\n\tstatic clientKeyExchangePayload(data: Uint8Array): ClientKeyExchange {\n\t\treturn {\n\t\t\t// Skip the first byte, which is the length of the public key\n\t\t\texchange_keys: data.slice(1, data.length),\n\t\t};\n\t}\n\n\tstatic clientFinishedPayload(data: Uint8Array): Finished {\n\t\treturn {\n\t\t\tverify_data: data,\n\t\t};\n\t}\n}\n\n/**\n * Creates a stream that emits chunks not larger than\n * the specified size.\n */\nfunction chunkStream(chunkSize: number) {\n\treturn new TransformStream({\n\t\ttransform(chunk, controller) {\n\t\t\twhile (chunk.length > 0) {\n\t\t\t\tcontroller.enqueue(chunk.slice(0, chunkSize));\n\t\t\t\tchunk = chunk.slice(chunkSize);\n\t\t\t}\n\t\t},\n\t});\n}\n\nclass MessageEncoder {\n\tstatic certificate(certificatesDER: ArrayBuffer[]): Uint8Array {\n\t\tconst certsBodies: Uint8Array[] = [];\n\t\tfor (const cert of certificatesDER) {\n\t\t\tcertsBodies.push(as3Bytes(cert.byteLength));\n\t\t\tcertsBodies.push(new Uint8Array(cert));\n\t\t}\n\t\tconst certsBody = concatUint8Arrays(certsBodies);\n\t\tconst body = new Uint8Array([\n\t\t\t...as3Bytes(certsBody.byteLength),\n\t\t\t...certsBody,\n\t\t]);\n\t\treturn new Uint8Array([\n\t\t\tHandshakeType.Certificate,\n\t\t\t...as3Bytes(body.length),\n\t\t\t...body,\n\t\t]);\n\t}\n\n\t/*\n\t * Byte layout of the ServerKeyExchange message:\n\t *\n\t * +-----------------------------------+\n\t * |    ServerKeyExchange Message      |\n\t * +-----------------------------------+\n\t * | Handshake type (1 byte)           |\n\t * +-----------------------------------+\n\t * | Length (3 bytes)                  |\n\t * +-----------------------------------+\n\t * | Curve Type (1 byte)               |\n\t * +-----------------------------------+\n\t * | Named Curve (2 bytes)             |\n\t * +-----------------------------------+\n\t * | EC Point Format (1 byte)          |\n\t * +-----------------------------------+\n\t * | Public Key Length (1 byte)        |\n\t * +-----------------------------------+\n\t * | Public Key (variable)             |\n\t * +-----------------------------------+\n\t * | Signature Algorithm (2 bytes)     |\n\t * +-----------------------------------+\n\t * | Signature Length (2 bytes)        |\n\t * +-----------------------------------+\n\t * | Signature (variable)              |\n\t * +-----------------------------------+\n\t *\n\t * @param clientRandom - 32 bytes from ClientHello\n\t * @param serverRandom - 32 bytes from ServerHello\n\t * @param ecdheKeyPair - ECDHE key pair\n\t * @param rsaPrivateKey - RSA private key for signing\n\t * @returns\n\t */\n\tstatic async ECDHEServerKeyExchange(\n\t\tclientRandom: Uint8Array,\n\t\tserverRandom: Uint8Array,\n\t\tecdheKeyPair: CryptoKeyPair,\n\t\trsaPrivateKey: CryptoKey\n\t): Promise<Uint8Array> {\n\t\t// 65 bytes (04 followed by x and y coordinates)\n\t\tconst publicKey = new Uint8Array(\n\t\t\tawait crypto.subtle.exportKey('raw', ecdheKeyPair.publicKey)\n\t\t);\n\n\t\t/*\n\t\t * The ServerKeyExchange message is extended as follows.\n\t\t *\n\t\t * select (KeyExchangeAlgorithm) {\n\t\t *     case ec_diffie_hellman:\n\t\t *         ServerECDHParams    params;\n\t\t *         Signature           signed_params;\n\t\t * } ServerKeyExchange;\n\t\t *\n\t\t * struct {\n\t\t *   ECCurveType     curve_type;\n\t\t *   NamedCurve      namedcurve;\n\t\t *   ECPoint         public;\n\t\t * } ServerECDHParams;\n\t\t */\n\t\tconst params = new Uint8Array([\n\t\t\t// Curve type (1 byte)\n\t\t\tECCurveTypes.NamedCurve,\n\t\t\t// Curve name (2 bytes)\n\t\t\t...as2Bytes(ECNamedCurves.secp256r1),\n\n\t\t\t// Public key length (1 byte)\n\t\t\tpublicKey.byteLength,\n\n\t\t\t// Public key (65 bytes, uncompressed format)\n\t\t\t...publicKey,\n\t\t]);\n\n\t\t/**\n\t\t * signed_params:\n\t\t *    A hash of the params, with the signature appropriate to that hash\n\t\t *    applied.  The private key corresponding to the certified public key\n\t\t *    in the server's Certificate message is used for signing.\n\t\t *\n\t\t *    Signature = encrypt(SHA(\n\t\t *       ClientHello.random + ServerHello.random + ServerECDHParams\n\t\t *    ));\n\t\t */\n\t\tconst signedParams = await crypto.subtle.sign(\n\t\t\t{\n\t\t\t\tname: 'RSASSA-PKCS1-v1_5',\n\t\t\t\thash: 'SHA-256',\n\t\t\t},\n\t\t\trsaPrivateKey,\n\t\t\tnew Uint8Array([...clientRandom, ...serverRandom, ...params])\n\t\t);\n\t\tconst signatureBytes = new Uint8Array(signedParams);\n\n\t\t/**\n\t\t * SignatureAlgorithm is \"rsa\" for the ECDHE_RSA key exchange\n\t\t * These cases are defined in TLS [RFC2246].\n\t\t */\n\t\tconst signatureAlgorithm = new Uint8Array([\n\t\t\tHashAlgorithms.sha256,\n\t\t\tSignatureAlgorithms.rsa,\n\t\t]);\n\n\t\t// Step 6: Construct the complete Server Key Exchange message\n\t\tconst body = new Uint8Array([\n\t\t\t...params,\n\t\t\t...signatureAlgorithm,\n\t\t\t...as2Bytes(signatureBytes.length),\n\t\t\t...signatureBytes,\n\t\t]);\n\n\t\treturn new Uint8Array([\n\t\t\tHandshakeType.ServerKeyExchange,\n\t\t\t...as3Bytes(body.length),\n\t\t\t...body,\n\t\t]);\n\t}\n\n\t/**\n\t * +------------------------------------+\n\t * | Content Type (Handshake)     [1B]  |\n\t * | 0x16                               |\n\t * +------------------------------------+\n\t * | Version (TLS 1.2)            [2B]  |\n\t * | 0x03 0x03                          |\n\t * +------------------------------------+\n\t * | Length                       [2B]  |\n\t * +------------------------------------+\n\t * | Handshake Type (ServerHello) [1B]  |\n\t * | 0x02                               |\n\t * +------------------------------------+\n\t * | Handshake Length             [3B]  |\n\t * +------------------------------------+\n\t * | Server Version               [2B]  |\n\t * +------------------------------------+\n\t * | Server Random               [32B]  |\n\t * +------------------------------------+\n\t * | Session ID Length            [1B]  |\n\t * +------------------------------------+\n\t * | Session ID             [0-32B]     |\n\t * +------------------------------------+\n\t * | Cipher Suite                 [2B]  |\n\t * +------------------------------------+\n\t * | Compression Method           [1B]  |\n\t * +------------------------------------+\n\t * | Extensions Length            [2B]  |\n\t * +------------------------------------+\n\t * | Extension: ec_point_formats        |\n\t * |   Type (0x00 0x0B)           [2B]  |\n\t * |   Length                     [2B]  |\n\t * |   EC Point Formats Length    [1B]  |\n\t * |   EC Point Format            [1B]  |\n\t * +------------------------------------+\n\t * | Other Extensions...                |\n\t * +------------------------------------+\n\t */\n\tstatic serverHello(\n\t\tclientHello: ClientHello,\n\t\tserverRandom: Uint8Array,\n\t\tcompressionAlgorithm: number\n\t): Uint8Array {\n\t\tconst extensionsParts: Uint8Array[] = clientHello.extensions\n\t\t\t.map((extension) => {\n\t\t\t\tswitch (extension['type']) {\n\t\t\t\t\tcase 'server_name':\n\t\t\t\t\t\t/**\n\t\t\t\t\t\t * The server SHALL include an extension of type \"server_name\" in the\n\t\t\t\t\t\t * (extended) server hello.  The \"extension_data\" field of this extension\n\t\t\t\t\t\t * SHALL be empty.\n\t\t\t\t\t\t *\n\t\t\t\t\t\t * Source: dfile:///Users/cloudnik/Library/Application%20Support/Dash/User%20Contributed/RFCs/RFCs.docset/Contents/Resources/Documents/rfc6066.html#section-3\n\t\t\t\t\t\t */\n\t\t\t\t\t\treturn ServerNameExtension.encodeForClient();\n\t\t\t\t\tcase 'supported_groups':\n\t\t\t\t\t\treturn SupportedGroupsExtension.encodeForClient(\n\t\t\t\t\t\t\t'secp256r1'\n\t\t\t\t\t\t);\n\t\t\t\t\tcase 'ec_point_formats':\n\t\t\t\t\t\treturn ECPointFormatsExtension.encodeForClient(\n\t\t\t\t\t\t\t'uncompressed'\n\t\t\t\t\t\t);\n\t\t\t\t\tcase 'signature_algorithms':\n\t\t\t\t\t\treturn SignatureAlgorithmsExtension.encodeforClient(\n\t\t\t\t\t\t\t'sha256',\n\t\t\t\t\t\t\t'rsa'\n\t\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\treturn undefined;\n\t\t\t})\n\t\t\t.filter((x): x is Uint8Array => x !== undefined);\n\t\tconst extensions = concatUint8Arrays(extensionsParts);\n\n\t\tconst body = new Uint8Array([\n\t\t\t// Version field – 0x03, 0x03 means TLS 1.2\n\t\t\t...TLS_Version_1_2,\n\n\t\t\t...serverRandom,\n\n\t\t\tclientHello.session_id.length,\n\t\t\t...clientHello.session_id,\n\n\t\t\t...as2Bytes(CipherSuites.TLS1_CK_ECDHE_RSA_WITH_AES_128_GCM_SHA256),\n\n\t\t\tcompressionAlgorithm,\n\n\t\t\t// Extensions length (2 bytes)\n\t\t\t...as2Bytes(extensions.length),\n\n\t\t\t...extensions,\n\t\t]);\n\n\t\treturn new Uint8Array([\n\t\t\tHandshakeType.ServerHello,\n\t\t\t...as3Bytes(body.length),\n\t\t\t...body,\n\t\t]);\n\t}\n\n\tstatic serverHelloDone(): Uint8Array {\n\t\treturn new Uint8Array([HandshakeType.ServerHelloDone, ...as3Bytes(0)]);\n\t}\n\n\t/**\n\t * Server finished message.\n\t * The structure is defined in:\n\t * https://datatracker.ietf.org/doc/html/rfc5246#section-7.4.9\n\t *\n\t * struct {\n\t *     opaque verify_data[verify_data_length];\n\t * } Finished;\n\t *\n\t * verify_data\n\t *    PRF(master_secret, finished_label, Hash(handshake_messages))\n\t *       [0..verify_data_length-1];\n\t *\n\t * finished_label\n\t *    For Finished messages sent by the client, the string\n\t *    \"client finished\".  For Finished messages sent by the server,\n\t *    the string \"server finished\".\n\t */\n\tstatic async createFinishedMessage(\n\t\thandshakeMessages: Uint8Array[],\n\t\tmasterSecret: ArrayBuffer\n\t): Promise<Uint8Array> {\n\t\t// Step 1: Compute the hash of the handshake messages\n\t\tconst handshakeHash = await crypto.subtle.digest(\n\t\t\t'SHA-256',\n\t\t\tconcatUint8Arrays(handshakeMessages)\n\t\t);\n\n\t\t// Step 2: Compute the verify_data using the PRF\n\t\tconst verifyData = new Uint8Array(\n\t\t\tawait tls12Prf(\n\t\t\t\tmasterSecret,\n\t\t\t\tnew TextEncoder().encode('server finished'),\n\t\t\t\thandshakeHash,\n\t\t\t\t// verify_data length. TLS 1.2 specifies 12 bytes for verify_data\n\t\t\t\t12\n\t\t\t)\n\t\t);\n\n\t\t// Step 3: Construct the Finished message\n\t\treturn new Uint8Array([\n\t\t\tHandshakeType.Finished,\n\t\t\t...as3Bytes(verifyData.length),\n\t\t\t...verifyData,\n\t\t]);\n\t}\n\n\tstatic changeCipherSpec(): Uint8Array {\n\t\treturn new Uint8Array([0x01]);\n\t}\n}\n","const DEFAULT_RESPONSE_TIMEOUT = 25000;\n\nlet lastRequestId = 0;\n\n/**\n * Posts a message branded with a unique `requestId` to the given `target`.\n * Then returns the `requestId` so it can be used to await a reply.\n * Effectively, it implements the request/response dynamics on\n * of JavaScript's `postMessage`\n *\n * @example\n *\n * In the main app:\n *\n * ```js\n * import { postMessageExpectReply, awaitReply } from 'php-wasm-browser';\n * const iframeWindow = iframe.contentWindow;\n * const requestId = postMessageExpectReply(iframeWindow, {\n *    type: \"get_php_version\"\n * });\n * const response = await awaitReply(iframeWindow, requestId);\n * console.log(response);\n * // \"8.0.24\"\n * ```\n *\n * In the iframe:\n *\n * ```js\n * import { responseTo } from 'php-wasm-browser';\n * window.addEventListener('message', (event) => {\n *    let response = '8.0.24';\n *    if(event.data.type === 'get_php_version') {\n *       response = '8.0.24';\n *    } else {\n *       throw new Error(`Unexpected message type: ${event.data.type}`);\n *    }\n *\n *    // When `requestId` is present, the other thread expects a response:\n *    if (event.data.requestId) {\n *       const response = responseTo(event.data.requestId, response);\n *       window.parent.postMessage(response, event.origin);\n *    }\n * });\n * ```\n *\n * @param  target          An object that has a `postMessage` method.\n * @param  message         A key-value object that can be serialized to JSON.\n * @param  postMessageArgs Additional arguments to pass to `postMessage`.\n * @returns The message ID for awaitReply().\n */\nexport function postMessageExpectReply(\n\ttarget: PostMessageTarget,\n\tmessage: Record<string, any>,\n\t...postMessageArgs: any[]\n): number {\n\tconst requestId = getNextRequestId();\n\ttarget.postMessage(\n\t\t{\n\t\t\t...message,\n\t\t\trequestId,\n\t\t},\n\t\t...postMessageArgs\n\t);\n\treturn requestId;\n}\n\nexport function getNextRequestId() {\n\treturn ++lastRequestId;\n}\n\n/**\n * Awaits a reply to the message with the given ID.\n *\n * @see postMessageExpectReply\n * @throws {@link Error} If the reply is not received within the timeout.\n * @param  messageTarget EventEmitter emitting `message` events, e.g. `window`\n *                       or a `Worker` instance.\n * @param  requestId     The message ID returned by postMessageExpectReply().\n * @param  timeout       The number of milliseconds to wait for a reply before\n *                       throwing an error.\n * @returns The reply from the messageTarget.\n */\nexport function awaitReply(\n\tmessageTarget: IsomorphicEventTarget,\n\trequestId: number,\n\ttimeout: number = DEFAULT_RESPONSE_TIMEOUT\n): Promise<any> {\n\treturn new Promise((resolve, reject) => {\n\t\tconst responseHandler = (event: MessageEvent) => {\n\t\t\tif (\n\t\t\t\tevent.data.type === 'response' &&\n\t\t\t\tevent.data.requestId === requestId\n\t\t\t) {\n\t\t\t\tmessageTarget.removeEventListener('message', responseHandler);\n\t\t\t\tclearTimeout(failOntimeout);\n\t\t\t\tresolve(event.data.response);\n\t\t\t}\n\t\t};\n\n\t\tconst failOntimeout = setTimeout(() => {\n\t\t\treject(new Error('Request timed out'));\n\t\t\tmessageTarget.removeEventListener('message', responseHandler);\n\t\t}, timeout);\n\n\t\tmessageTarget.addEventListener('message', responseHandler);\n\t});\n}\n\n/**\n * Creates a response message to the given message ID.\n *\n * @see postMessageExpectReply\n * @param  requestId The message ID sent from the other thread by\n *                   `postMessageExpectReply` in the `message` event.\n * @param  response  The response to send back to the messageTarget.\n * @returns A message object that can be sent back to the other thread.\n */\nexport function responseTo<T>(\n\trequestId: number,\n\tresponse: T\n): MessageResponse<T> {\n\treturn {\n\t\ttype: 'response',\n\t\trequestId,\n\t\tresponse,\n\t};\n}\n\nexport interface MessageResponse<T> {\n\ttype: 'response';\n\trequestId: number;\n\tresponse: T;\n}\n\ninterface PostMessageTarget {\n\tpostMessage(message: any, ...args: any[]): void;\n}\n\ninterface IsomorphicEventTarget {\n\taddEventListener(type: string, listener: (event: any) => void): void;\n\tremoveEventListener(type: string, listener: (event: any) => void): void;\n}\n","/// <reference lib=\"WebWorker\" />\ndeclare const self: ServiceWorkerGlobalScope;\n\nimport { awaitReply, getNextRequestId } from './messaging';\nimport { getURLScope, isURLScoped, setURLScope } from '@php-wasm/scopes';\n\nexport async function convertFetchEventToPHPRequest(event: FetchEvent) {\n\tlet url = new URL(event.request.url);\n\n\tif (!isURLScoped(url)) {\n\t\ttry {\n\t\t\tconst referrerUrl = new URL(event.request.referrer);\n\t\t\turl = setURLScope(url, getURLScope(referrerUrl)!);\n\t\t} catch (e) {\n\t\t\t// ignore\n\t\t}\n\t}\n\n\tconst contentType = event.request.headers.get('content-type')!;\n\tconst body =\n\t\tevent.request.method === 'POST'\n\t\t\t? new Uint8Array(await event.request.clone().arrayBuffer())\n\t\t\t: undefined;\n\tconst requestHeaders: Record<string, string> = {};\n\tfor (const pair of (event.request.headers as any).entries()) {\n\t\trequestHeaders[pair[0]] = pair[1];\n\t}\n\n\tlet phpResponse;\n\ttry {\n\t\tconst message = {\n\t\t\tmethod: 'request',\n\t\t\targs: [\n\t\t\t\t{\n\t\t\t\t\tbody,\n\t\t\t\t\turl: url.toString(),\n\t\t\t\t\tmethod: event.request.method,\n\t\t\t\t\theaders: {\n\t\t\t\t\t\t...requestHeaders,\n\t\t\t\t\t\tHost: url.host,\n\t\t\t\t\t\t// Safari and Firefox don't make the User-Agent header\n\t\t\t\t\t\t// available in the fetch event. Let's add it manually:\n\t\t\t\t\t\t'User-agent': self.navigator.userAgent,\n\t\t\t\t\t\t'Content-type': contentType,\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t],\n\t\t};\n\t\tconst scope = getURLScope(url);\n\t\tif (scope === null) {\n\t\t\tthrow new Error(\n\t\t\t\t`The URL ${url.toString()} is not scoped. This should not happen.`\n\t\t\t);\n\t\t}\n\t\tconst requestId = await broadcastMessageExpectReply(message, scope);\n\t\tphpResponse = await awaitReply(self, requestId);\n\n\t\t// X-frame-options gets in a way when PHP is\n\t\t// being displayed in an iframe.\n\t\tdelete phpResponse.headers['x-frame-options'];\n\t} catch (e) {\n\t\tconsole.error(e, { url: url.toString() });\n\t\tthrow e;\n\t}\n\n\t/**\n\t * Safari has a bug that prevents Service Workers from redirecting relative URLs.\n\t * When attempting to redirect to a relative URL, the network request will return an error.\n\t * See the Webkit bug for details: https://bugs.webkit.org/show_bug.cgi?id=282427.\n\t *\n\t * Because PHP and WordPress can redirect to both relative and absolute URLs\n\t * using the `location` header we need to ensure redirects are processed\n\t * correctly by the Service Worker.\n\t *\n\t * As a workaround for Safari Service Workers, we use `Response.redirect()`\n\t * for all redirect responses (300-399 status codes) coming from PHP.\n\t * This solution was suggested in the Webkit bug comment:\n\t * https://bugs.webkit.org/show_bug.cgi?id=282427#c2\n\t */\n\tif (\n\t\tphpResponse.httpStatusCode >= 300 &&\n\t\tphpResponse.httpStatusCode <= 399 &&\n\t\tphpResponse.headers['location']\n\t) {\n\t\treturn Response.redirect(\n\t\t\tphpResponse.headers['location'][0],\n\t\t\tphpResponse.httpStatusCode\n\t\t);\n\t}\n\n\treturn new Response(phpResponse.bytes, {\n\t\theaders: phpResponse.headers,\n\t\tstatus: phpResponse.httpStatusCode,\n\t});\n}\n\n/**\n * Sends the message to all the controlled clients\n * of this service worker.\n *\n * This used to be implemented with a BroadcastChannel, but\n * it didn't work in Safari. BroadcastChannel breaks iframe\n * embedding the playground in Safari.\n *\n * Weirdly, Safari does not pass any messages from the ServiceWorker\n * to Window if the page is rendered inside an iframe. Window to Service\n * Worker communication works just fine.\n *\n * The regular client.postMessage() communication works perfectly, so that's\n * what this function uses to broadcast the message.\n *\n * @param  message The message to broadcast.\n * @param  scope   Target web worker scope.\n * @returns The request ID to receive the reply.\n */\nexport async function broadcastMessageExpectReply(message: any, scope: string) {\n\tconst requestId = getNextRequestId();\n\tfor (const client of await self.clients.matchAll({\n\t\t// Sometimes the client that triggered the current fetch()\n\t\t// event is considered uncontrolled in Google Chrome. This\n\t\t// only happens on the first few fetches() after the initial\n\t\t// registration of the service worker.\n\t\tincludeUncontrolled: true,\n\t})) {\n\t\tclient.postMessage({\n\t\t\t...message,\n\t\t\t/**\n\t\t\t * Attach the scope with a URL starting with `/scope:` to this message.\n\t\t\t *\n\t\t\t * We need this mechanics because this worker broadcasts\n\t\t\t * events to all the listeners across all browser tabs. Scopes\n\t\t\t * helps WASM workers ignore requests meant for other WASM workers.\n\t\t\t */\n\t\t\tscope,\n\t\t\trequestId,\n\t\t});\n\t}\n\treturn requestId;\n}\n\n/**\n * Copy a request with custom overrides.\n *\n * This function is only needed because Request properties\n * are read-only. The only way to change e.g. a URL is to\n * create an entirely new request:\n *\n * https://developer.mozilla.org/en-US/docs/Web/API/Request\n *\n * @param  request\n * @param  overrides\n * @returns The new request.\n */\nexport async function cloneRequest(\n\trequest: Request,\n\toverrides: Record<string, any>\n): Promise<Request> {\n\tconst body =\n\t\t['GET', 'HEAD'].includes(request.method) || 'body' in overrides\n\t\t\t? undefined\n\t\t\t: await request.blob();\n\n\treturn new Request(overrides['url'] || request.url, {\n\t\tbody,\n\t\tmethod: request.method,\n\t\theaders: request.headers,\n\t\treferrer: request.referrer,\n\t\treferrerPolicy: request.referrerPolicy,\n\t\tmode: request.mode === 'navigate' ? 'same-origin' : request.mode,\n\t\tcredentials: request.credentials,\n\t\tcache: request.cache,\n\t\tredirect: request.redirect,\n\t\tintegrity: request.integrity,\n\t\t...overrides,\n\t});\n}\n\n/**\n * Extracts headers from a Request as a plain key->value JS object.\n *\n * @param request\n * @returns\n */\nexport function getRequestHeaders(request: Request) {\n\tconst headers: Record<string, string> = {};\n\trequest.headers.forEach((value: string, key: string) => {\n\t\theaders[key] = value;\n\t});\n\treturn headers;\n}\n","import { cloneRequest } from '@php-wasm/web-service-worker';\n\nexport async function fetchWithCorsProxy(\n\tinput: RequestInfo,\n\tinit?: RequestInit,\n\tcorsProxyUrl?: string\n): Promise<Response> {\n\tconst directFetch = fetch(input, init);\n\tif (!corsProxyUrl) {\n\t\treturn directFetch;\n\t}\n\n\ttry {\n\t\treturn await directFetch;\n\t} catch {\n\t\tlet newInput: string | Request;\n\t\tif (typeof input === 'string' || input instanceof URL) {\n\t\t\tnewInput = `${corsProxyUrl}${input}`;\n\t\t} else if (input instanceof Request) {\n\t\t\tnewInput = await cloneRequest(input, {\n\t\t\t\turl: `${corsProxyUrl}${input.url}`,\n\t\t\t});\n\t\t} else {\n\t\t\tthrow new Error('Invalid input type for fetch');\n\t\t}\n\n\t\treturn fetch(newInput, init);\n\t}\n}\n","/**\n * Setup a postMessage relay between the parent window and a nested iframe.\n *\n * When we're running a Playground instance inside an iframe, sometimes that\n * iframe will contain another iframe and so on. The parent application,\n * however, needs to be able to communicate with the innermost iframe. This\n * function relays the communication both ways. Call it in in every iframe\n * layer between the topmost window and the innermost iframe.\n *\n * @param nestedFrame The nested iframe element\n * @param expectedOrigin The origin that the nested iframe is expected to be on. If not\n *                       provided, any origin is allowed.\n */\nexport function setupPostMessageRelay(\n\tnestedFrame: HTMLIFrameElement,\n\texpectedOrigin?: string\n) {\n\t// Relay Messages from WP to Parent\n\twindow.addEventListener('message', (event) => {\n\t\tif (event.source !== nestedFrame.contentWindow) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (expectedOrigin && event.origin !== expectedOrigin) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (typeof event.data !== 'object' || event.data.type !== 'relay') {\n\t\t\treturn;\n\t\t}\n\n\t\twindow.parent.postMessage(event.data, '*');\n\t});\n\n\t// Relay Messages from Parent to WP\n\twindow.addEventListener('message', (event) => {\n\t\tif (event.source !== window.parent) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (typeof event.data !== 'object' || event.data.type !== 'relay') {\n\t\t\treturn;\n\t\t}\n\n\t\tnestedFrame?.contentWindow?.postMessage(event.data);\n\t});\n}\n","/**\n * Spawns a new Worker Thread.\n *\n * @param  workerUrl The absolute URL of the worker script.\n * @returns The spawned Worker Thread.\n */\nexport async function spawnPHPWorkerThread(workerUrl: string) {\n\tconst worker = new Worker(workerUrl, { type: 'module' });\n\treturn new Promise<Worker>((resolve, reject) => {\n\t\tworker.onerror = (e) => {\n\t\t\tconst error = new Error(\n\t\t\t\t`WebWorker failed to load at ${workerUrl}. ${\n\t\t\t\t\te.message ? `Original error: ${e.message}` : ''\n\t\t\t\t}`\n\t\t\t);\n\t\t\t(error as any).filename = e.filename;\n\t\t\treject(error);\n\t\t};\n\t\t// There is no way to know when the worker script has started\n\t\t// executing, so we use a message to signal that.\n\t\tfunction onStartup(event: { data: string }) {\n\t\t\tif (event.data === 'worker-script-started') {\n\t\t\t\tresolve(worker);\n\t\t\t\tworker.removeEventListener('message', onStartup);\n\t\t\t}\n\t\t}\n\t\tworker.addEventListener('message', onStartup);\n\t});\n}\n","// @ts-ignore\nimport css from './style.module.css';\n\nexport interface ProgressBarOptions {\n\tcaption?: string;\n\tprogress?: number;\n\tisIndefinite?: boolean;\n\tvisible?: boolean;\n}\n\nclass ProgressBar {\n\telement: HTMLDivElement;\n\tcaptionElement: HTMLHeadingElement;\n\tcaption = 'Preparing WordPress';\n\tprogress = 0;\n\tisIndefinite = false;\n\tvisible = true;\n\n\tconstructor(options: ProgressBarOptions = {}) {\n\t\tthis.element = document.createElement('div');\n\t\tthis.captionElement = document.createElement('h3');\n\t\tthis.element.appendChild(this.captionElement);\n\t\tthis.setOptions(options);\n\t}\n\n\tsetOptions(options: ProgressBarOptions) {\n\t\tif ('caption' in options && options.caption) {\n\t\t\tthis.caption = options.caption!;\n\t\t}\n\t\tif ('progress' in options) {\n\t\t\tthis.progress = options.progress!;\n\t\t}\n\t\tif ('isIndefinite' in options) {\n\t\t\tthis.isIndefinite = options.isIndefinite!;\n\t\t}\n\t\tif ('visible' in options) {\n\t\t\tthis.visible = options.visible!;\n\t\t}\n\n\t\tthis.updateElement();\n\t}\n\n\tdestroy() {\n\t\tthis.setOptions({\n\t\t\tvisible: false,\n\t\t});\n\t\tsetTimeout(() => {\n\t\t\tthis.element.remove();\n\t\t}, 500);\n\t}\n\n\tupdateElement() {\n\t\tthis.element.className = '';\n\t\tthis.element.classList.add(css['overlay']);\n\n\t\tif (!this.visible) {\n\t\t\tthis.element.classList.add(css['isHidden']);\n\t\t}\n\n\t\tthis.captionElement.className = '';\n\t\tthis.captionElement.classList.add(css['caption']);\n\t\tthis.captionElement.textContent = this.caption + '...';\n\n\t\tconst progressBarWrapper = this.element.querySelector(\n\t\t\t`.${css['wrapper']}`\n\t\t);\n\t\tif (progressBarWrapper) {\n\t\t\tthis.element.removeChild(progressBarWrapper);\n\t\t}\n\n\t\tif (this.isIndefinite) {\n\t\t\tthis.element.appendChild(this.createProgressIndefinite());\n\t\t} else {\n\t\t\tthis.element.appendChild(this.createProgress());\n\t\t}\n\t}\n\n\tcreateProgress() {\n\t\tconst wrapper = document.createElement('div');\n\t\twrapper.classList.add(css['wrapper'], css['wrapperDefinite']);\n\n\t\tconst progressBar = document.createElement('div');\n\t\tprogressBar.classList.add(css['progressBar'], css['isDefinite']);\n\t\tprogressBar.style.width = this.progress + '%';\n\n\t\twrapper.appendChild(progressBar);\n\t\treturn wrapper;\n\t}\n\n\tcreateProgressIndefinite() {\n\t\tconst wrapper = document.createElement('div');\n\t\twrapper.classList.add(css['wrapper'], css['wrapperIndefinite']);\n\n\t\tconst progressBar = document.createElement('div');\n\t\tprogressBar.classList.add(css['progressBar'], css['isIndefinite']);\n\n\t\twrapper.appendChild(progressBar);\n\t\treturn wrapper;\n\t}\n}\n\nexport default ProgressBar;\n","/**\n * Used by the export step to exclude the Playground-specific files\n * from the zip file. Keep it in sync with the list of files created\n * by WordPressPatcher.\n */\nexport const wpContentFilesExcludedFromExport = [\n\t'db.php',\n\t'plugins/akismet',\n\t'plugins/hello.php',\n\t'plugins/wordpress-importer',\n\t'mu-plugins/sqlite-database-integration',\n\t'mu-plugins/playground-includes',\n\t'mu-plugins/0-playground.php',\n\t'mu-plugins/0-sqlite.php',\n\n\t/*\n\t * Listing core themes like that here isn't ideal, especially since\n\t * developers may actually want to use one of them.\n\t * @TODO Let's give the user a choice whether or not to include them.\n\t */\n\t'themes/twentytwenty',\n\t'themes/twentytwentyone',\n\t'themes/twentytwentytwo',\n\t'themes/twentytwentythree',\n\t'themes/twentytwentyfour',\n\t'themes/twentytwentyfive',\n\t'themes/twentytwentysix',\n];\n","import { StepHandler } from '.';\nimport { logger } from '@php-wasm/logger';\n/**\n * @inheritDoc activatePlugin\n * @example\n *\n * <code>\n * {\n * \t\t\"step\": \"activatePlugin\",\n * \t\t\"pluginName\": \"Gutenberg\",\n * \t\t\"pluginPath\": \"/wordpress/wp-content/plugins/gutenberg\"\n * }\n * </code>\n */\nexport interface ActivatePluginStep {\n\tstep: 'activatePlugin';\n\t/**\n\t * Path to the plugin directory as absolute path\n\t * (/wordpress/wp-content/plugins/plugin-name); or the plugin entry file\n\t * relative to the plugins directory (plugin-name/plugin-name.php).\n\t */\n\tpluginPath: string;\n\t/** Optional. Plugin name to display in the progress bar. */\n\tpluginName?: string;\n}\n\n/**\n * Activates a WordPress plugin (if it's installed).\n *\n * @param playground The playground client.\n */\nexport const activatePlugin: StepHandler<ActivatePluginStep> = async (\n\tplayground,\n\t{ pluginPath, pluginName },\n\tprogress\n) => {\n\tprogress?.tracker.setCaption(`Activating ${pluginName || pluginPath}`);\n\n\tconst docroot = await playground.documentRoot;\n\tconst activatePluginResult = await playground.run({\n\t\tcode: `<?php\n\t\t\tdefine( 'WP_ADMIN', true );\n\t\t\trequire_once( getenv('DOCROOT') . \"/wp-load.php\" );\n\t\t\trequire_once( getenv('DOCROOT') . \"/wp-admin/includes/plugin.php\" );\n\n\t\t\t// Set current user to admin\n\t\t\twp_set_current_user( get_users(array('role' => 'Administrator') )[0]->ID );\n\n\t\t\t$plugin_path = getenv('PLUGIN_PATH');\n\t\t\t$response = false;\n\t\t\tif ( ! is_dir( $plugin_path)) {\n\t\t\t\t$response = activate_plugin($plugin_path);\n\t\t\t}\n\n\t\t\t// Activate plugin by name if activation by path wasn't successful\n\t\t\tif ( null !== $response ) {\n\t\t\t\tforeach ( ( glob( $plugin_path . '/*.php' ) ?: array() ) as $file ) {\n\t\t\t\t\t$info = get_plugin_data( $file, false, false );\n\t\t\t\t\tif ( ! empty( $info['Name'] ) ) {\n\t\t\t\t\t\t$response = activate_plugin( $file );\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif ( is_wp_error($response) ) {\n\t\t\t\tdie( $response->get_error_message() );\n\t\t\t} else if ( false === $response ) {\n\t\t\t\tdie( \"The activatePlugin step wasn't able to find the plugin $plugin_path.\" );\n\t\t\t}\n\t\t`,\n\t\tenv: {\n\t\t\tPLUGIN_PATH: pluginPath,\n\t\t\tDOCROOT: docroot,\n\t\t},\n\t});\n\tif (activatePluginResult.text) {\n\t\tlogger.warn(\n\t\t\t`Plugin ${pluginPath} activation printed the following bytes: ${activatePluginResult.text}`\n\t\t);\n\t}\n\n\t/**\n\t * Instead of checking the plugin activation response,\n\t * check if the plugin is active by looking at the active plugins list.\n\t *\n\t * We have to split the activation and the check into two PHP runs\n\t * because some plugins might redirect during activation,\n\t * which would prevent any output that happens after activation from being returned.\n\t *\n\t * Relying on the plugin activation response is not reliable because if the plugin activation\n\t * produces any output, WordPress will assume it's an activation error and return a WP_Error.\n\t * WordPress will still activate the plugin and load the required page,\n\t * but it will also show the error as a notice in wp-admin.\n\t * See WordPress source code for more details:\n\t * https://github.com/WordPress/wordpress-develop/blob/6.7/src/wp-admin/includes/plugin.php#L733\n\t *\n\t * Because some plugins can create an output, we need to use output buffering\n\t * to ensure the 'true' response is not polluted by other outputs.\n\t * If the plugin activation fails, we will return the buffered output as it might\n\t * contain more information about the failure.\n\t */\n\tconst isActiveCheckResult = await playground.run({\n\t\tcode: `<?php\n\t\t\tob_start();\n\t\t\trequire_once( getenv( 'DOCROOT' ) . \"/wp-load.php\" );\n\n\t\t\t/**\n\t\t\t * Extracts the relative plugin path from either an absolute or relative plugin path.\n\t\t\t *\n\t\t\t * Absolute paths starting with plugin directory (e.g., '/wordpress/wp-content/plugins/test-plugin/index.php')\n\t\t\t * should be converted to relative paths (e.g., 'test-plugin/index.php')\n\t\t\t *\n\t\t\t * Directories should finish with a trailing slash to ensure we match the full plugin directory name.\n\t\t\t *\n\t\t\t * Examples:\n\t\t\t * - '/wordpress/wp-content/plugins/test-plugin/index.php' → 'test-plugin/index.php'\n\t\t\t * - '/wordpress/wp-content/plugins/test-plugin/' → 'test-plugin/'\n\t\t\t * - '/wordpress/wp-content/plugins/test-plugin' → 'test-plugin/'\n\t\t\t * - 'test-plugin/index.php' → 'test-plugin/index.php'\n\t\t\t * - 'test-plugin/' → 'test-plugin/'\n\t\t\t * - 'test-plugin' → 'test-plugin/'\n\t\t\t */\n\t\t\t$plugin_directory = WP_PLUGIN_DIR . '/';\n\t\t\t$relative_plugin_path = getenv( 'PLUGIN_PATH' );\n\t\t\tif (strpos($relative_plugin_path, $plugin_directory) === 0) {\n\t\t\t\t$relative_plugin_path = substr($relative_plugin_path, strlen($plugin_directory));\n\t\t\t}\n\n\t\t\tif ( is_dir( $plugin_directory . $relative_plugin_path ) ) {\n\t\t\t\t$relative_plugin_path = rtrim( $relative_plugin_path, '/' ) . '/';\n\t\t\t}\n\n\t\t\t$active_plugins = get_option( 'active_plugins' );\n\t\t\tforeach ( $active_plugins as $plugin ) {\n\t\t\t\tif ( substr( $plugin, 0, strlen( $relative_plugin_path ) ) === $relative_plugin_path ) {\n\t\t\t\t\tob_end_clean();\n\t\t\t\t\tdie( 'true' );\n\t\t\t\t}\n\t\t\t}\n\t\t\tdie( ob_get_flush() ?: 'false' );\n\t\t`,\n\t\tenv: {\n\t\t\tDOCROOT: docroot,\n\t\t\tPLUGIN_PATH: pluginPath,\n\t\t},\n\t});\n\n\tif (isActiveCheckResult.text === 'true') {\n\t\t// Plugin activation was successful, yay!\n\t\treturn;\n\t}\n\n\tif (isActiveCheckResult.text !== 'false') {\n\t\tlogger.debug(isActiveCheckResult.text);\n\t}\n\tthrow new Error(\n\t\t`Plugin ${pluginPath} could not be activated – WordPress exited with no error. ` +\n\t\t\t`Sometimes, when $_SERVER or site options are not configured correctly, ` +\n\t\t\t`WordPress exits early with a 301 redirect. ` +\n\t\t\t`Inspect the \"debug\" logs in the console for more details.`\n\t);\n};\n","import { StepHandler } from '.';\nimport { logger } from '@php-wasm/logger';\n\n/**\n * @inheritDoc activateTheme\n * @example\n *\n * <code>\n * {\n * \t\t\"step\": \"activateTheme\",\n * \t\t\"themeFolderName\": \"storefront\"\n * }\n * </code>\n */\nexport interface ActivateThemeStep {\n\tstep: 'activateTheme';\n\t/**\n\t * The name of the theme folder inside wp-content/themes/\n\t */\n\tthemeFolderName: string;\n}\n\n/**\n * Activates a WordPress theme (if it's installed).\n *\n * @param playground The playground client.\n * @param themeFolderName The theme folder name.\n */\nexport const activateTheme: StepHandler<ActivateThemeStep> = async (\n\tplayground,\n\t{ themeFolderName },\n\tprogress\n) => {\n\tprogress?.tracker.setCaption(`Activating ${themeFolderName}`);\n\tconst docroot = await playground.documentRoot;\n\n\tconst themeFolderPath = `${docroot}/wp-content/themes/${themeFolderName}`;\n\tif (!(await playground.fileExists(themeFolderPath))) {\n\t\tthrow new Error(`\n\t\t\tCouldn't activate theme ${themeFolderName}.\n\t\t\tTheme not found at the provided theme path: ${themeFolderPath}.\n\t\t\tCheck the theme path to ensure it's correct.\n\t\t\tIf the theme is not installed, you can install it using the installTheme step.\n\t\t\tMore info can be found in the Blueprint documentation: https://wordpress.github.io/wordpress-playground/blueprints/steps/#ActivateThemeStep\n\t\t`);\n\t}\n\tconst result = await playground.run({\n\t\tcode: `<?php\n\t\t\tdefine( 'WP_ADMIN', true );\n\t\t\trequire_once( getenv('docroot') . \"/wp-load.php\" );\n\n\t\t\t// Set current user to admin\n\t\t\twp_set_current_user( get_users(array('role' => 'Administrator') )[0]->ID );\n\n\t\t\tswitch_theme( getenv('themeFolderName') );\n\n\t\t\tif( wp_get_theme()->get_stylesheet() !== getenv('themeFolderName') ) {\n\t\t\t\tthrow new Exception( 'Theme ' . getenv('themeFolderName') . ' could not be activated.' );\t\t\t\t\n\t\t\t}\n\t\t\tdie('Theme activated successfully');\n\t\t`,\n\t\tenv: {\n\t\t\tdocroot,\n\t\t\tthemeFolderName,\n\t\t},\n\t});\n\tif (result.text !== 'Theme activated successfully') {\n\t\tlogger.debug(result);\n\t\tthrow new Error(\n\t\t\t`Theme ${themeFolderName} could not be activated – WordPress exited with no error. ` +\n\t\t\t\t`Sometimes, when $_SERVER or site options are not configured correctly, ` +\n\t\t\t\t`WordPress exits early with a 301 redirect. ` +\n\t\t\t\t`Inspect the \"debug\" logs in the console for more details`\n\t\t);\n\t}\n};\n","import { PHPResponse } from '@php-wasm/universal';\nimport { StepHandler } from '.';\n\n/**\n * @inheritDoc runPHP\n * @hasRunnableExample\n * @example\n *\n * <code>\n * {\n * \t\t\"step\": \"runPHP\",\n * \t\t\"code\": \"<?php require_once 'wordpress/wp-load.php';\n * \t\twp_insert_post(array('post_title' => 'wp-load.php required for WP\n * \t\tfunctionality', 'post_status' => 'publish')); ?>\"\n * }\n * </code>\n */\nexport interface RunPHPStep {\n\t/** The step identifier. */\n\tstep: 'runPHP';\n\t/** The PHP code to run. */\n\tcode: string;\n}\n\n/**\n * Runs PHP code.\n * When running WordPress functions, the `code` key must first load [`wp-load.php`](https://github.com/WordPress/WordPress/blob/master/wp-load.php) and start with `\"<?php require_once 'wordpress/wp-load.php'; \"`.\n */\nexport const runPHP: StepHandler<RunPHPStep, Promise<PHPResponse>> = async (\n\tplayground,\n\t{ code }\n) => {\n\treturn await playground.run({ code });\n};\n","import { StepHandler } from '.';\nimport { PHPRunOptions } from '@php-wasm/universal';\n\n/**\n * @inheritDoc runPHP\n * @hasRunnableExample\n * @example\n *\n * <code>\n * {\n * \t\t\"step\": \"runPHP\",\n * \t\t\"options\": {\n * \t\t\t\"code\": \"<?php echo $_SERVER['CONTENT_TYPE']; ?>\",\n * \t\t\t\"headers\": {\n * \t\t\t\t\"Content-type\": \"text/plain\"\n * \t\t\t}\n * \t\t}\n * }\n * </code>\n */\nexport interface RunPHPWithOptionsStep {\n\tstep: 'runPHPWithOptions';\n\t/**\n\t * Run options (See\n\t * /wordpress-playground/api/universal/interface/PHPRunOptions/))\n\t */\n\toptions: PHPRunOptions;\n}\n\n/**\n * Runs PHP code with the given options.\n */\nexport const runPHPWithOptions: StepHandler<RunPHPWithOptionsStep> = async (\n\tplayground,\n\t{ options }\n) => {\n\treturn await playground.run(options);\n};\n","import { StepHandler } from '.';\n\n/**\n * @inheritDoc rm\n * @hasRunnableExample\n * @landingPage /index.php\n * @example\n *\n * <code>\n * {\n * \t\t\"step\": \"rm\",\n * \t\t\"path\": \"/wordpress/index.php\"\n * }\n * </code>\n */\nexport interface RmStep {\n\tstep: 'rm';\n\t/** The path to remove */\n\tpath: string;\n}\n\n/**\n * Removes a file at the specified path.\n */\nexport const rm: StepHandler<RmStep> = async (playground, { path }) => {\n\tawait playground.unlink(path);\n};\n","import { StepHandler } from '.';\nimport { rm } from './rm';\nimport { phpVars, randomFilename } from '@php-wasm/util';\n\n/**\n * @inheritDoc runSql\n * @hasRunnableExample\n * @example\n *\n * <code>\n * {\n *\t\t\"step\": \"runSql\",\n *\t\t\"sql\": {\n *\t\t\t\"resource\": \"literal\",\n *\t\t\t\"name\": \"schema.sql\",\n *\t\t\t\"contents\": \"DELETE FROM wp_posts\"\n *\t\t}\n * }\n * </code>\n */\nexport interface RunSqlStep<ResourceType> {\n\t/**\n\t * The step identifier.\n\t */\n\tstep: 'runSql';\n\t/**\n\t * The SQL to run. Each non-empty line must contain a valid SQL query.\n\t */\n\tsql: ResourceType;\n}\n\n/**\n * Run one or more SQL queries.\n *\n * This step will treat each non-empty line in the input SQL as a query and\n * try to execute it using `$wpdb`. Queries spanning multiple lines are not\n * yet supported.\n */\nexport const runSql: StepHandler<RunSqlStep<File>> = async (\n\tplayground,\n\t{ sql },\n\tprogress?\n) => {\n\tprogress?.tracker.setCaption(`Executing SQL Queries`);\n\n\tconst sqlFilename = `/tmp/${randomFilename()}.sql`;\n\n\tawait playground.writeFile(\n\t\tsqlFilename,\n\t\tnew Uint8Array(await sql.arrayBuffer())\n\t);\n\n\tconst docroot = await playground.documentRoot;\n\n\tconst js = phpVars({ docroot, sqlFilename });\n\n\tconst runPhp = await playground.run({\n\t\tcode: `<?php\n\t\trequire_once ${js.docroot} . '/wp-load.php';\n\n\t\t$handle = fopen(${js.sqlFilename}, 'r');\n\n\t\tglobal $wpdb;\n\n\t\twhile ($line = fgets($handle)) {\n\t\t\tif(trim($line, \" \\n;\") === '') {\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\t$wpdb->query($line);\n\t\t}\n\t`,\n\t});\n\n\tawait rm(playground, { path: sqlFilename });\n\n\treturn runPhp;\n};\n","import { PHPRequest, PHPResponse } from '@php-wasm/universal';\nimport { StepHandler } from '.';\nimport { logger } from '@php-wasm/logger';\n\n/**\n * @private\n * @inheritDoc request\n * @needsLogin\n * @hasRunnableExample\n * @example\n *\n * <code>\n * {\n * \t\t\"step\": \"request\",\n * \t\t\"request\": {\n * \t\t\t\"method\": \"POST\",\n * \t\t\t\"url\": \"/wp-admin/admin-ajax.php\",\n * \t\t\t\"formData\": {\n * \t\t\t\t\"action\": \"my_action\",\n * \t\t\t\t\"foo\": \"bar\"\n * \t\t\t}\n * \t\t}\n * }\n * </code>\n */\nexport interface RequestStep {\n\tstep: 'request';\n\t/**\n\t * Request details (See\n\t * /wordpress-playground/api/universal/interface/PHPRequest)\n\t */\n\trequest: PHPRequest;\n}\n\n/**\n * Sends a HTTP request to Playground.\n */\nexport const request: StepHandler<RequestStep, Promise<PHPResponse>> = async (\n\tplayground,\n\t{ request }\n) => {\n\tlogger.warn(\n\t\t'Deprecated: The Blueprint step \"request\" is deprecated and will be removed in a future release.'\n\t);\n\tconst response = await (playground as any).request(request);\n\tif (response.httpStatusCode > 399 || response.httpStatusCode < 200) {\n\t\tlogger.warn('WordPress response was', { response });\n\t\tthrow new Error(\n\t\t\t`Request failed with status ${response.httpStatusCode}`\n\t\t);\n\t}\n\treturn response;\n};\n","export default \"<?php\\n\\n/**\\n * Rewrites the wp-config.php file to ensure specific constants are defined\\n * with specific values.\\n * \\n * Example:\\n * \\n * ```php\\n * <?php\\n * define('WP_DEBUG', true);\\n * // The third define() argument is also supported:\\n * define('SAVEQUERIES', false, true);\\n * \\n * // Expression\\n * define(true ? 'WP_DEBUG_LOG' : 'WP_DEBUG_LOG', 123);\\n * \\n * // Guarded expressions shouldn't be wrapped twice\\n * if(!defined(1 ? 'A' : 'B')) {\\n *     define(1 ? 'A' : 'B', 0);\\n * }\\n * \\n * // More advanced expression\\n * define((function() use($x) {\\n *     return [$x, 'a'];\\n * })(), 123);\\n * ```\\n * \\n * Rewritten with\\n * \\n *     $constants = [\\n *        'WP_DEBUG' => false,\\n *        'WP_DEBUG_LOG' => true,\\n *        'SAVEQUERIES' => true,\\n *        'NEW_CONSTANT' => \\\"new constant\\\",\\n *     ];\\n * \\n * ```php\\n * <?php\\n * define('WP_DEBUG_LOG',true);\\n * define('NEW_CONSTANT','new constant');\\n * ?><?php\\n * define('WP_DEBUG',false);\\n * // The third define() argument is also supported:\\n * define('SAVEQUERIES',true, true);\\n * \\n * // Expression\\n * if(!defined($const ? 'WP_DEBUG_LOG' : 'WP_DEBUG_LOG')) {\\n *      define($const ? 'WP_DEBUG_LOG' : 'WP_DEBUG_LOG', 123);\\n * }\\n * \\n * // Guarded expressions shouldn't be wrapped twice\\n * if(!defined(1 ? 'A' : 'B')) {\\n *     define(1 ? 'A' : 'B', 0);\\n * }\\n * \\n * // More advanced expression\\n * if(!defined((function() use($x) {\\n *    return [$x, 'a'];\\n * })())) {\\n *     define((function() use($x) {\\n *         return [$x, 'a'];\\n *     })(), 123);\\n * }\\n * ```\\n * \\n * @param mixed $content\\n * @return string\\n */\\nfunction rewrite_wp_config_to_define_constants($content, $constants = [])\\n{\\n    $tokens = array_reverse(token_get_all($content));\\n    $output = [];\\n    $defined_expressions = [];\\n\\n    // Look through all the tokens and find the define calls\\n    do {\\n        $buffer = [];\\n        $name_buffer = [];\\n        $value_buffer = [];\\n        $third_arg_buffer = [];\\n\\n        // Capture everything until the define call into output.\\n        // Capturing the define call into a buffer.\\n        // Example:\\n        //     <?php echo 'a'; define  (\\n        //     ^^^^^^^^^^^^^^^^^^^^^^\\n        //           output   |buffer\\n        while ($token = array_pop($tokens)) {\\n            if (is_array($token) && $token[0] === T_STRING && (strtolower($token[1]) === 'define' || strtolower($token[1]) === 'defined')) {\\n                $buffer[] = $token;\\n                break;\\n            }\\n            $output[] = $token;\\n        }\\n\\n        // Maybe we didn't find a define call and reached the end of the file?\\n        if (!count($tokens)) {\\n            break;\\n        }\\n\\n        // Keep track of the \\\"defined\\\" expressions that are already accounted for\\n        if($token[1] === 'defined') {\\n            $output[] = $token;\\n            $defined_expression = [];\\n            $open_parenthesis = 0;\\n            // Capture everything up to the opening parenthesis, including the parenthesis\\n            // e.g. defined  (\\n            //           ^^^^\\n            while ($token = array_pop($tokens)) {\\n                $output[] = $token;\\n                if ($token === \\\"(\\\") {\\n                    ++$open_parenthesis;\\n                    break;\\n                }\\n            }\\n\\n            // Capture everything up to the closing parenthesis, including the parenthesis\\n            // e.g. defined  (\\n            //           ^^^^\\n            while ($token = array_pop($tokens)) {\\n                $output[] = $token;\\n                if ($token === \\\")\\\") {\\n                    --$open_parenthesis;\\n                }\\n                if ($open_parenthesis === 0) {\\n                    break;\\n                }\\n                $defined_expression[] = $token;\\n            }\\n\\n            $defined_expressions[] = stringify_tokens(skip_whitespace($defined_expression));\\n            continue;\\n        }\\n\\n        // Capture everything up to the opening parenthesis, including the parenthesis\\n        // e.g. define  (\\n        //           ^^^^\\n        while ($token = array_pop($tokens)) {\\n            $buffer[] = $token;\\n            if ($token === \\\"(\\\") {\\n                break;\\n            }\\n        }\\n\\n        // Capture the first argument – it's the first expression after the opening\\n        // parenthesis and before the comma:\\n        // Examples:\\n        //     define(\\\"WP_DEBUG\\\", true);\\n        //            ^^^^^^^^^^^\\n        //\\n        //     define(count([1,2]) > 2 ? 'WP_DEBUG' : 'FOO', true);\\n        //            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\\n        $open_parenthesis = 0;\\n        while ($token = array_pop($tokens)) {\\n            $buffer[] = $token;\\n            if ($token === \\\"(\\\" || $token === \\\"[\\\" || $token === \\\"{\\\") {\\n                ++$open_parenthesis;\\n            } elseif ($token === \\\")\\\" || $token === \\\"]\\\" || $token === \\\"}\\\") {\\n                --$open_parenthesis;\\n            } elseif ($token === \\\",\\\" && $open_parenthesis === 0) {\\n                break;\\n            }\\n\\n            // Don't capture the comma as a part of the constant name\\n            $name_buffer[] = $token;\\n        }\\n\\n        // Capture everything until the closing parenthesis\\n        //     define(\\\"WP_DEBUG\\\", true);\\n        //                       ^^^^^^\\n        $open_parenthesis = 0;\\n        $is_second_argument = true;\\n        while ($token = array_pop($tokens)) {\\n            $buffer[] = $token;\\n            if ($token === \\\")\\\" && $open_parenthesis === 0) {\\n                // Final parenthesis of the define call.\\n                break;\\n            } else if ($token === \\\"(\\\" || $token === \\\"[\\\" || $token === \\\"{\\\") {\\n                ++$open_parenthesis;\\n            } elseif ($token === \\\")\\\" || $token === \\\"]\\\" || $token === \\\"}\\\") {\\n                --$open_parenthesis;\\n            } elseif ($token === \\\",\\\" && $open_parenthesis === 0) {\\n                // This define call has more than 2 arguments! The third one is the\\n                // boolean value indicating $is_case_insensitive. Let's continue capturing\\n                // to $third_arg_buffer.\\n                $is_second_argument = false;\\n            }\\n            if ($is_second_argument) {\\n                $value_buffer[] = $token;\\n            } else {\\n                $third_arg_buffer[] = $token;\\n            }\\n        }\\n\\n        // Capture until the semicolon\\n        //     define(\\\"WP_DEBUG\\\", true)  ;\\n        //                             ^^^\\n        while ($token = array_pop($tokens)) {\\n            $buffer[] = $token;\\n            if ($token === \\\";\\\") {\\n                break;\\n            }\\n        }\\n\\n        // Decide whether $name_buffer is a constant name or an expression\\n        $name_token = null;\\n        $name_token_index = $token;\\n        $name_is_literal = true;\\n        foreach ($name_buffer as $k => $token) {\\n            if (is_array($token)) {\\n                if ($token[0] === T_WHITESPACE || $token[0] === T_COMMENT || $token[0] === T_DOC_COMMENT) {\\n                    continue;\\n                } else if ($token[0] === T_STRING || $token[0] === T_CONSTANT_ENCAPSED_STRING) {\\n                    $name_token = $token;\\n                    $name_token_index = $k;\\n                } else {\\n                    $name_is_literal = false;\\n                    break;\\n                }\\n            } else if ($token !== \\\"(\\\" && $token !== \\\")\\\") {\\n                $name_is_literal = false;\\n                break;\\n            }\\n        }\\n\\n        // We can't handle expressions as constant names. Let's wrap that define\\n        // call in an if(!defined()) statement, just in case it collides with\\n        // a constant name.\\n        if (!$name_is_literal) {\\n            // Ensure the defined expression is not already accounted for\\n            foreach ($defined_expressions as $defined_expression) {\\n                if ($defined_expression === stringify_tokens(skip_whitespace($name_buffer))) {\\n                    $output = array_merge($output, $buffer);\\n                    continue 2;\\n                }\\n            }\\n            $output = array_merge(\\n                $output,\\n                [\\\"if(!defined(\\\"],\\n                $name_buffer,\\n                [\\\")) {\\\\n     \\\"],\\n                ['define('],\\n                $name_buffer,\\n                [','],\\n                $value_buffer,\\n                $third_arg_buffer,\\n                [\\\");\\\"],\\n                [\\\"\\\\n}\\\\n\\\"]\\n            );\\n            continue;\\n        }\\n\\n        // Yay, we have a literal constant name in the buffer now. Let's\\n        // get its value:\\n        $name = eval('return ' . $name_token[1] . ';');\\n\\n        // If the constant name is not in the list of constants we're looking,\\n        // we can ignore it.\\n        if (!array_key_exists($name, $constants)) {\\n            $output = array_merge($output, $buffer);\\n            continue;\\n        }\\n\\n        // We now have a define() call that defines a constant we're looking for.\\n        // Let's rewrite its value to the one \\n        $output = array_merge(\\n            $output,\\n            ['define('],\\n            $name_buffer,\\n            [','],\\n            [var_export($constants[$name], true)],\\n            $third_arg_buffer,\\n            [\\\");\\\"]\\n        );\\n\\n        // Remove the constant from the list so we can process any remaining\\n        // constants later.\\n        unset($constants[$name]);\\n    } while (count($tokens));\\n\\n    // Add any constants that weren't found in the file\\n    if (count($constants)) {\\n        $prepend = [\\n            \\\"<?php \\\\n\\\"\\n        ];\\n        foreach ($constants as $name => $value) {\\n            $prepend = array_merge(\\n                $prepend,\\n                [\\n                    \\\"define(\\\",\\n                    var_export($name, true),\\n                    ',',\\n                    var_export($value, true),\\n                    \\\");\\\\n\\\"\\n                ]\\n            );\\n        }\\n        $prepend[] = \\\"?>\\\";\\n        $output = array_merge(\\n            $prepend,\\n            $output\\n        );\\n    }\\n\\n    // Translate the output tokens back into a string\\n    return stringify_tokens($output);\\n}\\n\\nfunction stringify_tokens($tokens) {\\n    $output = '';\\n    foreach ($tokens as $token) {\\n        if (is_array($token)) {\\n            $output .= $token[1];\\n        } else {\\n            $output .= $token;\\n        }\\n    }\\n    return $output;\\n}\\n\\nfunction skip_whitespace($tokens) {\\n    $output = [];\\n    foreach ($tokens as $token) {\\n        if (is_array($token) && ($token[0] === T_WHITESPACE || $token[0] === T_COMMENT || $token[0] === T_DOC_COMMENT)) {\\n            continue;\\n        }\\n        $output[] = $token;\\n    }\\n    return $output;\\n}\\n\"","import { joinPaths, phpVars } from '@php-wasm/util';\nimport { StepHandler } from '.';\n/** @ts-ignore */\nimport rewriteWpConfigToDefineConstants from './rewrite-wp-config-to-define-constants.php?raw';\nimport { UniversalPHP } from '@php-wasm/universal';\n\n/**\n * @inheritDoc defineWpConfigConsts\n * @hasRunnableExample\n * @example\n *\n * <code>\n * {\n * \t\t\"step\": \"defineWpConfigConsts\",\n * \t\t\"consts\": {\n *          \"WP_DEBUG\": true\n *      }\n * }\n * </code>\n */\nexport interface DefineWpConfigConstsStep {\n\tstep: 'defineWpConfigConsts';\n\t/** The constants to define */\n\tconsts: Record<string, unknown>;\n\t/**\n\t * The method of defining the constants in wp-config.php. Possible values are:\n\t *\n\t * - rewrite-wp-config: Default. Rewrites the wp-config.php file to\n\t *                      explicitly call define() with the requested\n\t *                      name and value. This method alters the file\n\t *                      on the disk, but it doesn't conflict with\n\t *                      existing define() calls in wp-config.php.\n\t *\n\t * - define-before-run: Defines the constant before running the requested\n\t *                      script. It doesn't alter any files on the disk, but\n\t *                      constants defined this way may conflict with existing\n\t *                      define() calls in wp-config.php.\n\t */\n\tmethod?: 'rewrite-wp-config' | 'define-before-run';\n\t/**\n\t * @deprecated This option is noop and will be removed in a future version.\n\t * This option is only kept in here to avoid breaking Blueprint schema validation\n\t * for existing apps using this option.\n\t */\n\tvirtualize?: boolean;\n}\n\n/**\n * Defines constants in a [`wp-config.php`](https://developer.wordpress.org/advanced-administration/wordpress/wp-config/) file.\n *\n * This step can be called multiple times, and the constants will be merged.\n *\n * @param playground The playground client.\n * @param wpConfigConst\n */\nexport const defineWpConfigConsts: StepHandler<\n\tDefineWpConfigConstsStep\n> = async (playground, { consts, method = 'define-before-run' }) => {\n\tswitch (method) {\n\t\tcase 'define-before-run':\n\t\t\tawait defineBeforeRun(playground, consts);\n\t\t\tbreak;\n\t\tcase 'rewrite-wp-config': {\n\t\t\tconst documentRoot = await playground.documentRoot;\n\t\t\tconst wpConfigPath = joinPaths(documentRoot, '/wp-config.php');\n\t\t\tconst wpConfig = await playground.readFileAsText(wpConfigPath);\n\t\t\tconst updatedWpConfig = await rewriteDefineCalls(\n\t\t\t\tplayground,\n\t\t\t\twpConfig,\n\t\t\t\tconsts\n\t\t\t);\n\t\t\tawait playground.writeFile(wpConfigPath, updatedWpConfig);\n\t\t\tbreak;\n\t\t}\n\t\tdefault:\n\t\t\tthrow new Error(`Invalid method: ${method}`);\n\t}\n};\n\nexport async function defineBeforeRun(\n\tplayground: UniversalPHP,\n\tconsts: Record<string, unknown>\n) {\n\tfor (const key in consts) {\n\t\tawait playground.defineConstant(key, consts[key] as string);\n\t}\n}\n\nexport async function rewriteDefineCalls(\n\tplayground: UniversalPHP,\n\tphpCode: string,\n\tconsts: Record<string, unknown>\n): Promise<string> {\n\tawait playground.writeFile('/tmp/code.php', phpCode);\n\tconst js = phpVars({\n\t\tconsts,\n\t});\n\tawait playground.run({\n\t\tcode: `${rewriteWpConfigToDefineConstants}\n\t$wp_config_path = '/tmp/code.php';\n\t$wp_config = file_get_contents($wp_config_path);\n\t$new_wp_config = rewrite_wp_config_to_define_constants($wp_config, ${js.consts});\n\tfile_put_contents($wp_config_path, $new_wp_config);\n\t`,\n\t});\n\treturn await playground.readFileAsText('/tmp/code.php');\n}\n","import { phpVar } from '@php-wasm/util';\nimport { StepHandler } from '.';\n\n/**\n * @inheritDoc setSiteOptions\n * @hasRunnableExample\n *\n * @example\n *\n * <code>\n * {\n *     \"step\": \"setSiteOptions\",\n *     \"options\": {\n *         \"blogname\": \"My Blog\",\n *         \"blogdescription\": \"A great blog\"\n *     }\n * }\n * </code>\n */\nexport type SetSiteOptionsStep = {\n\t/** The name of the step. Must be \"setSiteOptions\". */\n\tstep: 'setSiteOptions';\n\t/** The options to set on the site. */\n\toptions: Record<string, unknown>;\n};\n\n/**\n * Sets site options. This is equivalent to calling [`update_option`](https://developer.wordpress.org/reference/functions/update_option/) for each\n * option in the [`options`](https://developer.wordpress.org/apis/options/#available-options-by-category) object.\n */\nexport const setSiteOptions: StepHandler<SetSiteOptionsStep> = async (\n\tphp,\n\t{ options }\n) => {\n\tconst docroot = await php.documentRoot;\n\tawait php.run({\n\t\tcode: `<?php\n\t\tinclude ${phpVar(docroot)} . '/wp-load.php';\n\t\t$site_options = ${phpVar(options)};\n\t\tforeach($site_options as $name => $value) {\n\t\t\tupdate_option($name, $value);\n\t\t}\n\t\techo \"Success\";\n\t\t`,\n\t});\n};\n\n/**\n * @inheritDoc updateUserMeta\n * @hasRunnableExample\n *\n * @example\n *\n * <code>\n * {\n *     \"step\": \"updateUserMeta\",\n *     \"meta\": {\n * \t       \"first_name\": \"John\",\n * \t       \"last_name\": \"Doe\"\n *     },\n *     \"userId\": 1\n * }\n * </code>\n */\nexport interface UpdateUserMetaStep {\n\tstep: 'updateUserMeta';\n\t/** An object of user meta values to set, e.g. { \"first_name\": \"John\" } */\n\tmeta: Record<string, unknown>;\n\t/** User ID */\n\tuserId: number;\n}\n\n/**\n * Updates user meta. This is equivalent to calling [`update_user_meta`](https://developer.wordpress.org/reference/functions/update_user_meta/) for each\n * meta value in the `meta` object.\n */\nexport const updateUserMeta: StepHandler<UpdateUserMetaStep> = async (\n\tphp,\n\t{ meta, userId }\n) => {\n\tconst docroot = await php.documentRoot;\n\tawait php.run({\n\t\tcode: `<?php\n\t\tinclude ${phpVar(docroot)} . '/wp-load.php';\n\t\t$meta = ${phpVar(meta)};\n\t\tforeach($meta as $name => $value) {\n\t\t\tupdate_user_meta(${phpVar(userId)}, $name, $value);\n\t\t}\n\t\t`,\n\t});\n};\n","import { PHPResponse, UniversalPHP } from '@php-wasm/universal';\nimport { StepHandler } from '.';\nimport { joinPaths, phpVar } from '@php-wasm/util';\nimport { FileReference } from '../resources';\n\nexport const defaultWpCliPath = '/tmp/wp-cli.phar';\nexport const defaultWpCliResource: FileReference = {\n\tresource: 'url',\n\t/**\n\t * Use compression for downloading the wp-cli.phar file.\n\t * The official release, hosted at raw.githubusercontent.com, is ~7MB\n\t * and the transfer is uncompressed. playground.wordpress.net supports\n\t * transfer compression and only transmits ~1.4MB.\n\t *\n\t * @TODO: minify the wp-cli.phar file. It can be as small as 1MB when all the\n\t *        whitespaces and are removed, and even 500KB when libraries\n\t *        like the JavaScript parser or Composer are removed.\n\t */\n\turl: 'https://playground.wordpress.net/wp-cli.phar',\n};\n\nexport const assertWpCli = async (\n\tplayground: UniversalPHP,\n\twpCliPath: string = defaultWpCliPath\n) => {\n\tif (!(await playground.fileExists(wpCliPath))) {\n\t\tthrow new Error(`wp-cli.phar not found at ${wpCliPath}.\n\t\t\tYou can enable wp-cli support by adding \"wp-cli\" to the list of extra libraries in your blueprint as follows:\n\t\t\t{\n\t\t\t\t\"extraLibraries\": [ \"wp-cli\" ]\n\t\t\t}\n\t\t\tRead more about it in the documentation.\n\t\t\thttps://wordpress.github.io/wordpress-playground/blueprints/data-format#extra-libraries`);\n\t}\n};\n\n/**\n * @inheritDoc wpCLI\n * @hasRunnableExample\n * @example\n *\n * <code>\n * {\n * \t\t\"step\": \"wp-cli\",\n * \t\t\"command\": \"wp post create --post_title='Test post' --post_excerpt='Some\n * \t\tcontent'\"\n * }\n * </code>\n */\nexport interface WPCLIStep {\n\t/** The step identifier. */\n\tstep: 'wp-cli';\n\t/** The WP CLI command to run. */\n\tcommand: string | string[];\n\t/** wp-cli.phar path */\n\twpCliPath?: string;\n}\n\n/**\n * Runs PHP code using [WP-CLI](https://developer.wordpress.org/cli/commands/).\n */\nexport const wpCLI: StepHandler<WPCLIStep, Promise<PHPResponse>> = async (\n\tplayground,\n\t{ command, wpCliPath = defaultWpCliPath }\n) => {\n\tawait assertWpCli(playground, wpCliPath);\n\n\tlet args: string[];\n\tif (typeof command === 'string') {\n\t\tcommand = command.trim();\n\t\targs = splitShellCommand(command);\n\t} else {\n\t\targs = command;\n\t}\n\n\tconst cmd = args.shift();\n\tif (cmd !== 'wp') {\n\t\tthrow new Error(`The first argument must be \"wp\".`);\n\t}\n\n\tconst documentRoot = await playground.documentRoot;\n\n\tawait playground.writeFile('/tmp/stdout', '');\n\tawait playground.writeFile('/tmp/stderr', '');\n\tawait playground.writeFile(\n\t\tjoinPaths(documentRoot, 'run-cli.php'),\n\t\t`<?php\n\t\t// Set up the environment to emulate a shell script\n\t\t// call.\n\n\t\t// Set SHELL_PIPE to 0 to ensure WP-CLI formats\n\t\t// the output as ASCII tables.\n\t\t// @see https://github.com/wp-cli/wp-cli/issues/1102\n\t\tputenv( 'SHELL_PIPE=0' );\n\n\t\t// Set the argv global.\n\t\t$GLOBALS['argv'] = array_merge([\n\t\t  \"/tmp/wp-cli.phar\",\n\t\t  \"--path=${documentRoot}\"\n\t\t], ${phpVar(args)});\n\n\t\t// Provide stdin, stdout, stderr streams outside of\n\t\t// the CLI SAPI.\n\t\tdefine('STDIN', fopen('php://stdin', 'rb'));\n\t\tdefine('STDOUT', fopen('php://stdout', 'wb'));\n\t\tdefine('STDERR', fopen('php://stderr', 'wb'));\n\n\t\trequire( ${phpVar(wpCliPath)} );\n\t\t`\n\t);\n\n\tconst result = await playground.run({\n\t\tscriptPath: joinPaths(documentRoot, 'run-cli.php'),\n\t});\n\n\tif (result.errors) {\n\t\tthrow new Error(result.errors);\n\t}\n\n\treturn result;\n};\n\n/**\n * Naive shell command parser.\n * Ensures that commands like `wp option set blogname \"My blog name\"` are split\n * into `['wp', 'option', 'set', 'blogname', 'My blog name']` instead of\n * `['wp', 'option', 'set', 'blogname', 'My', 'blog', 'name']`.\n *\n * @param command\n * @returns\n */\nexport function splitShellCommand(command: string) {\n\tconst MODE_NORMAL = 0;\n\tconst MODE_IN_QUOTE = 1;\n\n\tlet mode = MODE_NORMAL;\n\tlet quote = '';\n\n\tconst parts: string[] = [];\n\tlet currentPart = '';\n\tfor (let i = 0; i < command.length; i++) {\n\t\tconst char = command[i];\n\t\tif (mode === MODE_NORMAL) {\n\t\t\tif (char === '\"' || char === \"'\") {\n\t\t\t\tmode = MODE_IN_QUOTE;\n\t\t\t\tquote = char;\n\t\t\t} else if (char.match(/\\s/)) {\n\t\t\t\tif (currentPart) {\n\t\t\t\t\tparts.push(currentPart);\n\t\t\t\t}\n\t\t\t\tcurrentPart = '';\n\t\t\t} else {\n\t\t\t\tcurrentPart += char;\n\t\t\t}\n\t\t} else if (mode === MODE_IN_QUOTE) {\n\t\t\tif (char === '\\\\') {\n\t\t\t\ti++;\n\t\t\t\tcurrentPart += command[i];\n\t\t\t} else if (char === quote) {\n\t\t\t\tmode = MODE_NORMAL;\n\t\t\t\tquote = '';\n\t\t\t} else {\n\t\t\t\tcurrentPart += char;\n\t\t\t}\n\t\t}\n\t}\n\tif (currentPart) {\n\t\tparts.push(currentPart);\n\t}\n\treturn parts;\n}\n","import { StepHandler } from '.';\nimport { defineWpConfigConsts } from './define-wp-config-consts';\nimport { setSiteOptions } from './site-data';\nimport { assertWpCli, wpCLI } from './wp-cli';\n\n/**\n * @inheritDoc enableMultisite\n * @hasRunnableExample\n * @example\n *\n * <code>\n * {\n * \t\t\"step\": \"enableMultisite\"\n * }\n * </code>\n */\nexport interface EnableMultisiteStep {\n\tstep: 'enableMultisite';\n\t/** wp-cli.phar path */\n\twpCliPath?: string;\n}\n\n/**\n * Defines the [Multisite](https://developer.wordpress.org/advanced-administration/multisite/create-network/) constants in a `wp-config.php` file.\n *\n * This step can be called multiple times, and the constants will be merged.\n *\n * @param playground The playground client.\n * @param enableMultisite\n */\nexport const enableMultisite: StepHandler<EnableMultisiteStep> = async (\n\tplayground,\n\t{ wpCliPath }\n) => {\n\tawait assertWpCli(playground, wpCliPath);\n\n\tawait defineWpConfigConsts(playground, {\n\t\tconsts: {\n\t\t\tWP_ALLOW_MULTISITE: 1,\n\t\t},\n\t});\n\n\tconst url = new URL(await playground.absoluteUrl);\n\tif (url.port !== '') {\n\t\tlet errorMessage = `The current host is ${url.host}, but WordPress multisites do not support custom ports.`;\n\t\tif (url.hostname === 'localhost') {\n\t\t\terrorMessage += ` For development, you can set up a playground.test domain using the instructions at https://wordpress.github.io/wordpress-playground/contributing/code.`;\n\t\t}\n\t\tthrow new Error(errorMessage);\n\t}\n\tconst sitePath = url.pathname.replace(/\\/$/, '') + '/';\n\tconst siteUrl = `${url.protocol}//${url.hostname}${sitePath}`;\n\tawait setSiteOptions(playground, {\n\t\toptions: {\n\t\t\tsiteurl: siteUrl,\n\t\t\thome: siteUrl,\n\t\t},\n\t});\n\n\tawait wpCLI(playground, {\n\t\tcommand: 'wp core multisite-convert',\n\t});\n};\n","import { StepHandler } from '.';\n\n/**\n * @inheritDoc cp\n * @hasRunnableExample\n * @landingPage /index2.php\n * @example\n *\n * <code>\n * {\n * \t\t\"step\": \"cp\",\n * \t\t\"fromPath\": \"/wordpress/index.php\",\n * \t\t\"toPath\": \"/wordpress/index2.php\"\n * }\n * </code>\n */\nexport interface CpStep {\n\tstep: 'cp';\n\t/** Source path */\n\tfromPath: string;\n\t/** Target path */\n\ttoPath: string;\n}\n\n/**\n * Copies a file from one path to another.\n */\nexport const cp: StepHandler<CpStep> = async (\n\tplayground,\n\t{ fromPath, toPath }\n) => {\n\tawait playground.writeFile(\n\t\ttoPath,\n\t\tawait playground.readFileAsBuffer(fromPath)\n\t);\n};\n","import { StepHandler } from '.';\n\n/**\n * @inheritDoc mv\n * @hasRunnableExample\n * @landingPage /index2.php\n * @example\n *\n * <code>\n * {\n * \t\t\"step\": \"mv\",\n * \t\t\"fromPath\": \"/wordpress/index.php\",\n * \t\t\"toPath\": \"/wordpress/index2.php\"\n * }\n * </code>\n */\nexport interface MvStep {\n\tstep: 'mv';\n\t/** Source path */\n\tfromPath: string;\n\t/** Target path */\n\ttoPath: string;\n}\n\n/**\n * Moves a file or directory from one path to another.\n */\nexport const mv: StepHandler<MvStep> = async (\n\tplayground,\n\t{ fromPath, toPath }\n) => {\n\tawait playground.mv(fromPath, toPath);\n};\n","import { StepHandler } from '.';\n\n/**\n * @inheritDoc mkdir\n * @hasRunnableExample\n * @example\n *\n * <code>\n * {\n * \t\t\"step\": \"mkdir\",\n * \t\t\"path\": \"/wordpress/my-new-folder\"\n * }\n * </code>\n */\nexport interface MkdirStep {\n\tstep: 'mkdir';\n\t/** The path of the directory you want to create */\n\tpath: string;\n}\n\n/**\n * Creates a directory at the specified path.\n */\nexport const mkdir: StepHandler<MkdirStep> = async (playground, { path }) => {\n\tawait playground.mkdir(path);\n};\n","import { StepHandler } from '.';\n\n/**\n * @inheritDoc rmdir\n * @hasRunnableExample\n * @landingPage /wp-admin/\n * @example\n *\n * <code>\n * {\n * \t\t\"step\": \"rmdir\",\n * \t\t\"path\": \"/wordpress/wp-admin\"\n * }\n * </code>\n */\nexport interface RmdirStep {\n\tstep: 'rmdir';\n\t/** The path to remove */\n\tpath: string;\n}\n\n/**\n * Removes a directory at the specified path.\n */\nexport const rmdir: StepHandler<RmdirStep> = async (playground, { path }) => {\n\tawait playground.rmdir(path);\n};\n","import { StepHandler } from '.';\n\n/**\n * @inheritDoc writeFile\n * @hasRunnableExample\n * @landingPage /test.php\n * @example\n *\n * <code>\n * {\n * \t\t\"step\": \"writeFile\",\n * \t\t\"path\": \"/wordpress/test.php\",\n * \t\t\"data\": \"<?php echo 'Hello World!'; ?>\"\n * }\n * </code>\n */\nexport interface WriteFileStep<FileResource> {\n\tstep: 'writeFile';\n\t/** The path of the file to write to */\n\tpath: string;\n\t/** The data to write */\n\tdata: FileResource | string | Uint8Array;\n}\n\n/**\n * Writes data to a file at the specified path.\n */\nexport const writeFile: StepHandler<WriteFileStep<File>> = async (\n\tplayground,\n\t{ path, data }\n) => {\n\tif (data instanceof File) {\n\t\tdata = new Uint8Array(await data.arrayBuffer());\n\t}\n\t/**\n\t * PR #1426 removed the mu-plugins directory from the default\n\t * WordPress build used by Playground. This is consistent with\n\t * the official WordPress build, but it also breaks existing\n\t * Blueprints that assume the mu-plugins directory is still\n\t * in place.\n\t *\n\t * This code block creates the mu-plugins directory on a write\n\t * attempt as a courtesy to Playground developers.\n\t *\n\t * @see https://github.com/WordPress/wordpress-playground/pull/1426\n\t *      for more context.\n\t */\n\tif (\n\t\tpath.startsWith('/wordpress/wp-content/mu-plugins') &&\n\t\t!(await playground.fileExists('/wordpress/wp-content/mu-plugins'))\n\t) {\n\t\tawait playground.mkdir('/wordpress/wp-content/mu-plugins');\n\t}\n\tawait playground.writeFile(path, data);\n};\n","import { writeFiles as writeFilesToPhpWasm } from '@php-wasm/universal';\nimport { StepHandler } from '.';\nimport { Directory } from '../resources';\n\n/**\n * @inheritDoc writeFiles\n * @hasRunnableExample\n * @landingPage /test.php\n * @example\n *\n * <code>\n * {\n * \t\t\"step\": \"writeFiles\",\n * \t\t\"writeToPath\": \"/wordpress/wp-content/plugins/my-plugin\",\n * \t\t\"filesTree\": {\n * \t\t\t\"name\": \"my-plugin\",\n * \t\t\t\"files\": {\n * \t\t\t\t\"index.php\": \"<?php echo '<a>Hello World!</a>'; ?>\",\n * \t\t\t\t\"public\": {\n * \t\t\t\t\t\"style.css\": \"a { color: red; }\"\n * \t\t\t\t}\n * \t\t\t}\n * \t\t}\n * }\n * </code>\n */\nexport interface WriteFilesStep<DirectoryResource> {\n\tstep: 'writeFiles';\n\t/** The path of the file to write to */\n\twriteToPath: string;\n\t/** The data to write */\n\tfilesTree: DirectoryResource;\n}\n\n/**\n * Writes multiple files to a specified directory in the Playground\n * filesystem.\n */\nexport const writeFiles: StepHandler<WriteFilesStep<Directory>> = async (\n\tplayground,\n\t{ writeToPath, filesTree }\n) => {\n\tawait writeFilesToPhpWasm(playground, writeToPath, filesTree.files);\n};\n","import { StepHandler } from '.';\nimport { defineWpConfigConsts } from './define-wp-config-consts';\n\n/**\n * Changes the site URL of the WordPress installation.\n *\n * @inheritDoc defineSiteUrl\n */\nexport interface DefineSiteUrlStep {\n\tstep: 'defineSiteUrl';\n\t/** The URL */\n\tsiteUrl: string;\n}\n\n/**\n * Sets [`WP_HOME`](https://developer.wordpress.org/advanced-administration/wordpress/wp-config/#blog-address-url) and [`WP_SITEURL`](https://developer.wordpress.org/advanced-administration/wordpress/wp-config/#wp-siteurl) constants for the WordPress installation.\n *\n * Using this step on playground.wordpress.net is moot.\n * It is useful when building a custom Playground-based tool, like [`wp-now`](https://www.npmjs.com/package/@wp-now/wp-now),\n * or deploying Playground on a custom domain.\n *\n * @param playground The playground client.\n * @param siteUrl\n */\nexport const defineSiteUrl: StepHandler<DefineSiteUrlStep> = async (\n\tplayground,\n\t{ siteUrl }\n) => {\n\tawait defineWpConfigConsts(playground, {\n\t\tconsts: {\n\t\t\tWP_HOME: siteUrl,\n\t\t\tWP_SITEURL: siteUrl,\n\t\t},\n\t});\n};\n","import { StepHandler, StepProgress } from '.';\nimport { writeFile } from './write-file';\nimport { phpVar } from '@php-wasm/util';\nimport { UniversalPHP } from '@php-wasm/universal';\n\n/**\n * @inheritDoc importWxr\n * @example\n *\n * <code>\n * {\n * \t\t\"step\": \"importWxr\",\n * \t\t\"file\": {\n * \t\t\t\"resource\": \"url\",\n * \t\t\t\"url\": \"https://your-site.com/starter-content.wxr\"\n * \t\t}\n * }\n * </code>\n */\nexport interface ImportWxrStep<ResourceType> {\n\tstep: 'importWxr';\n\t/** The file to import */\n\tfile: ResourceType;\n\t/**\n\t * The importer to use. Possible values:\n\t *\n\t * - `default`: The importer from https://github.com/humanmade/WordPress-Importer\n\t * - `data-liberation`: The experimental Data Liberation WXR importer developed at\n\t *                      https://github.com/WordPress/wordpress-playground/issues/1894\n\t *\n\t * This option is deprecated. The syntax will not be removed, but once the\n\t * Data Liberation importer matures, it will become the only supported\n\t * importer and the `importer` option will be ignored.\n\t *\n\t * @deprecated\n\t */\n\timporter?: 'data-liberation' | 'default';\n}\n\n/**\n * Imports a WXR file into WordPress.\n *\n * @param playground Playground client.\n * @param file The file to import.\n */\nexport const importWxr: StepHandler<ImportWxrStep<File>> = async (\n\tplayground,\n\t{ file, importer = 'default' },\n\tprogress?\n) => {\n\tif (importer === 'data-liberation') {\n\t\tawait importWithDataLiberationImporter(playground, file, progress);\n\t} else {\n\t\tawait importWithDefaultImporter(playground, file, progress);\n\t}\n};\n\nasync function importWithDefaultImporter(\n\tplayground: UniversalPHP,\n\tfile: File,\n\tprogress?: StepProgress | undefined\n) {\n\tprogress?.tracker?.setCaption('Importing content');\n\tawait writeFile(playground, {\n\t\tpath: '/tmp/import.wxr',\n\t\tdata: file,\n\t});\n\tconst docroot = await playground.documentRoot;\n\tawait playground.run({\n\t\tcode: `<?php\n\trequire ${phpVar(docroot)} . '/wp-load.php';\n\trequire ${phpVar(docroot)} . '/wp-admin/includes/admin.php';\n\n\tkses_remove_filters();\n\t$admin_id = get_users(array('role' => 'Administrator') )[0]->ID;\n\twp_set_current_user( $admin_id );\n\t$importer = new WXR_Importer( array(\n\t\t'fetch_attachments' => true,\n\t\t'default_author' => $admin_id\n\t) );\n\t$logger = new WP_Importer_Logger_CLI();\n\t$importer->set_logger( $logger );\n\t// Slashes from the imported content are lost if we don't call wp_slash here.\n\tadd_action( 'wp_insert_post_data', function( $data ) {\n\t\treturn wp_slash($data);\n\t});\n  \n  // Ensure that Site Editor templates are associated with the correct taxonomy.\n  add_filter( 'wp_import_post_terms', function ( $terms, $post_id ) {\n    foreach ( $terms as $post_term ) {\n      if ( 'wp_theme' !== $term['taxonomy'] ) continue;\n      $post_term = get_term_by('slug', $term['slug'], $term['taxonomy'] );\n      if ( ! $post_term ) {\n        $post_term = wp_insert_term(\n          $term['slug'],\n          $term['taxonomy']\n        );\n        $term_id = $post_term['term_id'];\n      } else {\n        $term_id = $post_term->term_id;\n      }\n      wp_set_object_terms( $post_id, $term_id, $term['taxonomy']) ;\n    }\n    return $terms;\n  }, 10, 2 );\n\t$result = $importer->import( '/tmp/import.wxr' );\n\t`,\n\t});\n}\n\nasync function importWithDataLiberationImporter(\n\tplayground: UniversalPHP,\n\tfile: File,\n\tprogress?: StepProgress | undefined\n) {\n\tprogress?.tracker?.setCaption('Preparing content import');\n\tawait writeFile(playground, {\n\t\tpath: '/tmp/import.wxr',\n\t\tdata: file,\n\t});\n\tconst docroot = await playground.documentRoot;\n\t/**\n\t * Surface the import progress information in the Blueprint progress bar.\n\t * This temporary message handler is cleared at the end of this step.\n\t */\n\tconst clearProgressListener = await playground.onMessage(\n\t\t(messageString) => {\n\t\t\tconst message = JSON.parse(messageString) as any;\n\t\t\tif (message?.type === 'import-wxr-progress') {\n\t\t\t\tprogress?.tracker?.setCaption(message.progress);\n\t\t\t}\n\t\t}\n\t);\n\ttry {\n\t\tawait playground.run({\n\t\t\tcode: `<?php\n\trequire ${phpVar(docroot)} . '/wp-load.php';\n\trequire ${phpVar(docroot)} . '/wp-admin/includes/admin.php';\n\n\t// Defines the constants expected by the Box .phar stub when \"cli\" is used\n\t// as the SAPI name.\n\t// @TODO: Don't use the \"cli\" SAPI string and don't allow composer to run platform checks.\n\tif(!defined('STDERR')) define('STDERR', fopen('php://stderr', 'w'));\n\tif(!defined('STDIN'))  define('STDIN', fopen('php://stdin', 'r'));\n\tif(!defined('STDOUT')) define('STDOUT', fopen('php://stdout', 'w'));\n\t\n\t// Preloaded by the Blueprint compile() function\n\trequire '/internal/shared/data-liberation-core.phar';\n\n\t$admin_id = get_users(array('role' => 'Administrator') )[0]->ID;\n\twp_set_current_user( $admin_id );\n\n\t$new_site_url = get_site_url();\n\t$importer = WP_Stream_Importer::create_for_wxr_file(\n\t\t'/tmp/import.wxr',\n\t\tarray(\n\t\t\t'new_site_url' => $new_site_url,\n\t\t)\n\t);\n\t$session = WP_Import_Session::create(\n\t\tarray(\n\t\t\t'data_source' => 'wxr_file',\n\t\t\t'file_name' => '/tmp/import.wxr',\n\t\t)\n\t);\n\twhile ( true ) {\n\t\tif ( true === $importer->next_step() ) {\n\t\t\t/**\n\t\t\t * We're ignoring any importing errors.\n\t\t\t * This script is a part of Blueprints and is expected to finish\n\t\t\t * without stopping. We won't be gathering additional user input\n\t\t\t * along the way. Instead, we'll just decide not to ignore the\n\t\t\t * errors.\n\t\t\t *\n\t\t\t * @TODO: Consider extracting this code into a CLI script and\n\t\t\t *        using it here instead of this custom script. Note it's\n\t\t\t *        about a simple CLI script, not a WP-CLI command, as the\n\t\t\t *        latter would require downloading 5MB of WP-CLI code.\n\t\t\t */\n\t\t\tswitch ( $importer->get_stage() ) {\n\t\t\t\tcase WP_Stream_Importer::STAGE_INITIAL:\n\t\t\t\t\t$message = 'Preparing content import';\n\t\t\t\t\tbreak;\n\t\t\n\t\t\t\tcase WP_Stream_Importer::STAGE_INDEX_ENTITIES:\n\t\t\t\t\t// Bump the total number of entities to import.\n\t\t\t\t\t$indexed = $session->count_all_total_entities();\n\t\t\t\t\t$message = 'Content import 1/4: Indexing records (' . $indexed . ' so far)';\n\t\t\t\t\t$session->create_frontloading_placeholders( $importer->get_indexed_assets_urls() );\n\t\t\t\t\t$session->bump_total_number_of_entities(\n\t\t\t\t\t\t$importer->get_indexed_entities_counts()\n\t\t\t\t\t);\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase WP_Stream_Importer::STAGE_TOPOLOGICAL_SORT:\n\t\t\t\t\t$message = 'Content import 2/4: Indexing data';\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase WP_Stream_Importer::STAGE_FRONTLOAD_ASSETS:\n\t\t\t\t\t$session->bump_frontloading_progress(\n\t\t\t\t\t\t$importer->get_frontloading_progress(),\n\t\t\t\t\t\t$importer->get_frontloading_events()\n\t\t\t\t\t);\n\t\t\t\t\t$nb_media = $session->count_awaiting_frontloading_placeholders();\n\t\t\t\t\t$message = 'Content import 3/4: Downloading media (' . $nb_media . ' remaining)';\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase WP_Stream_Importer::STAGE_IMPORT_ENTITIES:\n\t\t\t\t\t$session->bump_imported_entities_counts(\n\t\t\t\t\t\t$importer->get_imported_entities_counts()\n\t\t\t\t\t);\n\t\t\t\t\t$nb_remaining_entities = $session->count_remaining_entities();\n\t\t\t\t\t$message = 'Content import 4/4: Inserting data (' . $nb_remaining_entities . ' remaining)';\n\t\t\t\t\tbreak;\n\n\t\t\t\tdefault:\n\t\t\t\t\t$message = 'Importing content';\n\t\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\t// Report progress to the UI\n\t\t\tpost_message_to_js(json_encode([\n\t\t\t\t'type' => 'import-wxr-progress',\n\t\t\t\t'progress' => $message,\n\t\t\t]));\n\t\t\tcontinue;\n\t\t}\n\t\tif ( $importer->advance_to_next_stage() ) {\n\t\t\tcontinue;\n\t\t}\n\t\t// Import finished\n\t\tbreak;\n\t}\n\t`,\n\t\t});\n\t} finally {\n\t\tawait clearProgressListener();\n\t}\n}\n","import { StepHandler } from '.';\nimport { phpVar } from '@php-wasm/util';\n\n/**\n * @inheritDoc importThemeStarterContent\n * @example\n *\n * <code>\n * {\n * \t\t\"step\": \"importThemeStarterContent\"\n * }\n * </code>\n */\nexport interface ImportThemeStarterContentStep {\n\t/** The step identifier. */\n\tstep: 'importThemeStarterContent';\n\t/**\n\t * The name of the theme to import content from.\n\t */\n\tthemeSlug?: string;\n}\n\n/**\n * Imports a theme Starter Content into WordPress.\n *\n * @param playground Playground client.\n */\nexport const importThemeStarterContent: StepHandler<\n\tImportThemeStarterContentStep\n> = async (playground, { themeSlug = '' }, progress) => {\n\tprogress?.tracker?.setCaption('Importing theme starter content');\n\n\tconst docroot = await playground.documentRoot;\n\tawait playground.run({\n\t\tcode: `<?php\n\n\t\t/**\n\t\t * Ensure that the customizer loads as an admin user.\n\t\t *\n\t\t * For compatibility with themes, this MUST be run prior to theme inclusion, which is why this is a plugins_loaded filter instead\n\t\t * of running _wp_customize_include() manually after load.\n\t\t */\n\t\tfunction importThemeStarterContent_plugins_loaded() {\n\t\t\t// Set as the admin user, this ensures we can customize the site.\n\t\t\twp_set_current_user(\n\t\t\t\tget_users( [ 'role' => 'Administrator' ] )[0]\n\t\t\t);\n\n\t\t\t// Force the site to be fresh, although it should already be.\n\t\t\tadd_filter( 'pre_option_fresh_site', '__return_true' );\n\n\t\t\t/*\n\t\t\t * Simulate this request as the customizer loading with the current theme in preview mode.\n\t\t\t *\n\t\t\t * See _wp_customize_include()\n\t\t\t */\n\t\t\t$_REQUEST['wp_customize']    = 'on';\n\t\t\t$_REQUEST['customize_theme'] = ${phpVar(themeSlug)} ?: get_stylesheet();\n\n\t\t\t/*\n\t\t\t * Claim this is a ajax request saving settings, to avoid the preview filters being applied.\n\t\t\t */\n\t\t\t$_REQUEST['action'] = 'customize_save';\n\t\t\tadd_filter( 'wp_doing_ajax', '__return_true' );\n\n\t\t\t$_GET = $_REQUEST;\n\t\t}\n\t\tplayground_add_filter( 'plugins_loaded', 'importThemeStarterContent_plugins_loaded', 0 );\n\n\t\trequire ${phpVar(docroot)} . '/wp-load.php';\n\n\t\t// Return early if there's no starter content.\n\t\tif ( ! get_theme_starter_content() ) {\n\t\t\treturn;\n\t\t}\n\n\t\t// Import the Starter Content.\n\t\t$wp_customize->import_theme_starter_content();\n\n\t\t// Publish the changeset, which publishes the starter content.\n\t\twp_publish_post( $wp_customize->changeset_post_id() );\n\t\t`,\n\t});\n};\n","export interface CachedFetchResponse {\n\tbody: ReadableStream<Uint8Array>;\n\tresponseInit: ResponseInit;\n}\n\n/**\n * Creates a fetch function that memoizes the response stream.\n * Calling it twice will return a response with the same status,\n * headers, and the body stream.\n * Memoization is keyed by URL. Method, headers etc are ignored.\n *\n * @param originalFetch The fetch function to memoize. Defaults to the global fetch.\n */\nexport function createMemoizedFetch(originalFetch = fetch) {\n\tconst cache: Record<\n\t\tstring,\n\t\tPromise<CachedFetchResponse> | CachedFetchResponse\n\t> = {};\n\n\treturn async function memoizedFetch(url: string, options?: RequestInit) {\n\t\tif (!cache[url]) {\n\t\t\t// Write to cache synchronously to avoid duplicate requests.\n\t\t\tcache[url] = originalFetch(url, options).then((response) => ({\n\t\t\t\tbody: response.body!,\n\t\t\t\tresponseInit: {\n\t\t\t\t\tstatus: response.status,\n\t\t\t\t\tstatusText: response.statusText,\n\t\t\t\t\theaders: response.headers,\n\t\t\t\t},\n\t\t\t}));\n\t\t}\n\t\tconst { body, responseInit } = await cache[url];\n\t\t// Split the response stream so that the cached one is not consumed.\n\t\tconst [left, right] = body.tee();\n\t\t// Cache the \"left\" stream and don't use it until the next .tee().\n\t\tcache[url] = {\n\t\t\tbody: left,\n\t\t\tresponseInit,\n\t\t};\n\t\t// Return the \"right\" stream for consumption.\n\t\treturn new Response(right, responseInit);\n\t};\n}\n","/**\n * Avoid adding new code here. @wp-playground/common should remain\n * as lean as possible.\n *\n * This package exists to avoid circular dependencies. Let's not\n * use it as a default place to add code that doesn't seem to fit\n * anywhere else. If there's no good place for your code, perhaps\n * it needs to be restructured? Or maybe there's a need for a new package?\n * Let's always consider these questions before adding new code here.\n */\n\nimport { UniversalPHP } from '@php-wasm/universal';\nimport { phpVars } from '@php-wasm/util';\n\nexport { createMemoizedFetch } from './create-memoized-fetch';\n\nexport const RecommendedPHPVersion = '8.0';\n\n/**\n * Unzip a zip file inside Playground.\n */\nconst tmpPath = '/tmp/file.zip';\nexport const unzipFile = async (\n\tphp: UniversalPHP,\n\tzipPath: string | File,\n\textractToPath: string,\n\toverwriteFiles = true\n) => {\n\tif (zipPath instanceof File) {\n\t\tconst zipFile = zipPath;\n\t\tzipPath = tmpPath;\n\t\tawait php.writeFile(\n\t\t\tzipPath,\n\t\t\tnew Uint8Array(await zipFile.arrayBuffer())\n\t\t);\n\t}\n\tconst js = phpVars({\n\t\tzipPath,\n\t\textractToPath,\n\t\toverwriteFiles,\n\t});\n\tawait php.run({\n\t\tcode: `<?php\n        function unzip($zipPath, $extractTo, $overwriteFiles = true)\n        {\n            if (!is_dir($extractTo)) {\n                mkdir($extractTo, 0777, true);\n            }\n            $zip = new ZipArchive;\n            $res = $zip->open($zipPath);\n            if ($res === TRUE) {\n\t\t\t\tfor ($i = 0; $i < $zip->numFiles; $i++) {\n\t\t\t\t\t$filename = $zip->getNameIndex($i);\n\t\t\t\t\t$fileinfo = pathinfo($filename);\n\t\t\t\t\t$extractFilePath = rtrim($extractTo, '/') . '/' . $filename;\n\t\t\t\t\t// Check if file exists and $overwriteFiles is false\n\t\t\t\t\tif (!file_exists($extractFilePath) || $overwriteFiles) {\n\t\t\t\t\t\t// Extract file\n\t\t\t\t\t\t$zip->extractTo($extractTo, $filename);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t$zip->close();\n\t\t\t\tchmod($extractTo, 0777);\n            } else {\n                throw new Exception(\"Could not unzip file: \" . $zip->getStatusString());\n            }\n        }\n        unzip(${js.zipPath}, ${js.extractToPath}, ${js.overwriteFiles});\n        `,\n\t});\n\tif (await php.fileExists(tmpPath)) {\n\t\tawait php.unlink(tmpPath);\n\t}\n};\n\nexport const zipDirectory = async (\n\tphp: UniversalPHP,\n\tdirectoryPath: string\n) => {\n\tconst outputPath = `/tmp/file${Math.random()}.zip`;\n\tconst js = phpVars({\n\t\tdirectoryPath,\n\t\toutputPath,\n\t});\n\tawait php.run({\n\t\tcode: `<?php\n\t\tfunction zipDirectory($directoryPath, $outputPath) {\n\t\t\t$zip = new ZipArchive;\n\t\t\t$res = $zip->open($outputPath, ZipArchive::CREATE);\n\t\t\tif ($res !== TRUE) {\n\t\t\t\tthrow new Exception('Failed to create ZIP');\n\t\t\t}\n\t\t\t$files = new RecursiveIteratorIterator(\n\t\t\t\tnew RecursiveDirectoryIterator($directoryPath)\n\t\t\t);\n\t\t\tforeach ($files as $file) {\n\t\t\t\t$file = strval($file);\n\t\t\t\tif (is_dir($file)) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t\t$zip->addFile($file, substr($file, strlen($directoryPath)));\n\t\t\t}\n\t\t\t$zip->close();\n\t\t\tchmod($outputPath, 0777);\n\t\t}\n\t\tzipDirectory(${js.directoryPath}, ${js.outputPath});\n\t\t`,\n\t});\n\n\tconst fileBuffer = await php.readFileAsBuffer(outputPath);\n\tphp.unlink(outputPath);\n\treturn fileBuffer;\n};\n","import { StepHandler } from '.';\nimport { unzipFile } from '@wp-playground/common';\nimport { logger } from '@php-wasm/logger';\n\n/**\n * @inheritDoc unzip\n * @example\n *\n * <code>\n * {\n * \t\t\"step\": \"unzip\",\n * \t\t\"zipFile\": {\n * \t\t\t\"resource\": \"vfs\",\n * \t\t\t\"path\": \"/wordpress/data.zip\"\n * \t\t},\n * \t\t\"extractToPath\": \"/wordpress\"\n * }\n * </code>\n */\nexport interface UnzipStep<ResourceType> {\n\tstep: 'unzip';\n\t/** The zip file to extract */\n\tzipFile?: ResourceType;\n\t/**\n\t * The path of the zip file to extract\n\t * @deprecated Use zipFile instead.\n\t */\n\tzipPath?: string;\n\t/** The path to extract the zip file to */\n\textractToPath: string;\n}\n\n/**\n * Unzip a zip file.\n *\n * @param playground Playground client.\n * @param zipPath The zip file to unzip.\n * @param extractTo The directory to extract the zip file to.\n */\nexport const unzip: StepHandler<UnzipStep<File>> = async (\n\tplayground,\n\t{ zipFile, zipPath, extractToPath }\n) => {\n\tif (zipPath) {\n\t\t// @TODO: Remove the zipPath option in the next major version\n\t\tlogger.warn(\n\t\t\t`The \"zipPath\" option of the unzip() Blueprint step is deprecated and will be removed. ` +\n\t\t\t\t`Use \"zipFile\" instead.`\n\t\t);\n\t} else if (!zipFile) {\n\t\tthrow new Error('Either zipPath or zipFile must be provided');\n\t}\n\tawait unzipFile(playground, (zipFile || zipPath)!, extractToPath);\n};\n","import { StepHandler } from '.';\nimport { unzip } from './unzip';\nimport { dirname, joinPaths, phpVar } from '@php-wasm/util';\nimport { UniversalPHP } from '@php-wasm/universal';\nimport { wpContentFilesExcludedFromExport } from '../utils/wp-content-files-excluded-from-exports';\nimport { defineSiteUrl } from './define-site-url';\n\n/**\n * @inheritDoc importWordPressFiles\n * @example\n *\n * <code>\n * {\n * \t\t\"step\": \"importWordPressFiles\",\n * \t\t\"wordPressFilesZip\": {\n * \t\t\t\"resource\": \"url\",\n * \t\t\t\"url\": \"https://mysite.com/import.zip\"\n *  \t}\n * }\n * </code>\n */\nexport interface ImportWordPressFilesStep<ResourceType> {\n\tstep: 'importWordPressFiles';\n\t/**\n\t * The zip file containing the top-level WordPress files and\n\t * directories.\n\t */\n\twordPressFilesZip: ResourceType;\n\t/**\n\t * The path inside the zip file where the WordPress files are.\n\t */\n\tpathInZip?: string;\n}\n\n/**\n * Imports top-level WordPress files from a given zip file into\n * the `documentRoot`. For example, if a zip file contains the\n * `wp-content` and `wp-includes` directories, they will replace\n * the corresponding directories in Playground's `documentRoot`.\n *\n * Any files that Playground recognizes as \"excluded from the export\"\n * will carry over from the existing document root into the imported\n * directories. For example, the sqlite-database-integration plugin.\n *\n * @param playground Playground client.\n * @param wordPressFilesZip Zipped WordPress site.\n */\nexport const importWordPressFiles: StepHandler<\n\tImportWordPressFilesStep<File>\n> = async (playground, { wordPressFilesZip, pathInZip = '' }) => {\n\tconst documentRoot = await playground.documentRoot;\n\n\t// Unzip\n\tlet importPath = joinPaths('/tmp', 'import');\n\tawait playground.mkdir(importPath);\n\tawait unzip(playground, {\n\t\tzipFile: wordPressFilesZip,\n\t\textractToPath: importPath,\n\t});\n\timportPath = joinPaths(importPath, pathInZip);\n\n\t// Carry over any Playground-related files, such as the\n\t// SQLite database plugin, from the current wp-content\n\t// into the one that's about to be imported\n\tconst importedWpContentPath = joinPaths(importPath, 'wp-content');\n\tconst wpContentPath = joinPaths(documentRoot, 'wp-content');\n\tfor (const relativePath of wpContentFilesExcludedFromExport) {\n\t\t// Remove any paths that were supposed to be excluded from the export\n\t\t// but maybe weren't\n\t\tconst excludedImportPath = joinPaths(\n\t\t\timportedWpContentPath,\n\t\t\trelativePath\n\t\t);\n\t\tawait removePath(playground, excludedImportPath);\n\n\t\t// Replace them with files sourced from the live wp-content directory\n\t\tconst restoreFromPath = joinPaths(wpContentPath, relativePath);\n\t\tif (await playground.fileExists(restoreFromPath)) {\n\t\t\tawait playground.mkdir(dirname(excludedImportPath));\n\t\t\tawait playground.mv(restoreFromPath, excludedImportPath);\n\t\t}\n\t}\n\n\t// Carry over the database directory if the imported zip file doesn't\n\t// already contain one.\n\tconst importedDatabasePath = joinPaths(\n\t\timportPath,\n\t\t'wp-content',\n\t\t'database'\n\t);\n\tif (!(await playground.fileExists(importedDatabasePath))) {\n\t\tawait playground.mv(\n\t\t\tjoinPaths(documentRoot, 'wp-content', 'database'),\n\t\t\timportedDatabasePath\n\t\t);\n\t}\n\n\t// Move all the paths from the imported directory into the document root.\n\t// Overwrite, if needed.\n\tconst importedFilenames = await playground.listFiles(importPath);\n\tfor (const fileName of importedFilenames) {\n\t\tawait removePath(playground, joinPaths(documentRoot, fileName));\n\t\tawait playground.mv(\n\t\t\tjoinPaths(importPath, fileName),\n\t\t\tjoinPaths(documentRoot, fileName)\n\t\t);\n\t}\n\n\t// Remove the directory where we unzipped the imported zip file.\n\tawait playground.rmdir(importPath);\n\n\t// Adjust the site URL\n\tawait defineSiteUrl(playground, {\n\t\tsiteUrl: await playground.absoluteUrl,\n\t});\n\n\t// Upgrade the database\n\tconst upgradePhp = phpVar(\n\t\tjoinPaths(documentRoot, 'wp-admin', 'upgrade.php')\n\t);\n\tawait playground.run({\n\t\tcode: `<?php\n            $_GET['step'] = 'upgrade_db';\n            require ${upgradePhp};\n            `,\n\t});\n};\n\nasync function removePath(playground: UniversalPHP, path: string) {\n\tif (await playground.fileExists(path)) {\n\t\tif (await playground.isDir(path)) {\n\t\t\tawait playground.rmdir(path);\n\t\t} else {\n\t\t\tawait playground.unlink(path);\n\t\t}\n\t}\n}\n","import { UniversalPHP } from '@php-wasm/universal';\n\n/**\n * Exports the WordPress database as a WXR file using\n * the core WordPress export tool.\n *\n * @param playground Playground client\n * @returns WXR file\n */\nexport async function exportWXR(playground: UniversalPHP) {\n\tconst databaseExportResponse = await playground.request({\n\t\turl: '/wp-admin/export.php?download=true&content=all',\n\t});\n\treturn new File([databaseExportResponse.bytes], 'export.xml');\n}\n","import type { UniversalPHP } from '@php-wasm/universal';\nimport { joinPaths, randomString } from '@php-wasm/util';\nimport { unzip } from './unzip';\n\nexport interface InstallAssetOptions {\n\t/**\n\t * The zip file to install.\n\t */\n\tzipFile: File;\n\t/**\n\t * Target path to extract the main folder.\n\t * @example\n\t *\n\t * <code>\n\t * const targetPath = `${await playground.documentRoot}/wp-content/plugins`;\n\t * </code>\n\t */\n\ttargetPath: string;\n\t/**\n\t * Target folder name to install the asset into.\n\t */\n\ttargetFolderName?: string;\n\t/**\n\t * What to do if the asset already exists.\n\t */\n\tifAlreadyInstalled?: 'overwrite' | 'skip' | 'error';\n}\n\n/**\n * Install asset: Extract folder from zip file and move it to target\n */\nexport async function installAsset(\n\tplayground: UniversalPHP,\n\t{\n\t\ttargetPath,\n\t\tzipFile,\n\t\tifAlreadyInstalled = 'overwrite',\n\t\ttargetFolderName = ''\n\t}: InstallAssetOptions\n): Promise<{\n\tassetFolderPath: string;\n\tassetFolderName: string;\n}> {\n\t// Extract to temporary folder so we can find asset folder name\n\tconst zipFileName = zipFile.name;\n\tconst assetNameGuess = zipFileName.replace(/\\.zip$/, '');\n\n\tconst wpContent = joinPaths(await playground.documentRoot, 'wp-content');\n\tconst tmpDir = joinPaths(wpContent, randomString());\n\tconst tmpUnzippedFilesPath = joinPaths(tmpDir, 'assets', assetNameGuess);\n\n\tif (await playground.fileExists(tmpUnzippedFilesPath)) {\n\t\tawait playground.rmdir(tmpDir, {\n\t\t\trecursive: true,\n\t\t});\n\t}\n\tawait playground.mkdir(tmpDir);\n\n\ttry {\n\t\tawait unzip(playground, {\n\t\t\tzipFile,\n\t\t\textractToPath: tmpUnzippedFilesPath,\n\t\t});\n\n\t\t// Find the path asset folder name\n\t\tlet files = await playground.listFiles(tmpUnzippedFilesPath, {\n\t\t\tprependPath: true,\n\t\t});\n\t\t// _unzip_file_ziparchive in WordPress skips the __MACOSX files, and so\n\t\t// should we here.\n\t\tfiles = files.filter((name) => !name.endsWith('/__MACOSX'));\n\n\t\t/**\n\t\t * If the zip only contains a single entry that is directory,\n\t\t * we assume that's the asset folder. Otherwise, the zip\n\t\t * probably contains the plugin files without an intermediate folder.\n\t\t */\n\t\tconst zipHasRootFolder =\n\t\t\tfiles.length === 1 && (await playground.isDir(files[0]));\n\t\tlet assetFolderName;\n\t\tlet tmpAssetPath = '';\n\t\tif (zipHasRootFolder) {\n\t\t\ttmpAssetPath = files[0];\n\t\t\tassetFolderName = files[0].split('/').pop()!;\n\t\t} else {\n\t\t\ttmpAssetPath = tmpUnzippedFilesPath;\n\t\t\tassetFolderName = assetNameGuess;\n\t\t}\n\n\t\t// If a specific slug was requested be used, use that.\n\t\tif ( targetFolderName && targetFolderName.length ) {\n\t\t\tassetFolderName = targetFolderName;\n\t\t}\n\n\t\t// Move asset folder to target path\n\t\tconst assetFolderPath = `${targetPath}/${assetFolderName}`;\n\n\t\t// Handle the scenario when the asset is already installed.\n\t\tif (await playground.fileExists(assetFolderPath)) {\n\t\t\tif (!(await playground.isDir(assetFolderPath))) {\n\t\t\t\tthrow new Error(\n\t\t\t\t\t`Cannot install asset ${assetFolderName} to ${assetFolderPath} because a file with the same name already exists. Note it's a file, not a directory! Is this by mistake?`\n\t\t\t\t);\n\t\t\t}\n\t\t\tif (ifAlreadyInstalled === 'overwrite') {\n\t\t\t\tawait playground.rmdir(assetFolderPath, {\n\t\t\t\t\trecursive: true,\n\t\t\t\t});\n\t\t\t} else if (ifAlreadyInstalled === 'skip') {\n\t\t\t\treturn {\n\t\t\t\t\tassetFolderPath,\n\t\t\t\t\tassetFolderName,\n\t\t\t\t};\n\t\t\t} else {\n\t\t\t\tthrow new Error(\n\t\t\t\t\t`Cannot install asset ${assetFolderName} to ${targetPath} because it already exists and ` +\n\t\t\t\t\t\t`the ifAlreadyInstalled option was set to ${ifAlreadyInstalled}`\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\t\tawait playground.mv(tmpAssetPath, assetFolderPath);\n\n\t\treturn {\n\t\t\tassetFolderPath,\n\t\t\tassetFolderName,\n\t\t};\n\t} finally {\n\t\tawait playground.rmdir(tmpDir, {\n\t\t\trecursive: true,\n\t\t});\n\t}\n}\n","/**\n * Converts a zip file name to a nice, human-readable name.\n *\n * @example\t`hello-dolly.zip` -> `Hello dolly`\n *\n * @param zipName A zip filename.\n * @returns A nice, human-readable name.\n */\nexport function zipNameToHumanName(zipName: string) {\n\tconst mixedCaseName = zipName.split('.').shift()!.replace(/-/g, ' ');\n\treturn (\n\t\tmixedCaseName.charAt(0).toUpperCase() +\n\t\tmixedCaseName.slice(1).toLowerCase()\n\t);\n}\n","import { StepHandler } from '.';\nimport { InstallAssetOptions, installAsset } from './install-asset';\nimport { activatePlugin } from './activate-plugin';\nimport { writeFile } from './write-file';\nimport { zipNameToHumanName } from '../utils/zip-name-to-human-name';\nimport { Directory } from '../resources';\nimport { joinPaths } from '@php-wasm/util';\nimport { writeFiles } from '@php-wasm/universal';\nimport { logger } from '@php-wasm/logger';\n\n/**\n * @inheritDoc installPlugin\n * @hasRunnableExample\n * @needsLogin\n * @landingPage /wp-admin/plugins.php\n * @example\n *\n * <code>\n * {\n * \t\t\"step\": \"installPlugin\",\n * \t\t\"pluginData\": {\n * \t\t\t\"resource\": \"wordpress.org/plugins\",\n * \t\t\t\"slug\": \"gutenberg\"\n * \t\t},\n * \t\t\"options\": {\n * \t\t\t\"activate\": true\n * \t\t}\n * }\n * </code>\n *\n * @example\n *\n * <code>\n * {\n * \t\t\"step\": \"installPlugin\",\n * \t\t\"pluginData\": {\n * \t\t\t\"resource\": \"git:directory\",\n * \t\t\t\"url\": \"https://github.com/wordpress/wordpress-playground.git\",\n * \t\t\t\t\"ref\": \"HEAD\",\n * \t\t\t\t\"path\": \"wp-content/plugins/hello-dolly\"\n * \t\t},\n * \t\t\"options\": {\n * \t\t\t\"activate\": true\n * \t\t}\n * }\n * </code>\n */\nexport interface InstallPluginStep<FileResource, DirectoryResource>\n\textends Pick<InstallAssetOptions, 'ifAlreadyInstalled'> {\n\t/**\n\t * The step identifier.\n\t */\n\tstep: 'installPlugin';\n\t/**\n\t * The plugin files to install. It can be a plugin zip file, a single PHP\n\t * file, or a directory containing all the plugin files at its root.\n\t */\n\tpluginData: FileResource | DirectoryResource;\n\n\t/**\n\t * @deprecated. Use `pluginData` instead.\n\t */\n\tpluginZipFile?: FileResource;\n\n\t/**\n\t * Optional installation options.\n\t */\n\toptions?: InstallPluginOptions;\n}\n\nexport interface InstallPluginOptions {\n\t/**\n\t * Whether to activate the plugin after installing it.\n\t */\n\tactivate?: boolean;\n\t/**\n\t * The name of the folder to install the plugin to. Defaults to guessing from pluginData\n\t */\n\ttargetFolderName?: string;\n}\n\n/**\n * Installs a WordPress plugin in the Playground.\n *\n * @param playground The playground client.\n * @param pluginData The plugin zip file.\n * @param options Optional. Set `activate` to false if you don't want to activate the plugin.\n */\nexport const installPlugin: StepHandler<\n\tInstallPluginStep<File, Directory>\n> = async (\n\tplayground,\n\t{ pluginData, pluginZipFile, ifAlreadyInstalled, options = {} },\n\tprogress?\n) => {\n\tif (pluginZipFile) {\n\t\tpluginData = pluginZipFile;\n\t\tlogger.warn(\n\t\t\t'The \"pluginZipFile\" option is deprecated. Use \"pluginData\" instead.'\n\t\t);\n\t}\n\n\tconst pluginsDirectoryPath = joinPaths(\n\t\tawait playground.documentRoot,\n\t\t'wp-content',\n\t\t'plugins'\n\t);\n\tconst targetFolderName =\n\t\t'targetFolderName' in options ? options.targetFolderName : '';\n\tlet assetFolderPath = '';\n\tlet assetNiceName = '';\n\tif (pluginData instanceof File) {\n\t\tif (pluginData.name.endsWith('.php')) {\n\t\t\tconst destinationFilePath = joinPaths(\n\t\t\t\tpluginsDirectoryPath,\n\t\t\t\tpluginData.name\n\t\t\t);\n\t\t\tawait writeFile(playground, {\n\t\t\t\tpath: destinationFilePath,\n\t\t\t\tdata: pluginData,\n\t\t\t});\n\t\t\tassetFolderPath = pluginsDirectoryPath;\n\t\t\tassetNiceName = pluginData.name;\n\t\t} else {\n\t\t\t// Assume any other file is a zip file\n\t\t\t// @TODO: Consider validating whether this is a zip file?\n\t\t\tconst zipFileName =\n\t\t\t\tpluginData.name.split('/').pop() || 'plugin.zip';\n\t\t\tassetNiceName = zipNameToHumanName(zipFileName);\n\n\t\t\tprogress?.tracker.setCaption(\n\t\t\t\t`Installing the ${assetNiceName} plugin`\n\t\t\t);\n\t\t\tconst assetResult = await installAsset(playground, {\n\t\t\t\tifAlreadyInstalled,\n\t\t\t\tzipFile: pluginData,\n\t\t\t\ttargetPath: `${await playground.documentRoot}/wp-content/plugins`,\n\t\t\t\ttargetFolderName: targetFolderName,\n\t\t\t});\n\t\t\tassetFolderPath = assetResult.assetFolderPath;\n\t\t\tassetNiceName = assetResult.assetFolderName;\n\t\t}\n\t} else if (pluginData) {\n\t\tassetNiceName = pluginData.name;\n\t\tprogress?.tracker.setCaption(`Installing the ${assetNiceName} plugin`);\n\n\t\tconst pluginDirectoryPath = joinPaths(\n\t\t\tpluginsDirectoryPath,\n\t\t\ttargetFolderName || pluginData.name\n\t\t);\n\t\tawait writeFiles(playground, pluginDirectoryPath, pluginData.files, {\n\t\t\trmRoot: true,\n\t\t});\n\t\tassetFolderPath = pluginDirectoryPath;\n\t}\n\n\t// Activate\n\tconst activate = 'activate' in options ? options.activate : true;\n\n\tif (activate) {\n\t\tawait activatePlugin(\n\t\t\tplayground,\n\t\t\t{\n\t\t\t\tpluginPath: assetFolderPath,\n\t\t\t\tpluginName: assetNiceName,\n\t\t\t},\n\t\t\tprogress\n\t\t);\n\t}\n};\n","import { StepHandler } from '.';\nimport { InstallAssetOptions, installAsset } from './install-asset';\nimport { activateTheme } from './activate-theme';\nimport { Directory } from '../resources';\nimport { importThemeStarterContent } from './import-theme-starter-content';\nimport { zipNameToHumanName } from '../utils/zip-name-to-human-name';\nimport { writeFiles } from '@php-wasm/universal';\nimport { joinPaths } from '@php-wasm/util';\nimport { logger } from '@php-wasm/logger';\n\n/**\n * @inheritDoc installTheme\n * @hasRunnableExample\n * @needsLogin\n * @example\n *\n * <code>\n * {\n * \t\t\"step\": \"installTheme\",\n * \t\t\"themeData\": {\n * \t\t\t\"resource\": \"wordpress.org/themes\",\n * \t\t\t\"slug\": \"pendant\"\n * \t\t},\n * \t\t\"options\": {\n * \t\t\t\"activate\": true,\n * \t\t\t\"importStarterContent\": true\n * \t\t}\n * }\n * </code>\n */\nexport interface InstallThemeStep<FileResource, DirectoryResource>\n\textends Pick<InstallAssetOptions, 'ifAlreadyInstalled'> {\n\t/**\n\t * The step identifier.\n\t */\n\tstep: 'installTheme';\n\t/**\n\t * The theme files to install. It can be either a theme zip file, or a\n\t * directory containing all the theme files at its root.\n\t */\n\tthemeData: FileResource | DirectoryResource;\n\t/**\n\t * @deprecated. Use `themeData` instead.\n\t */\n\tthemeZipFile?: FileResource;\n\t/**\n\t * Optional installation options.\n\t */\n\toptions?: InstallThemeOptions;\n}\n\nexport interface InstallThemeOptions {\n\t/**\n\t * Whether to activate the theme after installing it.\n\t */\n\tactivate?: boolean;\n\t/**\n\t * Whether to import the theme's starter content after installing it.\n\t */\n\timportStarterContent?: boolean;\n\t/**\n\t * The name of the folder to install the theme to. Defaults to guessing from themeData\n\t */\n\ttargetFolderName?: string;\n}\n\n/**\n * Installs a WordPress theme in the Playground.\n *\n * @param playground The playground client.\n * @param themeZipFile The theme zip file.\n * @param options Optional. Set `activate` to false if you don't want to activate the theme.\n */\nexport const installTheme: StepHandler<\n\tInstallThemeStep<File, Directory>\n> = async (\n\tplayground,\n\t{ themeData, themeZipFile, ifAlreadyInstalled, options = {} },\n\tprogress\n) => {\n\tif (themeZipFile) {\n\t\tthemeData = themeZipFile;\n\t\tlogger.warn(\n\t\t\t'The \"themeZipFile\" option is deprecated. Use \"themeData\" instead.'\n\t\t);\n\t}\n\n\tconst targetFolderName = 'targetFolderName' in options ? options.targetFolderName : '';\n\tlet assetFolderName = '';\n\tlet assetNiceName = '';\n\tif (themeData instanceof File) {\n\t\t// @TODO: Consider validating whether this is a zip file?\n\t\tconst zipFileName = themeData.name.split('/').pop() || 'theme.zip';\n\t\tassetNiceName = zipNameToHumanName(zipFileName);\n\n\t\tprogress?.tracker.setCaption(`Installing the ${assetNiceName} theme`);\n\t\tconst assetResult = await installAsset(playground, {\n\t\t\tifAlreadyInstalled,\n\t\t\tzipFile: themeData,\n\t\t\ttargetPath: `${await playground.documentRoot}/wp-content/themes`,\n\t\t\ttargetFolderName: targetFolderName\n\t\t});\n\t\tassetFolderName = assetResult.assetFolderName;\n\t} else {\n\t\tassetNiceName = themeData.name;\n\t\tassetFolderName = targetFolderName || assetNiceName;\n\n\t\tprogress?.tracker.setCaption(`Installing the ${assetNiceName} theme`);\n\t\tconst themeDirectoryPath = joinPaths(\n\t\t\tawait playground.documentRoot,\n\t\t\t'wp-content',\n\t\t\t'themes',\n\t\t\tassetFolderName\n\t\t);\n\t\tawait writeFiles(playground, themeDirectoryPath, themeData.files, {\n\t\t\trmRoot: true,\n\t\t});\n\t}\n\n\tconst activate = 'activate' in options ? options.activate : true;\n\tif (activate) {\n\t\tawait activateTheme(\n\t\t\tplayground,\n\t\t\t{\n\t\t\t\tthemeFolderName: assetFolderName,\n\t\t\t},\n\t\t\tprogress\n\t\t);\n\t}\n\n\tconst importStarterContent =\n\t\t'importStarterContent' in options\n\t\t\t? options.importStarterContent\n\t\t\t: false;\n\tif (importStarterContent) {\n\t\tawait importThemeStarterContent(\n\t\t\tplayground,\n\t\t\t{\n\t\t\t\tthemeSlug: assetFolderName,\n\t\t\t},\n\t\t\tprogress\n\t\t);\n\t}\n};\n","import { StepHandler } from '.';\n\n/**\n * @inheritDoc login\n * @hasRunnableExample\n * @example\n *\n * <code>\n * {\n * \t    \"step\": \"login\",\n * \t\t\"username\": \"admin\",\n * }\n * </code>\n */\nexport type LoginStep = {\n\tstep: 'login';\n\t/**\n\t * The user to log in as. Defaults to 'admin'.\n\t */\n\tusername?: string;\n\t/**\n\t * @deprecated The password field is deprecated and will be removed in a future version.\n\t * Only the username field is required for user authentication.\n\t */\n\tpassword?: string;\n};\n\n/**\n * Logs in to Playground.\n * Under the hood, this function sets the `PLAYGROUND_AUTO_LOGIN_AS_USER` constant.\n * The `0-auto-login.php` mu-plugin uses that constant to log in the user on the first load.\n * This step depends on the `@wp-playground/wordpress` package because\n * the plugin is located in and loaded automatically by the `@wp-playground/wordpress` package.\n */\nexport const login: StepHandler<LoginStep> = async (\n\tplayground,\n\t{ username = 'admin' } = {},\n\tprogress\n) => {\n\tprogress?.tracker.setCaption(progress?.initialCaption || 'Logging in');\n\n\tplayground.defineConstant('PLAYGROUND_AUTO_LOGIN_AS_USER', username);\n};\n","import { StepHandler } from '.';\n\n/**\n * @inheritDoc resetData\n * @example\n *\n * <code>\n * {\n * \t\t\"step\": \"resetData\"\n * }\n * </code>\n */\nexport interface ResetDataStep {\n\tstep: 'resetData';\n}\n\n/**\n * Deletes WordPress posts and comments and sets the auto increment sequence\n * for the posts and comments tables to 0.\n *\n * @param playground Playground client.\n */\nexport const resetData: StepHandler<ResetDataStep> = async (\n\tplayground,\n\t_options,\n\tprogress?\n) => {\n\tprogress?.tracker?.setCaption('Resetting WordPress data');\n\tconst docroot = await playground.documentRoot;\n\tawait playground.run({\n\t\tenv: {\n\t\t\tDOCROOT: docroot,\n\t\t},\n\t\tcode: `<?php\n\t\trequire getenv('DOCROOT') . '/wp-load.php';\n\n\t\t$GLOBALS['@pdo']->query('DELETE FROM wp_posts WHERE id > 0');\n\t\t$GLOBALS['@pdo']->query(\"UPDATE SQLITE_SEQUENCE SET SEQ=0 WHERE NAME='wp_posts'\");\n\t\t\n\t\t$GLOBALS['@pdo']->query('DELETE FROM wp_postmeta WHERE post_id > 1');\n\t\t$GLOBALS['@pdo']->query(\"UPDATE SQLITE_SEQUENCE SET SEQ=20 WHERE NAME='wp_postmeta'\");\n\n\t\t$GLOBALS['@pdo']->query('DELETE FROM wp_comments');\n\t\t$GLOBALS['@pdo']->query(\"UPDATE SQLITE_SEQUENCE SET SEQ=0 WHERE NAME='wp_comments'\");\n\n\t\t$GLOBALS['@pdo']->query('DELETE FROM wp_commentmeta');\n\t\t$GLOBALS['@pdo']->query(\"UPDATE SQLITE_SEQUENCE SET SEQ=0 WHERE NAME='wp_commentmeta'\");\n\t\t`,\n\t});\n};\n","import { StepHandler } from '.';\n\n/**\n * @private\n */\nexport interface RunWpInstallationWizardStep {\n\tstep: 'runWpInstallationWizard';\n\toptions: WordPressInstallationOptions;\n}\n\nexport interface WordPressInstallationOptions {\n\tadminUsername?: string;\n\tadminPassword?: string;\n}\n\n/**\n * Installs WordPress\n *\n * @param playground The playground client.\n * @param options Installation options.\n */\nexport const runWpInstallationWizard: StepHandler<\n\tRunWpInstallationWizardStep\n> = async (playground, { options }) => {\n\tawait playground.request({\n\t\turl: '/wp-admin/install.php?step=2',\n\t\tmethod: 'POST',\n\t\tbody: {\n\t\t\tlanguage: 'en',\n\t\t\tprefix: 'wp_',\n\t\t\tweblog_title: 'My WordPress Website',\n\t\t\tuser_name: options.adminPassword || 'admin',\n\t\t\tadmin_password: options.adminPassword || 'password',\n\t\t\t// The installation wizard demands typing the same password twice\n\t\t\tadmin_password2: options.adminPassword || 'password',\n\t\t\tSubmit: 'Install WordPress',\n\t\t\tpw_weak: '1',\n\t\t\tadmin_email: 'admin@localhost.com',\n\t\t},\n\t});\n};\n","import { joinPaths, phpVars } from '@php-wasm/util';\nimport { UniversalPHP } from '@php-wasm/universal';\nimport { wpContentFilesExcludedFromExport } from '../utils/wp-content-files-excluded-from-exports';\n\ninterface ZipWpContentOptions {\n\t/**\n\t * @private\n\t * A temporary workaround to enable including the WordPress default theme\n\t * in the exported zip file.\n\t */\n\tselfContained?: boolean;\n}\n\n/**\n * Replace the current wp-content directory with one from the provided zip file.\n *\n * @param playground Playground client.\n * @param wpContentZip Zipped WordPress site.\n */\nexport const zipWpContent = async (\n\tplayground: UniversalPHP,\n\t{ selfContained = false }: ZipWpContentOptions = {}\n) => {\n\tconst zipPath = '/tmp/wordpress-playground.zip';\n\n\tconst documentRoot = await playground.documentRoot;\n\tconst wpContentPath = joinPaths(documentRoot, 'wp-content');\n\n\tlet exceptPaths = wpContentFilesExcludedFromExport;\n\t/*\n\t * This is a temporary workaround to enable including the WordPress\n\t * default theme and the SQLite plugin in the exported zip file. Let's\n\t * transition from this workaround to iterator-based streams once the\n\t * new API is merged in PR 851.\n\t */\n\tif (selfContained) {\n\t\t// This is a bit backwards, so hang on!\n\t\t// We have a list of paths to exclude.\n\t\t// We then *remove* the default theme and the SQLite plugin from that list.\n\t\t// As a result, we *include* the default theme and the SQLite plugin in the\n\t\t// final zip. It is hacky and will be removed soon.\n\t\texceptPaths = exceptPaths\n\t\t\t.filter((path) => !path.startsWith('themes/twenty'))\n\t\t\t.filter(\n\t\t\t\t(path) => path !== 'mu-plugins/sqlite-database-integration'\n\t\t\t);\n\t}\n\tconst js = phpVars({\n\t\tzipPath,\n\t\twpContentPath,\n\t\tdocumentRoot,\n\t\texceptPaths: exceptPaths.map((path) =>\n\t\t\tjoinPaths(documentRoot, 'wp-content', path)\n\t\t),\n\t\tadditionalPaths: selfContained\n\t\t\t? {\n\t\t\t\t\t[joinPaths(documentRoot, 'wp-config.php')]: 'wp-config.php',\n\t\t\t  }\n\t\t\t: {},\n\t});\n\tawait runPhpWithZipFunctions(\n\t\tplayground,\n\t\t`zipDir(${js.wpContentPath}, ${js.zipPath}, array(\n\t\t\t'exclude_paths' => ${js.exceptPaths},\n\t\t\t'zip_root'      => ${js.documentRoot},\n\t\t\t'additional_paths' => ${js.additionalPaths}\n\t\t));`\n\t);\n\n\tconst fileBuffer = await playground.readFileAsBuffer(zipPath);\n\tplayground.unlink(zipPath);\n\n\treturn fileBuffer;\n};\n\nconst zipFunctions = `<?php\n\nfunction zipDir($root, $output, $options = array())\n{\n    $root = rtrim($root, '/');\n    $additionalPaths = array_key_exists('additional_paths', $options) ? $options['additional_paths'] : array();\n    $excludePaths = array_key_exists('exclude_paths', $options) ? $options['exclude_paths'] : array();\n    $zip_root = array_key_exists('zip_root', $options) ? $options['zip_root'] : $root;\n\n    $zip = new ZipArchive;\n    $res = $zip->open($output, ZipArchive::CREATE);\n    if ($res === TRUE) {\n        $directories = array(\n            $root . '/'\n        );\n        while (sizeof($directories)) {\n            $current_dir = array_pop($directories);\n\n            if ($handle = opendir($current_dir)) {\n                while (false !== ($entry = readdir($handle))) {\n                    if ($entry == '.' || $entry == '..') {\n                        continue;\n                    }\n\n                    $entry = join_paths($current_dir, $entry);\n                    if (in_array($entry, $excludePaths)) {\n                        continue;\n                    }\n\n                    if (is_dir($entry)) {\n                        $directory_path = $entry . '/';\n                        array_push($directories, $directory_path);\n                    } else if (is_file($entry)) {\n                        $zip->addFile($entry, substr($entry, strlen($zip_root)));\n                    }\n                }\n                closedir($handle);\n            }\n        }\n        foreach ($additionalPaths as $disk_path => $zip_path) {\n            $zip->addFile($disk_path, $zip_path);\n        }\n        $zip->close();\n        chmod($output, 0777);\n    }\n}\n\nfunction join_paths()\n{\n    $paths = array();\n\n    foreach (func_get_args() as $arg) {\n        if ($arg !== '') {\n            $paths[] = $arg;\n        }\n    }\n\n    return preg_replace('#/+#', '/', join('/', $paths));\n}\n`;\n\nasync function runPhpWithZipFunctions(playground: UniversalPHP, code: string) {\n\treturn await playground.run({\n\t\tcode: zipFunctions + code,\n\t});\n}\n","import { PHP, UniversalPHP } from '@php-wasm/universal';\nimport { joinPaths, phpVar } from '@php-wasm/util';\nimport { unzipFile, createMemoizedFetch } from '@wp-playground/common';\nexport { bootWordPress, getFileNotFoundActionForWordPress } from './boot';\nexport { getLoadedWordPressVersion } from './version-detect';\n\nexport * from './version-detect';\nexport * from './rewrite-rules';\n\n/**\n * Preloads the platform mu-plugins from /internal/shared/mu-plugins.\n * This avoids polluting the WordPress installation with mu-plugins\n * that are only needed in the Playground environment.\n *\n * @param php\n */\nexport async function setupPlatformLevelMuPlugins(php: UniversalPHP) {\n\tawait php.mkdir('/internal/shared/mu-plugins');\n\tawait php.writeFile(\n\t\t'/internal/shared/preload/env.php',\n\t\t`<?php\n\n        // Allow adding filters/actions prior to loading WordPress.\n        // $function_to_add MUST be a string.\n        function playground_add_filter( $tag, $function_to_add, $priority = 10, $accepted_args = 1 ) {\n            global $wp_filter;\n            $wp_filter[$tag][$priority][$function_to_add] = array('function' => $function_to_add, 'accepted_args' => $accepted_args);\n        }\n        function playground_add_action( $tag, $function_to_add, $priority = 10, $accepted_args = 1 ) {\n            playground_add_filter( $tag, $function_to_add, $priority, $accepted_args );\n        }\n\n        // Load our mu-plugins after customer mu-plugins\n        // NOTE: this means our mu-plugins can't use the muplugins_loaded action!\n        playground_add_action( 'muplugins_loaded', 'playground_load_mu_plugins', 0 );\n        function playground_load_mu_plugins() {\n            // Load all PHP files from /internal/shared/mu-plugins, sorted by filename\n            $mu_plugins_dir = '/internal/shared/mu-plugins';\n            if(!is_dir($mu_plugins_dir)){\n                return;\n            }\n            $mu_plugins = glob( $mu_plugins_dir . '/*.php' );\n            sort( $mu_plugins );\n            foreach ( $mu_plugins as $mu_plugin ) {\n                require_once $mu_plugin;\n            }\n        }\n    `\n\t);\n\n\t/**\n\t * Automatically logs the user in to aid the login Blueprint step and\n\t * the Playground runtimes.\n\t *\n\t * There are two ways to trigger the auto-login:\n\t *\n\t * ## The PLAYGROUND_AUTO_LOGIN_AS_USER constant\n\t *\n\t * Used by the login Blueprint step does.\n\t *\n\t * When the PLAYGROUND_AUTO_LOGIN_AS_USER constant is defined, this mu-plugin\n\t * will automatically log the user in on their first visit. The username is\n\t * the value of the constant.\n\t *\n\t * On subsequent visits, the playground_auto_login_already_happened cookie will be\n\t * detected and the user will not be logged in. This means the \"logout\" feature\n\t * will work as expected.\n\t *\n\t * ## The playground_force_auto_login_as_user GET parameter\n\t *\n\t * Used by the \"login\" button in various Playground runtimes.\n\t *\n\t * Only works if the PLAYGROUND_FORCE_AUTO_LOGIN_ENABLED constant is defined.\n\t *\n\t * When the playground_force_auto_login_as_user GET parameter is present,\n\t * this mu-plugin will automatically log in any logged out visitor. This will\n\t * happen every time they visit, not just on their first visit.\n\t *\n\t *\n\t * ## Context\n\t *\n\t * The login step used to make a HTTP request to the /wp-login.php endpoint,\n\t * but that approach had significant downsides:\n\t *\n\t * * It only worked in web browsers\n\t * * It didn't support custom login mechanisms\n\t * * It required storing plaintext passwords in the Blueprint files\n\t */\n\tawait php.writeFile(\n\t\t'/internal/shared/mu-plugins/1-auto-login.php',\n\t\t`<?php\n\t\t/**\n\t\t * Returns the username to auto-login as, if any.\n\t\t * @return string|false\n\t\t */\n\t\tfunction playground_get_username_for_auto_login() {\n\t\t\t/**\n\t\t\t * Allow users to auto-login as a specific user on their first visit.\n\t\t\t *\n\t\t\t * Prevent the auto-login if it already happened by checking for the\n\t\t\t * playground_auto_login_already_happened cookie.\n\t\t\t * This is used to allow the user to logout.\n\t\t\t */\n\t\t\tif ( defined('PLAYGROUND_AUTO_LOGIN_AS_USER') && !isset($_COOKIE['playground_auto_login_already_happened']) ) {\n\t\t\t\treturn PLAYGROUND_AUTO_LOGIN_AS_USER;\n\t\t\t}\n\t\t\t/**\n\t\t\t * Allow users to auto-login as a specific user by passing the\n\t\t\t * playground_force_auto_login_as_user GET parameter.\n\t\t\t */\n\t\t\tif ( defined('PLAYGROUND_FORCE_AUTO_LOGIN_ENABLED') && isset($_GET['playground_force_auto_login_as_user']) ) {\n\t\t\t\treturn $_GET['playground_force_auto_login_as_user'];\n\t\t\t}\n\t\t\treturn false;\n\t\t}\n\n\t\t/**\n\t\t * Logs the user in on their first visit if the Playground runtime told us to.\n\t\t */\n\t\tfunction playground_auto_login() {\n\t\t\t/**\n\t\t\t * The redirect should only run if the current PHP request is\n\t\t\t * a HTTP request. If it's a PHP CLI run, we can't login the user\n\t\t\t * because logins require cookies which aren't available in the CLI.\n\t\t\t *\n\t\t\t * Currently all Playground requests use the \"cli\" SAPI name\n\t\t\t * to ensure support for WP-CLI, so the best way to distinguish\n\t\t\t * between a CLI run and an HTTP request is by checking if the\n\t\t\t * $_SERVER['REQUEST_URI'] global is set.\n\t\t\t *\n\t\t\t * If $_SERVER['REQUEST_URI'] is not set, we assume it's a CLI run.\n\t\t\t */\n\t\t\tif (empty($_SERVER['REQUEST_URI'])) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\t$user_name = playground_get_username_for_auto_login();\n\t\t\tif ( false === $user_name ) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif (wp_doing_ajax() || defined('REST_REQUEST')) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif ( is_user_logged_in() ) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\t$user = get_user_by('login', $user_name);\n\t\t\tif (!$user) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t/**\n\t\t\t * We're about to set cookies and redirect. It will log the user in\n\t\t\t * if the headers haven't been sent yet.\n\t\t\t *\n\t\t\t * However, if they have been sent already – e.g. there a PHP\n\t\t\t * notice was printed, we'll exit the script with a bunch of errors\n\t\t\t * on the screen and without the user being logged in. This\n\t\t\t * will happen on every page load and will effectively make Playground\n\t\t\t * unusable.\n\t\t\t *\n\t\t\t * Therefore, we just won't auto-login if headers have been sent. Maybe\n\t\t\t * we'll be able to finish the operation in one of the future requests\n\t\t\t * or maybe not, but at least we won't end up with a permanent white screen.\n\t\t\t */\n\t\t\tif (headers_sent()) {\n\t\t\t\t_doing_it_wrong('playground_auto_login', 'Headers already sent, the Playground runtime will not auto-login the user', '1.0.0');\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t/**\n\t\t\t * This approach is described in a comment on\n\t\t\t * https://developer.wordpress.org/reference/functions/wp_set_current_user/\n\t\t\t */\n\t\t\twp_set_current_user( $user->ID, $user->user_login );\n\t\t\twp_set_auth_cookie( $user->ID );\n\t\t\tdo_action( 'wp_login', $user->user_login, $user );\n\n\t\t\tsetcookie('playground_auto_login_already_happened', '1');\n\n\t\t\t/**\n\t\t\t * Confirm that nothing in WordPress, plugins, or filters have finalized\n\t\t\t * the headers sending phase. See the comment above for more context.\n\t\t\t */\n\t\t\tif (headers_sent()) {\n\t\t\t\t_doing_it_wrong('playground_auto_login', 'Headers already sent, the Playground runtime will not auto-login the user', '1.0.0');\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t/**\n\t\t\t * Reload page to ensure the user is logged in correctly.\n\t\t\t * WordPress uses cookies to determine if the user is logged in,\n\t\t\t * so we need to reload the page to ensure the cookies are set.\n\t\t\t */\n\t\t\t$redirect_url = $_SERVER['REQUEST_URI'];\n\t\t\t/**\n\t\t\t * Intentionally do not use wp_redirect() here. It removes\n\t\t\t * %0A and %0D sequences from the URL, which we don't want.\n\t\t\t * There are valid use-cases for encoded newlines in the query string,\n\t\t\t * for example html-api-debugger accepts markup with newlines\n\t\t\t * encoded as %0A via the query string.\n\t\t\t */\n\t\t\theader( \"Location: $redirect_url\", true, 302 );\n\t\t\texit;\n\t\t}\n\t\t/**\n\t\t * Autologin users from the wp-login.php page.\n\t\t *\n\t\t * The wp hook isn't triggered on\n\t\t **/\n\t\tadd_action('init', 'playground_auto_login', 1);\n\n\t\t/**\n\t\t * Disable the Site Admin Email Verification Screen for any session started\n\t\t * via autologin.\n\t\t */\n\t\tadd_filter('admin_email_check_interval', function($interval) {\n\t\t\tif(false === playground_get_username_for_auto_login()) {\n\t\t\t\treturn 0;\n\t\t\t}\n\t\t\treturn $interval;\n\t\t});\n\t\t`\n\t);\n\n\tawait php.writeFile(\n\t\t'/internal/shared/mu-plugins/0-playground.php',\n\t\t`<?php\n        // Needed because gethostbyname( 'wordpress.org' ) returns\n        // a private network IP address for some reason.\n        add_filter( 'allowed_redirect_hosts', function( $deprecated = '' ) {\n            return array(\n                'wordpress.org',\n                'api.wordpress.org',\n                'downloads.wordpress.org',\n            );\n        } );\n\n\t\t// Support pretty permalinks\n        add_filter( 'got_url_rewrite', '__return_true' );\n\n        // Create the fonts directory if missing\n        if(!file_exists(WP_CONTENT_DIR . '/fonts')) {\n            mkdir(WP_CONTENT_DIR . '/fonts');\n        }\n\n        $log_file = WP_CONTENT_DIR . '/debug.log';\n        define('ERROR_LOG_FILE', $log_file);\n        ini_set('error_log', $log_file);\n        ?>`\n\t);\n\n\t// Load the error handler before any other PHP file to ensure it\n\t// treats all the errors, even those trigerred before mu-plugins\n\t// are loaded.\n\tawait php.writeFile(\n\t\t'/internal/shared/preload/error-handler.php',\n\t\t`<?php\n\t\t(function() {\n\t\t\t$playground_consts = [];\n\t\t\tif(file_exists('/internal/shared/consts.json')) {\n\t\t\t\t$playground_consts = @json_decode(file_get_contents('/internal/shared/consts.json'), true) ?: [];\n\t\t\t\t$playground_consts = array_keys($playground_consts);\n\t\t\t}\n\t\t\tset_error_handler(function($severity, $message, $file, $line) use($playground_consts) {\n\t\t\t\t/**\n\t\t\t\t * This is a temporary workaround to hide the 32bit integer warnings that\n\t\t\t\t * appear when using various time related function, such as strtotime and mktime.\n\t\t\t\t * Examples of the warnings that are displayed:\n\t\t\t\t *\n\t\t\t\t * Warning: mktime(): Epoch doesn't fit in a PHP integer in <file>\n\t\t\t\t * Warning: strtotime(): Epoch doesn't fit in a PHP integer in <file>\n\t\t\t\t */\n\t\t\t\tif (strpos($message, \"fit in a PHP integer\") !== false) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\t/**\n\t\t\t\t * Networking support in Playground registers a http_api_transports filter.\n\t\t\t\t *\n\t\t\t\t * This filter is deprecated, and no longer actively used, but is needed for wp_http_supports().\n\t\t\t\t * @see https://core.trac.wordpress.org/ticket/37708\n\t\t\t\t */\n\t\t\t\tif (\n\t\t\t\t\tstrpos($message, \"http_api_transports\") !== false &&\n\t\t\t\t\tstrpos($message, \"since version 6.4.0 with no alternative available\") !== false\n\t\t\t\t) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\t/**\n\t\t\t\t * Playground defines some constants upfront, and some of them may be redefined\n\t\t\t\t * in wp-config.php. For example, SITE_URL or WP_DEBUG. This is expected and\n\t\t\t\t * we want Playground constants to take priority without showing warnings like:\n\t\t\t\t *\n\t\t\t\t * Warning: Constant SITE_URL already defined in\n\t\t\t\t */\n\t\t\t\tif (strpos($message, \"already defined\") !== false) {\n\t\t\t\t\tforeach($playground_consts as $const) {\n\t\t\t\t\t\tif(strpos($message, \"Constant $const already defined\") !== false) {\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t/**\n\t\t\t\t * Don't complain about network errors when not connected to the network.\n\t\t\t\t */\n\t\t\t\tif (\n\t\t\t\t\t(\n\t\t\t\t\t\t! defined('USE_FETCH_FOR_REQUESTS') ||\n\t\t\t\t\t\t! USE_FETCH_FOR_REQUESTS\n\t\t\t\t\t) &&\n\t\t\t\t\tstrpos($message, \"WordPress could not establish a secure connection to WordPress.org\") !== false)\n\t\t\t\t{\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\treturn false;\n\t\t\t});\n\t\t})();`\n\t);\n}\n\n/**\n * Runs phpinfo() when the requested path is /phpinfo.php.\n */\nexport async function preloadPhpInfoRoute(\n\tphp: UniversalPHP,\n\trequestPath = '/phpinfo.php'\n) {\n\tawait php.writeFile(\n\t\t'/internal/shared/preload/phpinfo.php',\n\t\t`<?php\n    // Render PHPInfo if the requested page is /phpinfo.php\n    if ( ${phpVar(requestPath)} === $_SERVER['REQUEST_URI'] ) {\n        phpinfo();\n        exit;\n    }\n    `\n\t);\n}\n\nexport async function preloadSqliteIntegration(\n\tphp: UniversalPHP,\n\tsqliteZip: File\n) {\n\tif (await php.isDir('/tmp/sqlite-database-integration')) {\n\t\tawait php.rmdir('/tmp/sqlite-database-integration', {\n\t\t\trecursive: true,\n\t\t});\n\t}\n\tawait php.mkdir('/tmp/sqlite-database-integration');\n\tawait unzipFile(php, sqliteZip, '/tmp/sqlite-database-integration');\n\tconst SQLITE_PLUGIN_FOLDER = '/internal/shared/sqlite-database-integration';\n\n\tconst temporarySqlitePluginFolder = (await php.isDir(\n\t\t'/tmp/sqlite-database-integration/sqlite-database-integration-main'\n\t))\n\t\t? // This is the name when the dev branch used to be called \"main\"\n\t\t  '/tmp/sqlite-database-integration/sqlite-database-integration-main'\n\t\t: // This is the name today when the dev branch is called \"develop\"\n\t\t  '/tmp/sqlite-database-integration/sqlite-database-integration-develop';\n\tawait php.mv(temporarySqlitePluginFolder, SQLITE_PLUGIN_FOLDER);\n\n\t// Prevents the SQLite integration from trying to call activate_plugin()\n\tawait php.defineConstant('SQLITE_MAIN_FILE', '1');\n\tconst dbCopy = await php.readFileAsText(\n\t\tjoinPaths(SQLITE_PLUGIN_FOLDER, 'db.copy')\n\t);\n\tconst dbPhp = dbCopy\n\t\t.replace(\n\t\t\t\"'{SQLITE_IMPLEMENTATION_FOLDER_PATH}'\",\n\t\t\tphpVar(SQLITE_PLUGIN_FOLDER)\n\t\t)\n\t\t.replace(\n\t\t\t\"'{SQLITE_PLUGIN}'\",\n\t\t\tphpVar(joinPaths(SQLITE_PLUGIN_FOLDER, 'load.php'))\n\t\t);\n\tconst dbPhpPath = joinPaths(await php.documentRoot, 'wp-content/db.php');\n\tconst stopIfDbPhpExists = `<?php\n\t// Do not preload this if WordPress comes with a custom db.php file.\n\tif(file_exists(${phpVar(dbPhpPath)})) {\n\t\treturn;\n\t}\n\t?>`;\n\tconst SQLITE_MUPLUGIN_PATH =\n\t\t'/internal/shared/mu-plugins/sqlite-database-integration.php';\n\tawait php.writeFile(SQLITE_MUPLUGIN_PATH, stopIfDbPhpExists + dbPhp);\n\tawait php.writeFile(\n\t\t`/internal/shared/preload/0-sqlite.php`,\n\t\tstopIfDbPhpExists +\n\t\t\t`<?php\n\n/**\n * Loads the SQLite integration plugin before WordPress is loaded\n * and without creating a drop-in \"db.php\" file.\n *\n * Technically, it creates a global $wpdb object whose only two\n * purposes are to:\n *\n * * Exist – because the require_wp_db() WordPress function won't\n *           connect to MySQL if $wpdb is already set.\n * * Load the SQLite integration plugin the first time it's used\n *   and replace the global $wpdb reference with the SQLite one.\n *\n * This lets Playground keep the WordPress installation clean and\n * solves dillemas like:\n *\n * * Should we include db.php in Playground exports?\n * * Should we remove db.php from Playground imports?\n * * How should we treat stale db.php from long-lived OPFS sites?\n *\n * @see https://github.com/WordPress/wordpress-playground/discussions/1379 for\n *      more context.\n */\nclass Playground_SQLite_Integration_Loader {\n\tpublic function __call($name, $arguments) {\n\t\t$this->load_sqlite_integration();\n\t\tif($GLOBALS['wpdb'] === $this) {\n\t\t\tthrow new Exception('Infinite loop detected in $wpdb – SQLite integration plugin could not be loaded');\n\t\t}\n\t\treturn call_user_func_array(\n\t\t\tarray($GLOBALS['wpdb'], $name),\n\t\t\t$arguments\n\t\t);\n\t}\n\tpublic function __get($name) {\n\t\t$this->load_sqlite_integration();\n\t\tif($GLOBALS['wpdb'] === $this) {\n\t\t\tthrow new Exception('Infinite loop detected in $wpdb – SQLite integration plugin could not be loaded');\n\t\t}\n\t\treturn $GLOBALS['wpdb']->$name;\n\t}\n\tpublic function __set($name, $value) {\n\t\t$this->load_sqlite_integration();\n\t\tif($GLOBALS['wpdb'] === $this) {\n\t\t\tthrow new Exception('Infinite loop detected in $wpdb – SQLite integration plugin could not be loaded');\n\t\t}\n\t\t$GLOBALS['wpdb']->$name = $value;\n\t}\n    protected function load_sqlite_integration() {\n        require_once ${phpVar(SQLITE_MUPLUGIN_PATH)};\n    }\n}\n$wpdb = $GLOBALS['wpdb'] = new Playground_SQLite_Integration_Loader();\n\n/**\n * WordPress is capable of using a preloaded global $wpdb. However, if\n * it cannot find the drop-in db.php plugin it still checks whether\n * the mysqli_connect() function exists even though it's not used.\n *\n * What WordPress demands, Playground shall provide.\n */\nif(!function_exists('mysqli_connect')) {\n\tfunction mysqli_connect() {}\n}\n\n\t\t`\n\t);\n\t/**\n\t * Ensure the SQLite integration is loaded and clearly communicate\n\t * if it isn't. This is useful because WordPress database errors\n\t * may be cryptic and won't mention the SQLite integration.\n\t */\n\tawait php.writeFile(\n\t\t`/internal/shared/mu-plugins/sqlite-test.php`,\n\t\t`<?php\n\t\tglobal $wpdb;\n\t\tif(!($wpdb instanceof WP_SQLite_DB)) {\n\t\t\tvar_dump(isset($wpdb));\n\t\t\tdie(\"SQLite integration not loaded \" . get_class($wpdb));\n\t\t}\n\t\t`\n\t);\n}\n\n/**\n * Prepare the WordPress document root given a WordPress zip file and\n * the sqlite-database-integration zip file.\n *\n * This is a TypeScript function for now, just to get something off the\n * ground, but it may be superseded by the PHP Blueprints library developed\n * at https://github.com/WordPress/blueprints-library/\n *\n * That PHP library will come with a set of functions and a CLI tool to\n * turn a Blueprint into a WordPress directory structure or a zip Snapshot.\n * Let's **not** invest in the TypeScript implementation of this function,\n * accept the limitation, and switch to the PHP implementation as soon\n * as that's viable.\n */\nexport async function unzipWordPress(php: PHP, wpZip: File) {\n\tphp.mkdir('/tmp/unzipped-wordpress');\n\tawait unzipFile(php, wpZip, '/tmp/unzipped-wordpress');\n\n\t// The zip file may contain another zip file if it's coming from GitHub\n\t// artifacts @TODO: Don't make so many guesses about the zip file contents.\n\t// Allow the API consumer to specify the exact \"coordinates\" of WordPress\n\t// inside the zip archive.\n\tif (php.fileExists('/tmp/unzipped-wordpress/wordpress.zip')) {\n\t\tawait unzipFile(\n\t\t\tphp,\n\t\t\t'/tmp/unzipped-wordpress/wordpress.zip',\n\t\t\t'/tmp/unzipped-wordpress'\n\t\t);\n\t}\n\n\t// The zip file may contain a subdirectory, or not.\n\t// @TODO: Don't make so many guesses about the zip file contents. Allow the\n\t//        API consumer to specify the exact \"coordinates\" of WordPress inside\n\t//        the zip archive.\n\tlet wpPath = php.fileExists('/tmp/unzipped-wordpress/wordpress')\n\t\t? '/tmp/unzipped-wordpress/wordpress'\n\t\t: php.fileExists('/tmp/unzipped-wordpress/build')\n\t\t? '/tmp/unzipped-wordpress/build'\n\t\t: '/tmp/unzipped-wordpress';\n\n\t// Dive one directory deeper if the zip root does not contain the sample\n\t// config file. This is relevant when unzipping a zipped branch from the\n\t// https://github.com/WordPress/WordPress repository.\n\tif (!php.fileExists(joinPaths(wpPath, 'wp-config-sample.php'))) {\n\t\t// Still don't know the directory structure of the zip file.\n\t\t// 1. Get the first item in path.\n\t\tconst files = php.listFiles(wpPath);\n\t\tif (files.length) {\n\t\t\tconst firstDir = files[0];\n\t\t\t// 2. If it's a directory that contains wp-config-sample.php, use it.\n\t\t\tif (\n\t\t\t\tphp.fileExists(\n\t\t\t\t\tjoinPaths(wpPath, firstDir, 'wp-config-sample.php')\n\t\t\t\t)\n\t\t\t) {\n\t\t\t\twpPath = joinPaths(wpPath, firstDir);\n\t\t\t}\n\t\t}\n\t}\n\n\tif (\n\t\tphp.isDir(php.documentRoot) &&\n\t\tisCleanDirContainingSiteMetadata(php.documentRoot, php)\n\t) {\n\t\t// We cannot mv the directory over a non-empty directory,\n\t\t// but we can move the children one by one.\n\t\tfor (const file of php.listFiles(wpPath)) {\n\t\t\tconst sourcePath = joinPaths(wpPath, file);\n\t\t\tconst targetPath = joinPaths(php.documentRoot, file);\n\t\t\tphp.mv(sourcePath, targetPath);\n\t\t}\n\t\tphp.rmdir(wpPath, { recursive: true });\n\t} else {\n\t\tphp.mv(wpPath, php.documentRoot);\n\t}\n\n\tif (\n\t\t!php.fileExists(joinPaths(php.documentRoot, 'wp-config.php')) &&\n\t\tphp.fileExists(joinPaths(php.documentRoot, 'wp-config-sample.php'))\n\t) {\n\t\tphp.writeFile(\n\t\t\tjoinPaths(php.documentRoot, 'wp-config.php'),\n\t\t\tphp.readFileAsText(\n\t\t\t\tjoinPaths(php.documentRoot, '/wp-config-sample.php')\n\t\t\t)\n\t\t);\n\t}\n}\n\nfunction isCleanDirContainingSiteMetadata(path: string, php: PHP) {\n\tconst files = php.listFiles(path);\n\tif (files.length === 0) {\n\t\treturn true;\n\t}\n\n\tif (\n\t\tfiles.length === 1 &&\n\t\t// TODO: use a constant from a site storage package\n\t\tfiles[0] === 'playground-site-metadata.json'\n\t) {\n\t\treturn true;\n\t}\n\n\treturn false;\n}\n\nconst memoizedFetch = createMemoizedFetch(fetch);\n\n/**\n * Resolves a specific WordPress release URL and version string based on\n * a version query string such as \"latest\", \"beta\", or \"6.6\".\n *\n * Examples:\n * ```js\n * const { releaseUrl, version } = await resolveWordPressRelease('latest')\n * // becomes https://wordpress.org/wordpress-6.6.2.zip and '6.6.2'\n *\n * const { releaseUrl, version } = await resolveWordPressRelease('beta')\n * // becomes https://wordpress.org/wordpress-6.6.2-RC1.zip and '6.6.2-RC1'\n *\n * const { releaseUrl, version } = await resolveWordPressRelease('6.6')\n * // becomes https://wordpress.org/wordpress-6.6.2.zip and '6.6.2'\n * ```\n *\n * @param versionQuery - The WordPress version query string to resolve.\n * @returns The resolved WordPress release URL and version string.\n */\nexport async function resolveWordPressRelease(versionQuery = 'latest') {\n\tif (\n\t\tversionQuery.startsWith('https://') ||\n\t\tversionQuery.startsWith('http://')\n\t) {\n\t\tconst shasum = await crypto.subtle.digest(\n\t\t\t'SHA-1',\n\t\t\tnew TextEncoder().encode(versionQuery)\n\t\t);\n\t\tconst sha1 = Array.from(new Uint8Array(shasum))\n\t\t\t.map((b) => b.toString(16).padStart(2, '0'))\n\t\t\t.join('');\n\t\treturn {\n\t\t\treleaseUrl: versionQuery,\n\t\t\tversion: 'custom-' + sha1.substring(0, 8),\n\t\t\tsource: 'inferred',\n\t\t};\n\t} else if (versionQuery === 'trunk' || versionQuery === 'nightly') {\n\t\treturn {\n\t\t\treleaseUrl:\n\t\t\t\t'https://wordpress.org/nightly-builds/wordpress-latest.zip',\n\t\t\tversion: 'nightly-' + new Date().toISOString().split('T')[0],\n\t\t\tsource: 'inferred',\n\t\t};\n\t}\n\n\tconst response = await memoizedFetch(\n\t\t'https://api.wordpress.org/core/version-check/1.7/?channel=beta'\n\t);\n\tlet latestVersions = await response.json();\n\n\tlatestVersions = latestVersions.offers.filter(\n\t\t(v: any) => v.response === 'autoupdate'\n\t);\n\n\tfor (const apiVersion of latestVersions) {\n\t\tif (versionQuery === 'beta' && apiVersion.version.includes('beta')) {\n\t\t\treturn {\n\t\t\t\treleaseUrl: apiVersion.download,\n\t\t\t\tversion: apiVersion.version,\n\t\t\t\tsource: 'api',\n\t\t\t};\n\t\t} else if (\n\t\t\tversionQuery === 'latest' &&\n\t\t\t!apiVersion.version.includes('beta')\n\t\t) {\n\t\t\t// The first non-beta item in the list is the latest version.\n\t\t\treturn {\n\t\t\t\treleaseUrl: apiVersion.download,\n\t\t\t\tversion: apiVersion.version,\n\t\t\t\tsource: 'api',\n\t\t\t};\n\t\t} else if (\n\t\t\tapiVersion.version.substring(0, versionQuery.length) ===\n\t\t\tversionQuery\n\t\t) {\n\t\t\treturn {\n\t\t\t\treleaseUrl: apiVersion.download,\n\t\t\t\tversion: apiVersion.version,\n\t\t\t\tsource: 'api',\n\t\t\t};\n\t\t}\n\t}\n\n\treturn {\n\t\treleaseUrl: `https://wordpress.org/wordpress-${versionQuery}.zip`,\n\t\tversion: versionQuery,\n\t\tsource: 'inferred',\n\t};\n}\n","import { StepHandler } from '.';\nimport { unzipFile } from '@wp-playground/common';\nimport { logger } from '@php-wasm/logger';\nimport { resolveWordPressRelease } from '@wp-playground/wordpress';\nimport { Semaphore } from '@php-wasm/util';\n\n/**\n * @inheritDoc setSiteLanguage\n * @hasRunnableExample\n * @example\n *\n * <code>\n * {\n * \t\t\"step\": \"setSiteLanguage\",\n * \t\t\"language\": \"en_US\"\n * }\n * </code>\n */\nexport interface SetSiteLanguageStep {\n\tstep: 'setSiteLanguage';\n\t/** The language to set, e.g. 'en_US' */\n\tlanguage: string;\n}\n\n/**\n * Infers the translation package URL for a given WordPress version.\n *\n * If it cannot be inferred, the latest translation package will be used instead.\n */\nexport const getWordPressTranslationUrl = async (\n\twpVersion: string,\n\tlanguage: string,\n\tlatestBetaWordPressVersion?: string,\n\tlatestStableWordPressVersion?: string\n) => {\n\t/**\n\t * Infer a WordPress version we can feed into the translations API based\n\t * on the requested fully-qualified WordPress version.\n\t *\n\t * The translation API provides translations for:\n\t *\n\t * - all major.minor WordPress releases\n\t * - all major.minor.patch WordPress releases\n\t * - Latest beta/RC version – under a label like \"6.6-RC\". It's always \"-RC\".\n\t *   There's no \"-BETA1\", \"-RC1\", \"-RC2\", etc.\n\t *\n\t * The API does not provide translations for \"nightly\", \"latest\", or\n\t * old beta/RC versions.\n\t *\n\t * For example translations for WordPress 6.6-BETA1 or 6.6-RC1 are found under\n\t * https://downloads.wordpress.org/translation/core/6.6-RC/en_GB.zip\n\t */\n\tlet resolvedVersion = null;\n\tif (wpVersion.match(/^(\\d+\\.\\d+)(?:\\.\\d+)?$/)) {\n\t\t// Use the version directly if it's a major.minor or major.minor.patch.\n\t\tresolvedVersion = wpVersion;\n\t} else if (wpVersion.match(/^(\\d.\\d(.\\d)?)-(beta|rc|alpha|nightly).*$/i)) {\n\t\t// Translate \"6.4-alpha\", \"6.5-beta\", \"6.6-nightly\", \"6.6-RC\" etc.\n\t\t// to \"6.6-RC\"\n\t\tif (latestBetaWordPressVersion) {\n\t\t\tresolvedVersion = latestBetaWordPressVersion;\n\t\t} else {\n\t\t\tlet resolved = await resolveWordPressRelease('beta');\n\t\t\t// Beta versions are only available during the beta period –\n\t\t\t// let's use the latest stable release as a fallback.\n\t\t\tif (resolved.source !== 'api') {\n\t\t\t\tresolved = await resolveWordPressRelease('latest');\n\t\t\t}\n\t\t\tresolvedVersion = resolved!.version;\n\t\t}\n\t\tresolvedVersion = resolvedVersion\n\t\t\t// Remove the patch version, e.g. 6.6.1-RC1 -> 6.6-RC1\n\t\t\t.replace(/^(\\d.\\d)(.\\d+)/i, '$1')\n\t\t\t// Replace \"rc\" and \"beta\" with \"RC\", e.g. 6.6-nightly -> 6.6-RC\n\t\t\t.replace(/(rc|beta).*$/i, 'RC');\n\t} else {\n\t\t/**\n\t\t * Use the latest stable version otherwise.\n\t\t *\n\t\t * The requested version is neither stable, nor beta/RC, nor alpha/nightly.\n\t\t * It must be a custom version string. We could actually fail at this point,\n\t\t * but it seems more useful to* download translations from the last official\n\t\t * WordPress version. If that assumption is wrong, let's reconsider this whenever\n\t\t * someone reports a related issue.\n\t\t */\n\t\tif (latestStableWordPressVersion) {\n\t\t\tresolvedVersion = latestStableWordPressVersion;\n\t\t} else {\n\t\t\tconst resolved = await resolveWordPressRelease('latest');\n\t\t\tresolvedVersion = resolved!.version;\n\t\t}\n\t}\n\tif (!resolvedVersion) {\n\t\tthrow new Error(\n\t\t\t`WordPress version ${wpVersion} is not supported by the setSiteLanguage step`\n\t\t);\n\t}\n\treturn `https://downloads.wordpress.org/translation/core/${resolvedVersion}/${language}.zip`;\n};\n\n/**\n * Sets the site language and download translations.\n */\nexport const setSiteLanguage: StepHandler<SetSiteLanguageStep> = async (\n\tplayground,\n\t{ language },\n\tprogress\n) => {\n\tprogress?.tracker.setCaption(progress?.initialCaption || 'Translating');\n\n\tawait playground.defineConstant('WPLANG', language);\n\n\tconst docroot = await playground.documentRoot;\n\n\tconst wpVersion = (\n\t\tawait playground.run({\n\t\t\tcode: `<?php\n\t\t\trequire '${docroot}/wp-includes/version.php';\n\t\t\techo $wp_version;\n\t\t`,\n\t\t})\n\t).text;\n\n\tconst translations = [\n\t\t{\n\t\t\turl: await getWordPressTranslationUrl(wpVersion, language),\n\t\t\ttype: 'core',\n\t\t},\n\t];\n\n\tconst pluginListResponse = await playground.run({\n\t\tcode: `<?php\n\t\trequire_once('${docroot}/wp-load.php');\n\t\trequire_once('${docroot}/wp-admin/includes/plugin.php');\n\t\techo json_encode(\n\t\t\tarray_values(\n\t\t\t\tarray_map(\n\t\t\t\t\tfunction($plugin) {\n\t\t\t\t\t\treturn [\n\t\t\t\t\t\t\t'slug'    => $plugin['TextDomain'],\n\t\t\t\t\t\t\t'version' => $plugin['Version']\n\t\t\t\t\t\t];\n\t\t\t\t\t},\n\t\t\t\t\tarray_filter(\n\t\t\t\t\t\tget_plugins(),\n\t\t\t\t\t\tfunction($plugin) {\n\t\t\t\t\t\t\treturn !empty($plugin['TextDomain']);\n\t\t\t\t\t\t}\n\t\t\t\t\t)\n\t\t\t\t)\n\t\t\t)\n\t\t);`,\n\t});\n\n\tconst plugins = pluginListResponse.json;\n\tfor (const { slug, version } of plugins) {\n\t\ttranslations.push({\n\t\t\turl: `https://downloads.wordpress.org/translation/plugin/${slug}/${version}/${language}.zip`,\n\t\t\ttype: 'plugin',\n\t\t});\n\t}\n\n\tconst themeListResponse = await playground.run({\n\t\tcode: `<?php\n\t\trequire_once('${docroot}/wp-load.php');\n\t\trequire_once('${docroot}/wp-admin/includes/theme.php');\n\t\techo json_encode(\n\t\t\tarray_values(\n\t\t\t\tarray_map(\n\t\t\t\t\tfunction($theme) {\n\t\t\t\t\t\treturn [\n\t\t\t\t\t\t\t'slug'    => $theme->get('TextDomain'),\n\t\t\t\t\t\t\t'version' => $theme->get('Version')\n\t\t\t\t\t\t];\n\t\t\t\t\t},\n\t\t\t\t\twp_get_themes()\n\t\t\t\t)\n\t\t\t)\n\t\t);`,\n\t});\n\n\tconst themes = themeListResponse.json;\n\tfor (const { slug, version } of themes) {\n\t\ttranslations.push({\n\t\t\turl: `https://downloads.wordpress.org/translation/theme/${slug}/${version}/${language}.zip`,\n\t\t\ttype: 'theme',\n\t\t});\n\t}\n\n\tif (!(await playground.isDir(`${docroot}/wp-content/languages/plugins`))) {\n\t\tawait playground.mkdir(`${docroot}/wp-content/languages/plugins`);\n\t}\n\tif (!(await playground.isDir(`${docroot}/wp-content/languages/themes`))) {\n\t\tawait playground.mkdir(`${docroot}/wp-content/languages/themes`);\n\t}\n\n\t// Fetch translations in parallel\n\tconst fetchQueue = new Semaphore({ concurrency: 5 });\n\tconst translationsQueue = translations.map(({ url, type }) =>\n\t\tfetchQueue.run(async () => {\n\t\t\ttry {\n\t\t\t\tconst response = await fetch(url);\n\t\t\t\tif (!response.ok) {\n\t\t\t\t\tthrow new Error(\n\t\t\t\t\t\t`Failed to download translations for ${type}: ${response.statusText}`\n\t\t\t\t\t);\n\t\t\t\t}\n\n\t\t\t\tlet destination = `${docroot}/wp-content/languages`;\n\t\t\t\tif (type === 'plugin') {\n\t\t\t\t\tdestination += '/plugins';\n\t\t\t\t} else if (type === 'theme') {\n\t\t\t\t\tdestination += '/themes';\n\t\t\t\t}\n\n\t\t\t\tawait unzipFile(\n\t\t\t\t\tplayground,\n\t\t\t\t\tnew File(\n\t\t\t\t\t\t[await response.blob()],\n\t\t\t\t\t\t`${language}-${type}.zip`\n\t\t\t\t\t),\n\t\t\t\t\tdestination\n\t\t\t\t);\n\t\t\t} catch (error) {\n\t\t\t\t/**\n\t\t\t\t * Throw an error when a core translation isn't found.\n\t\t\t\t *\n\t\t\t\t * The language slug used in the Blueprint is not recognized by the\n\t\t\t\t * WordPress.org API and will always return a 404. This is likely\n\t\t\t\t * unintentional – perhaps a typo or the API consumer guessed the\n\t\t\t\t * slug wrong.\n\t\t\t\t *\n\t\t\t\t * The least we can do is communicate the problem.\n\t\t\t\t */\n\t\t\t\tif (type === 'core') {\n\t\t\t\t\tthrow new Error(\n\t\t\t\t\t\t`Failed to download translations for WordPress. Please check if the language code ${language} is correct. You can find all available languages and translations on https://translate.wordpress.org/.`\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\t/**\n\t\t\t\t * WordPress core has translations for the requested language,\n\t\t\t\t * but one of the installed plugins or themes doesn't.\n\t\t\t\t *\n\t\t\t\t * This is fine. Not all plugins and themes have translations for\n\t\t\t\t * every language. Let's just log a warning and move on.\n\t\t\t\t */\n\t\t\t\tlogger.warn(\n\t\t\t\t\t`Error downloading translations for ${type}: ${error}`\n\t\t\t\t);\n\t\t\t}\n\t\t})\n\t);\n\tawait Promise.all(translationsQueue);\n};\n","export class BaseError extends Error {\n  constructor(message) {\n    super(message)\n    // Setting this here allows TS to infer that all git errors have a `caller` property and\n    // that its type is string.\n    this.caller = ''\n  }\n\n  toJSON() {\n    // Error objects aren't normally serializable. So we do something about that.\n    return {\n      code: this.code,\n      data: this.data,\n      caller: this.caller,\n      message: this.message,\n      stack: this.stack,\n    }\n  }\n\n  fromJSON(json) {\n    const e = new BaseError(json.message)\n    e.code = json.code\n    e.data = json.data\n    e.caller = json.caller\n    e.stack = json.stack\n    return e\n  }\n\n  get isIsomorphicGitError() {\n    return true\n  }\n}\n","/*! crc32.js (C) 2014-present SheetJS -- http://sheetjs.com */\n/* vim: set ts=2: */\n/*exported CRC32 */\nvar CRC32;\n(function (factory) {\n\t/*jshint ignore:start */\n\t/*eslint-disable */\n\tif(typeof DO_NOT_EXPORT_CRC === 'undefined') {\n\t\tif('object' === typeof exports) {\n\t\t\tfactory(exports);\n\t\t} else if ('function' === typeof define && define.amd) {\n\t\t\tdefine(function () {\n\t\t\t\tvar module = {};\n\t\t\t\tfactory(module);\n\t\t\t\treturn module;\n\t\t\t});\n\t\t} else {\n\t\t\tfactory(CRC32 = {});\n\t\t}\n\t} else {\n\t\tfactory(CRC32 = {});\n\t}\n\t/*eslint-enable */\n\t/*jshint ignore:end */\n}(function(CRC32) {\nCRC32.version = '1.2.2';\n/*global Int32Array */\nfunction signed_crc_table() {\n\tvar c = 0, table = new Array(256);\n\n\tfor(var n =0; n != 256; ++n){\n\t\tc = n;\n\t\tc = ((c&1) ? (-306674912 ^ (c >>> 1)) : (c >>> 1));\n\t\tc = ((c&1) ? (-306674912 ^ (c >>> 1)) : (c >>> 1));\n\t\tc = ((c&1) ? (-306674912 ^ (c >>> 1)) : (c >>> 1));\n\t\tc = ((c&1) ? (-306674912 ^ (c >>> 1)) : (c >>> 1));\n\t\tc = ((c&1) ? (-306674912 ^ (c >>> 1)) : (c >>> 1));\n\t\tc = ((c&1) ? (-306674912 ^ (c >>> 1)) : (c >>> 1));\n\t\tc = ((c&1) ? (-306674912 ^ (c >>> 1)) : (c >>> 1));\n\t\tc = ((c&1) ? (-306674912 ^ (c >>> 1)) : (c >>> 1));\n\t\ttable[n] = c;\n\t}\n\n\treturn typeof Int32Array !== 'undefined' ? new Int32Array(table) : table;\n}\n\nvar T0 = signed_crc_table();\nfunction slice_by_16_tables(T) {\n\tvar c = 0, v = 0, n = 0, table = typeof Int32Array !== 'undefined' ? new Int32Array(4096) : new Array(4096) ;\n\n\tfor(n = 0; n != 256; ++n) table[n] = T[n];\n\tfor(n = 0; n != 256; ++n) {\n\t\tv = T[n];\n\t\tfor(c = 256 + n; c < 4096; c += 256) v = table[c] = (v >>> 8) ^ T[v & 0xFF];\n\t}\n\tvar out = [];\n\tfor(n = 1; n != 16; ++n) out[n - 1] = typeof Int32Array !== 'undefined' ? table.subarray(n * 256, n * 256 + 256) : table.slice(n * 256, n * 256 + 256);\n\treturn out;\n}\nvar TT = slice_by_16_tables(T0);\nvar T1 = TT[0],  T2 = TT[1],  T3 = TT[2],  T4 = TT[3],  T5 = TT[4];\nvar T6 = TT[5],  T7 = TT[6],  T8 = TT[7],  T9 = TT[8],  Ta = TT[9];\nvar Tb = TT[10], Tc = TT[11], Td = TT[12], Te = TT[13], Tf = TT[14];\nfunction crc32_bstr(bstr, seed) {\n\tvar C = seed ^ -1;\n\tfor(var i = 0, L = bstr.length; i < L;) C = (C>>>8) ^ T0[(C^bstr.charCodeAt(i++))&0xFF];\n\treturn ~C;\n}\n\nfunction crc32_buf(B, seed) {\n\tvar C = seed ^ -1, L = B.length - 15, i = 0;\n\tfor(; i < L;) C =\n\t\tTf[B[i++] ^ (C & 255)] ^\n\t\tTe[B[i++] ^ ((C >> 8) & 255)] ^\n\t\tTd[B[i++] ^ ((C >> 16) & 255)] ^\n\t\tTc[B[i++] ^ (C >>> 24)] ^\n\t\tTb[B[i++]] ^ Ta[B[i++]] ^ T9[B[i++]] ^ T8[B[i++]] ^\n\t\tT7[B[i++]] ^ T6[B[i++]] ^ T5[B[i++]] ^ T4[B[i++]] ^\n\t\tT3[B[i++]] ^ T2[B[i++]] ^ T1[B[i++]] ^ T0[B[i++]];\n\tL += 15;\n\twhile(i < L) C = (C>>>8) ^ T0[(C^B[i++])&0xFF];\n\treturn ~C;\n}\n\nfunction crc32_str(str, seed) {\n\tvar C = seed ^ -1;\n\tfor(var i = 0, L = str.length, c = 0, d = 0; i < L;) {\n\t\tc = str.charCodeAt(i++);\n\t\tif(c < 0x80) {\n\t\t\tC = (C>>>8) ^ T0[(C^c)&0xFF];\n\t\t} else if(c < 0x800) {\n\t\t\tC = (C>>>8) ^ T0[(C ^ (192|((c>>6)&31)))&0xFF];\n\t\t\tC = (C>>>8) ^ T0[(C ^ (128|(c&63)))&0xFF];\n\t\t} else if(c >= 0xD800 && c < 0xE000) {\n\t\t\tc = (c&1023)+64; d = str.charCodeAt(i++)&1023;\n\t\t\tC = (C>>>8) ^ T0[(C ^ (240|((c>>8)&7)))&0xFF];\n\t\t\tC = (C>>>8) ^ T0[(C ^ (128|((c>>2)&63)))&0xFF];\n\t\t\tC = (C>>>8) ^ T0[(C ^ (128|((d>>6)&15)|((c&3)<<4)))&0xFF];\n\t\t\tC = (C>>>8) ^ T0[(C ^ (128|(d&63)))&0xFF];\n\t\t} else {\n\t\t\tC = (C>>>8) ^ T0[(C ^ (224|((c>>12)&15)))&0xFF];\n\t\t\tC = (C>>>8) ^ T0[(C ^ (128|((c>>6)&63)))&0xFF];\n\t\t\tC = (C>>>8) ^ T0[(C ^ (128|(c&63)))&0xFF];\n\t\t}\n\t}\n\treturn ~C;\n}\nCRC32.table = T0;\n// $FlowIgnore\nCRC32.bstr = crc32_bstr;\n// $FlowIgnore\nCRC32.buf = crc32_buf;\n// $FlowIgnore\nCRC32.str = crc32_str;\n}));\n","'use strict'\n\nexports.byteLength = byteLength\nexports.toByteArray = toByteArray\nexports.fromByteArray = fromByteArray\n\nvar lookup = []\nvar revLookup = []\nvar Arr = typeof Uint8Array !== 'undefined' ? Uint8Array : Array\n\nvar code = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/'\nfor (var i = 0, len = code.length; i < len; ++i) {\n  lookup[i] = code[i]\n  revLookup[code.charCodeAt(i)] = i\n}\n\n// Support decoding URL-safe base64 strings, as Node.js does.\n// See: https://en.wikipedia.org/wiki/Base64#URL_applications\nrevLookup['-'.charCodeAt(0)] = 62\nrevLookup['_'.charCodeAt(0)] = 63\n\nfunction getLens (b64) {\n  var len = b64.length\n\n  if (len % 4 > 0) {\n    throw new Error('Invalid string. Length must be a multiple of 4')\n  }\n\n  // Trim off extra bytes after placeholder bytes are found\n  // See: https://github.com/beatgammit/base64-js/issues/42\n  var validLen = b64.indexOf('=')\n  if (validLen === -1) validLen = len\n\n  var placeHoldersLen = validLen === len\n    ? 0\n    : 4 - (validLen % 4)\n\n  return [validLen, placeHoldersLen]\n}\n\n// base64 is 4/3 + up to two characters of the original data\nfunction byteLength (b64) {\n  var lens = getLens(b64)\n  var validLen = lens[0]\n  var placeHoldersLen = lens[1]\n  return ((validLen + placeHoldersLen) * 3 / 4) - placeHoldersLen\n}\n\nfunction _byteLength (b64, validLen, placeHoldersLen) {\n  return ((validLen + placeHoldersLen) * 3 / 4) - placeHoldersLen\n}\n\nfunction toByteArray (b64) {\n  var tmp\n  var lens = getLens(b64)\n  var validLen = lens[0]\n  var placeHoldersLen = lens[1]\n\n  var arr = new Arr(_byteLength(b64, validLen, placeHoldersLen))\n\n  var curByte = 0\n\n  // if there are placeholders, only get up to the last complete 4 chars\n  var len = placeHoldersLen > 0\n    ? validLen - 4\n    : validLen\n\n  var i\n  for (i = 0; i < len; i += 4) {\n    tmp =\n      (revLookup[b64.charCodeAt(i)] << 18) |\n      (revLookup[b64.charCodeAt(i + 1)] << 12) |\n      (revLookup[b64.charCodeAt(i + 2)] << 6) |\n      revLookup[b64.charCodeAt(i + 3)]\n    arr[curByte++] = (tmp >> 16) & 0xFF\n    arr[curByte++] = (tmp >> 8) & 0xFF\n    arr[curByte++] = tmp & 0xFF\n  }\n\n  if (placeHoldersLen === 2) {\n    tmp =\n      (revLookup[b64.charCodeAt(i)] << 2) |\n      (revLookup[b64.charCodeAt(i + 1)] >> 4)\n    arr[curByte++] = tmp & 0xFF\n  }\n\n  if (placeHoldersLen === 1) {\n    tmp =\n      (revLookup[b64.charCodeAt(i)] << 10) |\n      (revLookup[b64.charCodeAt(i + 1)] << 4) |\n      (revLookup[b64.charCodeAt(i + 2)] >> 2)\n    arr[curByte++] = (tmp >> 8) & 0xFF\n    arr[curByte++] = tmp & 0xFF\n  }\n\n  return arr\n}\n\nfunction tripletToBase64 (num) {\n  return lookup[num >> 18 & 0x3F] +\n    lookup[num >> 12 & 0x3F] +\n    lookup[num >> 6 & 0x3F] +\n    lookup[num & 0x3F]\n}\n\nfunction encodeChunk (uint8, start, end) {\n  var tmp\n  var output = []\n  for (var i = start; i < end; i += 3) {\n    tmp =\n      ((uint8[i] << 16) & 0xFF0000) +\n      ((uint8[i + 1] << 8) & 0xFF00) +\n      (uint8[i + 2] & 0xFF)\n    output.push(tripletToBase64(tmp))\n  }\n  return output.join('')\n}\n\nfunction fromByteArray (uint8) {\n  var tmp\n  var len = uint8.length\n  var extraBytes = len % 3 // if we have 1 byte left, pad 2 bytes\n  var parts = []\n  var maxChunkLength = 16383 // must be multiple of 3\n\n  // go through the array every three bytes, we'll deal with trailing stuff later\n  for (var i = 0, len2 = len - extraBytes; i < len2; i += maxChunkLength) {\n    parts.push(encodeChunk(uint8, i, (i + maxChunkLength) > len2 ? len2 : (i + maxChunkLength)))\n  }\n\n  // pad the end with zeros, but make sure to not forget the extra bytes\n  if (extraBytes === 1) {\n    tmp = uint8[len - 1]\n    parts.push(\n      lookup[tmp >> 2] +\n      lookup[(tmp << 4) & 0x3F] +\n      '=='\n    )\n  } else if (extraBytes === 2) {\n    tmp = (uint8[len - 2] << 8) + uint8[len - 1]\n    parts.push(\n      lookup[tmp >> 10] +\n      lookup[(tmp >> 4) & 0x3F] +\n      lookup[(tmp << 2) & 0x3F] +\n      '='\n    )\n  }\n\n  return parts.join('')\n}\n","/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */\nexports.read = function (buffer, offset, isLE, mLen, nBytes) {\n  var e, m\n  var eLen = (nBytes * 8) - mLen - 1\n  var eMax = (1 << eLen) - 1\n  var eBias = eMax >> 1\n  var nBits = -7\n  var i = isLE ? (nBytes - 1) : 0\n  var d = isLE ? -1 : 1\n  var s = buffer[offset + i]\n\n  i += d\n\n  e = s & ((1 << (-nBits)) - 1)\n  s >>= (-nBits)\n  nBits += eLen\n  for (; nBits > 0; e = (e * 256) + buffer[offset + i], i += d, nBits -= 8) {}\n\n  m = e & ((1 << (-nBits)) - 1)\n  e >>= (-nBits)\n  nBits += mLen\n  for (; nBits > 0; m = (m * 256) + buffer[offset + i], i += d, nBits -= 8) {}\n\n  if (e === 0) {\n    e = 1 - eBias\n  } else if (e === eMax) {\n    return m ? NaN : ((s ? -1 : 1) * Infinity)\n  } else {\n    m = m + Math.pow(2, mLen)\n    e = e - eBias\n  }\n  return (s ? -1 : 1) * m * Math.pow(2, e - mLen)\n}\n\nexports.write = function (buffer, value, offset, isLE, mLen, nBytes) {\n  var e, m, c\n  var eLen = (nBytes * 8) - mLen - 1\n  var eMax = (1 << eLen) - 1\n  var eBias = eMax >> 1\n  var rt = (mLen === 23 ? Math.pow(2, -24) - Math.pow(2, -77) : 0)\n  var i = isLE ? 0 : (nBytes - 1)\n  var d = isLE ? 1 : -1\n  var s = value < 0 || (value === 0 && 1 / value < 0) ? 1 : 0\n\n  value = Math.abs(value)\n\n  if (isNaN(value) || value === Infinity) {\n    m = isNaN(value) ? 1 : 0\n    e = eMax\n  } else {\n    e = Math.floor(Math.log(value) / Math.LN2)\n    if (value * (c = Math.pow(2, -e)) < 1) {\n      e--\n      c *= 2\n    }\n    if (e + eBias >= 1) {\n      value += rt / c\n    } else {\n      value += rt * Math.pow(2, 1 - eBias)\n    }\n    if (value * c >= 2) {\n      e++\n      c /= 2\n    }\n\n    if (e + eBias >= eMax) {\n      m = 0\n      e = eMax\n    } else if (e + eBias >= 1) {\n      m = ((value * c) - 1) * Math.pow(2, mLen)\n      e = e + eBias\n    } else {\n      m = value * Math.pow(2, eBias - 1) * Math.pow(2, mLen)\n      e = 0\n    }\n  }\n\n  for (; mLen >= 8; buffer[offset + i] = m & 0xff, i += d, m /= 256, mLen -= 8) {}\n\n  e = (e << mLen) | m\n  eLen += mLen\n  for (; eLen > 0; buffer[offset + i] = e & 0xff, i += d, e /= 256, eLen -= 8) {}\n\n  buffer[offset + i - d] |= s * 128\n}\n","/*!\n * The buffer module from node.js, for the browser.\n *\n * @author   Feross Aboukhadijeh <https://feross.org>\n * @license  MIT\n */\n/* eslint-disable no-proto */\n\n'use strict'\n\nconst base64 = require('base64-js')\nconst ieee754 = require('ieee754')\nconst customInspectSymbol =\n  (typeof Symbol === 'function' && typeof Symbol['for'] === 'function') // eslint-disable-line dot-notation\n    ? Symbol['for']('nodejs.util.inspect.custom') // eslint-disable-line dot-notation\n    : null\n\nexports.Buffer = Buffer\nexports.SlowBuffer = SlowBuffer\nexports.INSPECT_MAX_BYTES = 50\n\nconst K_MAX_LENGTH = 0x7fffffff\nexports.kMaxLength = K_MAX_LENGTH\n\n/**\n * If `Buffer.TYPED_ARRAY_SUPPORT`:\n *   === true    Use Uint8Array implementation (fastest)\n *   === false   Print warning and recommend using `buffer` v4.x which has an Object\n *               implementation (most compatible, even IE6)\n *\n * Browsers that support typed arrays are IE 10+, Firefox 4+, Chrome 7+, Safari 5.1+,\n * Opera 11.6+, iOS 4.2+.\n *\n * We report that the browser does not support typed arrays if the are not subclassable\n * using __proto__. Firefox 4-29 lacks support for adding new properties to `Uint8Array`\n * (See: https://bugzilla.mozilla.org/show_bug.cgi?id=695438). IE 10 lacks support\n * for __proto__ and has a buggy typed array implementation.\n */\nBuffer.TYPED_ARRAY_SUPPORT = typedArraySupport()\n\nif (!Buffer.TYPED_ARRAY_SUPPORT && typeof console !== 'undefined' &&\n    typeof console.error === 'function') {\n  console.error(\n    'This browser lacks typed array (Uint8Array) support which is required by ' +\n    '`buffer` v5.x. Use `buffer` v4.x if you require old browser support.'\n  )\n}\n\nfunction typedArraySupport () {\n  // Can typed array instances can be augmented?\n  try {\n    const arr = new Uint8Array(1)\n    const proto = { foo: function () { return 42 } }\n    Object.setPrototypeOf(proto, Uint8Array.prototype)\n    Object.setPrototypeOf(arr, proto)\n    return arr.foo() === 42\n  } catch (e) {\n    return false\n  }\n}\n\nObject.defineProperty(Buffer.prototype, 'parent', {\n  enumerable: true,\n  get: function () {\n    if (!Buffer.isBuffer(this)) return undefined\n    return this.buffer\n  }\n})\n\nObject.defineProperty(Buffer.prototype, 'offset', {\n  enumerable: true,\n  get: function () {\n    if (!Buffer.isBuffer(this)) return undefined\n    return this.byteOffset\n  }\n})\n\nfunction createBuffer (length) {\n  if (length > K_MAX_LENGTH) {\n    throw new RangeError('The value \"' + length + '\" is invalid for option \"size\"')\n  }\n  // Return an augmented `Uint8Array` instance\n  const buf = new Uint8Array(length)\n  Object.setPrototypeOf(buf, Buffer.prototype)\n  return buf\n}\n\n/**\n * The Buffer constructor returns instances of `Uint8Array` that have their\n * prototype changed to `Buffer.prototype`. Furthermore, `Buffer` is a subclass of\n * `Uint8Array`, so the returned instances will have all the node `Buffer` methods\n * and the `Uint8Array` methods. Square bracket notation works as expected -- it\n * returns a single octet.\n *\n * The `Uint8Array` prototype remains unmodified.\n */\n\nfunction Buffer (arg, encodingOrOffset, length) {\n  // Common case.\n  if (typeof arg === 'number') {\n    if (typeof encodingOrOffset === 'string') {\n      throw new TypeError(\n        'The \"string\" argument must be of type string. Received type number'\n      )\n    }\n    return allocUnsafe(arg)\n  }\n  return from(arg, encodingOrOffset, length)\n}\n\nBuffer.poolSize = 8192 // not used by this implementation\n\nfunction from (value, encodingOrOffset, length) {\n  if (typeof value === 'string') {\n    return fromString(value, encodingOrOffset)\n  }\n\n  if (ArrayBuffer.isView(value)) {\n    return fromArrayView(value)\n  }\n\n  if (value == null) {\n    throw new TypeError(\n      'The first argument must be one of type string, Buffer, ArrayBuffer, Array, ' +\n      'or Array-like Object. Received type ' + (typeof value)\n    )\n  }\n\n  if (isInstance(value, ArrayBuffer) ||\n      (value && isInstance(value.buffer, ArrayBuffer))) {\n    return fromArrayBuffer(value, encodingOrOffset, length)\n  }\n\n  if (typeof SharedArrayBuffer !== 'undefined' &&\n      (isInstance(value, SharedArrayBuffer) ||\n      (value && isInstance(value.buffer, SharedArrayBuffer)))) {\n    return fromArrayBuffer(value, encodingOrOffset, length)\n  }\n\n  if (typeof value === 'number') {\n    throw new TypeError(\n      'The \"value\" argument must not be of type number. Received type number'\n    )\n  }\n\n  const valueOf = value.valueOf && value.valueOf()\n  if (valueOf != null && valueOf !== value) {\n    return Buffer.from(valueOf, encodingOrOffset, length)\n  }\n\n  const b = fromObject(value)\n  if (b) return b\n\n  if (typeof Symbol !== 'undefined' && Symbol.toPrimitive != null &&\n      typeof value[Symbol.toPrimitive] === 'function') {\n    return Buffer.from(value[Symbol.toPrimitive]('string'), encodingOrOffset, length)\n  }\n\n  throw new TypeError(\n    'The first argument must be one of type string, Buffer, ArrayBuffer, Array, ' +\n    'or Array-like Object. Received type ' + (typeof value)\n  )\n}\n\n/**\n * Functionally equivalent to Buffer(arg, encoding) but throws a TypeError\n * if value is a number.\n * Buffer.from(str[, encoding])\n * Buffer.from(array)\n * Buffer.from(buffer)\n * Buffer.from(arrayBuffer[, byteOffset[, length]])\n **/\nBuffer.from = function (value, encodingOrOffset, length) {\n  return from(value, encodingOrOffset, length)\n}\n\n// Note: Change prototype *after* Buffer.from is defined to workaround Chrome bug:\n// https://github.com/feross/buffer/pull/148\nObject.setPrototypeOf(Buffer.prototype, Uint8Array.prototype)\nObject.setPrototypeOf(Buffer, Uint8Array)\n\nfunction assertSize (size) {\n  if (typeof size !== 'number') {\n    throw new TypeError('\"size\" argument must be of type number')\n  } else if (size < 0) {\n    throw new RangeError('The value \"' + size + '\" is invalid for option \"size\"')\n  }\n}\n\nfunction alloc (size, fill, encoding) {\n  assertSize(size)\n  if (size <= 0) {\n    return createBuffer(size)\n  }\n  if (fill !== undefined) {\n    // Only pay attention to encoding if it's a string. This\n    // prevents accidentally sending in a number that would\n    // be interpreted as a start offset.\n    return typeof encoding === 'string'\n      ? createBuffer(size).fill(fill, encoding)\n      : createBuffer(size).fill(fill)\n  }\n  return createBuffer(size)\n}\n\n/**\n * Creates a new filled Buffer instance.\n * alloc(size[, fill[, encoding]])\n **/\nBuffer.alloc = function (size, fill, encoding) {\n  return alloc(size, fill, encoding)\n}\n\nfunction allocUnsafe (size) {\n  assertSize(size)\n  return createBuffer(size < 0 ? 0 : checked(size) | 0)\n}\n\n/**\n * Equivalent to Buffer(num), by default creates a non-zero-filled Buffer instance.\n * */\nBuffer.allocUnsafe = function (size) {\n  return allocUnsafe(size)\n}\n/**\n * Equivalent to SlowBuffer(num), by default creates a non-zero-filled Buffer instance.\n */\nBuffer.allocUnsafeSlow = function (size) {\n  return allocUnsafe(size)\n}\n\nfunction fromString (string, encoding) {\n  if (typeof encoding !== 'string' || encoding === '') {\n    encoding = 'utf8'\n  }\n\n  if (!Buffer.isEncoding(encoding)) {\n    throw new TypeError('Unknown encoding: ' + encoding)\n  }\n\n  const length = byteLength(string, encoding) | 0\n  let buf = createBuffer(length)\n\n  const actual = buf.write(string, encoding)\n\n  if (actual !== length) {\n    // Writing a hex string, for example, that contains invalid characters will\n    // cause everything after the first invalid character to be ignored. (e.g.\n    // 'abxxcd' will be treated as 'ab')\n    buf = buf.slice(0, actual)\n  }\n\n  return buf\n}\n\nfunction fromArrayLike (array) {\n  const length = array.length < 0 ? 0 : checked(array.length) | 0\n  const buf = createBuffer(length)\n  for (let i = 0; i < length; i += 1) {\n    buf[i] = array[i] & 255\n  }\n  return buf\n}\n\nfunction fromArrayView (arrayView) {\n  if (isInstance(arrayView, Uint8Array)) {\n    const copy = new Uint8Array(arrayView)\n    return fromArrayBuffer(copy.buffer, copy.byteOffset, copy.byteLength)\n  }\n  return fromArrayLike(arrayView)\n}\n\nfunction fromArrayBuffer (array, byteOffset, length) {\n  if (byteOffset < 0 || array.byteLength < byteOffset) {\n    throw new RangeError('\"offset\" is outside of buffer bounds')\n  }\n\n  if (array.byteLength < byteOffset + (length || 0)) {\n    throw new RangeError('\"length\" is outside of buffer bounds')\n  }\n\n  let buf\n  if (byteOffset === undefined && length === undefined) {\n    buf = new Uint8Array(array)\n  } else if (length === undefined) {\n    buf = new Uint8Array(array, byteOffset)\n  } else {\n    buf = new Uint8Array(array, byteOffset, length)\n  }\n\n  // Return an augmented `Uint8Array` instance\n  Object.setPrototypeOf(buf, Buffer.prototype)\n\n  return buf\n}\n\nfunction fromObject (obj) {\n  if (Buffer.isBuffer(obj)) {\n    const len = checked(obj.length) | 0\n    const buf = createBuffer(len)\n\n    if (buf.length === 0) {\n      return buf\n    }\n\n    obj.copy(buf, 0, 0, len)\n    return buf\n  }\n\n  if (obj.length !== undefined) {\n    if (typeof obj.length !== 'number' || numberIsNaN(obj.length)) {\n      return createBuffer(0)\n    }\n    return fromArrayLike(obj)\n  }\n\n  if (obj.type === 'Buffer' && Array.isArray(obj.data)) {\n    return fromArrayLike(obj.data)\n  }\n}\n\nfunction checked (length) {\n  // Note: cannot use `length < K_MAX_LENGTH` here because that fails when\n  // length is NaN (which is otherwise coerced to zero.)\n  if (length >= K_MAX_LENGTH) {\n    throw new RangeError('Attempt to allocate Buffer larger than maximum ' +\n                         'size: 0x' + K_MAX_LENGTH.toString(16) + ' bytes')\n  }\n  return length | 0\n}\n\nfunction SlowBuffer (length) {\n  if (+length != length) { // eslint-disable-line eqeqeq\n    length = 0\n  }\n  return Buffer.alloc(+length)\n}\n\nBuffer.isBuffer = function isBuffer (b) {\n  return b != null && b._isBuffer === true &&\n    b !== Buffer.prototype // so Buffer.isBuffer(Buffer.prototype) will be false\n}\n\nBuffer.compare = function compare (a, b) {\n  if (isInstance(a, Uint8Array)) a = Buffer.from(a, a.offset, a.byteLength)\n  if (isInstance(b, Uint8Array)) b = Buffer.from(b, b.offset, b.byteLength)\n  if (!Buffer.isBuffer(a) || !Buffer.isBuffer(b)) {\n    throw new TypeError(\n      'The \"buf1\", \"buf2\" arguments must be one of type Buffer or Uint8Array'\n    )\n  }\n\n  if (a === b) return 0\n\n  let x = a.length\n  let y = b.length\n\n  for (let i = 0, len = Math.min(x, y); i < len; ++i) {\n    if (a[i] !== b[i]) {\n      x = a[i]\n      y = b[i]\n      break\n    }\n  }\n\n  if (x < y) return -1\n  if (y < x) return 1\n  return 0\n}\n\nBuffer.isEncoding = function isEncoding (encoding) {\n  switch (String(encoding).toLowerCase()) {\n    case 'hex':\n    case 'utf8':\n    case 'utf-8':\n    case 'ascii':\n    case 'latin1':\n    case 'binary':\n    case 'base64':\n    case 'ucs2':\n    case 'ucs-2':\n    case 'utf16le':\n    case 'utf-16le':\n      return true\n    default:\n      return false\n  }\n}\n\nBuffer.concat = function concat (list, length) {\n  if (!Array.isArray(list)) {\n    throw new TypeError('\"list\" argument must be an Array of Buffers')\n  }\n\n  if (list.length === 0) {\n    return Buffer.alloc(0)\n  }\n\n  let i\n  if (length === undefined) {\n    length = 0\n    for (i = 0; i < list.length; ++i) {\n      length += list[i].length\n    }\n  }\n\n  const buffer = Buffer.allocUnsafe(length)\n  let pos = 0\n  for (i = 0; i < list.length; ++i) {\n    let buf = list[i]\n    if (isInstance(buf, Uint8Array)) {\n      if (pos + buf.length > buffer.length) {\n        if (!Buffer.isBuffer(buf)) buf = Buffer.from(buf)\n        buf.copy(buffer, pos)\n      } else {\n        Uint8Array.prototype.set.call(\n          buffer,\n          buf,\n          pos\n        )\n      }\n    } else if (!Buffer.isBuffer(buf)) {\n      throw new TypeError('\"list\" argument must be an Array of Buffers')\n    } else {\n      buf.copy(buffer, pos)\n    }\n    pos += buf.length\n  }\n  return buffer\n}\n\nfunction byteLength (string, encoding) {\n  if (Buffer.isBuffer(string)) {\n    return string.length\n  }\n  if (ArrayBuffer.isView(string) || isInstance(string, ArrayBuffer)) {\n    return string.byteLength\n  }\n  if (typeof string !== 'string') {\n    throw new TypeError(\n      'The \"string\" argument must be one of type string, Buffer, or ArrayBuffer. ' +\n      'Received type ' + typeof string\n    )\n  }\n\n  const len = string.length\n  const mustMatch = (arguments.length > 2 && arguments[2] === true)\n  if (!mustMatch && len === 0) return 0\n\n  // Use a for loop to avoid recursion\n  let loweredCase = false\n  for (;;) {\n    switch (encoding) {\n      case 'ascii':\n      case 'latin1':\n      case 'binary':\n        return len\n      case 'utf8':\n      case 'utf-8':\n        return utf8ToBytes(string).length\n      case 'ucs2':\n      case 'ucs-2':\n      case 'utf16le':\n      case 'utf-16le':\n        return len * 2\n      case 'hex':\n        return len >>> 1\n      case 'base64':\n        return base64ToBytes(string).length\n      default:\n        if (loweredCase) {\n          return mustMatch ? -1 : utf8ToBytes(string).length // assume utf8\n        }\n        encoding = ('' + encoding).toLowerCase()\n        loweredCase = true\n    }\n  }\n}\nBuffer.byteLength = byteLength\n\nfunction slowToString (encoding, start, end) {\n  let loweredCase = false\n\n  // No need to verify that \"this.length <= MAX_UINT32\" since it's a read-only\n  // property of a typed array.\n\n  // This behaves neither like String nor Uint8Array in that we set start/end\n  // to their upper/lower bounds if the value passed is out of range.\n  // undefined is handled specially as per ECMA-262 6th Edition,\n  // Section 13.3.3.7 Runtime Semantics: KeyedBindingInitialization.\n  if (start === undefined || start < 0) {\n    start = 0\n  }\n  // Return early if start > this.length. Done here to prevent potential uint32\n  // coercion fail below.\n  if (start > this.length) {\n    return ''\n  }\n\n  if (end === undefined || end > this.length) {\n    end = this.length\n  }\n\n  if (end <= 0) {\n    return ''\n  }\n\n  // Force coercion to uint32. This will also coerce falsey/NaN values to 0.\n  end >>>= 0\n  start >>>= 0\n\n  if (end <= start) {\n    return ''\n  }\n\n  if (!encoding) encoding = 'utf8'\n\n  while (true) {\n    switch (encoding) {\n      case 'hex':\n        return hexSlice(this, start, end)\n\n      case 'utf8':\n      case 'utf-8':\n        return utf8Slice(this, start, end)\n\n      case 'ascii':\n        return asciiSlice(this, start, end)\n\n      case 'latin1':\n      case 'binary':\n        return latin1Slice(this, start, end)\n\n      case 'base64':\n        return base64Slice(this, start, end)\n\n      case 'ucs2':\n      case 'ucs-2':\n      case 'utf16le':\n      case 'utf-16le':\n        return utf16leSlice(this, start, end)\n\n      default:\n        if (loweredCase) throw new TypeError('Unknown encoding: ' + encoding)\n        encoding = (encoding + '').toLowerCase()\n        loweredCase = true\n    }\n  }\n}\n\n// This property is used by `Buffer.isBuffer` (and the `is-buffer` npm package)\n// to detect a Buffer instance. It's not possible to use `instanceof Buffer`\n// reliably in a browserify context because there could be multiple different\n// copies of the 'buffer' package in use. This method works even for Buffer\n// instances that were created from another copy of the `buffer` package.\n// See: https://github.com/feross/buffer/issues/154\nBuffer.prototype._isBuffer = true\n\nfunction swap (b, n, m) {\n  const i = b[n]\n  b[n] = b[m]\n  b[m] = i\n}\n\nBuffer.prototype.swap16 = function swap16 () {\n  const len = this.length\n  if (len % 2 !== 0) {\n    throw new RangeError('Buffer size must be a multiple of 16-bits')\n  }\n  for (let i = 0; i < len; i += 2) {\n    swap(this, i, i + 1)\n  }\n  return this\n}\n\nBuffer.prototype.swap32 = function swap32 () {\n  const len = this.length\n  if (len % 4 !== 0) {\n    throw new RangeError('Buffer size must be a multiple of 32-bits')\n  }\n  for (let i = 0; i < len; i += 4) {\n    swap(this, i, i + 3)\n    swap(this, i + 1, i + 2)\n  }\n  return this\n}\n\nBuffer.prototype.swap64 = function swap64 () {\n  const len = this.length\n  if (len % 8 !== 0) {\n    throw new RangeError('Buffer size must be a multiple of 64-bits')\n  }\n  for (let i = 0; i < len; i += 8) {\n    swap(this, i, i + 7)\n    swap(this, i + 1, i + 6)\n    swap(this, i + 2, i + 5)\n    swap(this, i + 3, i + 4)\n  }\n  return this\n}\n\nBuffer.prototype.toString = function toString () {\n  const length = this.length\n  if (length === 0) return ''\n  if (arguments.length === 0) return utf8Slice(this, 0, length)\n  return slowToString.apply(this, arguments)\n}\n\nBuffer.prototype.toLocaleString = Buffer.prototype.toString\n\nBuffer.prototype.equals = function equals (b) {\n  if (!Buffer.isBuffer(b)) throw new TypeError('Argument must be a Buffer')\n  if (this === b) return true\n  return Buffer.compare(this, b) === 0\n}\n\nBuffer.prototype.inspect = function inspect () {\n  let str = ''\n  const max = exports.INSPECT_MAX_BYTES\n  str = this.toString('hex', 0, max).replace(/(.{2})/g, '$1 ').trim()\n  if (this.length > max) str += ' ... '\n  return '<Buffer ' + str + '>'\n}\nif (customInspectSymbol) {\n  Buffer.prototype[customInspectSymbol] = Buffer.prototype.inspect\n}\n\nBuffer.prototype.compare = function compare (target, start, end, thisStart, thisEnd) {\n  if (isInstance(target, Uint8Array)) {\n    target = Buffer.from(target, target.offset, target.byteLength)\n  }\n  if (!Buffer.isBuffer(target)) {\n    throw new TypeError(\n      'The \"target\" argument must be one of type Buffer or Uint8Array. ' +\n      'Received type ' + (typeof target)\n    )\n  }\n\n  if (start === undefined) {\n    start = 0\n  }\n  if (end === undefined) {\n    end = target ? target.length : 0\n  }\n  if (thisStart === undefined) {\n    thisStart = 0\n  }\n  if (thisEnd === undefined) {\n    thisEnd = this.length\n  }\n\n  if (start < 0 || end > target.length || thisStart < 0 || thisEnd > this.length) {\n    throw new RangeError('out of range index')\n  }\n\n  if (thisStart >= thisEnd && start >= end) {\n    return 0\n  }\n  if (thisStart >= thisEnd) {\n    return -1\n  }\n  if (start >= end) {\n    return 1\n  }\n\n  start >>>= 0\n  end >>>= 0\n  thisStart >>>= 0\n  thisEnd >>>= 0\n\n  if (this === target) return 0\n\n  let x = thisEnd - thisStart\n  let y = end - start\n  const len = Math.min(x, y)\n\n  const thisCopy = this.slice(thisStart, thisEnd)\n  const targetCopy = target.slice(start, end)\n\n  for (let i = 0; i < len; ++i) {\n    if (thisCopy[i] !== targetCopy[i]) {\n      x = thisCopy[i]\n      y = targetCopy[i]\n      break\n    }\n  }\n\n  if (x < y) return -1\n  if (y < x) return 1\n  return 0\n}\n\n// Finds either the first index of `val` in `buffer` at offset >= `byteOffset`,\n// OR the last index of `val` in `buffer` at offset <= `byteOffset`.\n//\n// Arguments:\n// - buffer - a Buffer to search\n// - val - a string, Buffer, or number\n// - byteOffset - an index into `buffer`; will be clamped to an int32\n// - encoding - an optional encoding, relevant is val is a string\n// - dir - true for indexOf, false for lastIndexOf\nfunction bidirectionalIndexOf (buffer, val, byteOffset, encoding, dir) {\n  // Empty buffer means no match\n  if (buffer.length === 0) return -1\n\n  // Normalize byteOffset\n  if (typeof byteOffset === 'string') {\n    encoding = byteOffset\n    byteOffset = 0\n  } else if (byteOffset > 0x7fffffff) {\n    byteOffset = 0x7fffffff\n  } else if (byteOffset < -0x80000000) {\n    byteOffset = -0x80000000\n  }\n  byteOffset = +byteOffset // Coerce to Number.\n  if (numberIsNaN(byteOffset)) {\n    // byteOffset: it it's undefined, null, NaN, \"foo\", etc, search whole buffer\n    byteOffset = dir ? 0 : (buffer.length - 1)\n  }\n\n  // Normalize byteOffset: negative offsets start from the end of the buffer\n  if (byteOffset < 0) byteOffset = buffer.length + byteOffset\n  if (byteOffset >= buffer.length) {\n    if (dir) return -1\n    else byteOffset = buffer.length - 1\n  } else if (byteOffset < 0) {\n    if (dir) byteOffset = 0\n    else return -1\n  }\n\n  // Normalize val\n  if (typeof val === 'string') {\n    val = Buffer.from(val, encoding)\n  }\n\n  // Finally, search either indexOf (if dir is true) or lastIndexOf\n  if (Buffer.isBuffer(val)) {\n    // Special case: looking for empty string/buffer always fails\n    if (val.length === 0) {\n      return -1\n    }\n    return arrayIndexOf(buffer, val, byteOffset, encoding, dir)\n  } else if (typeof val === 'number') {\n    val = val & 0xFF // Search for a byte value [0-255]\n    if (typeof Uint8Array.prototype.indexOf === 'function') {\n      if (dir) {\n        return Uint8Array.prototype.indexOf.call(buffer, val, byteOffset)\n      } else {\n        return Uint8Array.prototype.lastIndexOf.call(buffer, val, byteOffset)\n      }\n    }\n    return arrayIndexOf(buffer, [val], byteOffset, encoding, dir)\n  }\n\n  throw new TypeError('val must be string, number or Buffer')\n}\n\nfunction arrayIndexOf (arr, val, byteOffset, encoding, dir) {\n  let indexSize = 1\n  let arrLength = arr.length\n  let valLength = val.length\n\n  if (encoding !== undefined) {\n    encoding = String(encoding).toLowerCase()\n    if (encoding === 'ucs2' || encoding === 'ucs-2' ||\n        encoding === 'utf16le' || encoding === 'utf-16le') {\n      if (arr.length < 2 || val.length < 2) {\n        return -1\n      }\n      indexSize = 2\n      arrLength /= 2\n      valLength /= 2\n      byteOffset /= 2\n    }\n  }\n\n  function read (buf, i) {\n    if (indexSize === 1) {\n      return buf[i]\n    } else {\n      return buf.readUInt16BE(i * indexSize)\n    }\n  }\n\n  let i\n  if (dir) {\n    let foundIndex = -1\n    for (i = byteOffset; i < arrLength; i++) {\n      if (read(arr, i) === read(val, foundIndex === -1 ? 0 : i - foundIndex)) {\n        if (foundIndex === -1) foundIndex = i\n        if (i - foundIndex + 1 === valLength) return foundIndex * indexSize\n      } else {\n        if (foundIndex !== -1) i -= i - foundIndex\n        foundIndex = -1\n      }\n    }\n  } else {\n    if (byteOffset + valLength > arrLength) byteOffset = arrLength - valLength\n    for (i = byteOffset; i >= 0; i--) {\n      let found = true\n      for (let j = 0; j < valLength; j++) {\n        if (read(arr, i + j) !== read(val, j)) {\n          found = false\n          break\n        }\n      }\n      if (found) return i\n    }\n  }\n\n  return -1\n}\n\nBuffer.prototype.includes = function includes (val, byteOffset, encoding) {\n  return this.indexOf(val, byteOffset, encoding) !== -1\n}\n\nBuffer.prototype.indexOf = function indexOf (val, byteOffset, encoding) {\n  return bidirectionalIndexOf(this, val, byteOffset, encoding, true)\n}\n\nBuffer.prototype.lastIndexOf = function lastIndexOf (val, byteOffset, encoding) {\n  return bidirectionalIndexOf(this, val, byteOffset, encoding, false)\n}\n\nfunction hexWrite (buf, string, offset, length) {\n  offset = Number(offset) || 0\n  const remaining = buf.length - offset\n  if (!length) {\n    length = remaining\n  } else {\n    length = Number(length)\n    if (length > remaining) {\n      length = remaining\n    }\n  }\n\n  const strLen = string.length\n\n  if (length > strLen / 2) {\n    length = strLen / 2\n  }\n  let i\n  for (i = 0; i < length; ++i) {\n    const parsed = parseInt(string.substr(i * 2, 2), 16)\n    if (numberIsNaN(parsed)) return i\n    buf[offset + i] = parsed\n  }\n  return i\n}\n\nfunction utf8Write (buf, string, offset, length) {\n  return blitBuffer(utf8ToBytes(string, buf.length - offset), buf, offset, length)\n}\n\nfunction asciiWrite (buf, string, offset, length) {\n  return blitBuffer(asciiToBytes(string), buf, offset, length)\n}\n\nfunction base64Write (buf, string, offset, length) {\n  return blitBuffer(base64ToBytes(string), buf, offset, length)\n}\n\nfunction ucs2Write (buf, string, offset, length) {\n  return blitBuffer(utf16leToBytes(string, buf.length - offset), buf, offset, length)\n}\n\nBuffer.prototype.write = function write (string, offset, length, encoding) {\n  // Buffer#write(string)\n  if (offset === undefined) {\n    encoding = 'utf8'\n    length = this.length\n    offset = 0\n  // Buffer#write(string, encoding)\n  } else if (length === undefined && typeof offset === 'string') {\n    encoding = offset\n    length = this.length\n    offset = 0\n  // Buffer#write(string, offset[, length][, encoding])\n  } else if (isFinite(offset)) {\n    offset = offset >>> 0\n    if (isFinite(length)) {\n      length = length >>> 0\n      if (encoding === undefined) encoding = 'utf8'\n    } else {\n      encoding = length\n      length = undefined\n    }\n  } else {\n    throw new Error(\n      'Buffer.write(string, encoding, offset[, length]) is no longer supported'\n    )\n  }\n\n  const remaining = this.length - offset\n  if (length === undefined || length > remaining) length = remaining\n\n  if ((string.length > 0 && (length < 0 || offset < 0)) || offset > this.length) {\n    throw new RangeError('Attempt to write outside buffer bounds')\n  }\n\n  if (!encoding) encoding = 'utf8'\n\n  let loweredCase = false\n  for (;;) {\n    switch (encoding) {\n      case 'hex':\n        return hexWrite(this, string, offset, length)\n\n      case 'utf8':\n      case 'utf-8':\n        return utf8Write(this, string, offset, length)\n\n      case 'ascii':\n      case 'latin1':\n      case 'binary':\n        return asciiWrite(this, string, offset, length)\n\n      case 'base64':\n        // Warning: maxLength not taken into account in base64Write\n        return base64Write(this, string, offset, length)\n\n      case 'ucs2':\n      case 'ucs-2':\n      case 'utf16le':\n      case 'utf-16le':\n        return ucs2Write(this, string, offset, length)\n\n      default:\n        if (loweredCase) throw new TypeError('Unknown encoding: ' + encoding)\n        encoding = ('' + encoding).toLowerCase()\n        loweredCase = true\n    }\n  }\n}\n\nBuffer.prototype.toJSON = function toJSON () {\n  return {\n    type: 'Buffer',\n    data: Array.prototype.slice.call(this._arr || this, 0)\n  }\n}\n\nfunction base64Slice (buf, start, end) {\n  if (start === 0 && end === buf.length) {\n    return base64.fromByteArray(buf)\n  } else {\n    return base64.fromByteArray(buf.slice(start, end))\n  }\n}\n\nfunction utf8Slice (buf, start, end) {\n  end = Math.min(buf.length, end)\n  const res = []\n\n  let i = start\n  while (i < end) {\n    const firstByte = buf[i]\n    let codePoint = null\n    let bytesPerSequence = (firstByte > 0xEF)\n      ? 4\n      : (firstByte > 0xDF)\n          ? 3\n          : (firstByte > 0xBF)\n              ? 2\n              : 1\n\n    if (i + bytesPerSequence <= end) {\n      let secondByte, thirdByte, fourthByte, tempCodePoint\n\n      switch (bytesPerSequence) {\n        case 1:\n          if (firstByte < 0x80) {\n            codePoint = firstByte\n          }\n          break\n        case 2:\n          secondByte = buf[i + 1]\n          if ((secondByte & 0xC0) === 0x80) {\n            tempCodePoint = (firstByte & 0x1F) << 0x6 | (secondByte & 0x3F)\n            if (tempCodePoint > 0x7F) {\n              codePoint = tempCodePoint\n            }\n          }\n          break\n        case 3:\n          secondByte = buf[i + 1]\n          thirdByte = buf[i + 2]\n          if ((secondByte & 0xC0) === 0x80 && (thirdByte & 0xC0) === 0x80) {\n            tempCodePoint = (firstByte & 0xF) << 0xC | (secondByte & 0x3F) << 0x6 | (thirdByte & 0x3F)\n            if (tempCodePoint > 0x7FF && (tempCodePoint < 0xD800 || tempCodePoint > 0xDFFF)) {\n              codePoint = tempCodePoint\n            }\n          }\n          break\n        case 4:\n          secondByte = buf[i + 1]\n          thirdByte = buf[i + 2]\n          fourthByte = buf[i + 3]\n          if ((secondByte & 0xC0) === 0x80 && (thirdByte & 0xC0) === 0x80 && (fourthByte & 0xC0) === 0x80) {\n            tempCodePoint = (firstByte & 0xF) << 0x12 | (secondByte & 0x3F) << 0xC | (thirdByte & 0x3F) << 0x6 | (fourthByte & 0x3F)\n            if (tempCodePoint > 0xFFFF && tempCodePoint < 0x110000) {\n              codePoint = tempCodePoint\n            }\n          }\n      }\n    }\n\n    if (codePoint === null) {\n      // we did not generate a valid codePoint so insert a\n      // replacement char (U+FFFD) and advance only 1 byte\n      codePoint = 0xFFFD\n      bytesPerSequence = 1\n    } else if (codePoint > 0xFFFF) {\n      // encode to utf16 (surrogate pair dance)\n      codePoint -= 0x10000\n      res.push(codePoint >>> 10 & 0x3FF | 0xD800)\n      codePoint = 0xDC00 | codePoint & 0x3FF\n    }\n\n    res.push(codePoint)\n    i += bytesPerSequence\n  }\n\n  return decodeCodePointsArray(res)\n}\n\n// Based on http://stackoverflow.com/a/22747272/680742, the browser with\n// the lowest limit is Chrome, with 0x10000 args.\n// We go 1 magnitude less, for safety\nconst MAX_ARGUMENTS_LENGTH = 0x1000\n\nfunction decodeCodePointsArray (codePoints) {\n  const len = codePoints.length\n  if (len <= MAX_ARGUMENTS_LENGTH) {\n    return String.fromCharCode.apply(String, codePoints) // avoid extra slice()\n  }\n\n  // Decode in chunks to avoid \"call stack size exceeded\".\n  let res = ''\n  let i = 0\n  while (i < len) {\n    res += String.fromCharCode.apply(\n      String,\n      codePoints.slice(i, i += MAX_ARGUMENTS_LENGTH)\n    )\n  }\n  return res\n}\n\nfunction asciiSlice (buf, start, end) {\n  let ret = ''\n  end = Math.min(buf.length, end)\n\n  for (let i = start; i < end; ++i) {\n    ret += String.fromCharCode(buf[i] & 0x7F)\n  }\n  return ret\n}\n\nfunction latin1Slice (buf, start, end) {\n  let ret = ''\n  end = Math.min(buf.length, end)\n\n  for (let i = start; i < end; ++i) {\n    ret += String.fromCharCode(buf[i])\n  }\n  return ret\n}\n\nfunction hexSlice (buf, start, end) {\n  const len = buf.length\n\n  if (!start || start < 0) start = 0\n  if (!end || end < 0 || end > len) end = len\n\n  let out = ''\n  for (let i = start; i < end; ++i) {\n    out += hexSliceLookupTable[buf[i]]\n  }\n  return out\n}\n\nfunction utf16leSlice (buf, start, end) {\n  const bytes = buf.slice(start, end)\n  let res = ''\n  // If bytes.length is odd, the last 8 bits must be ignored (same as node.js)\n  for (let i = 0; i < bytes.length - 1; i += 2) {\n    res += String.fromCharCode(bytes[i] + (bytes[i + 1] * 256))\n  }\n  return res\n}\n\nBuffer.prototype.slice = function slice (start, end) {\n  const len = this.length\n  start = ~~start\n  end = end === undefined ? len : ~~end\n\n  if (start < 0) {\n    start += len\n    if (start < 0) start = 0\n  } else if (start > len) {\n    start = len\n  }\n\n  if (end < 0) {\n    end += len\n    if (end < 0) end = 0\n  } else if (end > len) {\n    end = len\n  }\n\n  if (end < start) end = start\n\n  const newBuf = this.subarray(start, end)\n  // Return an augmented `Uint8Array` instance\n  Object.setPrototypeOf(newBuf, Buffer.prototype)\n\n  return newBuf\n}\n\n/*\n * Need to make sure that buffer isn't trying to write out of bounds.\n */\nfunction checkOffset (offset, ext, length) {\n  if ((offset % 1) !== 0 || offset < 0) throw new RangeError('offset is not uint')\n  if (offset + ext > length) throw new RangeError('Trying to access beyond buffer length')\n}\n\nBuffer.prototype.readUintLE =\nBuffer.prototype.readUIntLE = function readUIntLE (offset, byteLength, noAssert) {\n  offset = offset >>> 0\n  byteLength = byteLength >>> 0\n  if (!noAssert) checkOffset(offset, byteLength, this.length)\n\n  let val = this[offset]\n  let mul = 1\n  let i = 0\n  while (++i < byteLength && (mul *= 0x100)) {\n    val += this[offset + i] * mul\n  }\n\n  return val\n}\n\nBuffer.prototype.readUintBE =\nBuffer.prototype.readUIntBE = function readUIntBE (offset, byteLength, noAssert) {\n  offset = offset >>> 0\n  byteLength = byteLength >>> 0\n  if (!noAssert) {\n    checkOffset(offset, byteLength, this.length)\n  }\n\n  let val = this[offset + --byteLength]\n  let mul = 1\n  while (byteLength > 0 && (mul *= 0x100)) {\n    val += this[offset + --byteLength] * mul\n  }\n\n  return val\n}\n\nBuffer.prototype.readUint8 =\nBuffer.prototype.readUInt8 = function readUInt8 (offset, noAssert) {\n  offset = offset >>> 0\n  if (!noAssert) checkOffset(offset, 1, this.length)\n  return this[offset]\n}\n\nBuffer.prototype.readUint16LE =\nBuffer.prototype.readUInt16LE = function readUInt16LE (offset, noAssert) {\n  offset = offset >>> 0\n  if (!noAssert) checkOffset(offset, 2, this.length)\n  return this[offset] | (this[offset + 1] << 8)\n}\n\nBuffer.prototype.readUint16BE =\nBuffer.prototype.readUInt16BE = function readUInt16BE (offset, noAssert) {\n  offset = offset >>> 0\n  if (!noAssert) checkOffset(offset, 2, this.length)\n  return (this[offset] << 8) | this[offset + 1]\n}\n\nBuffer.prototype.readUint32LE =\nBuffer.prototype.readUInt32LE = function readUInt32LE (offset, noAssert) {\n  offset = offset >>> 0\n  if (!noAssert) checkOffset(offset, 4, this.length)\n\n  return ((this[offset]) |\n      (this[offset + 1] << 8) |\n      (this[offset + 2] << 16)) +\n      (this[offset + 3] * 0x1000000)\n}\n\nBuffer.prototype.readUint32BE =\nBuffer.prototype.readUInt32BE = function readUInt32BE (offset, noAssert) {\n  offset = offset >>> 0\n  if (!noAssert) checkOffset(offset, 4, this.length)\n\n  return (this[offset] * 0x1000000) +\n    ((this[offset + 1] << 16) |\n    (this[offset + 2] << 8) |\n    this[offset + 3])\n}\n\nBuffer.prototype.readBigUInt64LE = defineBigIntMethod(function readBigUInt64LE (offset) {\n  offset = offset >>> 0\n  validateNumber(offset, 'offset')\n  const first = this[offset]\n  const last = this[offset + 7]\n  if (first === undefined || last === undefined) {\n    boundsError(offset, this.length - 8)\n  }\n\n  const lo = first +\n    this[++offset] * 2 ** 8 +\n    this[++offset] * 2 ** 16 +\n    this[++offset] * 2 ** 24\n\n  const hi = this[++offset] +\n    this[++offset] * 2 ** 8 +\n    this[++offset] * 2 ** 16 +\n    last * 2 ** 24\n\n  return BigInt(lo) + (BigInt(hi) << BigInt(32))\n})\n\nBuffer.prototype.readBigUInt64BE = defineBigIntMethod(function readBigUInt64BE (offset) {\n  offset = offset >>> 0\n  validateNumber(offset, 'offset')\n  const first = this[offset]\n  const last = this[offset + 7]\n  if (first === undefined || last === undefined) {\n    boundsError(offset, this.length - 8)\n  }\n\n  const hi = first * 2 ** 24 +\n    this[++offset] * 2 ** 16 +\n    this[++offset] * 2 ** 8 +\n    this[++offset]\n\n  const lo = this[++offset] * 2 ** 24 +\n    this[++offset] * 2 ** 16 +\n    this[++offset] * 2 ** 8 +\n    last\n\n  return (BigInt(hi) << BigInt(32)) + BigInt(lo)\n})\n\nBuffer.prototype.readIntLE = function readIntLE (offset, byteLength, noAssert) {\n  offset = offset >>> 0\n  byteLength = byteLength >>> 0\n  if (!noAssert) checkOffset(offset, byteLength, this.length)\n\n  let val = this[offset]\n  let mul = 1\n  let i = 0\n  while (++i < byteLength && (mul *= 0x100)) {\n    val += this[offset + i] * mul\n  }\n  mul *= 0x80\n\n  if (val >= mul) val -= Math.pow(2, 8 * byteLength)\n\n  return val\n}\n\nBuffer.prototype.readIntBE = function readIntBE (offset, byteLength, noAssert) {\n  offset = offset >>> 0\n  byteLength = byteLength >>> 0\n  if (!noAssert) checkOffset(offset, byteLength, this.length)\n\n  let i = byteLength\n  let mul = 1\n  let val = this[offset + --i]\n  while (i > 0 && (mul *= 0x100)) {\n    val += this[offset + --i] * mul\n  }\n  mul *= 0x80\n\n  if (val >= mul) val -= Math.pow(2, 8 * byteLength)\n\n  return val\n}\n\nBuffer.prototype.readInt8 = function readInt8 (offset, noAssert) {\n  offset = offset >>> 0\n  if (!noAssert) checkOffset(offset, 1, this.length)\n  if (!(this[offset] & 0x80)) return (this[offset])\n  return ((0xff - this[offset] + 1) * -1)\n}\n\nBuffer.prototype.readInt16LE = function readInt16LE (offset, noAssert) {\n  offset = offset >>> 0\n  if (!noAssert) checkOffset(offset, 2, this.length)\n  const val = this[offset] | (this[offset + 1] << 8)\n  return (val & 0x8000) ? val | 0xFFFF0000 : val\n}\n\nBuffer.prototype.readInt16BE = function readInt16BE (offset, noAssert) {\n  offset = offset >>> 0\n  if (!noAssert) checkOffset(offset, 2, this.length)\n  const val = this[offset + 1] | (this[offset] << 8)\n  return (val & 0x8000) ? val | 0xFFFF0000 : val\n}\n\nBuffer.prototype.readInt32LE = function readInt32LE (offset, noAssert) {\n  offset = offset >>> 0\n  if (!noAssert) checkOffset(offset, 4, this.length)\n\n  return (this[offset]) |\n    (this[offset + 1] << 8) |\n    (this[offset + 2] << 16) |\n    (this[offset + 3] << 24)\n}\n\nBuffer.prototype.readInt32BE = function readInt32BE (offset, noAssert) {\n  offset = offset >>> 0\n  if (!noAssert) checkOffset(offset, 4, this.length)\n\n  return (this[offset] << 24) |\n    (this[offset + 1] << 16) |\n    (this[offset + 2] << 8) |\n    (this[offset + 3])\n}\n\nBuffer.prototype.readBigInt64LE = defineBigIntMethod(function readBigInt64LE (offset) {\n  offset = offset >>> 0\n  validateNumber(offset, 'offset')\n  const first = this[offset]\n  const last = this[offset + 7]\n  if (first === undefined || last === undefined) {\n    boundsError(offset, this.length - 8)\n  }\n\n  const val = this[offset + 4] +\n    this[offset + 5] * 2 ** 8 +\n    this[offset + 6] * 2 ** 16 +\n    (last << 24) // Overflow\n\n  return (BigInt(val) << BigInt(32)) +\n    BigInt(first +\n    this[++offset] * 2 ** 8 +\n    this[++offset] * 2 ** 16 +\n    this[++offset] * 2 ** 24)\n})\n\nBuffer.prototype.readBigInt64BE = defineBigIntMethod(function readBigInt64BE (offset) {\n  offset = offset >>> 0\n  validateNumber(offset, 'offset')\n  const first = this[offset]\n  const last = this[offset + 7]\n  if (first === undefined || last === undefined) {\n    boundsError(offset, this.length - 8)\n  }\n\n  const val = (first << 24) + // Overflow\n    this[++offset] * 2 ** 16 +\n    this[++offset] * 2 ** 8 +\n    this[++offset]\n\n  return (BigInt(val) << BigInt(32)) +\n    BigInt(this[++offset] * 2 ** 24 +\n    this[++offset] * 2 ** 16 +\n    this[++offset] * 2 ** 8 +\n    last)\n})\n\nBuffer.prototype.readFloatLE = function readFloatLE (offset, noAssert) {\n  offset = offset >>> 0\n  if (!noAssert) checkOffset(offset, 4, this.length)\n  return ieee754.read(this, offset, true, 23, 4)\n}\n\nBuffer.prototype.readFloatBE = function readFloatBE (offset, noAssert) {\n  offset = offset >>> 0\n  if (!noAssert) checkOffset(offset, 4, this.length)\n  return ieee754.read(this, offset, false, 23, 4)\n}\n\nBuffer.prototype.readDoubleLE = function readDoubleLE (offset, noAssert) {\n  offset = offset >>> 0\n  if (!noAssert) checkOffset(offset, 8, this.length)\n  return ieee754.read(this, offset, true, 52, 8)\n}\n\nBuffer.prototype.readDoubleBE = function readDoubleBE (offset, noAssert) {\n  offset = offset >>> 0\n  if (!noAssert) checkOffset(offset, 8, this.length)\n  return ieee754.read(this, offset, false, 52, 8)\n}\n\nfunction checkInt (buf, value, offset, ext, max, min) {\n  if (!Buffer.isBuffer(buf)) throw new TypeError('\"buffer\" argument must be a Buffer instance')\n  if (value > max || value < min) throw new RangeError('\"value\" argument is out of bounds')\n  if (offset + ext > buf.length) throw new RangeError('Index out of range')\n}\n\nBuffer.prototype.writeUintLE =\nBuffer.prototype.writeUIntLE = function writeUIntLE (value, offset, byteLength, noAssert) {\n  value = +value\n  offset = offset >>> 0\n  byteLength = byteLength >>> 0\n  if (!noAssert) {\n    const maxBytes = Math.pow(2, 8 * byteLength) - 1\n    checkInt(this, value, offset, byteLength, maxBytes, 0)\n  }\n\n  let mul = 1\n  let i = 0\n  this[offset] = value & 0xFF\n  while (++i < byteLength && (mul *= 0x100)) {\n    this[offset + i] = (value / mul) & 0xFF\n  }\n\n  return offset + byteLength\n}\n\nBuffer.prototype.writeUintBE =\nBuffer.prototype.writeUIntBE = function writeUIntBE (value, offset, byteLength, noAssert) {\n  value = +value\n  offset = offset >>> 0\n  byteLength = byteLength >>> 0\n  if (!noAssert) {\n    const maxBytes = Math.pow(2, 8 * byteLength) - 1\n    checkInt(this, value, offset, byteLength, maxBytes, 0)\n  }\n\n  let i = byteLength - 1\n  let mul = 1\n  this[offset + i] = value & 0xFF\n  while (--i >= 0 && (mul *= 0x100)) {\n    this[offset + i] = (value / mul) & 0xFF\n  }\n\n  return offset + byteLength\n}\n\nBuffer.prototype.writeUint8 =\nBuffer.prototype.writeUInt8 = function writeUInt8 (value, offset, noAssert) {\n  value = +value\n  offset = offset >>> 0\n  if (!noAssert) checkInt(this, value, offset, 1, 0xff, 0)\n  this[offset] = (value & 0xff)\n  return offset + 1\n}\n\nBuffer.prototype.writeUint16LE =\nBuffer.prototype.writeUInt16LE = function writeUInt16LE (value, offset, noAssert) {\n  value = +value\n  offset = offset >>> 0\n  if (!noAssert) checkInt(this, value, offset, 2, 0xffff, 0)\n  this[offset] = (value & 0xff)\n  this[offset + 1] = (value >>> 8)\n  return offset + 2\n}\n\nBuffer.prototype.writeUint16BE =\nBuffer.prototype.writeUInt16BE = function writeUInt16BE (value, offset, noAssert) {\n  value = +value\n  offset = offset >>> 0\n  if (!noAssert) checkInt(this, value, offset, 2, 0xffff, 0)\n  this[offset] = (value >>> 8)\n  this[offset + 1] = (value & 0xff)\n  return offset + 2\n}\n\nBuffer.prototype.writeUint32LE =\nBuffer.prototype.writeUInt32LE = function writeUInt32LE (value, offset, noAssert) {\n  value = +value\n  offset = offset >>> 0\n  if (!noAssert) checkInt(this, value, offset, 4, 0xffffffff, 0)\n  this[offset + 3] = (value >>> 24)\n  this[offset + 2] = (value >>> 16)\n  this[offset + 1] = (value >>> 8)\n  this[offset] = (value & 0xff)\n  return offset + 4\n}\n\nBuffer.prototype.writeUint32BE =\nBuffer.prototype.writeUInt32BE = function writeUInt32BE (value, offset, noAssert) {\n  value = +value\n  offset = offset >>> 0\n  if (!noAssert) checkInt(this, value, offset, 4, 0xffffffff, 0)\n  this[offset] = (value >>> 24)\n  this[offset + 1] = (value >>> 16)\n  this[offset + 2] = (value >>> 8)\n  this[offset + 3] = (value & 0xff)\n  return offset + 4\n}\n\nfunction wrtBigUInt64LE (buf, value, offset, min, max) {\n  checkIntBI(value, min, max, buf, offset, 7)\n\n  let lo = Number(value & BigInt(0xffffffff))\n  buf[offset++] = lo\n  lo = lo >> 8\n  buf[offset++] = lo\n  lo = lo >> 8\n  buf[offset++] = lo\n  lo = lo >> 8\n  buf[offset++] = lo\n  let hi = Number(value >> BigInt(32) & BigInt(0xffffffff))\n  buf[offset++] = hi\n  hi = hi >> 8\n  buf[offset++] = hi\n  hi = hi >> 8\n  buf[offset++] = hi\n  hi = hi >> 8\n  buf[offset++] = hi\n  return offset\n}\n\nfunction wrtBigUInt64BE (buf, value, offset, min, max) {\n  checkIntBI(value, min, max, buf, offset, 7)\n\n  let lo = Number(value & BigInt(0xffffffff))\n  buf[offset + 7] = lo\n  lo = lo >> 8\n  buf[offset + 6] = lo\n  lo = lo >> 8\n  buf[offset + 5] = lo\n  lo = lo >> 8\n  buf[offset + 4] = lo\n  let hi = Number(value >> BigInt(32) & BigInt(0xffffffff))\n  buf[offset + 3] = hi\n  hi = hi >> 8\n  buf[offset + 2] = hi\n  hi = hi >> 8\n  buf[offset + 1] = hi\n  hi = hi >> 8\n  buf[offset] = hi\n  return offset + 8\n}\n\nBuffer.prototype.writeBigUInt64LE = defineBigIntMethod(function writeBigUInt64LE (value, offset = 0) {\n  return wrtBigUInt64LE(this, value, offset, BigInt(0), BigInt('0xffffffffffffffff'))\n})\n\nBuffer.prototype.writeBigUInt64BE = defineBigIntMethod(function writeBigUInt64BE (value, offset = 0) {\n  return wrtBigUInt64BE(this, value, offset, BigInt(0), BigInt('0xffffffffffffffff'))\n})\n\nBuffer.prototype.writeIntLE = function writeIntLE (value, offset, byteLength, noAssert) {\n  value = +value\n  offset = offset >>> 0\n  if (!noAssert) {\n    const limit = Math.pow(2, (8 * byteLength) - 1)\n\n    checkInt(this, value, offset, byteLength, limit - 1, -limit)\n  }\n\n  let i = 0\n  let mul = 1\n  let sub = 0\n  this[offset] = value & 0xFF\n  while (++i < byteLength && (mul *= 0x100)) {\n    if (value < 0 && sub === 0 && this[offset + i - 1] !== 0) {\n      sub = 1\n    }\n    this[offset + i] = ((value / mul) >> 0) - sub & 0xFF\n  }\n\n  return offset + byteLength\n}\n\nBuffer.prototype.writeIntBE = function writeIntBE (value, offset, byteLength, noAssert) {\n  value = +value\n  offset = offset >>> 0\n  if (!noAssert) {\n    const limit = Math.pow(2, (8 * byteLength) - 1)\n\n    checkInt(this, value, offset, byteLength, limit - 1, -limit)\n  }\n\n  let i = byteLength - 1\n  let mul = 1\n  let sub = 0\n  this[offset + i] = value & 0xFF\n  while (--i >= 0 && (mul *= 0x100)) {\n    if (value < 0 && sub === 0 && this[offset + i + 1] !== 0) {\n      sub = 1\n    }\n    this[offset + i] = ((value / mul) >> 0) - sub & 0xFF\n  }\n\n  return offset + byteLength\n}\n\nBuffer.prototype.writeInt8 = function writeInt8 (value, offset, noAssert) {\n  value = +value\n  offset = offset >>> 0\n  if (!noAssert) checkInt(this, value, offset, 1, 0x7f, -0x80)\n  if (value < 0) value = 0xff + value + 1\n  this[offset] = (value & 0xff)\n  return offset + 1\n}\n\nBuffer.prototype.writeInt16LE = function writeInt16LE (value, offset, noAssert) {\n  value = +value\n  offset = offset >>> 0\n  if (!noAssert) checkInt(this, value, offset, 2, 0x7fff, -0x8000)\n  this[offset] = (value & 0xff)\n  this[offset + 1] = (value >>> 8)\n  return offset + 2\n}\n\nBuffer.prototype.writeInt16BE = function writeInt16BE (value, offset, noAssert) {\n  value = +value\n  offset = offset >>> 0\n  if (!noAssert) checkInt(this, value, offset, 2, 0x7fff, -0x8000)\n  this[offset] = (value >>> 8)\n  this[offset + 1] = (value & 0xff)\n  return offset + 2\n}\n\nBuffer.prototype.writeInt32LE = function writeInt32LE (value, offset, noAssert) {\n  value = +value\n  offset = offset >>> 0\n  if (!noAssert) checkInt(this, value, offset, 4, 0x7fffffff, -0x80000000)\n  this[offset] = (value & 0xff)\n  this[offset + 1] = (value >>> 8)\n  this[offset + 2] = (value >>> 16)\n  this[offset + 3] = (value >>> 24)\n  return offset + 4\n}\n\nBuffer.prototype.writeInt32BE = function writeInt32BE (value, offset, noAssert) {\n  value = +value\n  offset = offset >>> 0\n  if (!noAssert) checkInt(this, value, offset, 4, 0x7fffffff, -0x80000000)\n  if (value < 0) value = 0xffffffff + value + 1\n  this[offset] = (value >>> 24)\n  this[offset + 1] = (value >>> 16)\n  this[offset + 2] = (value >>> 8)\n  this[offset + 3] = (value & 0xff)\n  return offset + 4\n}\n\nBuffer.prototype.writeBigInt64LE = defineBigIntMethod(function writeBigInt64LE (value, offset = 0) {\n  return wrtBigUInt64LE(this, value, offset, -BigInt('0x8000000000000000'), BigInt('0x7fffffffffffffff'))\n})\n\nBuffer.prototype.writeBigInt64BE = defineBigIntMethod(function writeBigInt64BE (value, offset = 0) {\n  return wrtBigUInt64BE(this, value, offset, -BigInt('0x8000000000000000'), BigInt('0x7fffffffffffffff'))\n})\n\nfunction checkIEEE754 (buf, value, offset, ext, max, min) {\n  if (offset + ext > buf.length) throw new RangeError('Index out of range')\n  if (offset < 0) throw new RangeError('Index out of range')\n}\n\nfunction writeFloat (buf, value, offset, littleEndian, noAssert) {\n  value = +value\n  offset = offset >>> 0\n  if (!noAssert) {\n    checkIEEE754(buf, value, offset, 4, 3.4028234663852886e+38, -3.4028234663852886e+38)\n  }\n  ieee754.write(buf, value, offset, littleEndian, 23, 4)\n  return offset + 4\n}\n\nBuffer.prototype.writeFloatLE = function writeFloatLE (value, offset, noAssert) {\n  return writeFloat(this, value, offset, true, noAssert)\n}\n\nBuffer.prototype.writeFloatBE = function writeFloatBE (value, offset, noAssert) {\n  return writeFloat(this, value, offset, false, noAssert)\n}\n\nfunction writeDouble (buf, value, offset, littleEndian, noAssert) {\n  value = +value\n  offset = offset >>> 0\n  if (!noAssert) {\n    checkIEEE754(buf, value, offset, 8, 1.7976931348623157E+308, -1.7976931348623157E+308)\n  }\n  ieee754.write(buf, value, offset, littleEndian, 52, 8)\n  return offset + 8\n}\n\nBuffer.prototype.writeDoubleLE = function writeDoubleLE (value, offset, noAssert) {\n  return writeDouble(this, value, offset, true, noAssert)\n}\n\nBuffer.prototype.writeDoubleBE = function writeDoubleBE (value, offset, noAssert) {\n  return writeDouble(this, value, offset, false, noAssert)\n}\n\n// copy(targetBuffer, targetStart=0, sourceStart=0, sourceEnd=buffer.length)\nBuffer.prototype.copy = function copy (target, targetStart, start, end) {\n  if (!Buffer.isBuffer(target)) throw new TypeError('argument should be a Buffer')\n  if (!start) start = 0\n  if (!end && end !== 0) end = this.length\n  if (targetStart >= target.length) targetStart = target.length\n  if (!targetStart) targetStart = 0\n  if (end > 0 && end < start) end = start\n\n  // Copy 0 bytes; we're done\n  if (end === start) return 0\n  if (target.length === 0 || this.length === 0) return 0\n\n  // Fatal error conditions\n  if (targetStart < 0) {\n    throw new RangeError('targetStart out of bounds')\n  }\n  if (start < 0 || start >= this.length) throw new RangeError('Index out of range')\n  if (end < 0) throw new RangeError('sourceEnd out of bounds')\n\n  // Are we oob?\n  if (end > this.length) end = this.length\n  if (target.length - targetStart < end - start) {\n    end = target.length - targetStart + start\n  }\n\n  const len = end - start\n\n  if (this === target && typeof Uint8Array.prototype.copyWithin === 'function') {\n    // Use built-in when available, missing from IE11\n    this.copyWithin(targetStart, start, end)\n  } else {\n    Uint8Array.prototype.set.call(\n      target,\n      this.subarray(start, end),\n      targetStart\n    )\n  }\n\n  return len\n}\n\n// Usage:\n//    buffer.fill(number[, offset[, end]])\n//    buffer.fill(buffer[, offset[, end]])\n//    buffer.fill(string[, offset[, end]][, encoding])\nBuffer.prototype.fill = function fill (val, start, end, encoding) {\n  // Handle string cases:\n  if (typeof val === 'string') {\n    if (typeof start === 'string') {\n      encoding = start\n      start = 0\n      end = this.length\n    } else if (typeof end === 'string') {\n      encoding = end\n      end = this.length\n    }\n    if (encoding !== undefined && typeof encoding !== 'string') {\n      throw new TypeError('encoding must be a string')\n    }\n    if (typeof encoding === 'string' && !Buffer.isEncoding(encoding)) {\n      throw new TypeError('Unknown encoding: ' + encoding)\n    }\n    if (val.length === 1) {\n      const code = val.charCodeAt(0)\n      if ((encoding === 'utf8' && code < 128) ||\n          encoding === 'latin1') {\n        // Fast path: If `val` fits into a single byte, use that numeric value.\n        val = code\n      }\n    }\n  } else if (typeof val === 'number') {\n    val = val & 255\n  } else if (typeof val === 'boolean') {\n    val = Number(val)\n  }\n\n  // Invalid ranges are not set to a default, so can range check early.\n  if (start < 0 || this.length < start || this.length < end) {\n    throw new RangeError('Out of range index')\n  }\n\n  if (end <= start) {\n    return this\n  }\n\n  start = start >>> 0\n  end = end === undefined ? this.length : end >>> 0\n\n  if (!val) val = 0\n\n  let i\n  if (typeof val === 'number') {\n    for (i = start; i < end; ++i) {\n      this[i] = val\n    }\n  } else {\n    const bytes = Buffer.isBuffer(val)\n      ? val\n      : Buffer.from(val, encoding)\n    const len = bytes.length\n    if (len === 0) {\n      throw new TypeError('The value \"' + val +\n        '\" is invalid for argument \"value\"')\n    }\n    for (i = 0; i < end - start; ++i) {\n      this[i + start] = bytes[i % len]\n    }\n  }\n\n  return this\n}\n\n// CUSTOM ERRORS\n// =============\n\n// Simplified versions from Node, changed for Buffer-only usage\nconst errors = {}\nfunction E (sym, getMessage, Base) {\n  errors[sym] = class NodeError extends Base {\n    constructor () {\n      super()\n\n      Object.defineProperty(this, 'message', {\n        value: getMessage.apply(this, arguments),\n        writable: true,\n        configurable: true\n      })\n\n      // Add the error code to the name to include it in the stack trace.\n      this.name = `${this.name} [${sym}]`\n      // Access the stack to generate the error message including the error code\n      // from the name.\n      this.stack // eslint-disable-line no-unused-expressions\n      // Reset the name to the actual name.\n      delete this.name\n    }\n\n    get code () {\n      return sym\n    }\n\n    set code (value) {\n      Object.defineProperty(this, 'code', {\n        configurable: true,\n        enumerable: true,\n        value,\n        writable: true\n      })\n    }\n\n    toString () {\n      return `${this.name} [${sym}]: ${this.message}`\n    }\n  }\n}\n\nE('ERR_BUFFER_OUT_OF_BOUNDS',\n  function (name) {\n    if (name) {\n      return `${name} is outside of buffer bounds`\n    }\n\n    return 'Attempt to access memory outside buffer bounds'\n  }, RangeError)\nE('ERR_INVALID_ARG_TYPE',\n  function (name, actual) {\n    return `The \"${name}\" argument must be of type number. Received type ${typeof actual}`\n  }, TypeError)\nE('ERR_OUT_OF_RANGE',\n  function (str, range, input) {\n    let msg = `The value of \"${str}\" is out of range.`\n    let received = input\n    if (Number.isInteger(input) && Math.abs(input) > 2 ** 32) {\n      received = addNumericalSeparator(String(input))\n    } else if (typeof input === 'bigint') {\n      received = String(input)\n      if (input > BigInt(2) ** BigInt(32) || input < -(BigInt(2) ** BigInt(32))) {\n        received = addNumericalSeparator(received)\n      }\n      received += 'n'\n    }\n    msg += ` It must be ${range}. Received ${received}`\n    return msg\n  }, RangeError)\n\nfunction addNumericalSeparator (val) {\n  let res = ''\n  let i = val.length\n  const start = val[0] === '-' ? 1 : 0\n  for (; i >= start + 4; i -= 3) {\n    res = `_${val.slice(i - 3, i)}${res}`\n  }\n  return `${val.slice(0, i)}${res}`\n}\n\n// CHECK FUNCTIONS\n// ===============\n\nfunction checkBounds (buf, offset, byteLength) {\n  validateNumber(offset, 'offset')\n  if (buf[offset] === undefined || buf[offset + byteLength] === undefined) {\n    boundsError(offset, buf.length - (byteLength + 1))\n  }\n}\n\nfunction checkIntBI (value, min, max, buf, offset, byteLength) {\n  if (value > max || value < min) {\n    const n = typeof min === 'bigint' ? 'n' : ''\n    let range\n    if (byteLength > 3) {\n      if (min === 0 || min === BigInt(0)) {\n        range = `>= 0${n} and < 2${n} ** ${(byteLength + 1) * 8}${n}`\n      } else {\n        range = `>= -(2${n} ** ${(byteLength + 1) * 8 - 1}${n}) and < 2 ** ` +\n                `${(byteLength + 1) * 8 - 1}${n}`\n      }\n    } else {\n      range = `>= ${min}${n} and <= ${max}${n}`\n    }\n    throw new errors.ERR_OUT_OF_RANGE('value', range, value)\n  }\n  checkBounds(buf, offset, byteLength)\n}\n\nfunction validateNumber (value, name) {\n  if (typeof value !== 'number') {\n    throw new errors.ERR_INVALID_ARG_TYPE(name, 'number', value)\n  }\n}\n\nfunction boundsError (value, length, type) {\n  if (Math.floor(value) !== value) {\n    validateNumber(value, type)\n    throw new errors.ERR_OUT_OF_RANGE(type || 'offset', 'an integer', value)\n  }\n\n  if (length < 0) {\n    throw new errors.ERR_BUFFER_OUT_OF_BOUNDS()\n  }\n\n  throw new errors.ERR_OUT_OF_RANGE(type || 'offset',\n                                    `>= ${type ? 1 : 0} and <= ${length}`,\n                                    value)\n}\n\n// HELPER FUNCTIONS\n// ================\n\nconst INVALID_BASE64_RE = /[^+/0-9A-Za-z-_]/g\n\nfunction base64clean (str) {\n  // Node takes equal signs as end of the Base64 encoding\n  str = str.split('=')[0]\n  // Node strips out invalid characters like \\n and \\t from the string, base64-js does not\n  str = str.trim().replace(INVALID_BASE64_RE, '')\n  // Node converts strings with length < 2 to ''\n  if (str.length < 2) return ''\n  // Node allows for non-padded base64 strings (missing trailing ===), base64-js does not\n  while (str.length % 4 !== 0) {\n    str = str + '='\n  }\n  return str\n}\n\nfunction utf8ToBytes (string, units) {\n  units = units || Infinity\n  let codePoint\n  const length = string.length\n  let leadSurrogate = null\n  const bytes = []\n\n  for (let i = 0; i < length; ++i) {\n    codePoint = string.charCodeAt(i)\n\n    // is surrogate component\n    if (codePoint > 0xD7FF && codePoint < 0xE000) {\n      // last char was a lead\n      if (!leadSurrogate) {\n        // no lead yet\n        if (codePoint > 0xDBFF) {\n          // unexpected trail\n          if ((units -= 3) > -1) bytes.push(0xEF, 0xBF, 0xBD)\n          continue\n        } else if (i + 1 === length) {\n          // unpaired lead\n          if ((units -= 3) > -1) bytes.push(0xEF, 0xBF, 0xBD)\n          continue\n        }\n\n        // valid lead\n        leadSurrogate = codePoint\n\n        continue\n      }\n\n      // 2 leads in a row\n      if (codePoint < 0xDC00) {\n        if ((units -= 3) > -1) bytes.push(0xEF, 0xBF, 0xBD)\n        leadSurrogate = codePoint\n        continue\n      }\n\n      // valid surrogate pair\n      codePoint = (leadSurrogate - 0xD800 << 10 | codePoint - 0xDC00) + 0x10000\n    } else if (leadSurrogate) {\n      // valid bmp char, but last char was a lead\n      if ((units -= 3) > -1) bytes.push(0xEF, 0xBF, 0xBD)\n    }\n\n    leadSurrogate = null\n\n    // encode utf8\n    if (codePoint < 0x80) {\n      if ((units -= 1) < 0) break\n      bytes.push(codePoint)\n    } else if (codePoint < 0x800) {\n      if ((units -= 2) < 0) break\n      bytes.push(\n        codePoint >> 0x6 | 0xC0,\n        codePoint & 0x3F | 0x80\n      )\n    } else if (codePoint < 0x10000) {\n      if ((units -= 3) < 0) break\n      bytes.push(\n        codePoint >> 0xC | 0xE0,\n        codePoint >> 0x6 & 0x3F | 0x80,\n        codePoint & 0x3F | 0x80\n      )\n    } else if (codePoint < 0x110000) {\n      if ((units -= 4) < 0) break\n      bytes.push(\n        codePoint >> 0x12 | 0xF0,\n        codePoint >> 0xC & 0x3F | 0x80,\n        codePoint >> 0x6 & 0x3F | 0x80,\n        codePoint & 0x3F | 0x80\n      )\n    } else {\n      throw new Error('Invalid code point')\n    }\n  }\n\n  return bytes\n}\n\nfunction asciiToBytes (str) {\n  const byteArray = []\n  for (let i = 0; i < str.length; ++i) {\n    // Node's code seems to be doing this and not & 0x7F..\n    byteArray.push(str.charCodeAt(i) & 0xFF)\n  }\n  return byteArray\n}\n\nfunction utf16leToBytes (str, units) {\n  let c, hi, lo\n  const byteArray = []\n  for (let i = 0; i < str.length; ++i) {\n    if ((units -= 2) < 0) break\n\n    c = str.charCodeAt(i)\n    hi = c >> 8\n    lo = c % 256\n    byteArray.push(lo)\n    byteArray.push(hi)\n  }\n\n  return byteArray\n}\n\nfunction base64ToBytes (str) {\n  return base64.toByteArray(base64clean(str))\n}\n\nfunction blitBuffer (src, dst, offset, length) {\n  let i\n  for (i = 0; i < length; ++i) {\n    if ((i + offset >= dst.length) || (i >= src.length)) break\n    dst[i + offset] = src[i]\n  }\n  return i\n}\n\n// ArrayBuffer or Uint8Array objects from other contexts (i.e. iframes) do not pass\n// the `instanceof` check but they should be treated as of that type.\n// See: https://github.com/feross/buffer/issues/166\nfunction isInstance (obj, type) {\n  return obj instanceof type ||\n    (obj != null && obj.constructor != null && obj.constructor.name != null &&\n      obj.constructor.name === type.name)\n}\nfunction numberIsNaN (obj) {\n  // For IE11 support\n  return obj !== obj // eslint-disable-line no-self-compare\n}\n\n// Create lookup table for `toString('hex')`\n// See: https://github.com/feross/buffer/issues/219\nconst hexSliceLookupTable = (function () {\n  const alphabet = '0123456789abcdef'\n  const table = new Array(256)\n  for (let i = 0; i < 16; ++i) {\n    const i16 = i * 16\n    for (let j = 0; j < 16; ++j) {\n      table[i16 + j] = alphabet[i] + alphabet[j]\n    }\n  }\n  return table\n})()\n\n// Return not function with Error if BigInt not supported\nfunction defineBigIntMethod (fn) {\n  return typeof BigInt === 'undefined' ? BufferBigIntNotDefined : fn\n}\n\nfunction BufferBigIntNotDefined () {\n  throw new Error('BigInt not supported')\n}\n","import { BaseError } from './BaseError.js'\n\nexport class ObjectTypeError extends BaseError {\n  /**\n   * @param {string} oid\n   * @param {'blob'|'commit'|'tag'|'tree'} actual\n   * @param {'blob'|'commit'|'tag'|'tree'} expected\n   * @param {string} [filepath]\n   */\n  constructor(oid, actual, expected, filepath) {\n    super(\n      `Object ${oid} ${\n        filepath ? `at ${filepath}` : ''\n      }was anticipated to be a ${expected} but it is a ${actual}.`\n    )\n    this.code = this.name = ObjectTypeError.code\n    this.data = { oid, actual, expected, filepath }\n  }\n}\n/** @type {'ObjectTypeError'} */\nObjectTypeError.code = 'ObjectTypeError'\n","/*\n * Import internal data parsers and structures from isomorphic-git. These\n * exports are not available in the npm version of isomorphic-git, which is why\n * we use one from the git repository.\n *\n * This file heavily relies on isomorphic-git internals to parse Git data formats\n * such as PACK, trees, deltas, etc.\n */\nimport './isomorphic-git.d.ts';\nimport { GitPktLine } from 'isomorphic-git/src/models/GitPktLine.js';\nimport { GitTree } from 'isomorphic-git/src/models/GitTree.js';\nimport { GitAnnotatedTag } from 'isomorphic-git/src/models/GitAnnotatedTag.js';\nimport { GitCommit } from 'isomorphic-git/src/models/GitCommit.js';\nimport { GitPackIndex } from 'isomorphic-git/src/models/GitPackIndex.js';\nimport { collect } from 'isomorphic-git/src/internal-apis.js';\nimport { parseUploadPackResponse } from 'isomorphic-git/src/wire/parseUploadPackResponse.js';\nimport { ObjectTypeError } from 'isomorphic-git/src/errors/ObjectTypeError.js';\nimport { Buffer } from 'buffer';\n\n/**\n * A polyfill for the Buffer class. We need it because isomorphic-git uses it internally.\n * The isomorphic-git version released via npm shipes a Buffer implementation, but we're\n * using a version cloned from the git repository which assumes a global Buffer is available.\n */\nif (typeof window !== 'undefined') {\n\twindow.Buffer = Buffer;\n}\n\n/**\n * Downloads specific files from a git repository.\n * It uses the git protocol over HTTP to fetch the files. It only uses\n * three HTTP requests regardless of the number of paths requested.\n *\n * @param repoUrl The URL of the git repository.\n * @param fullyQualifiedBranchName The full name of the branch to fetch from (e.g., 'refs/heads/main').\n * @param filesPaths An array of all the file paths to fetch from the repository. Does **not** accept\n *                   patterns, wildcards, directory paths. All files must be explicitly listed.\n * @returns A record where keys are file paths and values are the retrieved file contents.\n */\nexport async function sparseCheckout(\n\trepoUrl: string,\n\tcommitHash: string,\n\tfilesPaths: string[]\n) {\n\tconst treesIdx = await fetchWithoutBlobs(repoUrl, commitHash);\n\tconst objects = await resolveObjects(treesIdx, commitHash, filesPaths);\n\n\tconst blobsIdx = await fetchObjects(\n\t\trepoUrl,\n\t\tfilesPaths.map((path) => objects[path].oid)\n\t);\n\n\tconst fetchedPaths: Record<string, any> = {};\n\tawait Promise.all(\n\t\tfilesPaths.map(async (path) => {\n\t\t\tfetchedPaths[path] = await extractGitObjectFromIdx(\n\t\t\t\tblobsIdx,\n\t\t\t\tobjects[path].oid\n\t\t\t);\n\t\t})\n\t);\n\treturn fetchedPaths;\n}\n\nexport type FileTreeFile = {\n\tname: string;\n\ttype: 'file';\n};\nexport type FileTreeFolder = {\n\tname: string;\n\ttype: 'folder';\n\tchildren: FileTree[];\n};\nexport type FileTree = FileTreeFile | FileTreeFolder;\n\nexport type GitRef = {\n\tvalue: string;\n\ttype?: 'branch' | 'commit' | 'refname' | 'infer';\n};\n\n/**\n * Lists all files in a git repository.\n *\n * See https://git-scm.com/book/en/v2/Git-Internals-Git-Objects for more information.\n *\n * @param repoUrl The URL of the git repository.\n * @param commitHash The commit hash to fetch from.\n * @returns A list of all files in the repository.\n */\nexport async function listGitFiles(\n\trepoUrl: string,\n\tcommitHash: string\n): Promise<FileTree[]> {\n\tconst treesIdx = await fetchWithoutBlobs(repoUrl, commitHash);\n\tconst rootTree = await resolveAllObjects(treesIdx, commitHash);\n\tif (!rootTree?.object) {\n\t\treturn [];\n\t}\n\n\treturn gitTreeToFileTree(rootTree);\n}\n\n/**\n * Resolves a ref description, e.g. a branch name, to a commit hash.\n *\n * @param repoUrl The URL of the git repository.\n * @param ref The branch name or commit hash.\n * @returns The commit hash.\n */\nexport async function resolveCommitHash(repoUrl: string, ref: GitRef) {\n\tif (ref.type === 'infer' || ref.type === undefined) {\n\t\tif (['', 'HEAD'].includes(ref.value)) {\n\t\t\tref = {\n\t\t\t\tvalue: ref.value,\n\t\t\t\ttype: 'refname',\n\t\t\t};\n\t\t} else if (typeof ref.value === 'string' && ref.value.length === 40) {\n\t\t\tref = {\n\t\t\t\tvalue: ref.value,\n\t\t\t\ttype: 'commit',\n\t\t\t};\n\t\t}\n\t}\n\tif (ref.type === 'branch') {\n\t\tref = {\n\t\t\tvalue: `refs/heads/${ref.value}`,\n\t\t\ttype: 'refname',\n\t\t};\n\t}\n\tswitch (ref.type) {\n\t\tcase 'commit':\n\t\t\treturn ref.value;\n\t\tcase 'refname': {\n\t\t\tconst refs = await listGitRefs(repoUrl, ref.value);\n\t\t\tif (!(ref.value in refs)) {\n\t\t\t\tthrow new Error(`Branch ${ref.value} not found`);\n\t\t\t}\n\t\t\treturn refs[ref.value];\n\t\t}\n\t\tdefault:\n\t\t\tthrow new Error(`Invalid ref type: ${ref.type}`);\n\t}\n}\n\nfunction gitTreeToFileTree(tree: GitTree): FileTree[] {\n\treturn tree.object\n\t\t.map((branch) => {\n\t\t\tif (branch.type === 'blob') {\n\t\t\t\treturn {\n\t\t\t\t\tname: branch.path,\n\t\t\t\t\ttype: 'file',\n\t\t\t\t} as FileTreeFile;\n\t\t\t} else if (branch.type === 'tree' && branch.object) {\n\t\t\t\treturn {\n\t\t\t\t\tname: branch.path,\n\t\t\t\t\ttype: 'folder',\n\t\t\t\t\tchildren: gitTreeToFileTree(branch as any as GitTree),\n\t\t\t\t} as FileTreeFolder;\n\t\t\t}\n\t\t\treturn undefined;\n\t\t})\n\t\t.filter((entry) => !!entry?.name) as FileTree[];\n}\n\n/**\n * Retrieves a list of refs from a git repository.\n *\n * See https://git-scm.com/book/en/v2/Git-Internals-Git-References for more information.\n *\n * @param repoUrl The URL of the git repository. For example: https://github.com/WordPress/gutenberg.git\n * @param fullyQualifiedBranchPrefix The prefix of the refs to fetch. For example: refs/heads/my-feature-branch\n * @returns A map of refs to their corresponding commit hashes.\n */\nexport async function listGitRefs(\n\trepoUrl: string,\n\tfullyQualifiedBranchPrefix: string\n) {\n\tconst packbuffer = Buffer.from(\n\t\tawait collect([\n\t\t\tGitPktLine.encode(`command=ls-refs\\n`),\n\t\t\tGitPktLine.encode(`agent=git/2.37.3\\n`),\n\t\t\tGitPktLine.encode(`object-format=sha1\\n`),\n\t\t\tGitPktLine.delim(),\n\t\t\tGitPktLine.encode(`peel\\n`),\n\t\t\tGitPktLine.encode(`ref-prefix ${fullyQualifiedBranchPrefix}\\n`),\n\t\t\tGitPktLine.flush(),\n\t\t])\n\t);\n\n\tconst response = await fetch(repoUrl + '/git-upload-pack', {\n\t\tmethod: 'POST',\n\t\theaders: {\n\t\t\tAccept: 'application/x-git-upload-pack-advertisement',\n\t\t\t'content-type': 'application/x-git-upload-pack-request',\n\t\t\t'Content-Length': `${packbuffer.length}`,\n\t\t\t'Git-Protocol': 'version=2',\n\t\t},\n\t\tbody: packbuffer,\n\t});\n\n\tconst refs: Record<string, string> = {};\n\tfor await (const line of parseGitResponseLines(response)) {\n\t\tconst spaceAt = line.indexOf(' ');\n\t\tconst ref = line.slice(0, spaceAt);\n\t\tconst name = line.slice(spaceAt + 1, line.length - 1);\n\t\trefs[name] = ref;\n\t}\n\treturn refs;\n}\n\nasync function fetchWithoutBlobs(repoUrl: string, commitHash: string) {\n\tconst packbuffer = Buffer.from(\n\t\tawait collect([\n\t\t\tGitPktLine.encode(\n\t\t\t\t`want ${commitHash} multi_ack_detailed no-done side-band-64k thin-pack ofs-delta agent=git/2.37.3 filter \\n`\n\t\t\t),\n\t\t\tGitPktLine.encode(`filter blob:none\\n`),\n\t\t\tGitPktLine.encode(`shallow ${commitHash}\\n`),\n\t\t\tGitPktLine.encode(`deepen 1\\n`),\n\t\t\tGitPktLine.flush(),\n\t\t\tGitPktLine.encode(`done\\n`),\n\t\t\tGitPktLine.encode(`done\\n`),\n\t\t])\n\t);\n\n\tconst response = await fetch(repoUrl + '/git-upload-pack', {\n\t\tmethod: 'POST',\n\t\theaders: {\n\t\t\tAccept: 'application/x-git-upload-pack-advertisement',\n\t\t\t'content-type': 'application/x-git-upload-pack-request',\n\t\t\t'Content-Length': `${packbuffer.length}`,\n\t\t},\n\t\tbody: packbuffer,\n\t});\n\n\tconst iterator = streamToIterator(response.body!);\n\tconst parsed = await parseUploadPackResponse(iterator);\n\tconst packfile = Buffer.from(await collect(parsed.packfile));\n\tconst idx = await GitPackIndex.fromPack({\n\t\tpack: packfile,\n\t});\n\tconst originalRead = idx.read as any;\n\tidx.read = async function ({ oid, ...rest }: { oid: string }) {\n\t\tconst result = await originalRead.call(this, { oid, ...rest });\n\t\tresult.oid = oid;\n\t\treturn result;\n\t};\n\treturn idx;\n}\n\nasync function resolveAllObjects(idx: GitPackIndex, commitHash: string) {\n\tconst commit = await idx.read({\n\t\toid: commitHash,\n\t});\n\treadObject(commit);\n\n\tconst rootItem = await idx.read({ oid: commit.object.tree });\n\tconst items = [rootItem];\n\twhile (items.length > 0) {\n\t\tconst tree = items.pop();\n\t\tconst readItem = await idx.read({ oid: tree.oid });\n\t\treadObject(readItem);\n\t\ttree.object = readItem.object;\n\t\tif (readItem.type === 'tree') {\n\t\t\tfor (const subitem of readItem.object) {\n\t\t\t\tif (subitem.type === 'tree') {\n\t\t\t\t\titems.push(subitem);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\treturn rootItem;\n}\n\nasync function resolveObjects(\n\tidx: GitPackIndex,\n\tcommitHash: string,\n\tpaths: string[]\n) {\n\tconst commit = await idx.read({\n\t\toid: commitHash,\n\t});\n\treadObject(commit);\n\n\tconst rootTree = await idx.read({ oid: commit.object.tree });\n\treadObject(rootTree);\n\n\t// Resolve refs to fetch\n\tconst resolvedOids: Record<string, any> = {};\n\tfor (const path of paths) {\n\t\tlet currentObject = rootTree;\n\t\tconst segments = path.split('/');\n\t\tfor (const segment of segments) {\n\t\t\tif (currentObject.type !== 'tree') {\n\t\t\t\tthrow new Error(`Path not found in the repo: ${path}`);\n\t\t\t}\n\n\t\t\tlet found = false;\n\t\t\tfor (const item of currentObject.object) {\n\t\t\t\tif (item.path === segment) {\n\t\t\t\t\ttry {\n\t\t\t\t\t\tcurrentObject = await idx.read({ oid: item.oid });\n\t\t\t\t\t\treadObject(currentObject);\n\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\tcurrentObject = item;\n\t\t\t\t\t}\n\t\t\t\t\tfound = true;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (!found) {\n\t\t\t\tthrow new Error(`Path not found in the repo: ${path}`);\n\t\t\t}\n\t\t}\n\t\tresolvedOids[path] = currentObject;\n\t}\n\treturn resolvedOids;\n}\n\n// Request oid for each resolvedRef\nasync function fetchObjects(url: string, objectHashes: string[]) {\n\tconst packbuffer = Buffer.from(\n\t\tawait collect([\n\t\t\t...objectHashes.map((objectHash) =>\n\t\t\t\tGitPktLine.encode(\n\t\t\t\t\t`want ${objectHash} multi_ack_detailed no-done side-band-64k thin-pack ofs-delta agent=git/2.37.3 \\n`\n\t\t\t\t)\n\t\t\t),\n\t\t\tGitPktLine.flush(),\n\t\t\tGitPktLine.encode(`done\\n`),\n\t\t])\n\t);\n\n\tconst response = await fetch(url + '/git-upload-pack', {\n\t\tmethod: 'POST',\n\t\theaders: {\n\t\t\tAccept: 'application/x-git-upload-pack-advertisement',\n\t\t\t'content-type': 'application/x-git-upload-pack-request',\n\t\t\t'Content-Length': `${packbuffer.length}`,\n\t\t},\n\t\tbody: packbuffer,\n\t});\n\n\tconst iterator = streamToIterator(response.body!);\n\tconst parsed = await parseUploadPackResponse(iterator);\n\tconst packfile = Buffer.from(await collect(parsed.packfile));\n\treturn await GitPackIndex.fromPack({\n\t\tpack: packfile,\n\t});\n}\n\nasync function extractGitObjectFromIdx(idx: GitPackIndex, objectHash: string) {\n\tconst tree = await idx.read({ oid: objectHash });\n\treadObject(tree);\n\n\tif (tree.type === 'blob') {\n\t\treturn tree.object;\n\t}\n\n\tconst files: Record<string, any> = {};\n\tfor (const { path, oid, type } of tree.object) {\n\t\tif (type === 'blob') {\n\t\t\tconst object = await idx.read({ oid });\n\t\t\treadObject(object);\n\t\t\tfiles[path] = object.object;\n\t\t} else if (type === 'tree') {\n\t\t\tfiles[path] = await extractGitObjectFromIdx(idx, oid);\n\t\t}\n\t}\n\treturn files;\n}\n\nfunction readObject(result: any) {\n\tif (!(result.object instanceof Buffer)) {\n\t\treturn;\n\t}\n\tswitch (result.type) {\n\t\tcase 'commit':\n\t\t\tresult.object = GitCommit.from(result.object).parse();\n\t\t\tbreak;\n\t\tcase 'tree':\n\t\t\tresult.object = (GitTree.from(result.object) as any).entries();\n\t\t\tbreak;\n\t\tcase 'blob':\n\t\t\tresult.object = new Uint8Array(result.object);\n\t\t\tresult.format = 'content';\n\t\t\tbreak;\n\t\tcase 'tag':\n\t\t\tresult.object = GitAnnotatedTag.from(result.object).parse();\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tthrow new ObjectTypeError(\n\t\t\t\tresult.oid,\n\t\t\t\tresult.type,\n\t\t\t\t'blob|commit|tag|tree'\n\t\t\t);\n\t}\n}\n\nasync function* parseGitResponseLines(response: Response) {\n\tconst text = await response.text();\n\tlet at = 0;\n\n\twhile (at <= text.length) {\n\t\tconst lineLength = parseInt(text.substring(at, at + 4), 16);\n\t\tif (lineLength === 0) {\n\t\t\tbreak;\n\t\t}\n\t\tconst line = text.substring(at + 4, at + lineLength);\n\t\tyield line;\n\t\tat += lineLength;\n\t}\n}\n\nfunction streamToIterator(stream: any) {\n\t// Use native async iteration if it's available.\n\tif (stream[Symbol.asyncIterator]) {\n\t\treturn stream;\n\t}\n\tconst reader = stream.getReader();\n\treturn {\n\t\tnext() {\n\t\t\treturn reader.read();\n\t\t},\n\t\treturn() {\n\t\t\treader.releaseLock();\n\t\t\treturn {};\n\t\t},\n\t\t[Symbol.asyncIterator]() {\n\t\t\treturn this;\n\t\t},\n\t};\n}\n","import { ProgressTracker } from '@php-wasm/progress';\nimport { Semaphore } from '@php-wasm/util';\nimport {\n\tLatestSupportedPHPVersion,\n\tSupportedPHPVersion,\n\tSupportedPHPVersions,\n\tUniversalPHP,\n} from '@php-wasm/universal';\nimport { FileReference, isResourceReference, Resource } from './resources';\nimport { ImportWxrStep, Step, StepDefinition, WriteFileStep } from './steps';\nimport * as allStepHandlers from './steps/handlers';\nimport { Blueprint, ExtraLibrary } from './blueprint';\nimport { logger } from '@php-wasm/logger';\n/* @ts-ignore */\n// eslint-disable-next-line\nimport dataLiberationCoreUrl from '../../../data-liberation/dist/data-liberation-core.phar.gz?url';\n\n// @TODO: Configure this in the `wp-cli` step, not here.\nconst { wpCLI, ...otherStepHandlers } = allStepHandlers;\nconst keyedStepHandlers = {\n\t...otherStepHandlers,\n\t'wp-cli': wpCLI,\n\timportFile: otherStepHandlers.importWxr,\n};\n\n/**\n * The JSON schema validator stored in this directory is used to validate\n * the Blueprints and is autogenerated from the Blueprints schema which is\n * autogenerated from TypeScript types.\n *\n * Whenever the types are modified, the schema and validator need to be\n * rebuilt using `nx build playground-blueprints` and then committed to\n * the repository.\n *\n * Unfortunately, it is not auto-rebuilt in `npm run dev` mode as the\n * `dts-bundle-generator` utility we use for type rollyps does not support\n * watching for changes.\n */\nimport blueprintValidator from '../../public/blueprint-schema-validator';\nimport { defaultWpCliPath, defaultWpCliResource } from './steps/wp-cli';\n\nexport type CompiledStep = (php: UniversalPHP) => Promise<void> | void;\n\nexport interface CompiledBlueprint {\n\t/** The requested versions of PHP and WordPress for the blueprint */\n\tversions: {\n\t\tphp: SupportedPHPVersion;\n\t\twp: string;\n\t};\n\tfeatures: {\n\t\t/** Should boot with support for network request via wp_safe_remote_get? */\n\t\tnetworking: boolean;\n\t};\n\textraLibraries: ExtraLibrary[];\n\t/** The compiled steps for the blueprint */\n\trun: (playground: UniversalPHP) => Promise<void>;\n}\n\nexport type OnStepCompleted = (output: any, step: StepDefinition) => any;\n\nexport interface CompileBlueprintOptions {\n\t/** Optional progress tracker to monitor progress */\n\tprogress?: ProgressTracker;\n\t/** Optional semaphore to control access to a shared resource */\n\tsemaphore?: Semaphore;\n\t/** Optional callback with step output */\n\tonStepCompleted?: OnStepCompleted;\n\t/**\n\t * Proxy URL to use for cross-origin requests.\n\t *\n\t * For example, if corsProxy is set to \"https://cors.wordpress.net/proxy.php\",\n\t * then the CORS requests to https://github.com/WordPress/gutenberg.git would actually\n\t * be made to https://cors.wordpress.net/proxy.php?https://github.com/WordPress/gutenberg.git.\n\t */\n\tcorsProxy?: string;\n}\n\n/**\n * Compiles Blueprint into a form that can be executed.\n *\n * @param playground The PlaygroundClient to use for the compilation\n * @param blueprint The bBueprint to compile\n * @param options Additional options for the compilation\n * @returns The compiled blueprint\n */\nexport function compileBlueprint(\n\tblueprint: Blueprint,\n\t{\n\t\tprogress = new ProgressTracker(),\n\t\tsemaphore = new Semaphore({ concurrency: 3 }),\n\t\tonStepCompleted = () => {},\n\t\tcorsProxy,\n\t}: CompileBlueprintOptions = {}\n): CompiledBlueprint {\n\t// Deep clone the blueprint to avoid mutating the input\n\tblueprint = structuredClone(blueprint);\n\n\tblueprint = {\n\t\t...blueprint,\n\t\tsteps: (blueprint.steps || [])\n\t\t\t.filter(isStepDefinition)\n\t\t\t.filter(isStepStillSupported),\n\t};\n\tfor (const step of blueprint.steps!) {\n\t\tif (!step || typeof step !== 'object') {\n\t\t\tcontinue;\n\t\t}\n\t\t// Convert legacy importFile steps to importWxr\n\t\tif ((step as any).step === 'importFile') {\n\t\t\t(step as any).step = 'importWxr';\n\t\t\tlogger.warn(\n\t\t\t\t`The \"importFile\" step is deprecated. Use \"importWxr\" instead.`\n\t\t\t);\n\t\t} else if (\n\t\t\t(step as any)?.step === 'installPlugin' &&\n\t\t\t'pluginZipFile' in step\n\t\t) {\n\t\t\t(step as any).pluginData = (step as any).pluginZipFile;\n\t\t\tlogger.warn(\n\t\t\t\t`The \"pluginZipFile\" option of the \"installPlugin\" step is deprecated. Use \"pluginData\" instead.`\n\t\t\t);\n\t\t} else if (\n\t\t\t(step as any)?.step === 'installTheme' &&\n\t\t\t'themeZipFile' in step\n\t\t) {\n\t\t\t(step as any).themeData = (step as any).themeZipFile;\n\t\t\tlogger.warn(\n\t\t\t\t`The \"themeZipFile\" option of the \"installTheme\" step is deprecated. Use \"themeData\" instead.`\n\t\t\t);\n\t\t}\n\t}\n\n\t// Experimental declarative syntax {{{\n\tif (blueprint.constants) {\n\t\tblueprint.steps!.unshift({\n\t\t\tstep: 'defineWpConfigConsts',\n\t\t\tconsts: blueprint.constants,\n\t\t});\n\t}\n\tif (blueprint.siteOptions) {\n\t\tblueprint.steps!.unshift({\n\t\t\tstep: 'setSiteOptions',\n\t\t\toptions: blueprint.siteOptions,\n\t\t});\n\t}\n\tif (blueprint.plugins) {\n\t\t// Translate an array of strings into a map of pluginName => true to\n\t\t// install the latest version of the plugin from wordpress.org\n\t\tconst steps = blueprint.plugins\n\t\t\t.map((value) => {\n\t\t\t\tif (typeof value === 'string') {\n\t\t\t\t\tif (value.startsWith('https://')) {\n\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\tresource: 'url',\n\t\t\t\t\t\t\turl: value,\n\t\t\t\t\t\t} as FileReference;\n\t\t\t\t\t} else {\n\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\tresource: 'wordpress.org/plugins',\n\t\t\t\t\t\t\tslug: value,\n\t\t\t\t\t\t} as FileReference;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\treturn value;\n\t\t\t})\n\t\t\t.map((resource) => ({\n\t\t\t\tstep: 'installPlugin',\n\t\t\t\tpluginData: resource,\n\t\t\t})) as StepDefinition[];\n\t\tblueprint.steps!.unshift(...steps);\n\t}\n\tif (blueprint.login) {\n\t\tblueprint.steps!.push({\n\t\t\tstep: 'login',\n\t\t\t...(blueprint.login === true\n\t\t\t\t? { username: 'admin' }\n\t\t\t\t: blueprint.login),\n\t\t});\n\t}\n\n\t/**\n\t * Download WP-CLI. {{{\n\t * Hardcoding this in the compile() function is a temporary solution\n\t * to provide steps with the wp-cli.phar file it needs. Eventually,\n\t * each Blueprint step may be able to specify any pre-requisite resources.\n\t * Also, wp-cli should only be downloaded if it's not already present.\n\t *\n\t * The enableMultisite step uses wp-cli to convert the site to a multisite.\n\t * The wp-cli step itself depends on WP-CLI.\n\t */\n\tconst indexOfStepThatDependsOnWpCli =\n\t\tblueprint.steps?.findIndex(\n\t\t\t(step) =>\n\t\t\t\ttypeof step === 'object' &&\n\t\t\t\tstep?.step &&\n\t\t\t\t['wp-cli', 'enableMultisite'].includes(step.step)\n\t\t) ?? -1;\n\tif (\n\t\tblueprint?.extraLibraries?.includes('wp-cli') ||\n\t\tindexOfStepThatDependsOnWpCli !== -1\n\t) {\n\t\tconst wpCliInstallStep: WriteFileStep<FileReference> = {\n\t\t\tstep: 'writeFile',\n\t\t\tdata: defaultWpCliResource,\n\t\t\tpath: defaultWpCliPath,\n\t\t};\n\t\t/**\n\t\t * If the blueprint does not have a wp-cli step,\n\t\t * we can install wp-cli as the last step because other steps don't depend\n\t\t * on wp-cli.\n\t\t *\n\t\t * If the blueprint has wp-cli steps,\n\t\t * we need to install wp-cli before running these steps.\n\t\t */\n\t\tif (indexOfStepThatDependsOnWpCli === -1) {\n\t\t\tblueprint.steps?.push(wpCliInstallStep);\n\t\t} else {\n\t\t\tblueprint.steps?.splice(\n\t\t\t\tindexOfStepThatDependsOnWpCli,\n\t\t\t\t0,\n\t\t\t\twpCliInstallStep\n\t\t\t);\n\t\t}\n\t}\n\n\t/**\n\t * Download the WordPress-importer plugin. {{{\n\t * Hardcoding this in the compile() function is a temporary solution\n\t */\n\tconst importWxrStepIndex = blueprint.steps?.findIndex(\n\t\t(step) => typeof step === 'object' && step?.step === 'importWxr'\n\t);\n\tif (importWxrStepIndex !== undefined && importWxrStepIndex > -1) {\n\t\tconst importWxrStep = blueprint.steps![\n\t\t\timportWxrStepIndex\n\t\t]! as ImportWxrStep<any>;\n\t\tif (importWxrStep.importer === 'data-liberation') {\n\t\t\tblueprint.steps?.splice(importWxrStepIndex, 0, {\n\t\t\t\tstep: 'writeFile',\n\t\t\t\tpath: '/internal/shared/data-liberation-core.phar',\n\t\t\t\tdata: {\n\t\t\t\t\tresource: 'url',\n\t\t\t\t\turl: dataLiberationCoreUrl,\n\t\t\t\t\tcaption: 'Downloading the Data Liberation WXR importer',\n\t\t\t\t},\n\t\t\t});\n\t\t} else {\n\t\t\tblueprint.steps?.splice(importWxrStepIndex, 0, {\n\t\t\t\tstep: 'installPlugin',\n\t\t\t\tpluginData: {\n\t\t\t\t\tresource: 'url',\n\t\t\t\t\turl: 'https://playground.wordpress.net/wordpress-importer.zip',\n\t\t\t\t\tcaption: 'Downloading the WordPress Importer plugin',\n\t\t\t\t},\n\t\t\t});\n\t\t}\n\t}\n\n\tconst { valid, errors } = validateBlueprint(blueprint);\n\tif (!valid) {\n\t\tconst e = new Error(\n\t\t\t`Invalid blueprint: ${errors![0].message} at ${\n\t\t\t\terrors![0].instancePath\n\t\t\t}`\n\t\t);\n\t\t// Attach Ajv output to the thrown object for easier debugging\n\t\t(e as any).errors = errors;\n\t\tthrow e;\n\t}\n\n\tconst steps = (blueprint.steps || []) as StepDefinition[];\n\tconst totalProgressWeight = steps.reduce(\n\t\t(total, step) => total + (step.progress?.weight || 1),\n\t\t0\n\t);\n\tconst compiled = steps.map((step) =>\n\t\tcompileStep(step, {\n\t\t\tsemaphore,\n\t\t\trootProgressTracker: progress,\n\t\t\ttotalProgressWeight,\n\t\t\tcorsProxy,\n\t\t})\n\t);\n\n\treturn {\n\t\tversions: {\n\t\t\tphp: compileVersion(\n\t\t\t\tblueprint.preferredVersions?.php,\n\t\t\t\tSupportedPHPVersions,\n\t\t\t\tLatestSupportedPHPVersion\n\t\t\t),\n\t\t\twp: blueprint.preferredVersions?.wp || 'latest',\n\t\t},\n\t\tfeatures: {\n\t\t\t// Disable networking by default\n\t\t\tnetworking: blueprint.features?.networking ?? false,\n\t\t},\n\t\textraLibraries: blueprint.extraLibraries || [],\n\t\trun: async (playground: UniversalPHP) => {\n\t\t\ttry {\n\t\t\t\t// Start resolving resources early\n\t\t\t\tfor (const { resources } of compiled) {\n\t\t\t\t\tfor (const resource of resources) {\n\t\t\t\t\t\tresource.setPlayground(playground);\n\t\t\t\t\t\tif (resource.isAsync) {\n\t\t\t\t\t\t\tresource.resolve();\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tfor (const [i, { run, step }] of Object.entries(compiled)) {\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst result = await run(playground);\n\t\t\t\t\t\tonStepCompleted(result, step);\n\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\tlogger.error(e);\n\t\t\t\t\t\tthrow new Error(\n\t\t\t\t\t\t\t`Error when executing the blueprint step #${i} (${JSON.stringify(\n\t\t\t\t\t\t\t\tstep\n\t\t\t\t\t\t\t)}) ${e instanceof Error ? `: ${e.message}` : e}`,\n\t\t\t\t\t\t\t{ cause: e }\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} finally {\n\t\t\t\ttry {\n\t\t\t\t\tawait (playground as any).goTo(\n\t\t\t\t\t\tblueprint.landingPage || '/'\n\t\t\t\t\t);\n\t\t\t\t} catch (e) {\n\t\t\t\t\t/*\n\t\t\t\t\t * PHP exposes no goTo method.\n\t\t\t\t\t * We can't use `goto` in playground here,\n\t\t\t\t\t * because it may be a Comlink proxy object\n\t\t\t\t\t * with no such method.\n\t\t\t\t\t */\n\t\t\t\t}\n\t\t\t\tprogress.finish();\n\t\t\t}\n\t\t},\n\t};\n}\n\nexport function validateBlueprint(blueprintMaybe: object) {\n\tconst valid = blueprintValidator(blueprintMaybe);\n\tif (valid) {\n\t\treturn { valid };\n\t}\n\n\t/**\n\t * Each entry of \"steps\" can be either an object, null, undefined etc\n\t * via the \"anyOf\" part of the schema.\n\t *\n\t * If the step has any error in it, like a missing property, Ajv will\n\t * also return errors for each case listed in \"anyOf\" which means we'll\n\t * learn that step is not a null, undefined etc. This is not helpful, so\n\t * we filter out those errors.\n\t *\n\t * However, if the \"anyOf\" error is the only error we have then we want\n\t * to keep it because the step is likely, say, a number, and we want to\n\t * let the developer know.\n\t */\n\tconst hasErrorsDifferentThanAnyOf: Set<string> = new Set();\n\tfor (const error of blueprintValidator.errors!) {\n\t\tif (!error.schemaPath.startsWith('#/properties/steps/items/anyOf')) {\n\t\t\thasErrorsDifferentThanAnyOf.add(error.instancePath);\n\t\t}\n\t}\n\tconst errors = blueprintValidator.errors?.filter(\n\t\t(error) =>\n\t\t\t!(\n\t\t\t\terror.schemaPath.startsWith('#/properties/steps/items/anyOf') &&\n\t\t\t\thasErrorsDifferentThanAnyOf.has(error.instancePath)\n\t\t\t)\n\t);\n\n\treturn {\n\t\tvalid,\n\t\terrors,\n\t};\n}\n\n/**\n * Compiles a preferred version string into a supported version\n *\n * @param value The value to compile\n * @param supported The list of supported versions\n * @param latest The latest supported version\n * @returns The compiled version\n */\nfunction compileVersion<T>(\n\tvalue: string | undefined | null,\n\tsupported: readonly T[],\n\tlatest: string\n): T {\n\tif (value && supported.includes(value as any)) {\n\t\treturn value as T;\n\t}\n\treturn latest as T;\n}\n\n/**\n * Determines if a step is a StepDefinition object\n *\n * @param step The object to test\n * @returns Whether the object is a StepDefinition\n */\nfunction isStepDefinition(\n\tstep: Step | string | undefined | false | null\n): step is StepDefinition {\n\treturn !!(typeof step === 'object' && step);\n}\n\n/**\n * Determines if a step is still supported, or was it deprecated\n * and removed.\n *\n * @param step The step definition to test.\n * @returns Whether the step is still supported.\n */\nfunction isStepStillSupported(\n\tstep: Record<string, any>\n): step is StepDefinition {\n\tif (['setPhpIniEntry', 'request'].includes(step['step'])) {\n\t\tlogger.warn(\n\t\t\t`The \"${step['step']}\" Blueprint is no longer supported and you can remove it from your Blueprint.`\n\t\t);\n\t\treturn false;\n\t}\n\treturn true;\n}\n\ninterface CompileStepArgsOptions {\n\t/** Optional semaphore to control access to a shared resource */\n\tsemaphore?: Semaphore;\n\t/** The root progress tracker for the compilation */\n\trootProgressTracker: ProgressTracker;\n\t/** The total progress weight of all the steps in the blueprint */\n\ttotalProgressWeight: number;\n\t/**\n\t * Proxy URL to use for cross-origin requests.\n\t *\n\t * @see CompileBlueprintOptions.corsProxy\n\t */\n\tcorsProxy?: string;\n}\n\n/**\n * Compiles a single Blueprint step into a form that can be executed\n *\n * @param playground The PlaygroundClient to use for the compilation\n * @param step The step to compile\n * @param options Additional options for the compilation\n * @returns The compiled step\n */\nfunction compileStep<S extends StepDefinition>(\n\tstep: S,\n\t{\n\t\tsemaphore,\n\t\trootProgressTracker,\n\t\ttotalProgressWeight,\n\t\tcorsProxy,\n\t}: CompileStepArgsOptions\n): { run: CompiledStep; step: S; resources: Array<Resource<any>> } {\n\tconst stepProgress = rootProgressTracker.stage(\n\t\t(step.progress?.weight || 1) / totalProgressWeight\n\t);\n\n\tconst args: any = {};\n\tfor (const key of Object.keys(step)) {\n\t\tlet value = (step as any)[key];\n\t\tif (isResourceReference(value)) {\n\t\t\tvalue = Resource.create(value, {\n\t\t\t\tsemaphore,\n\t\t\t\tcorsProxy,\n\t\t\t});\n\t\t}\n\t\targs[key] = value;\n\t}\n\n\tconst run = async (playground: UniversalPHP) => {\n\t\ttry {\n\t\t\tstepProgress.fillSlowly();\n\t\t\treturn await keyedStepHandlers[step.step](\n\t\t\t\tplayground,\n\t\t\t\tawait resolveArguments(args),\n\t\t\t\t{\n\t\t\t\t\ttracker: stepProgress,\n\t\t\t\t\tinitialCaption: step.progress?.caption,\n\t\t\t\t}\n\t\t\t);\n\t\t} finally {\n\t\t\tstepProgress.finish();\n\t\t}\n\t};\n\n\t/**\n\t * The weight of each async resource is the same, and is the same as the\n\t * weight of the step itself.\n\t */\n\tconst resources = getResources(args);\n\tconst asyncResources = getResources(args).filter(\n\t\t(resource) => resource.isAsync\n\t);\n\n\tconst evenWeight = 1 / (asyncResources.length + 1);\n\tfor (const resource of asyncResources) {\n\t\tresource.progress = stepProgress.stage(evenWeight);\n\t}\n\n\treturn { run, step, resources };\n}\n\n/**\n * Gets the resources used by a specific compiled step\n *\n * @param step The compiled step\n * @returns The resources used by the compiled step\n */\nfunction getResources<S extends StepDefinition>(args: S) {\n\tconst result: Resource<any>[] = [];\n\tfor (const argName in args) {\n\t\tconst resourceMaybe = (args as any)[argName];\n\t\tif (resourceMaybe instanceof Resource) {\n\t\t\tresult.push(resourceMaybe);\n\t\t}\n\t}\n\treturn result;\n}\n\n/**\n * Replaces Resource objects with their resolved values\n *\n * @param step The compiled step\n * @returns The resources used by the compiled step\n */\nasync function resolveArguments<T extends Record<string, unknown>>(args: T) {\n\tconst resolved: any = {};\n\tfor (const argName in args) {\n\t\tconst resourceMaybe = (args as any)[argName];\n\t\tif (resourceMaybe instanceof Resource) {\n\t\t\tresolved[argName] = await resourceMaybe.resolve();\n\t\t} else {\n\t\t\tresolved[argName] = resourceMaybe;\n\t\t}\n\t}\n\treturn resolved;\n}\n\nexport async function runBlueprintSteps(\n\tcompiledBlueprint: CompiledBlueprint,\n\tplayground: UniversalPHP\n) {\n\tawait compiledBlueprint.run(playground);\n}\n","import { UniversalPHP } from '@php-wasm/universal';\nimport { fetchWithCorsProxy } from '@php-wasm/web';\nimport { defineWpConfigConsts } from '@wp-playground/blueprints';\n\nexport interface RequestData {\n\turl: string;\n\tmethod?: string;\n\theaders?: Record<string, string>;\n\tdata?: string;\n}\n\nexport interface RequestMessage {\n\ttype: 'request';\n\tdata: RequestData;\n}\n\nexport interface SetupFetchNetworkTransportOptions {\n\tcorsProxyUrl?: string;\n}\n\n/**\n * Allow WordPress to make network requests via the fetch API.\n * On the WordPress side, this is handled by Requests_Transport_Fetch\n *\n * @param playground the Playground instance to set up with network support.\n */\nexport async function setupFetchNetworkTransport(\n\tplayground: UniversalPHP,\n\toptions?: SetupFetchNetworkTransportOptions\n) {\n\tawait defineWpConfigConsts(playground, {\n\t\tconsts: {\n\t\t\tUSE_FETCH_FOR_REQUESTS: true,\n\t\t},\n\t});\n\n\tawait playground.onMessage(async (message: string) => {\n\t\tlet envelope: RequestMessage;\n\t\ttry {\n\t\t\t// PHP-WASM sends messages as strings, so we can't expect valid JSON.\n\t\t\tenvelope = JSON.parse(message);\n\t\t} catch (e) {\n\t\t\treturn '';\n\t\t}\n\t\tconst { type, data } = envelope;\n\t\tif (type !== 'request') {\n\t\t\treturn '';\n\t\t}\n\n\t\t// PHP encodes empty arrays as JSON arrays, not objects.\n\t\t// We can't easily reason about the request body, but we know\n\t\t// headers should be an object so let's convert it here.\n\t\tif (!data.headers) {\n\t\t\tdata.headers = {};\n\t\t} else if (Array.isArray(data.headers)) {\n\t\t\tdata.headers = Object.fromEntries(data.headers);\n\t\t}\n\n\t\t// Let the Playground request handler know that this request is\n\t\t// coming from PHP. We can't just add this header to all external\n\t\t// requests because of CORS. The browser will refuse to process\n\t\t// cross-origin requests with custom headers unless the server\n\t\t// explicitly allows them in Access-Control-Allow-Headers.\n\t\tconst parsedUrl = new URL(data.url);\n\t\tif (parsedUrl.hostname === window.location.hostname) {\n\t\t\tdata.headers['x-request-issuer'] = 'php';\n\t\t}\n\n\t\tconst corsProxyUrl = options?.corsProxyUrl;\n\t\treturn handleRequest(data, (url: any, options: any) =>\n\t\t\tfetchWithCorsProxy(url, options, corsProxyUrl)\n\t\t);\n\t});\n}\n\nexport async function handleRequest(data: RequestData, fetchFn = fetch) {\n\tlet response;\n\ttry {\n\t\tconst fetchMethod = data.method || 'GET';\n\t\tconst fetchHeaders = data.headers || {};\n\n\t\tconst hasContentTypeHeader = Object.keys(fetchHeaders).some(\n\t\t\t(name) => name.toLowerCase() === 'content-type'\n\t\t);\n\n\t\tif (fetchMethod == 'POST' && !hasContentTypeHeader) {\n\t\t\tfetchHeaders['Content-Type'] = 'application/x-www-form-urlencoded';\n\t\t}\n\n\t\tresponse = await fetchFn(data.url, {\n\t\t\tmethod: fetchMethod,\n\t\t\theaders: fetchHeaders,\n\t\t\tbody: fetchMethod === 'GET' ? undefined : data.data,\n\t\t\tcredentials: 'omit',\n\t\t});\n\t} catch (e) {\n\t\treturn new TextEncoder().encode(\n\t\t\t`HTTP/1.1 400 Invalid Request\\r\\ncontent-type: text/plain\\r\\n\\r\\nPlayground could not serve the request.`\n\t\t);\n\t}\n\tconst responseHeaders: string[] = [];\n\tresponse.headers.forEach((value, key) => {\n\t\tresponseHeaders.push(key + ': ' + value);\n\t});\n\n\t/*\n\t * Technically we should only send ASCII here and ensure we don't send control\n\t * characters or newlines. We ought to be very careful with HTTP headers since\n\t * some attacks rely on assumed processing of them to let things slip in that\n\t * would end the headers section before its done. e.g. we don't want to allow\n\t * emoji in a header and we don't want to allow \\r\\n\\r\\n in a header.\n\t *\n\t * That being said, the browser takes care of it for us.\n\t * response.headers is an instance of the Headers class, and you just can't\n\t * construct the Headers instance if the values are malformed:\n\t *\n\t * > new Headers({'Content-type': 'text/html\\r\\n\\r\\nBreakout!'})\n\t * Failed to construct 'Headers': Invalid value\n\t */\n\tconst headersText =\n\t\t[\n\t\t\t'HTTP/1.1 ' + response.status + ' ' + response.statusText,\n\t\t\t...responseHeaders,\n\t\t].join('\\r\\n') + `\\r\\n\\r\\n`;\n\tconst headersBuffer = new TextEncoder().encode(headersText);\n\tconst bodyBuffer = new Uint8Array(await response.arrayBuffer());\n\tconst jointBuffer = new Uint8Array(\n\t\theadersBuffer.byteLength + bodyBuffer.byteLength\n\t);\n\tjointBuffer.set(headersBuffer);\n\tjointBuffer.set(bodyBuffer, headersBuffer.byteLength);\n\n\treturn jointBuffer;\n}\n","import { MessageListener } from '@php-wasm/universal';\nimport {\n\tspawnPHPWorkerThread,\n\texposeAPI,\n\tconsumeAPI,\n\tsetupPostMessageRelay,\n\tSyncProgressCallback,\n} from '@php-wasm/web';\n\nimport type {\n\tPlaygroundWorkerEndpoint,\n\tWorkerBootOptions,\n\tMountDescriptor,\n} from './worker-thread';\nexport type { MountDescriptor, WorkerBootOptions };\nimport type { WebClientMixin } from './playground-client';\nimport ProgressBar, { ProgressBarOptions } from './progress-bar';\n\n// Avoid literal \"import.meta.url\" on purpose as vite would attempt\n// to resolve it during build time. This should specifically be\n// resolved by the browser at runtime to reflect the current origin.\nconst origin = new URL('/', (import.meta || {}).url).origin;\n\n// @ts-ignore\nimport moduleWorkerUrl from './worker-thread?worker&url';\n\nexport const workerUrl: string = new URL(moduleWorkerUrl, origin) + '';\n\n// @ts-ignore\nimport serviceWorkerPath from '../../service-worker.ts?worker&url';\nimport { FilesystemOperation } from '@php-wasm/fs-journal';\nimport { setupFetchNetworkTransport } from './setup-fetch-network-transport';\nimport { logger } from '@php-wasm/logger';\nimport { PhpWasmError } from '@php-wasm/util';\nimport { responseTo } from '@php-wasm/web-service-worker';\nexport const serviceWorkerUrl = new URL(serviceWorkerPath, origin);\n\n// Prevent Vite from hot-reloading this file – it would\n// cause bootPlaygroundRemote() to register another web worker\n// without unregistering the previous one. The first web worker\n// would then fight for service worker requests with the second\n// one. It's a difficult problem to debug and HMR isn't that useful\n// here anyway – let's just disable it for this file.\n// @ts-ignore\nif (import.meta.hot) {\n\t// @ts-ignore\n\timport.meta.hot.accept(() => {});\n}\n\nconst query = new URL(document.location.href).searchParams;\nexport async function bootPlaygroundRemote() {\n\tassertNotInfiniteLoadingLoop();\n\n\tconst hasProgressBar = query.has('progressbar');\n\tlet bar: ProgressBar | undefined;\n\tif (hasProgressBar) {\n\t\tbar = new ProgressBar();\n\t\tdocument.body.prepend(bar.element);\n\t}\n\tconst sw = navigator.serviceWorker;\n\tif (!sw) {\n\t\t/**\n\t\t * Service workers may only run in secure contexts.\n\t\t * See https://w3c.github.io/webappsec-secure-contexts/\n\t\t */\n\t\tif (window.isSecureContext) {\n\t\t\tthrow new PhpWasmError(\n\t\t\t\t'Service workers are not supported in your browser.'\n\t\t\t);\n\t\t} else {\n\t\t\tthrow new PhpWasmError(\n\t\t\t\t'WordPress Playground uses service workers and may only work on HTTPS and http://localhost/ sites, but the current site is neither.'\n\t\t\t);\n\t\t}\n\t}\n\n\tconst registration = await sw.register(serviceWorkerUrl + '', {\n\t\ttype: 'module',\n\t\t// Always bypass HTTP cache when fetching the new Service Worker script:\n\t\tupdateViaCache: 'none',\n\t});\n\n\t// Check if there's a new service worker available and, if so, enqueue\n\t// the update:\n\ttry {\n\t\tawait registration.update();\n\t} catch (e) {\n\t\t// registration.update() throws if it can't reach the server.\n\t\t// We're swallowing the error to keep the app working in offline mode\n\t\t// or when playground.wordpress.net is down. We can be sure we have a\n\t\t// functional service worker at this point because sw.register() succeeded.\n\t\tlogger.error('Failed to update service worker.', e);\n\t}\n\n\tconst phpWorkerApi = consumeAPI<PlaygroundWorkerEndpoint>(\n\t\tawait spawnPHPWorkerThread(workerUrl)\n\t);\n\n\tconst wpFrame = document.querySelector('#wp') as HTMLIFrameElement;\n\tconst phpRemoteApi: WebClientMixin = {\n\t\tasync onDownloadProgress(fn) {\n\t\t\treturn phpWorkerApi.onDownloadProgress(fn);\n\t\t},\n\t\tasync journalFSEvents(root: string, callback) {\n\t\t\treturn phpWorkerApi.journalFSEvents(root, callback);\n\t\t},\n\t\tasync replayFSJournal(events: FilesystemOperation[]) {\n\t\t\treturn phpWorkerApi.replayFSJournal(events);\n\t\t},\n\t\tasync addEventListener(event, listener) {\n\t\t\treturn await phpWorkerApi.addEventListener(event, listener);\n\t\t},\n\t\tasync removeEventListener(event, listener) {\n\t\t\treturn await phpWorkerApi.removeEventListener(event, listener);\n\t\t},\n\t\tasync setProgress(options: ProgressBarOptions) {\n\t\t\tif (!bar) {\n\t\t\t\tthrow new Error('Progress bar not available');\n\t\t\t}\n\t\t\tbar.setOptions(options);\n\t\t},\n\t\tasync setLoaded() {\n\t\t\tif (!bar) {\n\t\t\t\tthrow new Error('Progress bar not available');\n\t\t\t}\n\t\t\tbar.destroy();\n\t\t},\n\t\tasync onNavigation(fn) {\n\t\t\t// Manage the address bar\n\t\t\twpFrame.addEventListener('load', async (e: any) => {\n\t\t\t\ttry {\n\t\t\t\t\t/**\n\t\t\t\t\t * When navigating to a page with %0A sequences (encoded newlines)\n\t\t\t\t\t * in the query string, the `location.href` property of the\n\t\t\t\t\t * iframe's content window doesn't seem to reflect them. Everything\n\t\t\t\t\t * else is in place, but not the %0A sequences.\n\t\t\t\t\t *\n\t\t\t\t\t * Weirdly, these sequences are available after the next event\n\t\t\t\t\t * loop tick – hence the `setTimeout(0)`.\n\t\t\t\t\t *\n\t\t\t\t\t * The exact cause is unclear at the moment of writing of this\n\t\t\t\t\t * comment. The WHATWG HTML Standard [1] has a few hints:\n\t\t\t\t\t *\n\t\t\t\t\t * * Current and active session history entries may get out of\n\t\t\t\t\t *   sync for iframes.\n\t\t\t\t\t * * Documents inside iframes have \"is delaying load events\" set\n\t\t\t\t\t *   to true.\n\t\t\t\t\t *\n\t\t\t\t\t * But there doesn't seem to be any concrete explanation and no\n\t\t\t\t\t * recommended remediation. If anyone has a clue, please share it\n\t\t\t\t\t * in a GitHub issue or start a new PR.\n\t\t\t\t\t *\n\t\t\t\t\t * [1] https://html.spec.whatwg.org/multipage/document-sequences.html#nav-active-history-entry\n\t\t\t\t\t */\n\t\t\t\t\t// Get the content window while e.currentTarget is available.\n\t\t\t\t\t// It will be undefined on the next event loop tick.\n\t\t\t\t\tconst contentWindow = e.currentTarget!.contentWindow;\n\t\t\t\t\tawait new Promise((resolve) => setTimeout(resolve, 0));\n\t\t\t\t\tconst path = await playground.internalUrlToPath(\n\t\t\t\t\t\tcontentWindow.location.href\n\t\t\t\t\t);\n\t\t\t\t\tfn(path);\n\t\t\t\t} catch (e) {\n\t\t\t\t\t// @TODO: The above call can fail if the remote iframe\n\t\t\t\t\t// is embedded in StackBlitz, or presumably, any other\n\t\t\t\t\t// environment with restrictive CSP. Any error thrown\n\t\t\t\t\t// due to CORS-related stuff crashes the entire remote\n\t\t\t\t\t// so let's ignore it for now and find a correct fix in time.\n\t\t\t\t}\n\t\t\t});\n\t\t},\n\t\tasync goTo(requestedPath: string) {\n\t\t\tif (!requestedPath.startsWith('/')) {\n\t\t\t\trequestedPath = '/' + requestedPath;\n\t\t\t}\n\t\t\t/**\n\t\t\t * Workaround for a Safari bug: navigating to `/wp-admin`\n\t\t\t * without the trailing slash causes the browser to hang.\n\t\t\t * Chrome and Firefox correctly navigate to `/wp-admin`,\n\t\t\t * get a 302 redirect from PHPRequestHandler, and then follow\n\t\t\t * it to `/wp-admin/`.\n\t\t\t *\n\t\t\t * Interestingly, opening pretty permalinks without the trailing slash\n\t\t\t * works correctly. For example, `/sample-page` works as expected.\n\t\t\t */\n\t\t\tif (requestedPath === '/wp-admin') {\n\t\t\t\trequestedPath = '/wp-admin/';\n\t\t\t}\n\t\t\tconst newUrl = await playground.pathToInternalUrl(requestedPath);\n\t\t\tconst oldUrl = wpFrame.src;\n\n\t\t\t// If the URL is the same, we need to force a reload\n\t\t\t// because otherwise the iframe will not reload the page.\n\t\t\tif (newUrl === oldUrl && wpFrame.contentWindow) {\n\t\t\t\ttry {\n\t\t\t\t\twpFrame.contentWindow.location.href = newUrl;\n\t\t\t\t\treturn;\n\t\t\t\t} catch (e) {\n\t\t\t\t\t// The above call can fail if we're embedded in an\n\t\t\t\t\t// environment with a restrictive CSP policy.\n\t\t\t\t}\n\t\t\t}\n\t\t\twpFrame.src = newUrl;\n\t\t},\n\t\tasync getCurrentURL() {\n\t\t\tlet url = '';\n\t\t\ttry {\n\t\t\t\turl = wpFrame.contentWindow!.location.href;\n\t\t\t} catch (e) {\n\t\t\t\t// The above call can fail if we're embedded in an\n\t\t\t\t// environment with a restrictive CSP policy.\n\t\t\t}\n\t\t\tif (!url) {\n\t\t\t\t// If we can't get the URL from the iframe (e.g. it's not loaded\n\t\t\t\t// yet), let's refer to the src attribute of the iframe itself.\n\t\t\t\t// This is less reliable because the src attribute may not be\n\t\t\t\t// updated when the iframe navigates to a new URL.\n\t\t\t\turl = wpFrame.src;\n\t\t\t}\n\t\t\treturn await playground.internalUrlToPath(url);\n\t\t},\n\t\tasync setIframeSandboxFlags(flags: string[]) {\n\t\t\twpFrame.setAttribute('sandbox', flags.join(' '));\n\t\t},\n\t\t/**\n\t\t * This function is merely here to explicitly call workerApi.onMessage.\n\t\t * Comlink should be able to handle that on its own, but something goes\n\t\t * wrong and if this function is not here, we see the following error:\n\t\t *\n\t\t * Error: Failed to execute 'postMessage' on 'Worker': function() {\n\t\t * } could not be cloned.\n\t\t *\n\t\t * In the future, this explicit declaration shouldn't be needed.\n\t\t *\n\t\t * @param callback\n\t\t * @returns\n\t\t */\n\t\tasync onMessage(callback: MessageListener) {\n\t\t\treturn await phpWorkerApi.onMessage(callback);\n\t\t},\n\n\t\t/**\n\t\t * Ditto for this function.\n\t\t * @see onMessage\n\t\t * @param callback\n\t\t * @returns\n\t\t */\n\t\tasync mountOpfs(\n\t\t\toptions: MountDescriptor,\n\t\t\tonProgress?: SyncProgressCallback\n\t\t) {\n\t\t\treturn await phpWorkerApi.mountOpfs(options, onProgress);\n\t\t},\n\n\t\t/**\n\t\t * Ditto for this function.\n\t\t * @see onMessage\n\t\t * @param mountpoint\n\t\t * @returns\n\t\t */\n\t\tasync unmountOpfs(mountpoint: string) {\n\t\t\treturn await phpWorkerApi.unmountOpfs(mountpoint);\n\t\t},\n\n\t\t/**\n\t\t * Download WordPress assets.\n\t\t * @see backfillStaticFilesRemovedFromMinifiedBuild in the worker-thread.ts\n\t\t */\n\t\tasync backfillStaticFilesRemovedFromMinifiedBuild() {\n\t\t\tawait phpWorkerApi.backfillStaticFilesRemovedFromMinifiedBuild();\n\t\t},\n\n\t\t/**\n\t\t * Checks whether we have the missing WordPress assets readily\n\t\t * available in the request cache.\n\t\t */\n\t\tasync hasCachedStaticFilesRemovedFromMinifiedBuild() {\n\t\t\treturn await phpWorkerApi.hasCachedStaticFilesRemovedFromMinifiedBuild();\n\t\t},\n\n\t\tasync boot(options) {\n\t\t\tawait phpWorkerApi.boot(options);\n\n\t\t\t// Proxy the service worker messages to the web worker:\n\t\t\tnavigator.serviceWorker.addEventListener(\n\t\t\t\t'message',\n\t\t\t\tasync function onMessage(event) {\n\t\t\t\t\t/**\n\t\t\t\t\t * Ignore events meant for other PHP instances to\n\t\t\t\t\t * avoid handling the same event twice.\n\t\t\t\t\t *\n\t\t\t\t\t * This is important because the service worker posts the\n\t\t\t\t\t * same message to all application instances across all browser tabs.\n\t\t\t\t\t */\n\t\t\t\t\tif (options.scope && event.data.scope !== options.scope) {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\t// Wait for the PHP API client to be set by bootPlaygroundRemote\n\t\t\t\t\tconst args = event.data.args || [];\n\t\t\t\t\tconst method = event.data\n\t\t\t\t\t\t.method as keyof PlaygroundWorkerEndpoint;\n\t\t\t\t\tconst result = await (phpWorkerApi[method] as Function)(\n\t\t\t\t\t\t...args\n\t\t\t\t\t);\n\t\t\t\t\tevent.source!.postMessage(\n\t\t\t\t\t\tresponseTo(event.data.requestId, result)\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t);\n\t\t\tsw.startMessages();\n\n\t\t\ttry {\n\t\t\t\tawait phpWorkerApi.isReady();\n\n\t\t\t\tsetupPostMessageRelay(\n\t\t\t\t\twpFrame,\n\t\t\t\t\tgetOrigin((await playground.absoluteUrl)!)\n\t\t\t\t);\n\n\t\t\t\tif (options.withNetworking) {\n\t\t\t\t\tawait setupFetchNetworkTransport(phpWorkerApi, {\n\t\t\t\t\t\tcorsProxyUrl: options.corsProxyUrl,\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\tsetAPIReady();\n\t\t\t} catch (e) {\n\t\t\t\tsetAPIError(e as Error);\n\t\t\t\tthrow e;\n\t\t\t}\n\n\t\t\t/**\n\t\t\t * When we're running WordPress from a minified bundle, we're missing some static assets.\n\t\t\t * The section below backfills them if needed. It doesn't do anything if the assets are already\n\t\t\t * in place, or when WordPress is loaded from a non-minified bundle.\n\t\t\t *\n\t\t\t * Minified bundles are shipped without most static assets to reduce the bundle size and\n\t\t\t * the loading time. When WordPress loads for the first time, the browser parses all the\n\t\t\t * <script src=\"\">, <link href=\"\">, etc. tags and fetches the missing assets from the server.\n\t\t\t *\n\t\t\t * Unfortunately, fetching these assets on demand wouldn't work in an offline mode.\n\t\t\t *\n\t\t\t * Below we're downloading a zipped bundle of the missing assets.\n\t\t\t */\n\t\t\tif (\n\t\t\t\tawait phpRemoteApi.hasCachedStaticFilesRemovedFromMinifiedBuild()\n\t\t\t) {\n\t\t\t\t/**\n\t\t\t\t * If we already have the static assets in the cache, the backfilling only\n\t\t\t\t * involves unzipping the archive. This is fast. Let's do it before the first\n\t\t\t\t * render.\n\t\t\t\t *\n\t\t\t\t * Why?\n\t\t\t\t *\n\t\t\t\t * Because otherwise the initial offline page render would lack CSS.\n\t\t\t\t * Without the static assets in /wordpress/wp-content, the browser would\n\t\t\t\t * attempt to fetch them from the server. However, we're in an offline mode\n\t\t\t\t * so nothing would be fetched.\n\t\t\t\t */\n\t\t\t\tawait phpRemoteApi.backfillStaticFilesRemovedFromMinifiedBuild();\n\t\t\t} else {\n\t\t\t\t/**\n\t\t\t\t * If we don't have the static assets in the cache, we need to fetch them.\n\t\t\t\t *\n\t\t\t\t * Let's wait for the initial page load before we start the backfilling.\n\t\t\t\t * The static assets are 12MB+ in size. Starting the download before\n\t\t\t\t * Playground is loaded would noticeably delay the first paint.\n\t\t\t\t */\n\t\t\t\twpFrame.addEventListener('load', () => {\n\t\t\t\t\tphpRemoteApi.backfillStaticFilesRemovedFromMinifiedBuild();\n\t\t\t\t});\n\t\t\t}\n\t\t},\n\t};\n\n\tawait phpWorkerApi.isConnected();\n\n\t// If onDownloadProgress is not explicitly re-exposed here,\n\t// Comlink will throw an error and claim the callback\n\t// cannot be cloned. Adding a transfer handler for functions\n\t// doesn't help:\n\t// https://github.com/GoogleChromeLabs/comlink/issues/426#issuecomment-578401454\n\t// @TODO: Handle the callback conversion automatically and don't explicitly re-expose\n\t//        the onDownloadProgress method\n\tconst [setAPIReady, setAPIError, playground] = exposeAPI(\n\t\tphpRemoteApi,\n\t\tphpWorkerApi\n\t);\n\n\t/*\n\t * An assertion to make sure Playground Client is compatible\n\t * with Remote<PlaygroundClient>\n\t */\n\treturn playground;\n}\n\nfunction getOrigin(url: string) {\n\treturn new URL(url, 'https://example.com').origin;\n}\n\n/**\n * When the service worker fails for any reason, the page displayed inside\n * the iframe won't be a WordPress instance we expect from the service worker.\n * Instead, it will be the original page trying to load the service worker. This\n * causes an infinite loop with a loader inside a loader inside a loader.\n */\nfunction assertNotInfiniteLoadingLoop() {\n\tlet isBrowserInABrowser = false;\n\ttry {\n\t\tisBrowserInABrowser =\n\t\t\twindow.parent !== window &&\n\t\t\t(window as any).parent.IS_WASM_WORDPRESS;\n\t} catch (e) {\n\t\t// ignore\n\t}\n\tif (isBrowserInABrowser) {\n\t\tthrow new Error(\n\t\t\t`The service worker did not load correctly. This is a bug,\n\t\t\tplease report it on https://github.com/WordPress/wordpress-playground/issues`\n\t\t);\n\t}\n\t(window as any).IS_WASM_WORDPRESS = true;\n}\n","export { getWordPressModuleDetails } from './wordpress/get-wordpress-module-details';\nexport { getWordPressModule } from './wordpress/get-wordpress-module';\nexport * as sqliteDatabaseIntegrationModuleDetails from './sqlite-database-integration/get-sqlite-database-plugin-details';\nexport { getSqliteDatabaseModule } from './sqlite-database-integration/get-sqlite-database-module';\nimport MinifiedWordPressVersions from './wordpress/wp-versions.json';\n\nexport { MinifiedWordPressVersions };\nexport const MinifiedWordPressVersionsList = Object.keys(\n\tMinifiedWordPressVersions\n) as any as string[];\nexport const LatestMinifiedWordPressVersion =\n\tMinifiedWordPressVersionsList.filter((v) => v.match(/^\\d/))[0] as string;\n\nexport function wpVersionToStaticAssetsDirectory(\n\twpVersion: string\n): string | undefined {\n\treturn wpVersion in MinifiedWordPressVersions\n\t\t? `wp-${wpVersion}`\n\t\t: undefined;\n}\n","\n\t\t\tif (window.top != window.self) {\n\t\t\t\tdocument.body.classList.add('is-embedded');\n\t\t\t}\n\t\t\timport { bootPlaygroundRemote } from './src/index';\n\t\t\ttry {\n\t\t\t\twindow.playground = await bootPlaygroundRemote();\n\t\t\t} catch (e) {\n\t\t\t\tconsole.error(e);\n\t\t\t\tdocument.body.className = 'has-error';\n\t\t\t\tdocument.body.innerHTML = '';\n\n\t\t\t\tif (e?.name === 'NotSupportedError') {\n\t\t\t\t\tdocument.body.append(await renderStorageErrorUI());\n\t\t\t\t} else {\n\t\t\t\t\tdocument.body.append(renderGenericErrorUI(e));\n\t\t\t\t}\n\t\t\t} finally {\n\t\t\t\tdocument.body.classList.remove('is-loading');\n\t\t\t}\n\n\t\t\tfunction renderGenericErrorUI(error) {\n\t\t\t\tconst fragment = document.createDocumentFragment();\n\n\t\t\t\tconst div = document.createElement('div');\n\t\t\t\tdiv.className = 'error-message';\n\t\t\t\tconst userFriendlyMessage =\n\t\t\t\t\terror.userFriendlyMessage ||\n\t\t\t\t\t'See the developer tools for error details.';\n\t\t\t\tdiv.innerHTML =\n\t\t\t\t\t'Ooops! WordPress Playground had a hiccup! <br/><br/> ' +\n\t\t\t\t\tuserFriendlyMessage;\n\t\t\t\tfragment.append(div);\n\n\t\t\t\tconst button = document.createElement('button');\n\t\t\t\tbutton.innerText = 'Try again';\n\t\t\t\tbutton.onclick = () => {\n\t\t\t\t\twindow.location.reload();\n\t\t\t\t};\n\t\t\t\tfragment.append(button);\n\n\t\t\t\tconst reportIssues = document.createElement('p');\n\t\t\t\treportIssues.innerHTML = `\n\t\t\t\t\tIf the problem persists, please\n\t\t\t\t\t<a href=\"https://github.com/WordPress/playground-tools/issues/new\"\n\t\t\t\t\t\ttarget=\"_blank\"\n\t\t\t\t\t\t>report an issue on GitHub</a>.\n\t\t\t\t`;\n\t\t\t\tfragment.append(reportIssues);\n\n\t\t\t\treturn fragment;\n\t\t\t}\n\n\t\t\tasync function renderStorageErrorUI() {\n\t\t\t\tconst fragment = document.createDocumentFragment();\n\n\t\t\t\t/**\n\t\t\t\t * Chrome does not allow Service Workers to be registered from cross-origin iframes\n\t\t\t\t * when third-party cookies are disabled unless `requestStorageAccess()` is called\n\t\t\t\t * and the user grants storage access.\n\t\t\t\t *\n\t\t\t\t * Let's assess the situation and provide a helpful message.\n\t\t\t\t */\n\t\t\t\tlet hasStorageAccess = false;\n\t\t\t\ttry {\n\t\t\t\t\tconst { state } = await navigator.permissions.query({\n\t\t\t\t\t\tname: 'storage-access',\n\t\t\t\t\t});\n\t\t\t\t\thasStorageAccess = state === 'granted';\n\t\t\t\t} catch (e) {\n\t\t\t\t\t// noop\n\t\t\t\t}\n\n\t\t\t\tif (hasStorageAccess || !('requestStorageAccess' in document)) {\n\t\t\t\t\tconst div = document.createElement('div');\n\n\t\t\t\t\t// The user has granted storage access, but the error still persists.\n\t\t\t\t\t// Let's explain why.\n\t\t\t\t\tdiv.innerText =\n\t\t\t\t\t\t'It looks like you have disabled third-party cookies in your browser. This ' +\n\t\t\t\t\t\t'also disables the Service Worker API used by WordPress Playground. Please re-enable ' +\n\t\t\t\t\t\t'third-party cookies and try again.';\n\t\t\t\t\tfragment.append(div);\n\n\t\t\t\t\tconst button = document.createElement('button');\n\t\t\t\t\tbutton.innerText = 'Try again';\n\t\t\t\t\tbutton.onclick = () => {\n\t\t\t\t\t\twindow.location.reload();\n\t\t\t\t\t};\n\t\t\t\t\tfragment.append(button);\n\t\t\t\t} else {\n\t\t\t\t\tconst div = document.createElement('div');\n\n\t\t\t\t\t// The user has not granted storage access.\n\t\t\t\t\t// There's a chance we can fix this by asking for storage access.\n\t\t\t\t\tdiv.innerText =\n\t\t\t\t\t\t'WordPress Playground needs to use storage in your browser.';\n\t\t\t\t\tfragment.append(div);\n\n\t\t\t\t\tconst button = document.createElement('button');\n\t\t\t\t\tbutton.innerText = 'Allow storage access';\n\t\t\t\t\tfragment.append(button);\n\n\t\t\t\t\tbutton.onclick = async () => {\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tawait document.requestStorageAccess();\n\t\t\t\t\t\t\twindow.location.reload();\n\t\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\t\t// Either the user denied storage access OR chrome is not allowing\n\t\t\t\t\t\t\t// storage access to be requested from an iframe for some reason.\n\n\t\t\t\t\t\t\t// The two errors are indistinguishable and just say \"requestStorageAccess not allowed\"\n\t\t\t\t\t\t\t// https://source.chromium.org/chromium/chromium/src/+/main:third_party/blink/renderer/core/dom/document.cc;drc=daf56cfa413f10dee6aa15b0b1e4572fcf5578df;l=462\n\t\t\t\t\t\t\t// It's confusing! But we can at least tell the user what to do.\n\t\t\t\t\t\t\tdiv.innerHTML = `\n\t\t\t\t\t\t\t\t<p>\n\t\t\t\t\t\t\t\t\tOops! Playground failed to start. Here's what to do:\n\t\t\t\t\t\t\t\t</p>\n\n\t\t\t\t\t\t\t\t<h3>Did you disable third-party cookies?</h3>\n\t\t\t\t\t\t\t\t<p>\n\t\t\t\t\t\t\t\t\tIt also disables the required Service Worker API. Please re-enable\n\t\t\t\t\t\t\t\t\tthird-party cookies and try again.\n\t\t\t\t\t\t\t\t</p>\n\n\t\t\t\t\t\t\t\t<h3>Did you refuse to grant Playground storage access?</h3>\n\t\t\t\t\t\t\t\t<p>\n\t\t\t\t\t\t\t\t\tClick the button below and grant storage access. Note the button may\n\t\t\t\t\t\t\t\t\tnot work if you have disabled third-party cookies in your browser.\n\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t\t<p>\n\t\t\t\t\t\t\t\t\tIf neither method helped, please\n\t\t\t\t\t\t\t\t\t<a href=\"https://github.com/WordPress/playground-tools/issues/new\"\n\t\t\t\t\t\t\t\t\t\ttarget=\"_blank\">\n\t\t\t\t\t\t\t\t\t\treport an issue on GitHub\n\t\t\t\t\t\t\t\t\t</a>.\n\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t\t`;\n\t\t\t\t\t\t}\n\t\t\t\t\t};\n\t\t\t\t}\n\n\t\t\t\treturn fragment;\n\t\t\t}\n\t\t"],"names":["currentJsRuntime","asPromise","obj","resolve","reject","event","isByobSupported","inputBytes","stream","File","sources","fileName","options","date","reader","position","blob","controller","view","buffer","uint8array","bytesRead","CustomEvent","name","url","FileErrorCodes","getEmscriptenFsError","e","errno","rethrowFileSystemError","messagePrefix","target","methodName","descriptor","method","args","errmsg","path","formattedPrefix","logEventType","logEvent","log","logger","logToConsole","prepareLogMessage","logMessage","logs","addToLogArray","message","logToMemory","formatLogEntry","Logger","handlers","handler","getDefaultHandlers","severity","prefix","formattedDate","formattedTime","now","SleepFinished","sleep","ms","AcquireTimeoutError","Semaphore","concurrency","timeout","acquired","value","released","fn","release","PhpWasmError","userFriendlyMessage","joinPaths","paths","hasTrailingSlash","p","isAbsolute","trailingSlash","normalizePath","dirname","lastSlash","normalizePathsArray","parts","allowAboveRoot","up","i","last","randomString","length","specialChars","chars","result","randomFilename","phpVar","stringToBase64","phpVars","vars","key","str","bytesToBase64","bytes","binString","_FSHelpers","FS","data","fromPath","toPath","fromMount","toMount","file","filePath","files","prepend","link","fromNode","filenames","filename","__decorateClass","responseTexts","PHPResponse","httpStatusCode","headers","body","errors","exitCode","text","done","writeFiles","php","root","newFiles","rmRoot","relativePath","content","proxyMarker","createEndpoint","releaseProxy","finalizer","throwMarker","isObject","val","proxyTransferHandler","port1","port2","expose","port","wrap","throwTransferHandler","serialized","transferHandlers","isAllowedOrigin","allowedOrigins","origin","allowedOrigin","ep","callback","ev","id","type","argumentList","fromWireValue","returnValue","parent","prop","rawValue","proxy","transfer","wireValue","transferables","toWireValue","closeEndPoint","error","isMessagePort","endpoint","createProxy","throwIfProxyReleased","isReleased","releaseEndpoint","requestResponseMessage","proxyCounter","proxyFinalizers","newCount","registerProxy","unregisterProxy","isProxyReleased","_target","r","_thisArg","rawArgumentList","processArguments","myFlat","arr","processed","v","transferCache","transfers","windowEndpoint","w","context","targetOrigin","msg","serializedValue","generateUUID","l","consumeAPI","remote","setupTransferHandlers","Comlink.windowEndpoint","api","Comlink.wrap","methods","proxyClone","runWithTimeout","promise","exposeAPI","apiMethods","pipedApi","connected","setReady","setFailed","ready","exposedApi","Comlink.expose","isTransferHandlersSetup","Comlink.transferHandlers","responseData","throwHandler","originalSerialize","object","Comlink.proxy","flipObject","k","ExtensionTypes","ServerNameTypes","CipherSuites","SupportedGroups","ECPointFormats","SignatureAlgorithms","HashAlgorithms","AlertLevels","AlertDescriptions","responseTo","requestId","response","cloneRequest","request","overrides","fetchWithCorsProxy","input","init","corsProxyUrl","directFetch","newInput","setupPostMessageRelay","nestedFrame","expectedOrigin","spawnPHPWorkerThread","workerUrl","worker","onStartup","ProgressBar","css","progressBarWrapper","wrapper","progressBar","wpContentFilesExcludedFromExport","activatePlugin","playground","pluginPath","pluginName","progress","docroot","activatePluginResult","isActiveCheckResult","activateTheme","themeFolderName","themeFolderPath","runPHP","code","runPHPWithOptions","rm","runSql","sql","sqlFilename","js","runPhp","rewriteWpConfigToDefineConstants","defineWpConfigConsts","consts","defineBeforeRun","documentRoot","wpConfigPath","wpConfig","updatedWpConfig","rewriteDefineCalls","phpCode","setSiteOptions","updateUserMeta","meta","userId","defaultWpCliPath","assertWpCli","wpCliPath","wpCLI","command","splitShellCommand","mode","quote","currentPart","char","enableMultisite","errorMessage","sitePath","siteUrl","cp","mv","mkdir","rmdir","writeFile","writeToPath","filesTree","writeFilesToPhpWasm","defineSiteUrl","importWxr","importer","importWithDataLiberationImporter","importWithDefaultImporter","clearProgressListener","messageString","importThemeStarterContent","themeSlug","createMemoizedFetch","originalFetch","cache","responseInit","left","right","tmpPath","unzipFile","zipPath","extractToPath","overwriteFiles","zipFile","unzip","importWordPressFiles","wordPressFilesZip","pathInZip","importPath","importedWpContentPath","wpContentPath","excludedImportPath","removePath","restoreFromPath","importedDatabasePath","importedFilenames","upgradePhp","exportWXR","databaseExportResponse","installAsset","targetPath","ifAlreadyInstalled","targetFolderName","assetNameGuess","wpContent","tmpDir","tmpUnzippedFilesPath","zipHasRootFolder","assetFolderName","tmpAssetPath","assetFolderPath","zipNameToHumanName","zipName","mixedCaseName","installPlugin","pluginData","pluginZipFile","pluginsDirectoryPath","assetNiceName","destinationFilePath","zipFileName","assetResult","pluginDirectoryPath","installTheme","themeData","themeZipFile","themeDirectoryPath","login","username","resetData","_options","runWpInstallationWizard","zipWpContent","selfContained","exceptPaths","runPhpWithZipFunctions","fileBuffer","zipFunctions","memoizedFetch","resolveWordPressRelease","versionQuery","shasum","sha1","b","latestVersions","apiVersion","getWordPressTranslationUrl","wpVersion","language","latestBetaWordPressVersion","latestStableWordPressVersion","resolvedVersion","resolved","setSiteLanguage","translations","plugins","slug","version","themes","fetchQueue","translationsQueue","destination","BaseError","json","factory","exports","CRC32","signed_crc_table","c","table","n","T0","slice_by_16_tables","T","out","TT","T1","T2","T3","T4","T5","T6","T7","T8","T9","Ta","Tb","Tc","Td","Te","Tf","crc32_bstr","bstr","seed","L","crc32_buf","B","crc32_str","d","base64Js","byteLength","toByteArray","fromByteArray","lookup","revLookup","Arr","len","getLens","b64","validLen","placeHoldersLen","lens","_byteLength","tmp","curByte","tripletToBase64","num","encodeChunk","uint8","start","end","output","extraBytes","maxChunkLength","len2","ieee754","offset","isLE","mLen","nBytes","m","eLen","eMax","eBias","nBits","s","rt","base64","require$$0","require$$1","customInspectSymbol","Buffer","SlowBuffer","K_MAX_LENGTH","typedArraySupport","proto","createBuffer","buf","arg","encodingOrOffset","allocUnsafe","from","fromString","fromArrayView","isInstance","fromArrayBuffer","valueOf","fromObject","assertSize","size","alloc","fill","encoding","checked","string","actual","fromArrayLike","array","arrayView","copy","byteOffset","numberIsNaN","a","x","y","list","pos","mustMatch","loweredCase","utf8ToBytes","base64ToBytes","slowToString","hexSlice","utf8Slice","asciiSlice","latin1Slice","base64Slice","utf16leSlice","swap","max","thisStart","thisEnd","thisCopy","targetCopy","bidirectionalIndexOf","dir","arrayIndexOf","indexSize","arrLength","valLength","read","foundIndex","found","j","hexWrite","remaining","strLen","parsed","utf8Write","blitBuffer","asciiWrite","asciiToBytes","base64Write","ucs2Write","utf16leToBytes","res","firstByte","codePoint","bytesPerSequence","secondByte","thirdByte","fourthByte","tempCodePoint","decodeCodePointsArray","MAX_ARGUMENTS_LENGTH","codePoints","ret","hexSliceLookupTable","newBuf","checkOffset","ext","noAssert","mul","defineBigIntMethod","validateNumber","first","boundsError","lo","hi","checkInt","min","maxBytes","wrtBigUInt64LE","checkIntBI","wrtBigUInt64BE","limit","sub","checkIEEE754","writeFloat","littleEndian","writeDouble","targetStart","E","sym","getMessage","Base","range","received","addNumericalSeparator","checkBounds","INVALID_BASE64_RE","base64clean","units","leadSurrogate","byteArray","src","dst","alphabet","i16","BufferBigIntNotDefined","ObjectTypeError","oid","expected","filepath","otherStepHandlers","allStepHandlers","setupFetchNetworkTransport","envelope","handleRequest","fetchFn","fetchMethod","fetchHeaders","hasContentTypeHeader","responseHeaders","headersText","headersBuffer","bodyBuffer","jointBuffer","moduleWorkerUrl","serviceWorkerUrl","serviceWorkerPath","query","bootPlaygroundRemote","assertNotInfiniteLoadingLoop","hasProgressBar","bar","sw","registration","phpWorkerApi","wpFrame","phpRemoteApi","events","listener","contentWindow","requestedPath","newUrl","oldUrl","flags","onProgress","mountpoint","getOrigin","setAPIReady","setAPIError","isBrowserInABrowser","MinifiedWordPressVersionsList","MinifiedWordPressVersions","renderStorageErrorUI","renderGenericErrorUI","fragment","div","button","reportIssues","hasStorageAccess","state"],"mappings":"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AA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AA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","x_google_ignoreList":[21,76,77,78,79]}